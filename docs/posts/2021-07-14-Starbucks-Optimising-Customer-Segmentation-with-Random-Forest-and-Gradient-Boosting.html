<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.1.251">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>blog – starbucks-optimising-customer-segmentation-with-random-forest-and-gradient-boosting</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">blog</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../about.html">About</a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/"><i class="bi bi-github" role="img">
</i> 
 </a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com"><i class="bi bi-twitter" role="img">
</i> 
 </a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">



<section id="optimising-starbucks-rewards-program" class="level1">
<h1>Optimising Starbuck’s rewards program</h1>
<blockquote class="blockquote">
<p>Lionel Mpofu explores marketing analytics strategies using random forests and gradient boosting models..</p>
</blockquote>
</section>
<section id="table-of-contents" class="level1">
<h1>Table of Contents</h1>
<ol type="1">
<li><a href="#intro">Introduction</a><br>
<ol type="i">
<li><a href="#data">Data Sets</a><br></li>
</ol></li>
<li><a href="#clean">Data Assessment &amp; Cleaning</a><br></li>
<li><a href="#eda">Exploratory Data Analysis</a><br>
<ol type="i">
<li><a href="#segmentation">Customer segmentation</a><br></li>
</ol></li>
<li><a href="#preprocessing">Data Preprocessing</a><br></li>
<li><a href="#prediction">Prediction Modeling</a><br> <a href="#gb">Gradient Boosting Classifier</a><br> <a href="#tune">Tuning Parameter Refinement</a><br></li>
<li><a href="#conclusion">Conclusion</a><br>
<ol type="i">
<li><a href="#results">Results</a><br></li>
<li><a href="#recs">Recommendations</a><br></li>
</ol></li>
</ol>
<p><a id="intro"></a> # 1. Introduction</p>
<p>Starbucks is one of the largest coffehouses in the world. They have been known for having done of the most vigorous digitalisation strategies that has seen them grow to become titans in industry. In the first quarter of 2020, it witnessed a 16pc in year over year growth recording 18.9 million active users. It is infamous for its rewards program. According to starbucks, as of end of 2020, nearly a quarter of their transactions are done through the phone. This means that, a substantial amount of its revenue relies on the rewards app. In this project, we seek to analyse customer behavior of the starbucks rewards app so we can optimise profits by targetted marketing.</p>
<p>This data set contains simulated data that mimics customer behavior on the Starbucks rewards mobile app. Once every few days, Starbucks sends out an offer to users of the mobile app. An offer can be merely an advertisement for a drink or an actual offer such as a discount or BOGO (buy one get one free). Some users might not receive any offer during certain weeks.</p>
<p>Not all users receive the same offer.</p>
<p>The objective is to combine transaction, demographic and offer data to determine which demographic groups respond best to which offer type.</p>
<p>Every offer has a validity period before the offer expires. As an example, a BOGO offer might be valid for only 5 days. Informational offers have a validity period even though these ads are merely providing information about a product; for example, if an informational offer has 7 days of validity, you can assume the customer is feeling the influence of the offer for 7 days after receiving the advertisement.</p>
<p>Starbuks has provided transactional data showing user purchases made on the app including the timestamp of purchase and the amount of money spent on a purchase. This transactional data also has a record for each offer that a user receives as well as a record for when a user actually views the offer. There are also records for when a user completes an offer.</p>
<p>Keep in mind as well that someone using the app might make a purchase through the app without having received an offer or seen an offer.</p>
<section id="example" class="level3">
<h3 class="anchored" data-anchor-id="example">Example</h3>
<p>To give an example, a user could receive a discount offer buy 10 dollars get 2 off on Monday. The offer is valid for 10 days from receipt. If the customer accumulates at least 10 dollars in purchases during the validity period, the customer completes the offer.</p>
<p>However, there are a few things to watch out for in this data set. Customers do not opt into the offers that they receive; in other words, a user can receive an offer, never actually view the offer, and still complete the offer. For example, a user might receive the “buy 10 dollars get 2 dollars off offer”, but the user never opens the offer during the 10 day validity period. The customer spends 15 dollars during those ten days. There will be an offer completion record in the data set; however, the customer was not influenced by the offer because the customer never viewed the offer.</p>
</section>
<section id="cleaning" class="level3">
<h3 class="anchored" data-anchor-id="cleaning">Cleaning</h3>
<p>This makes data cleaning especially important and tricky.</p>
<p>You’ll also want to take into account that some demographic groups will make purchases even if they don’t receive an offer. From a business perspective, if a customer is going to make a 10 dollar purchase without an offer anyway, you wouldn’t want to send a buy 10 dollars get 2 dollars off offer. You’ll want to try to assess what a certain demographic group will buy when not receiving any offers.</p>
<p>The “transaction” event does not have any “offer_id” associated to it, so we have to figure out which transactions are connected to particular offer and which ones are not (customer bought something casually).</p>
<p>Informational offer can not be “completed” due to it’s nature, so we need to find a way to connect it with the possible transactions.</p>
<p>Some demographic groups will make purchases regardless of whether they receive an offer. Ideally we would like to group them separately.</p>
<p>A user can complete the offer without actually seeing it. In this case user was making a regular purchase and offer completed automatically. This is not a result of particular marketing campaign but rather a coincidence.</p>
<p><a id="data"> </a> # Data Sets</p>
<p>The data is contained in three files:</p>
<ul>
<li>portfolio.json - containing offer ids and meta data about each offer (duration, type, etc.)</li>
<li>profile.json - demographic data for each customer</li>
<li>transcript.json - records for transactions, offers received, offers viewed, and offers completed</li>
</ul>
<p>Here is the schema and explanation of each variable in the files:</p>
<p><strong>portfolio.json</strong> * id (string) - offer id * offer_type (string) - type of offer ie BOGO, discount, informational * difficulty (int) - minimum required spend to complete an offer * reward (int) - reward given for completing an offer * duration (int) - time for offer to be open, in days * channels (list of strings)</p>
<p><strong>profile.json</strong> * age (int) - age of the customer * became_member_on (int) - date when customer created an app account * gender (str) - gender of the customer (note some entries contain ‘O’ for other rather than M or F) * id (str) - customer id * income (float) - customer’s income</p>
<p><strong>transcript.json</strong> * event (str) - record description (ie transaction, offer received, offer viewed, etc.) * person (str) - customer id * time (int) - time in hours since start of test. The data begins at time t=0 * value - (dict of strings) - either an offer id or transaction amount depending on the record</p>
<p><strong>Data quality issues</strong>: * Null values for “gender” and “income” in profile.json * Age: missing value encoded as 118 in profile.json * Incorrect data format (int64 instead of datetime) in profile.json * Column names can be improved * Incompatible units - offer duration days vs.&nbsp;event time in hours * Different keys in transcript.json - “event id” and “event_id”</p>
</section>
<section id="implementation-steps" class="level3">
<h3 class="anchored" data-anchor-id="implementation-steps">Implementation Steps:</h3>
<ul>
<li>Data exploration</li>
<li>Data cleaning</li>
<li>Exploratory data analysis (EDA)</li>
<li>Customer segmentation</li>
<li>Exploring the resultant clusters</li>
<li>Data Preprocessing</li>
<li>Training the model</li>
<li>Improving the model</li>
<li>Choosing the best performing model</li>
<li>Deploying the best model</li>
<li>Exploring the prediction results</li>
</ul>
<div class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> math</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> lifetimes.utils <span class="im">import</span> summary_data_from_transaction_data</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> datetime</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> MultiLabelBinarizer</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> StandardScaler, MinMaxScaler</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.decomposition <span class="im">import</span> PCA</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.neighbors <span class="im">import</span> NearestNeighbors</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.cluster <span class="im">import</span> KMeans</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.cluster <span class="im">import</span> DBSCAN</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.cluster <span class="im">import</span> OPTICS</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> LabelEncoder</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn <span class="im">import</span> metrics</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> recall_score</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> cross_val_score</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> RepeatedStratifiedKFold</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.svm <span class="im">import</span> LinearSVC</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.discriminant_analysis <span class="im">import</span> LinearDiscriminantAnalysis</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.ensemble <span class="im">import</span> RandomForestClassifier</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.ensemble <span class="im">import</span> ExtraTreesClassifier</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.ensemble <span class="im">import</span> BaggingClassifier</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.neighbors <span class="im">import</span> KNeighborsClassifier</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.gaussian_process <span class="im">import</span> GaussianProcessClassifier</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> imblearn.over_sampling <span class="im">import</span> SMOTE</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> imblearn.pipeline <span class="im">import</span> Pipeline</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.ensemble <span class="im">import</span> GradientBoostingClassifier, RandomForestClassifier</span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.linear_model <span class="im">import</span> LogisticRegression</span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split</span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> accuracy_score, f1_score</span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> fbeta_score, make_scorer</span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> GridSearchCV, RandomizedSearchCV</span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> RandomizedSearchCV</span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sklearn.model_selection</span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> yellowbrick.cluster.elbow <span class="im">import</span> kelbow_visualizer</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="read-in-the-dataset" class="level3">
<h3 class="anchored" data-anchor-id="read-in-the-dataset">Read in the dataset</h3>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># read in the json files</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>portfolio <span class="op">=</span> pd.read_json(<span class="st">'./data/portfolio.json'</span>, orient<span class="op">=</span><span class="st">'records'</span>, lines<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>profile <span class="op">=</span> pd.read_json(<span class="st">'./data/profile.json'</span>, orient<span class="op">=</span><span class="st">'records'</span>, lines<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>transcript <span class="op">=</span> pd.read_json(<span class="st">'./data/transcript.json'</span>, orient<span class="op">=</span><span class="st">'records'</span>, lines<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><a id="clean"> </a> ## 2. Data Assesment and cleaning</p>
</section>
<section id="portfolio-data" class="level3">
<h3 class="anchored" data-anchor-id="portfolio-data">Portfolio data</h3>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>portfolio.head()[:<span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>reward</th>
      <th>channels</th>
      <th>difficulty</th>
      <th>duration</th>
      <th>offer_type</th>
      <th>id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>10</td>
      <td>[email, mobile, social]</td>
      <td>10</td>
      <td>7</td>
      <td>bogo</td>
      <td>ae264e3637204a6fb9bb56bc8210ddfd</td>
    </tr>
    <tr>
      <th>1</th>
      <td>10</td>
      <td>[web, email, mobile, social]</td>
      <td>10</td>
      <td>5</td>
      <td>bogo</td>
      <td>4d5c57ea9a6940dd891ad53e9dbe8da0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0</td>
      <td>[web, email, mobile]</td>
      <td>0</td>
      <td>4</td>
      <td>informational</td>
      <td>3f207df678b143eea3cee63160fa8bed</td>
    </tr>
    <tr>
      <th>3</th>
      <td>5</td>
      <td>[web, email, mobile]</td>
      <td>5</td>
      <td>7</td>
      <td>bogo</td>
      <td>9b98b8c7a33c4b65b9aebfe6a799e6d9</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>[web, email]</td>
      <td>20</td>
      <td>10</td>
      <td>discount</td>
      <td>0b1e1539f2cc45b7b9fa7c272da2e1d7</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<section id="rename-the-columns-to-meaningful-names" class="level4">
<h4 class="anchored" data-anchor-id="rename-the-columns-to-meaningful-names">Rename the columns to meaningful names</h4>
<div class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">#rename the column to meaningful names</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>portfolio.rename(columns<span class="op">=</span>{<span class="st">'id'</span>:<span class="st">'offer_id'</span>}, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>portfolio.rename(columns<span class="op">=</span>{<span class="st">'duration'</span>: <span class="st">'offer_duration_days'</span>}, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>portfolio.rename(columns<span class="op">=</span>{<span class="st">'difficulty'</span>: <span class="st">'spent_required'</span>}, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>portfolio.rename(columns<span class="op">=</span>{<span class="st">'reward'</span>: <span class="st">'possible_reward'</span>}, inplace<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Check for null values</p>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">#check for null values</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>portfolio.isnull().<span class="bu">sum</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="5">
<pre><code>possible_reward        0
channels               0
spent_required         0
offer_duration_days    0
offer_type             0
offer_id               0
dtype: int64</code></pre>
</div>
</div>
<p>There are no missing values.</p>
</section>
<section id="extract-data-from-the-channels-column" class="level4">
<h4 class="anchored" data-anchor-id="extract-data-from-the-channels-column">Extract data from the channels column</h4>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create dummy variables for channels</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>portfolio_clean <span class="op">=</span> portfolio.copy() </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a> <span class="co"># Create dummy columns for the channels column</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>d_chann <span class="op">=</span> pd.get_dummies(portfolio_clean.channels.<span class="bu">apply</span>(pd.Series).stack(),</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>                             prefix<span class="op">=</span><span class="st">"channel"</span>).<span class="bu">sum</span>(level<span class="op">=</span><span class="dv">0</span>)   </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>portfolio_clean <span class="op">=</span> pd.concat([portfolio_clean, d_chann], axis<span class="op">=</span><span class="dv">1</span>, sort<span class="op">=</span><span class="va">False</span>)  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>portfolio_clean.drop(columns<span class="op">=</span><span class="st">'channels'</span>, inplace<span class="op">=</span><span class="va">True</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>portfolio_clean</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="10">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>possible_reward</th>
      <th>spent_required</th>
      <th>offer_duration_days</th>
      <th>offer_type</th>
      <th>offer_id</th>
      <th>channel_email</th>
      <th>channel_mobile</th>
      <th>channel_social</th>
      <th>channel_web</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>10</td>
      <td>10</td>
      <td>7</td>
      <td>bogo</td>
      <td>ae264e3637204a6fb9bb56bc8210ddfd</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>10</td>
      <td>10</td>
      <td>5</td>
      <td>bogo</td>
      <td>4d5c57ea9a6940dd891ad53e9dbe8da0</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0</td>
      <td>0</td>
      <td>4</td>
      <td>informational</td>
      <td>3f207df678b143eea3cee63160fa8bed</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>3</th>
      <td>5</td>
      <td>5</td>
      <td>7</td>
      <td>bogo</td>
      <td>9b98b8c7a33c4b65b9aebfe6a799e6d9</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>20</td>
      <td>10</td>
      <td>discount</td>
      <td>0b1e1539f2cc45b7b9fa7c272da2e1d7</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>5</th>
      <td>3</td>
      <td>7</td>
      <td>7</td>
      <td>discount</td>
      <td>2298d6c36e964ae4a3e7e9706d1fb8c2</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <th>6</th>
      <td>2</td>
      <td>10</td>
      <td>10</td>
      <td>discount</td>
      <td>fafdcd668e3743c1bb461111dcafc2a4</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <th>7</th>
      <td>0</td>
      <td>0</td>
      <td>3</td>
      <td>informational</td>
      <td>5a8bc65990b245e5a138643cd4eb9837</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>8</th>
      <td>5</td>
      <td>5</td>
      <td>5</td>
      <td>bogo</td>
      <td>f19421c1d4aa40978ebb69ca19b0e20d</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <th>9</th>
      <td>2</td>
      <td>10</td>
      <td>7</td>
      <td>discount</td>
      <td>2906b810c7d4411798c6938adc9daaa5</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<p>We will use the data for modelling, so we save a copy of the portfolio dataframe here</p>
<div class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>portfolio_for_modelling<span class="op">=</span>portfolio_clean.copy()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>There are 10 offers distinguished by offer_ids, in 3 categories bogo, discount and informational</p>
<div class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>portfolio_clean[[<span class="st">'offer_type'</span>,<span class="st">'offer_id'</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="12">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>offer_type</th>
      <th>offer_id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>bogo</td>
      <td>ae264e3637204a6fb9bb56bc8210ddfd</td>
    </tr>
    <tr>
      <th>1</th>
      <td>bogo</td>
      <td>4d5c57ea9a6940dd891ad53e9dbe8da0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>informational</td>
      <td>3f207df678b143eea3cee63160fa8bed</td>
    </tr>
    <tr>
      <th>3</th>
      <td>bogo</td>
      <td>9b98b8c7a33c4b65b9aebfe6a799e6d9</td>
    </tr>
    <tr>
      <th>4</th>
      <td>discount</td>
      <td>0b1e1539f2cc45b7b9fa7c272da2e1d7</td>
    </tr>
    <tr>
      <th>5</th>
      <td>discount</td>
      <td>2298d6c36e964ae4a3e7e9706d1fb8c2</td>
    </tr>
    <tr>
      <th>6</th>
      <td>discount</td>
      <td>fafdcd668e3743c1bb461111dcafc2a4</td>
    </tr>
    <tr>
      <th>7</th>
      <td>informational</td>
      <td>5a8bc65990b245e5a138643cd4eb9837</td>
    </tr>
    <tr>
      <th>8</th>
      <td>bogo</td>
      <td>f19421c1d4aa40978ebb69ca19b0e20d</td>
    </tr>
    <tr>
      <th>9</th>
      <td>discount</td>
      <td>2906b810c7d4411798c6938adc9daaa5</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<p>We will also merge some dataframe for some analysis, so we save this data here</p>
<div class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>portfolio_fr_df2<span class="op">=</span>portfolio_clean.copy()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Encode the offer types</p>
<div class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>portfolio_clean.loc[portfolio_clean[<span class="st">'offer_type'</span>] <span class="op">==</span> <span class="st">'bogo'</span>, <span class="st">'offer_type'</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>portfolio_clean.loc[portfolio_clean[<span class="st">'offer_type'</span>] <span class="op">==</span> <span class="st">'discount'</span>, <span class="st">'offer_type'</span>] <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>portfolio_clean.loc[portfolio_clean[<span class="st">'offer_type'</span>] <span class="op">==</span> <span class="st">'informational'</span>, <span class="st">'offer_type'</span>] <span class="op">=</span> <span class="dv">3</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="profile-data" class="level3">
<h3 class="anchored" data-anchor-id="profile-data">Profile data</h3>
<div class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>profile <span class="op">=</span> pd.read_json(<span class="st">'./profile.json'</span>, orient<span class="op">=</span><span class="st">'records'</span>, lines<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>profile[:<span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="16">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>gender</th>
      <th>age</th>
      <th>id</th>
      <th>became_member_on</th>
      <th>income</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>None</td>
      <td>118</td>
      <td>68be06ca386d4c31939f3a4f0e3dd783</td>
      <td>20170212</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1</th>
      <td>F</td>
      <td>55</td>
      <td>0610b486422d4921ae7d2bf64640c50b</td>
      <td>20170715</td>
      <td>112000.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>None</td>
      <td>118</td>
      <td>38fe809add3b4fcf9315a9694bb96ff5</td>
      <td>20180712</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3</th>
      <td>F</td>
      <td>75</td>
      <td>78afa995795e4d85b5d9ceeca43f5fef</td>
      <td>20170509</td>
      <td>100000.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>None</td>
      <td>118</td>
      <td>a03223e636434f42ac4c3df47e8bac43</td>
      <td>20170804</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>profile.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="17">
<pre><code>(17000, 5)</code></pre>
</div>
</div>
<p>Check for null values</p>
<div class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>profile.isnull().<span class="bu">sum</span>()[profile.isnull().<span class="bu">sum</span>()<span class="op">&gt;</span><span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="18">
<pre><code>gender    2175
income    2175
dtype: int64</code></pre>
</div>
</div>
<p>Display the customer profile distribution for age,income and gender</p>
<div class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_hist(data, title, xlabel, ylabel, bins<span class="op">=</span><span class="dv">20</span>):</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Plot a histogram with values passed as input."""</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>    plt.hist(data, bins<span class="op">=</span>bins)</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    plt.title(title)</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(xlabel)</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(ylabel)</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>    plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> display_customer_profile():</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">'''Display customer profile with histograms'''</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Display Histogram of Customer Age</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    plot_hist(data<span class="op">=</span>profile[<span class="st">'age'</span>], title<span class="op">=</span><span class="st">'Customer Age Distrbution'</span>, xlabel<span class="op">=</span><span class="st">'Age'</span>, ylabel<span class="op">=</span><span class="st">'Count'</span>, bins<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Display Histogram of Customer Income</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>    plot_hist(data<span class="op">=</span>profile[<span class="st">'income'</span>], title<span class="op">=</span><span class="st">'Customer Income Distrbution'</span>, xlabel<span class="op">=</span><span class="st">'Income'</span>, ylabel<span class="op">=</span><span class="st">'Count'</span>, bins<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>    sns.countplot(profile[<span class="st">'gender'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>display_customer_profile()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2021-07-14-Starbucks-Optimising-Customer-Segmentation-with-Random-Forest-and-Gradient-Boosting_files/figure-html/cell-22-output-1.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="2021-07-14-Starbucks-Optimising-Customer-Segmentation-with-Random-Forest-and-Gradient-Boosting_files/figure-html/cell-22-output-2.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="2021-07-14-Starbucks-Optimising-Customer-Segmentation-with-Random-Forest-and-Gradient-Boosting_files/figure-html/cell-22-output-3.png" class="img-fluid"></p>
</div>
</div>
<p>The customer age distribution has some outliers, ages 100-118. It is improbable that starbucks would have app users this age. Income is left skewed, most people earn between 40k and 80k. Gender distribution has males highest followed by females and a few O</p>
<div class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>profile[profile.age<span class="op">==</span><span class="dv">118</span>].count()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="22">
<pre><code>gender                 0
age                 2175
id                  2175
became_member_on    2175
income                 0
dtype: int64</code></pre>
</div>
</div>
<div class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>profile<span class="op">=</span>profile.drop(profile[profile[<span class="st">'gender'</span>].isnull()].index)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>There are 2175 customers with age 118. Obviously this cant be true. But given that this data was taken in 2018, 2018-118 is 1900 which was probably the default date on the app. 2175 is 12% of our data, dropping these from our analysis and modelling would greatly affect the model since these users made transactions and participated in the experiment.</p>
<p>Replace values with age 118 with nan values</p>
<div class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>profile.age.replace(<span class="dv">118</span>, np.nan, inplace<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Check the datatypes in the profiles data</p>
<div class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>profile.dtypes</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="25">
<pre><code>gender               object
age                   int64
id                   object
became_member_on      int64
income              float64
dtype: object</code></pre>
</div>
</div>
<p>Change the became_member_on from int to datetime</p>
<div class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>profile[<span class="st">'became_member_on'</span>] <span class="op">=</span> pd.to_datetime(profile[<span class="st">'became_member_on'</span>], <span class="bu">format</span><span class="op">=</span><span class="st">'%Y%m</span><span class="sc">%d</span><span class="st">'</span>)</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>profile[<span class="st">'year'</span>] <span class="op">=</span> profile[<span class="st">'became_member_on'</span>].dt.year</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>profile[<span class="st">'quarter'</span>] <span class="op">=</span> profile[<span class="st">'became_member_on'</span>].dt.quarter</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Rename column name into meaningful name</p>
<div class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>profile.rename(columns<span class="op">=</span>{<span class="st">'id'</span>: <span class="st">'customer_id'</span>}, inplace<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>profile[:<span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="28">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>gender</th>
      <th>age</th>
      <th>customer_id</th>
      <th>became_member_on</th>
      <th>income</th>
      <th>year</th>
      <th>quarter</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>F</td>
      <td>55</td>
      <td>0610b486422d4921ae7d2bf64640c50b</td>
      <td>2017-07-15</td>
      <td>112000.0</td>
      <td>2017</td>
      <td>3</td>
    </tr>
    <tr>
      <th>3</th>
      <td>F</td>
      <td>75</td>
      <td>78afa995795e4d85b5d9ceeca43f5fef</td>
      <td>2017-05-09</td>
      <td>100000.0</td>
      <td>2017</td>
      <td>2</td>
    </tr>
    <tr>
      <th>5</th>
      <td>M</td>
      <td>68</td>
      <td>e2127556f4f64592b11af22de27a7932</td>
      <td>2018-04-26</td>
      <td>70000.0</td>
      <td>2018</td>
      <td>2</td>
    </tr>
    <tr>
      <th>8</th>
      <td>M</td>
      <td>65</td>
      <td>389bc3fa690240e798340f5a15918d5c</td>
      <td>2018-02-09</td>
      <td>53000.0</td>
      <td>2018</td>
      <td>1</td>
    </tr>
    <tr>
      <th>12</th>
      <td>M</td>
      <td>58</td>
      <td>2eeac8d8feae4a8cad5a6af0499a211d</td>
      <td>2017-11-11</td>
      <td>51000.0</td>
      <td>2017</td>
      <td>4</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<section id="create-new-column-days_of_membership" class="level4">
<h4 class="anchored" data-anchor-id="create-new-column-days_of_membership">Create new column “days_of_membership”</h4>
<p>Create a new column days of membership to calculate how long someone has been a member. Maybe that will have an effect as well into how they spend and how they respond to offers. To do this, we need to know when this data was collected. This we dont have bu we can make an assumption. The last date on this dataset will be used and this is - October 18, 2018.</p>
<div class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> datetime</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>data_collection_date <span class="op">=</span> <span class="st">"2018-10-18"</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>profile[<span class="st">'days_of_membership'</span>] <span class="op">=</span> datetime.datetime.strptime(data_collection_date, <span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st">'</span>) <span class="op">-</span> profile[<span class="st">'became_member_on'</span>]</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>profile[<span class="st">'days_of_membership'</span>] <span class="op">=</span> profile[<span class="st">'days_of_membership'</span>].dt.days.astype(<span class="st">'int16'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>profile[:<span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="30">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>gender</th>
      <th>age</th>
      <th>customer_id</th>
      <th>became_member_on</th>
      <th>income</th>
      <th>year</th>
      <th>quarter</th>
      <th>days_of_membership</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>F</td>
      <td>55</td>
      <td>0610b486422d4921ae7d2bf64640c50b</td>
      <td>2017-07-15</td>
      <td>112000.0</td>
      <td>2017</td>
      <td>3</td>
      <td>460</td>
    </tr>
    <tr>
      <th>3</th>
      <td>F</td>
      <td>75</td>
      <td>78afa995795e4d85b5d9ceeca43f5fef</td>
      <td>2017-05-09</td>
      <td>100000.0</td>
      <td>2017</td>
      <td>2</td>
      <td>527</td>
    </tr>
    <tr>
      <th>5</th>
      <td>M</td>
      <td>68</td>
      <td>e2127556f4f64592b11af22de27a7932</td>
      <td>2018-04-26</td>
      <td>70000.0</td>
      <td>2018</td>
      <td>2</td>
      <td>175</td>
    </tr>
    <tr>
      <th>8</th>
      <td>M</td>
      <td>65</td>
      <td>389bc3fa690240e798340f5a15918d5c</td>
      <td>2018-02-09</td>
      <td>53000.0</td>
      <td>2018</td>
      <td>1</td>
      <td>251</td>
    </tr>
    <tr>
      <th>12</th>
      <td>M</td>
      <td>58</td>
      <td>2eeac8d8feae4a8cad5a6af0499a211d</td>
      <td>2017-11-11</td>
      <td>51000.0</td>
      <td>2017</td>
      <td>4</td>
      <td>341</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<p>Save the profile data for modelling later</p>
<div class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>profile_for_modelling<span class="op">=</span>profile.copy()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="create-an-age-range-column" class="level4">
<h4 class="anchored" data-anchor-id="create-an-age-range-column">Create an age range column</h4>
<p>From the age distribution we saw above, we can group into these categories</p>
<div class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>profile[<span class="st">'age'</span>].hist()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="32">
<pre><code>&lt;AxesSubplot:&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="2021-07-14-Starbucks-Optimising-Customer-Segmentation-with-Random-Forest-and-Gradient-Boosting_files/figure-html/cell-33-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>Create bins for teen, young adult, adult and elderly. 17-22 teen, 22-35 young adult, 35-60 adult, 60-103 elderly</p>
<div class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>profile[<span class="st">'age_group'</span>]<span class="op">=</span>pd.cut(profile[<span class="st">'age'</span>],bins<span class="op">=</span>[<span class="dv">17</span>,<span class="dv">22</span>,<span class="dv">35</span>,<span class="dv">60</span>,<span class="dv">103</span>],labels<span class="op">=</span>[<span class="st">'teenager'</span>,<span class="st">'young-adult'</span>,<span class="st">'adult'</span>,<span class="st">'elderly'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>x<span class="op">=</span>profile[<span class="st">'age'</span>].unique()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Create a list of ages as categories so that we encode them</p>
<div class="cell" data-execution_count="35">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>x<span class="op">=</span>profile[<span class="st">'age_group'</span>].astype(<span class="st">'category'</span>).cat.categories.tolist()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Encode age group as 1-4 to represent the age groups</p>
<div class="cell" data-execution_count="36">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>y<span class="op">=</span>{<span class="st">"age_group"</span>: {k:v <span class="cf">for</span> k,v <span class="kw">in</span> <span class="bu">zip</span>(x,<span class="bu">list</span>(<span class="bu">range</span>(<span class="dv">1</span>,<span class="bu">len</span>(x)<span class="op">+</span><span class="dv">1</span>)))}}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Replace the categories with encoded values</p>
<div class="cell" data-execution_count="37">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>profile.replace(y,inplace<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Drop the age column</p>
<div class="cell" data-execution_count="38">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>profile.drop(columns<span class="op">=</span><span class="st">"age"</span>,inplace<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="create-a-new-income-range-column" class="level4">
<h4 class="anchored" data-anchor-id="create-a-new-income-range-column">Create a new income range column</h4>
<p>Find the income distribution to come up with bins</p>
<div class="cell" data-execution_count="39">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>profile[<span class="st">'income'</span>].describe()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="39">
<pre><code>count     14825.000000
mean      65404.991568
std       21598.299410
min       30000.000000
25%       49000.000000
50%       64000.000000
75%       80000.000000
max      120000.000000
Name: income, dtype: float64</code></pre>
</div>
</div>
<p>From the distribution we see that the min is 30k and the max is 120k, the average is 65k with a standard deviation of 20k</p>
<p>Create new column income range</p>
<div class="cell" data-execution_count="40">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>profile[<span class="st">'income_range'</span>]<span class="op">=</span>pd.cut(profile[<span class="st">'income'</span>],bins<span class="op">=</span>[<span class="dv">0</span>,<span class="dv">30000</span>,<span class="dv">50001</span>,<span class="dv">70001</span>,<span class="dv">90001</span>,<span class="dv">120001</span>],labels<span class="op">=</span>[<span class="st">'low'</span>,<span class="st">'low_to_mid'</span>,<span class="st">'mid'</span>,<span class="st">'mid_to_high'</span>,<span class="st">'high'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="41">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>profile[<span class="st">'income_range'</span>].value_counts()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="41">
<pre><code>mid            5006
low_to_mid     3946
mid_to_high    3591
high           2194
low              88
Name: income_range, dtype: int64</code></pre>
</div>
</div>
<div class="cell" data-execution_count="42">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>profile[:<span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="42">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>gender</th>
      <th>customer_id</th>
      <th>became_member_on</th>
      <th>income</th>
      <th>year</th>
      <th>quarter</th>
      <th>days_of_membership</th>
      <th>age_group</th>
      <th>income_range</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>F</td>
      <td>0610b486422d4921ae7d2bf64640c50b</td>
      <td>2017-07-15</td>
      <td>112000.0</td>
      <td>2017</td>
      <td>3</td>
      <td>460</td>
      <td>3</td>
      <td>high</td>
    </tr>
    <tr>
      <th>3</th>
      <td>F</td>
      <td>78afa995795e4d85b5d9ceeca43f5fef</td>
      <td>2017-05-09</td>
      <td>100000.0</td>
      <td>2017</td>
      <td>2</td>
      <td>527</td>
      <td>4</td>
      <td>high</td>
    </tr>
    <tr>
      <th>5</th>
      <td>M</td>
      <td>e2127556f4f64592b11af22de27a7932</td>
      <td>2018-04-26</td>
      <td>70000.0</td>
      <td>2018</td>
      <td>2</td>
      <td>175</td>
      <td>4</td>
      <td>mid</td>
    </tr>
    <tr>
      <th>8</th>
      <td>M</td>
      <td>389bc3fa690240e798340f5a15918d5c</td>
      <td>2018-02-09</td>
      <td>53000.0</td>
      <td>2018</td>
      <td>1</td>
      <td>251</td>
      <td>4</td>
      <td>mid</td>
    </tr>
    <tr>
      <th>12</th>
      <td>M</td>
      <td>2eeac8d8feae4a8cad5a6af0499a211d</td>
      <td>2017-11-11</td>
      <td>51000.0</td>
      <td>2017</td>
      <td>4</td>
      <td>341</td>
      <td>3</td>
      <td>mid</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<p>Encode the income categories</p>
<div class="cell" data-execution_count="43">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>labels<span class="op">=</span>profile[<span class="st">'income_range'</span>].astype(<span class="st">'category'</span>).cat.categories.tolist()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="44">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>b<span class="op">=</span>{<span class="st">'income_range'</span>:{k:v <span class="cf">for</span> k,v <span class="kw">in</span> <span class="bu">zip</span>(labels,<span class="bu">list</span>(<span class="bu">range</span>(<span class="dv">1</span>,<span class="bu">len</span>(labels)<span class="op">+</span><span class="dv">1</span>)))}}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="45">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>profile.replace(b,inplace<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Drop the income column since we have the income range</p>
<div class="cell" data-execution_count="46">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>profile.drop(columns<span class="op">=</span><span class="st">"income"</span>,inplace<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="create-a-loyalty-column-based-on-membership" class="level4">
<h4 class="anchored" data-anchor-id="create-a-loyalty-column-based-on-membership">Create a loyalty column based on membership</h4>
<p>We also want to be able to categorise members as new, regular and or loyal, to aid our analysis</p>
<p>Let’s check days of membership distribution</p>
<div class="cell" data-execution_count="47">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>profile[<span class="st">'days_of_membership'</span>].describe()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="47">
<pre><code>count    14825.000000
mean       606.478988
std        419.205158
min         84.000000
25%        292.000000
50%        442.000000
75%        881.000000
max       1907.000000
Name: days_of_membership, dtype: float64</code></pre>
</div>
</div>
<div class="cell" data-execution_count="48">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>profile[<span class="st">'days_of_membership'</span>].hist()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="48">
<pre><code>&lt;AxesSubplot:&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="2021-07-14-Starbucks-Optimising-Customer-Segmentation-with-Random-Forest-and-Gradient-Boosting_files/figure-html/cell-49-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>Create bins for the different member types as new, regular and loyal for days of membership between 85 (the minimum) and 1908 (the maximum)</p>
<div class="cell" data-execution_count="49">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>profile[<span class="st">'member_type'</span>]<span class="op">=</span>pd.cut(profile[<span class="st">'days_of_membership'</span>],bins<span class="op">=</span>[<span class="dv">84</span>,<span class="dv">650</span>,<span class="dv">1200</span>,<span class="dv">1908</span>],labels<span class="op">=</span>[<span class="st">'new'</span>,<span class="st">'regular'</span>,<span class="st">'loyal'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="50">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>profile[<span class="st">'member_type'</span>].value_counts()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="50">
<pre><code>new        9215
regular    4293
loyal      1296
Name: member_type, dtype: int64</code></pre>
</div>
</div>
<p>Encode the member types as categorical variables</p>
<div class="cell" data-execution_count="51">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>x<span class="op">=</span>profile[<span class="st">'member_type'</span>].astype(<span class="st">'category'</span>).cat.categories.tolist()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="52">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>y<span class="op">=</span>{<span class="st">'member_type'</span>:{k:v <span class="cf">for</span> k,v <span class="kw">in</span> <span class="bu">zip</span>(x,<span class="bu">list</span>(<span class="bu">range</span>(<span class="dv">1</span>,<span class="bu">len</span>(x)<span class="op">+</span><span class="dv">1</span>)))}}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="53">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>profile.replace(y,inplace<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="54">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>profile[:<span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="54">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>gender</th>
      <th>customer_id</th>
      <th>became_member_on</th>
      <th>year</th>
      <th>quarter</th>
      <th>days_of_membership</th>
      <th>age_group</th>
      <th>income_range</th>
      <th>member_type</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>F</td>
      <td>0610b486422d4921ae7d2bf64640c50b</td>
      <td>2017-07-15</td>
      <td>2017</td>
      <td>3</td>
      <td>460</td>
      <td>3</td>
      <td>5</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>F</td>
      <td>78afa995795e4d85b5d9ceeca43f5fef</td>
      <td>2017-05-09</td>
      <td>2017</td>
      <td>2</td>
      <td>527</td>
      <td>4</td>
      <td>5</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>5</th>
      <td>M</td>
      <td>e2127556f4f64592b11af22de27a7932</td>
      <td>2018-04-26</td>
      <td>2018</td>
      <td>2</td>
      <td>175</td>
      <td>4</td>
      <td>3</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>8</th>
      <td>M</td>
      <td>389bc3fa690240e798340f5a15918d5c</td>
      <td>2018-02-09</td>
      <td>2018</td>
      <td>1</td>
      <td>251</td>
      <td>4</td>
      <td>3</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>12</th>
      <td>M</td>
      <td>2eeac8d8feae4a8cad5a6af0499a211d</td>
      <td>2017-11-11</td>
      <td>2017</td>
      <td>4</td>
      <td>341</td>
      <td>3</td>
      <td>3</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<p>Drop the days of membership and when customer became a member since we membership type</p>
<div class="cell" data-execution_count="55">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>profile.drop(columns<span class="op">=</span>[<span class="st">'days_of_membership'</span>,<span class="st">'became_member_on'</span>],inplace<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="56">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>profile[:<span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="56">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>gender</th>
      <th>customer_id</th>
      <th>year</th>
      <th>quarter</th>
      <th>age_group</th>
      <th>income_range</th>
      <th>member_type</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>F</td>
      <td>0610b486422d4921ae7d2bf64640c50b</td>
      <td>2017</td>
      <td>3</td>
      <td>3</td>
      <td>5</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>F</td>
      <td>78afa995795e4d85b5d9ceeca43f5fef</td>
      <td>2017</td>
      <td>2</td>
      <td>4</td>
      <td>5</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>5</th>
      <td>M</td>
      <td>e2127556f4f64592b11af22de27a7932</td>
      <td>2018</td>
      <td>2</td>
      <td>4</td>
      <td>3</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>8</th>
      <td>M</td>
      <td>389bc3fa690240e798340f5a15918d5c</td>
      <td>2018</td>
      <td>1</td>
      <td>4</td>
      <td>3</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>12</th>
      <td>M</td>
      <td>2eeac8d8feae4a8cad5a6af0499a211d</td>
      <td>2017</td>
      <td>4</td>
      <td>3</td>
      <td>3</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<p>Check for duplicates</p>
<div class="cell" data-execution_count="57">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>profile.duplicated().<span class="bu">sum</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="57">
<pre><code>0</code></pre>
</div>
</div>
<p>Save the profile data for exploratory analysis</p>
<div class="cell" data-execution_count="58">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>profile_fr_df2<span class="op">=</span>profile.copy()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="transcript-data" class="level3">
<h3 class="anchored" data-anchor-id="transcript-data">Transcript data</h3>
<div class="cell" data-execution_count="59">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>transcript[:<span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="59">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>person</th>
      <th>event</th>
      <th>value</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>78afa995795e4d85b5d9ceeca43f5fef</td>
      <td>offer received</td>
      <td>{'offer id': '9b98b8c7a33c4b65b9aebfe6a799e6d9'}</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>a03223e636434f42ac4c3df47e8bac43</td>
      <td>offer received</td>
      <td>{'offer id': '0b1e1539f2cc45b7b9fa7c272da2e1d7'}</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>e2127556f4f64592b11af22de27a7932</td>
      <td>offer received</td>
      <td>{'offer id': '2906b810c7d4411798c6938adc9daaa5'}</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>8ec6ce2a7e7949b1bf142def7d0e0586</td>
      <td>offer received</td>
      <td>{'offer id': 'fafdcd668e3743c1bb461111dcafc2a4'}</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>68617ca6246f4fbc85e91a2a49552598</td>
      <td>offer received</td>
      <td>{'offer id': '4d5c57ea9a6940dd891ad53e9dbe8da0'}</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="cell" data-execution_count="60">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>transcript[<span class="st">'event'</span>].value_counts()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="60">
<pre><code>transaction        138953
offer received      76277
offer viewed        57725
offer completed     33579
Name: event, dtype: int64</code></pre>
</div>
</div>
<div class="cell" data-execution_count="61">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>transcript.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="61">
<pre><code>(306534, 4)</code></pre>
</div>
</div>
<p>Split the value column into columns, this method takes time for a large dataset</p>
<div class="cell" data-execution_count="62">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>cleaned_transcript<span class="op">=</span>pd.concat([transcript.drop([<span class="st">'value'</span>], axis<span class="op">=</span><span class="dv">1</span>), transcript[<span class="st">'value'</span>].<span class="bu">apply</span>(pd.Series)], axis<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 2min 25s, sys: 2.52 s, total: 2min 28s
Wall time: 2min 30s</code></pre>
</div>
</div>
<div class="cell" data-execution_count="63">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>cleaned_transcript[:<span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="63">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>person</th>
      <th>event</th>
      <th>time</th>
      <th>offer id</th>
      <th>amount</th>
      <th>offer_id</th>
      <th>reward</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>78afa995795e4d85b5d9ceeca43f5fef</td>
      <td>offer received</td>
      <td>0</td>
      <td>9b98b8c7a33c4b65b9aebfe6a799e6d9</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1</th>
      <td>a03223e636434f42ac4c3df47e8bac43</td>
      <td>offer received</td>
      <td>0</td>
      <td>0b1e1539f2cc45b7b9fa7c272da2e1d7</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2</th>
      <td>e2127556f4f64592b11af22de27a7932</td>
      <td>offer received</td>
      <td>0</td>
      <td>2906b810c7d4411798c6938adc9daaa5</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3</th>
      <td>8ec6ce2a7e7949b1bf142def7d0e0586</td>
      <td>offer received</td>
      <td>0</td>
      <td>fafdcd668e3743c1bb461111dcafc2a4</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>4</th>
      <td>68617ca6246f4fbc85e91a2a49552598</td>
      <td>offer received</td>
      <td>0</td>
      <td>4d5c57ea9a6940dd891ad53e9dbe8da0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<p>We have two columns offer_id, Assign values of offer id column to offer_id column to remove duplicate columns</p>
<div class="cell" data-execution_count="64">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>cleaned_transcript[<span class="st">'offer_id'</span>] <span class="op">=</span> cleaned_transcript[<span class="st">'offer_id'</span>].fillna(cleaned_transcript[<span class="st">'offer id'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="65">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>cleaned_transcript.drop([<span class="st">'offer id'</span>], axis<span class="op">=</span><span class="dv">1</span>, inplace<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Rename the columns to something more meaningful</p>
<div class="cell" data-execution_count="66">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>cleaned_transcript.rename(columns<span class="op">=</span>{<span class="st">'person'</span>: <span class="st">'customer_id'</span>}, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>cleaned_transcript.rename(columns<span class="op">=</span>{<span class="st">'amount'</span>: <span class="st">'money_spent'</span>}, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>cleaned_transcript.rename(columns<span class="op">=</span>{<span class="st">'reward'</span>: <span class="st">'money_gained'</span>}, inplace<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Offer amount and reward with null values will be assigned as zeros</p>
<div class="cell" data-execution_count="67">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>cleaned_transcript[<span class="st">'money_spent'</span>] <span class="op">=</span> cleaned_transcript[<span class="st">'money_spent'</span>].replace(np.nan, <span class="dv">0</span>)</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>cleaned_transcript[<span class="st">'money_gained'</span>] <span class="op">=</span> cleaned_transcript[<span class="st">'money_gained'</span>].replace(np.nan, <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Change time column from hours to days</p>
<div class="cell" data-execution_count="68">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>cleaned_transcript[<span class="st">'time'</span>] <span class="op">=</span> cleaned_transcript[<span class="st">'time'</span>]<span class="op">/</span><span class="fl">24.0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="69">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>cleaned_transcript[:<span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="69">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>customer_id</th>
      <th>event</th>
      <th>time</th>
      <th>money_spent</th>
      <th>offer_id</th>
      <th>money_gained</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>78afa995795e4d85b5d9ceeca43f5fef</td>
      <td>offer received</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>9b98b8c7a33c4b65b9aebfe6a799e6d9</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>a03223e636434f42ac4c3df47e8bac43</td>
      <td>offer received</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0b1e1539f2cc45b7b9fa7c272da2e1d7</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>e2127556f4f64592b11af22de27a7932</td>
      <td>offer received</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>2906b810c7d4411798c6938adc9daaa5</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>8ec6ce2a7e7949b1bf142def7d0e0586</td>
      <td>offer received</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>fafdcd668e3743c1bb461111dcafc2a4</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>68617ca6246f4fbc85e91a2a49552598</td>
      <td>offer received</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>4d5c57ea9a6940dd891ad53e9dbe8da0</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<p>We only want to analyze the customers whose profile we have so we have to drop customers who have transaction data but do not have profile data.</p>
<div class="cell" data-execution_count="70">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Drop customers ids that not available in the profile dataset, because we know nothing about them</span></span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>cleaned_transcript <span class="op">=</span> cleaned_transcript[cleaned_transcript[<span class="st">'customer_id'</span>].isin(profile[<span class="st">'customer_id'</span>])]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>One-hot encode events</p>
<div class="cell" data-execution_count="71">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>transcript_dummies <span class="op">=</span> pd.get_dummies(cleaned_transcript.event)</span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>cleaned_transcript <span class="op">=</span> pd.concat([cleaned_transcript, transcript_dummies], axis<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Creating a copy for some exploratory analysis</p>
<div class="cell" data-execution_count="72">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>transcript_fr_df2<span class="op">=</span>cleaned_transcript.copy()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Taking a look at the events and time columns, it seems like events are ordered according to how much time and not according to whether the offer received, resulted in offer being completed/transaction done</p>
</section>
<section id="further-cleaning-on-transcript-transaction-data" class="level3">
<h3 class="anchored" data-anchor-id="further-cleaning-on-transcript-transaction-data">Further cleaning on transcript/ transaction data</h3>
<section id="combine-the-offer-completed-and-transanction-done-into-1-row" class="level4">
<h4 class="anchored" data-anchor-id="combine-the-offer-completed-and-transanction-done-into-1-row">Combine the offer completed and transanction done into 1 row</h4>
<p>We want to be able to know when an offer was completed the transaction was done, so we combine the rows for offer completed and transaction done into one row</p>
<div class="cell" data-execution_count="73">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Total rows: </span><span class="sc">{}</span><span class="st">"</span>.<span class="bu">format</span>(<span class="bu">len</span>(cleaned_transcript)))</span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a>rows_to_drop <span class="op">=</span> [] </span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-7"><a href="#cb88-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop over "offer completed" events:</span></span>
<span id="cb88-8"><a href="#cb88-8" aria-hidden="true" tabindex="-1"></a>c_df <span class="op">=</span> cleaned_transcript[cleaned_transcript.event <span class="op">==</span> <span class="st">"offer completed"</span>]</span>
<span id="cb88-9"><a href="#cb88-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Total "offer completed" rows: </span><span class="sc">{}</span><span class="st">'</span>.<span class="bu">format</span>(<span class="bu">len</span>(c_df)))</span>
<span id="cb88-10"><a href="#cb88-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-11"><a href="#cb88-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> c_index, row <span class="kw">in</span> c_df.iterrows():</span>
<span id="cb88-12"><a href="#cb88-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb88-13"><a href="#cb88-13" aria-hidden="true" tabindex="-1"></a>    t_index <span class="op">=</span> c_index<span class="op">-</span><span class="dv">1</span> <span class="co"># transaction row index</span></span>
<span id="cb88-14"><a href="#cb88-14" aria-hidden="true" tabindex="-1"></a>    cleaned_transcript.at[c_index, <span class="st">'money_spent'</span>] <span class="op">=</span> cleaned_transcript.at[t_index, <span class="st">'money_spent'</span>] <span class="co"># update "amount"</span></span>
<span id="cb88-15"><a href="#cb88-15" aria-hidden="true" tabindex="-1"></a>    cleaned_transcript.at[c_index, <span class="st">'transaction'</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb88-16"><a href="#cb88-16" aria-hidden="true" tabindex="-1"></a>    rows_to_drop.append(t_index) <span class="co"># we will drop the "transaction" row</span></span>
<span id="cb88-17"><a href="#cb88-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-18"><a href="#cb88-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-19"><a href="#cb88-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Rows to drop: </span><span class="sc">{}</span><span class="st">"</span>.<span class="bu">format</span>(<span class="bu">len</span>(rows_to_drop)))</span>
<span id="cb88-20"><a href="#cb88-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-21"><a href="#cb88-21" aria-hidden="true" tabindex="-1"></a>cleaned_transcript <span class="op">=</span> cleaned_transcript[<span class="op">~</span>cleaned_transcript.index.isin(rows_to_drop)] <span class="co"># faster alternative to dropping rows one by one inside the loop</span></span>
<span id="cb88-22"><a href="#cb88-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-23"><a href="#cb88-23" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Rows after job is finished: </span><span class="sc">{}</span><span class="st">"</span>.<span class="bu">format</span>(<span class="bu">len</span>(cleaned_transcript)))</span>
<span id="cb88-24"><a href="#cb88-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-25"><a href="#cb88-25" aria-hidden="true" tabindex="-1"></a>cleaned_transcript[cleaned_transcript.event <span class="op">==</span> <span class="st">"offer completed"</span>].sample(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Total rows: 272762
Total "offer completed" rows: 32444

Rows to drop: 32444
Rows after job is finished: 240318
CPU times: user 5.85 s, sys: 2.65 ms, total: 5.85 s
Wall time: 5.99 s</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="73">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>customer_id</th>
      <th>event</th>
      <th>time</th>
      <th>money_spent</th>
      <th>offer_id</th>
      <th>money_gained</th>
      <th>offer completed</th>
      <th>offer received</th>
      <th>offer viewed</th>
      <th>transaction</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>259403</th>
      <td>a206d7f1c7124bd0b16dd13e7932592e</td>
      <td>offer completed</td>
      <td>24.00</td>
      <td>11.20</td>
      <td>f19421c1d4aa40978ebb69ca19b0e20d</td>
      <td>5.0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>230473</th>
      <td>3f244f4dea654688ace14acb4f0257bb</td>
      <td>offer completed</td>
      <td>22.25</td>
      <td>3.63</td>
      <td>2298d6c36e964ae4a3e7e9706d1fb8c2</td>
      <td>3.0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>225697</th>
      <td>de035e26f1c34866984482cf5c2c3e36</td>
      <td>offer completed</td>
      <td>21.75</td>
      <td>18.81</td>
      <td>ae264e3637204a6fb9bb56bc8210ddfd</td>
      <td>10.0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
</section>
<section id="combine-offer-viewed-and-offer-completed" class="level4">
<h4 class="anchored" data-anchor-id="combine-offer-viewed-and-offer-completed">Combine offer viewed and offer completed</h4>
<p>We also want to know those who viewed and completed the offer and those who received and did not complete the offer</p>
<div class="cell" data-execution_count="74">
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a><span class="co">### TIME-CONSUMING CELL! DO NOT RE-RUN IT UNLESS NECESSARY. </span><span class="al">###</span></span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Total rows: </span><span class="sc">{}</span><span class="st">"</span>.<span class="bu">format</span>(<span class="bu">len</span>(cleaned_transcript)))</span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Total "offer viewed" rows: </span><span class="sc">{}</span><span class="st">'</span>.<span class="bu">format</span>(<span class="bu">len</span>(cleaned_transcript[cleaned_transcript.event <span class="op">==</span> <span class="st">"offer completed"</span>])))</span>
<span id="cb90-7"><a href="#cb90-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-8"><a href="#cb90-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-9"><a href="#cb90-9" aria-hidden="true" tabindex="-1"></a>rows_to_drop <span class="op">=</span> [] </span>
<span id="cb90-10"><a href="#cb90-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-11"><a href="#cb90-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop over "offer completed" events:</span></span>
<span id="cb90-12"><a href="#cb90-12" aria-hidden="true" tabindex="-1"></a>c_df <span class="op">=</span> cleaned_transcript[cleaned_transcript.event <span class="op">==</span> <span class="st">"offer completed"</span>]</span>
<span id="cb90-13"><a href="#cb90-13" aria-hidden="true" tabindex="-1"></a>num_rows <span class="op">=</span> <span class="bu">len</span>(c_df)</span>
<span id="cb90-14"><a href="#cb90-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-15"><a href="#cb90-15" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> c_index, row <span class="kw">in</span> c_df.iterrows():</span>
<span id="cb90-16"><a href="#cb90-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb90-17"><a href="#cb90-17" aria-hidden="true" tabindex="-1"></a>    person <span class="op">=</span> c_df.at[c_index, <span class="st">'customer_id'</span>] <span class="co"># save customer id</span></span>
<span id="cb90-18"><a href="#cb90-18" aria-hidden="true" tabindex="-1"></a>    offer <span class="op">=</span> c_df.at[c_index, <span class="st">'offer_id'</span>] <span class="co"># save offer id</span></span>
<span id="cb90-19"><a href="#cb90-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-20"><a href="#cb90-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if there is an "offer viewed" row before "offer completed":</span></span>
<span id="cb90-21"><a href="#cb90-21" aria-hidden="true" tabindex="-1"></a>    prev_rows <span class="op">=</span> cleaned_transcript[:c_index]</span>
<span id="cb90-22"><a href="#cb90-22" aria-hidden="true" tabindex="-1"></a>    idx_found <span class="op">=</span> prev_rows[(prev_rows.event <span class="op">==</span> <span class="st">"offer viewed"</span>)</span>
<span id="cb90-23"><a href="#cb90-23" aria-hidden="true" tabindex="-1"></a>                        <span class="op">&amp;</span> (prev_rows.customer_id <span class="op">==</span> person)</span>
<span id="cb90-24"><a href="#cb90-24" aria-hidden="true" tabindex="-1"></a>                        <span class="op">&amp;</span> (prev_rows.offer_id <span class="op">==</span> offer)].index.tolist()</span>
<span id="cb90-25"><a href="#cb90-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb90-26"><a href="#cb90-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(idx_found) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb90-27"><a href="#cb90-27" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb90-28"><a href="#cb90-28" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Updating row nr. "</span> <span class="op">+</span> <span class="bu">str</span>(c_index)</span>
<span id="cb90-29"><a href="#cb90-29" aria-hidden="true" tabindex="-1"></a>              <span class="op">+</span> <span class="st">" "</span><span class="op">*</span><span class="dv">100</span>, end<span class="op">=</span><span class="st">"</span><span class="ch">\r</span><span class="st">"</span>) <span class="co"># erase output and print on the same line</span></span>
<span id="cb90-30"><a href="#cb90-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-31"><a href="#cb90-31" aria-hidden="true" tabindex="-1"></a>        cleaned_transcript.at[c_index, <span class="st">'offer viewed'</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb90-32"><a href="#cb90-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> v_index <span class="kw">in</span> idx_found:</span>
<span id="cb90-33"><a href="#cb90-33" aria-hidden="true" tabindex="-1"></a>            rows_to_drop.append(v_index) <span class="co"># we will drop the "offer viewed" row</span></span>
<span id="cb90-34"><a href="#cb90-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-35"><a href="#cb90-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-36"><a href="#cb90-36" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Rows to drop: </span><span class="sc">{}</span><span class="st">"</span>.<span class="bu">format</span>(<span class="bu">len</span>(rows_to_drop)))</span>
<span id="cb90-37"><a href="#cb90-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-38"><a href="#cb90-38" aria-hidden="true" tabindex="-1"></a>cleaned_transcript <span class="op">=</span> cleaned_transcript[<span class="op">~</span>cleaned_transcript.index.isin(rows_to_drop)] <span class="co"># faster alternative to dropping rows one by one inside the loop</span></span>
<span id="cb90-39"><a href="#cb90-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-40"><a href="#cb90-40" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Rows after job is finished: </span><span class="sc">{}</span><span class="st">"</span>.<span class="bu">format</span>(<span class="bu">len</span>(cleaned_transcript)))</span>
<span id="cb90-41"><a href="#cb90-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-42"><a href="#cb90-42" aria-hidden="true" tabindex="-1"></a>cleaned_transcript[cleaned_transcript.event <span class="op">==</span> <span class="st">"offer completed"</span>].sample(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Total rows: 240318
Total "offer viewed" rows: 29581
Updating row nr. 306527                                                                                                    
Rows to drop: 29634
Rows after job is finished: 214604
CPU times: user 25min 35s, sys: 8.41 s, total: 25min 43s
Wall time: 25min 35s</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="74">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>customer_id</th>
      <th>event</th>
      <th>time</th>
      <th>money_spent</th>
      <th>offer_id</th>
      <th>money_gained</th>
      <th>offer completed</th>
      <th>offer received</th>
      <th>offer viewed</th>
      <th>transaction</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>124407</th>
      <td>89df998636e744a981d7c907e778bea7</td>
      <td>offer completed</td>
      <td>14.0</td>
      <td>10.97</td>
      <td>ae264e3637204a6fb9bb56bc8210ddfd</td>
      <td>10.0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <th>272854</th>
      <td>04fad15f96d446f483823ad08857e752</td>
      <td>offer completed</td>
      <td>25.0</td>
      <td>25.85</td>
      <td>2906b810c7d4411798c6938adc9daaa5</td>
      <td>2.0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>124865</th>
      <td>7ffb3da7ed254a35bea25b35d40c47b9</td>
      <td>offer completed</td>
      <td>14.0</td>
      <td>16.12</td>
      <td>2906b810c7d4411798c6938adc9daaa5</td>
      <td>2.0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<p>The above method takes time, so to ensure that we dont run it often unless we need to, we are going to save this checkpoint by saving this df to csv. So that we save it as a csv file</p>
<div class="cell" data-execution_count="75">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>cleaned_transcript[:<span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="75">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>customer_id</th>
      <th>event</th>
      <th>time</th>
      <th>money_spent</th>
      <th>offer_id</th>
      <th>money_gained</th>
      <th>offer completed</th>
      <th>offer received</th>
      <th>offer viewed</th>
      <th>transaction</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>78afa995795e4d85b5d9ceeca43f5fef</td>
      <td>offer received</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>9b98b8c7a33c4b65b9aebfe6a799e6d9</td>
      <td>0.0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>e2127556f4f64592b11af22de27a7932</td>
      <td>offer received</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>2906b810c7d4411798c6938adc9daaa5</td>
      <td>0.0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>5</th>
      <td>389bc3fa690240e798340f5a15918d5c</td>
      <td>offer received</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>f19421c1d4aa40978ebb69ca19b0e20d</td>
      <td>0.0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>7</th>
      <td>2eeac8d8feae4a8cad5a6af0499a211d</td>
      <td>offer received</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>3f207df678b143eea3cee63160fa8bed</td>
      <td>0.0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>8</th>
      <td>aa4862eba776480b8bb9c68455b8c2e1</td>
      <td>offer received</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0b1e1539f2cc45b7b9fa7c272da2e1d7</td>
      <td>0.0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<p>Rename the offer columns by putting a _ so that we can easily index them</p>
<div class="cell" data-execution_count="76">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>cleaned_transcript.rename(columns<span class="op">=</span> {<span class="st">'offer completed'</span>: <span class="st">'offer_completed'</span>}, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>cleaned_transcript.rename(columns<span class="op">=</span>{<span class="st">'offer received'</span>: <span class="st">'offer_received'</span>}, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a>cleaned_transcript.rename(columns<span class="op">=</span>{<span class="st">'offer viewed'</span>: <span class="st">'offer_viewed'</span>}, inplace<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>How many offers were viewed and completed</p>
<div class="cell" data-execution_count="77">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Total offers viewed and completed: </span><span class="sc">{}</span><span class="st">"</span>.<span class="bu">format</span>(<span class="bu">len</span>(cleaned_transcript[(cleaned_transcript.event <span class="op">==</span> <span class="st">"offer completed"</span>) </span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>                                                              <span class="op">&amp;</span> (cleaned_transcript.offer_viewed <span class="op">==</span> <span class="dv">1</span>)])))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Total offers viewed and completed: 24949</code></pre>
</div>
</div>
<p>How many offers were completed without being viewed</p>
<div class="cell" data-execution_count="78">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Total offers completed but NOT viewed: </span><span class="sc">{}</span><span class="st">"</span>.<span class="bu">format</span>(<span class="bu">len</span>(cleaned_transcript[(cleaned_transcript.event <span class="op">==</span> <span class="st">"offer completed"</span>) </span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>                                                                  <span class="op">&amp;</span> (cleaned_transcript.offer_viewed <span class="op">==</span> <span class="dv">0</span>)])))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Total offers completed but NOT viewed: 4632</code></pre>
</div>
</div>
</section>
<section id="make-new-event-category-for-offers-completed-by-accident-auto-completed" class="level4">
<h4 class="anchored" data-anchor-id="make-new-event-category-for-offers-completed-by-accident-auto-completed">Make new event category for offers completed by accident: “auto completed”</h4>
<p>There are customers who dont receive the offer but complete it and others who receive the offer, dont view it but complete it</p>
<div class="cell" data-execution_count="79">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> index, row <span class="kw">in</span> cleaned_transcript.loc[(cleaned_transcript.event <span class="op">==</span> <span class="st">"offer completed"</span>) <span class="op">&amp;</span> (cleaned_transcript.offer_viewed <span class="op">==</span> <span class="dv">0</span>)].iterrows(): </span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a>    cleaned_transcript.at[index, <span class="st">'event'</span>] <span class="op">=</span> <span class="st">"auto completed"</span></span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a>    cleaned_transcript.at[index, <span class="st">'offer_completed'</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb98-6"><a href="#cb98-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-7"><a href="#cb98-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Also add new numerical column:</span></span>
<span id="cb98-8"><a href="#cb98-8" aria-hidden="true" tabindex="-1"></a>cleaned_transcript[<span class="st">'auto_completed'</span>] <span class="op">=</span> np.where(cleaned_transcript[<span class="st">'event'</span>]<span class="op">==</span><span class="st">'auto completed'</span>, <span class="dv">1</span>, <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 783 ms, sys: 4.02 ms, total: 787 ms
Wall time: 1.02 s</code></pre>
</div>
</div>
<div class="cell" data-execution_count="80">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>cleaned_transcript[<span class="st">'auto_completed'</span>].value_counts()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="80">
<pre><code>0    209972
1      4632
Name: auto_completed, dtype: int64</code></pre>
</div>
</div>
<p>Only 2.2% of customers auto completed the offers</p>
<p>Check if the function worked, if function worked, it should return len 0</p>
<div class="cell" data-execution_count="81">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(cleaned_transcript[(cleaned_transcript.event <span class="op">==</span> <span class="st">"offer_completed"</span>) <span class="op">&amp;</span> (cleaned_transcript.offer_viewed <span class="op">==</span> <span class="dv">0</span>)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="81">
<pre><code>0</code></pre>
</div>
</div>
<p>Is it possible for a customer to receive the same offer multiple times? Lets pick an offer ID and customer ID and test this</p>
<div class="cell" data-execution_count="82">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>cleaned_transcript[(cleaned_transcript.customer_id <span class="op">==</span> <span class="st">"fffad4f4828548d1b5583907f2e9906b"</span>) <span class="op">&amp;</span> (cleaned_transcript.offer_id <span class="op">==</span> <span class="st">"f19421c1d4aa40978ebb69ca19b0e20d"</span>)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="82">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>customer_id</th>
      <th>event</th>
      <th>time</th>
      <th>money_spent</th>
      <th>offer_id</th>
      <th>money_gained</th>
      <th>offer_completed</th>
      <th>offer_received</th>
      <th>offer_viewed</th>
      <th>transaction</th>
      <th>auto_completed</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>184</th>
      <td>fffad4f4828548d1b5583907f2e9906b</td>
      <td>offer received</td>
      <td>0.0</td>
      <td>0.00</td>
      <td>f19421c1d4aa40978ebb69ca19b0e20d</td>
      <td>0.0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>26145</th>
      <td>fffad4f4828548d1b5583907f2e9906b</td>
      <td>offer completed</td>
      <td>1.5</td>
      <td>6.97</td>
      <td>f19421c1d4aa40978ebb69ca19b0e20d</td>
      <td>5.0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>150794</th>
      <td>fffad4f4828548d1b5583907f2e9906b</td>
      <td>offer received</td>
      <td>17.0</td>
      <td>0.00</td>
      <td>f19421c1d4aa40978ebb69ca19b0e20d</td>
      <td>0.0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>221937</th>
      <td>fffad4f4828548d1b5583907f2e9906b</td>
      <td>offer completed</td>
      <td>21.5</td>
      <td>12.18</td>
      <td>f19421c1d4aa40978ebb69ca19b0e20d</td>
      <td>5.0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<p>Apparently a customer can receive the same offer multiple times, so we should factor this in when doing our EDA</p>
<div class="cell" data-execution_count="84">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a>transcript_checkpoint<span class="op">=</span>pd.read_csv(<span class="st">'./transcript_checkpoint_file.csv'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="86">
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a>transcript_checkpoint</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="86">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>Unnamed: 0</th>
      <th>customer_id</th>
      <th>event</th>
      <th>time</th>
      <th>money_spent</th>
      <th>offer_id</th>
      <th>money_gained</th>
      <th>offer_completed</th>
      <th>offer_received</th>
      <th>offer_viewed</th>
      <th>transaction</th>
      <th>auto_completed</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>78afa995795e4d85b5d9ceeca43f5fef</td>
      <td>offer received</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>9b98b8c7a33c4b65b9aebfe6a799e6d9</td>
      <td>0.0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>e2127556f4f64592b11af22de27a7932</td>
      <td>offer received</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>2906b810c7d4411798c6938adc9daaa5</td>
      <td>0.0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>5</td>
      <td>389bc3fa690240e798340f5a15918d5c</td>
      <td>offer received</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>f19421c1d4aa40978ebb69ca19b0e20d</td>
      <td>0.0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>7</td>
      <td>2eeac8d8feae4a8cad5a6af0499a211d</td>
      <td>offer received</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>3f207df678b143eea3cee63160fa8bed</td>
      <td>0.0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>8</td>
      <td>aa4862eba776480b8bb9c68455b8c2e1</td>
      <td>offer received</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0b1e1539f2cc45b7b9fa7c272da2e1d7</td>
      <td>0.0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>214599</th>
      <td>306527</td>
      <td>24f56b5e1849462093931b164eb803b5</td>
      <td>offer completed</td>
      <td>29.75</td>
      <td>22.64</td>
      <td>fafdcd668e3743c1bb461111dcafc2a4</td>
      <td>2.0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>214600</th>
      <td>306529</td>
      <td>b3a1272bc9904337b331bf348c3e8c17</td>
      <td>transaction</td>
      <td>29.75</td>
      <td>1.59</td>
      <td>NaN</td>
      <td>0.0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>214601</th>
      <td>306530</td>
      <td>68213b08d99a4ae1b0dcb72aebd9aa35</td>
      <td>transaction</td>
      <td>29.75</td>
      <td>9.53</td>
      <td>NaN</td>
      <td>0.0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>214602</th>
      <td>306531</td>
      <td>a00058cf10334a308c68e7631c529907</td>
      <td>transaction</td>
      <td>29.75</td>
      <td>3.61</td>
      <td>NaN</td>
      <td>0.0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>214603</th>
      <td>306532</td>
      <td>76ddbd6576844afe811f1a3c0fbb5bec</td>
      <td>transaction</td>
      <td>29.75</td>
      <td>3.53</td>
      <td>NaN</td>
      <td>0.0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
<p>214604 rows × 12 columns</p>
</div>
</div>
</div>
<p><a id="eda"></a><a> ## 3. Exploratory Data Analysis</a></p><a>
<p>First we save the cleaned data from all the datasets for ease of access</p>
</a><div class="cell" data-execution_count="85"><a>
</a><div class="sourceCode cell-code" id="cb107"><a></a><pre class="sourceCode python code-with-copy"><a><code class="sourceCode python"><span id="cb107-1"></span></code></a><code class="sourceCode python"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a>profile.to_csv(<span class="st">'./clean_profile.csv'</span>)
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a>portfolio_clean.to_csv(<span class="st">'./clean_portfolio.csv'</span>)</span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a>cleaned_transcript.to_csv(<span class="st">'./updated_clean_transcript.csv'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="create-a-new-dataframe-for-some-demographic-analysis" class="level3">
<h3 class="anchored" data-anchor-id="create-a-new-dataframe-for-some-demographic-analysis">Create a new dataframe for some demographic analysis</h3>
<p>Build a dataframe with aggregated transaction, offer, and demographics data for customer behavior analysis. As we saw earlier, the same customer can receive the same offer multiple times, they can also receive other offers of the same type or of different types. We will build a new dataframe by: 1. Getting the offer type data per customer 2. Getting offer id data per customer 3. Building a dataframe by merging extracted variables, demographics, offers, and transaction data</p>
<div class="cell" data-execution_count="86">
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a>transcript_fr_df2[:<span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="86">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>customer_id</th>
      <th>event</th>
      <th>time</th>
      <th>money_spent</th>
      <th>offer_id</th>
      <th>money_gained</th>
      <th>offer completed</th>
      <th>offer received</th>
      <th>offer viewed</th>
      <th>transaction</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>78afa995795e4d85b5d9ceeca43f5fef</td>
      <td>offer received</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>9b98b8c7a33c4b65b9aebfe6a799e6d9</td>
      <td>0.0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>e2127556f4f64592b11af22de27a7932</td>
      <td>offer received</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>2906b810c7d4411798c6938adc9daaa5</td>
      <td>0.0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>5</th>
      <td>389bc3fa690240e798340f5a15918d5c</td>
      <td>offer received</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>f19421c1d4aa40978ebb69ca19b0e20d</td>
      <td>0.0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>7</th>
      <td>2eeac8d8feae4a8cad5a6af0499a211d</td>
      <td>offer received</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>3f207df678b143eea3cee63160fa8bed</td>
      <td>0.0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>8</th>
      <td>aa4862eba776480b8bb9c68455b8c2e1</td>
      <td>offer received</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0b1e1539f2cc45b7b9fa7c272da2e1d7</td>
      <td>0.0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="cell" data-execution_count="87">
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a>transcript_fr_df2.rename(columns<span class="op">=</span> {<span class="st">'offer completed'</span>: <span class="st">'offer_completed'</span>}, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a>transcript_fr_df2.rename(columns<span class="op">=</span>{<span class="st">'offer received'</span>: <span class="st">'offer_received'</span>}, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a>transcript_fr_df2.rename(columns<span class="op">=</span>{<span class="st">'offer viewed'</span>: <span class="st">'offer_viewed'</span>}, inplace<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="88">
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a>profile_fr_df2[:<span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="88">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>gender</th>
      <th>customer_id</th>
      <th>year</th>
      <th>quarter</th>
      <th>age_group</th>
      <th>income_range</th>
      <th>member_type</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>F</td>
      <td>0610b486422d4921ae7d2bf64640c50b</td>
      <td>2017</td>
      <td>3</td>
      <td>3</td>
      <td>5</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>F</td>
      <td>78afa995795e4d85b5d9ceeca43f5fef</td>
      <td>2017</td>
      <td>2</td>
      <td>4</td>
      <td>5</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>5</th>
      <td>M</td>
      <td>e2127556f4f64592b11af22de27a7932</td>
      <td>2018</td>
      <td>2</td>
      <td>4</td>
      <td>3</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>8</th>
      <td>M</td>
      <td>389bc3fa690240e798340f5a15918d5c</td>
      <td>2018</td>
      <td>1</td>
      <td>4</td>
      <td>3</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>12</th>
      <td>M</td>
      <td>2eeac8d8feae4a8cad5a6af0499a211d</td>
      <td>2017</td>
      <td>4</td>
      <td>3</td>
      <td>3</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="cell" data-execution_count="89">
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a>portfolio_fr_df2[:<span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="89">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>possible_reward</th>
      <th>spent_required</th>
      <th>offer_duration_days</th>
      <th>offer_type</th>
      <th>offer_id</th>
      <th>channel_email</th>
      <th>channel_mobile</th>
      <th>channel_social</th>
      <th>channel_web</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>10</td>
      <td>10</td>
      <td>7</td>
      <td>bogo</td>
      <td>ae264e3637204a6fb9bb56bc8210ddfd</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>10</td>
      <td>10</td>
      <td>5</td>
      <td>bogo</td>
      <td>4d5c57ea9a6940dd891ad53e9dbe8da0</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0</td>
      <td>0</td>
      <td>4</td>
      <td>informational</td>
      <td>3f207df678b143eea3cee63160fa8bed</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>3</th>
      <td>5</td>
      <td>5</td>
      <td>7</td>
      <td>bogo</td>
      <td>9b98b8c7a33c4b65b9aebfe6a799e6d9</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>20</td>
      <td>10</td>
      <td>discount</td>
      <td>0b1e1539f2cc45b7b9fa7c272da2e1d7</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<p>Merge the transcript, portfolio and profile data</p>
<div class="cell" data-execution_count="90">
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a>trans_prof <span class="op">=</span> pd.merge(transcript_fr_df2, profile_fr_df2, on<span class="op">=</span><span class="st">'customer_id'</span>, how<span class="op">=</span><span class="st">'left'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="91">
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a>df<span class="op">=</span>pd.merge(trans_prof, portfolio_fr_df2, on<span class="op">=</span><span class="st">'offer_id'</span>, how<span class="op">=</span><span class="st">'left'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="92">
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a>df[:<span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="92">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>customer_id</th>
      <th>event</th>
      <th>time</th>
      <th>money_spent</th>
      <th>offer_id</th>
      <th>money_gained</th>
      <th>offer_completed</th>
      <th>offer_received</th>
      <th>offer_viewed</th>
      <th>transaction</th>
      <th>...</th>
      <th>income_range</th>
      <th>member_type</th>
      <th>possible_reward</th>
      <th>spent_required</th>
      <th>offer_duration_days</th>
      <th>offer_type</th>
      <th>channel_email</th>
      <th>channel_mobile</th>
      <th>channel_social</th>
      <th>channel_web</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>78afa995795e4d85b5d9ceeca43f5fef</td>
      <td>offer received</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>9b98b8c7a33c4b65b9aebfe6a799e6d9</td>
      <td>0.0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>5</td>
      <td>1.0</td>
      <td>5.0</td>
      <td>5.0</td>
      <td>7.0</td>
      <td>bogo</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>e2127556f4f64592b11af22de27a7932</td>
      <td>offer received</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>2906b810c7d4411798c6938adc9daaa5</td>
      <td>0.0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>3</td>
      <td>1.0</td>
      <td>2.0</td>
      <td>10.0</td>
      <td>7.0</td>
      <td>discount</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>389bc3fa690240e798340f5a15918d5c</td>
      <td>offer received</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>f19421c1d4aa40978ebb69ca19b0e20d</td>
      <td>0.0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>3</td>
      <td>1.0</td>
      <td>5.0</td>
      <td>5.0</td>
      <td>5.0</td>
      <td>bogo</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2eeac8d8feae4a8cad5a6af0499a211d</td>
      <td>offer received</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>3f207df678b143eea3cee63160fa8bed</td>
      <td>0.0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>3</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>4.0</td>
      <td>informational</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>aa4862eba776480b8bb9c68455b8c2e1</td>
      <td>offer received</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0b1e1539f2cc45b7b9fa7c272da2e1d7</td>
      <td>0.0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>3</td>
      <td>1.0</td>
      <td>5.0</td>
      <td>20.0</td>
      <td>10.0</td>
      <td>discount</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 24 columns</p>
</div>
</div>
</div>
<p>There are 10 different offers that were rolled out to customers. Change the offer id to indicate the type of offer</p>
<div class="cell" data-execution_count="93">
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a>df.loc[df.offer_id <span class="op">==</span> <span class="st">"ae264e3637204a6fb9bb56bc8210ddfd"</span>, <span class="st">"offer_id"</span>] <span class="op">=</span> <span class="st">"bogo_1"</span></span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a>df.loc[df.offer_id <span class="op">==</span> <span class="st">"9b98b8c7a33c4b65b9aebfe6a799e6d9"</span>, <span class="st">"offer_id"</span>] <span class="op">=</span> <span class="st">"bogo_3"</span></span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a>df.loc[df.offer_id <span class="op">==</span> <span class="st">"2298d6c36e964ae4a3e7e9706d1fb8c2"</span>, <span class="st">"offer_id"</span>] <span class="op">=</span> <span class="st">"discount_2"</span></span>
<span id="cb115-4"><a href="#cb115-4" aria-hidden="true" tabindex="-1"></a>df.loc[df.offer_id <span class="op">==</span> <span class="st">"2906b810c7d4411798c6938adc9daaa5"</span>, <span class="st">"offer_id"</span>] <span class="op">=</span> <span class="st">"discount_4"</span></span>
<span id="cb115-5"><a href="#cb115-5" aria-hidden="true" tabindex="-1"></a>df.loc[df.offer_id <span class="op">==</span> <span class="st">"f19421c1d4aa40978ebb69ca19b0e20d"</span>, <span class="st">"offer_id"</span>] <span class="op">=</span> <span class="st">"bogo_2"</span></span>
<span id="cb115-6"><a href="#cb115-6" aria-hidden="true" tabindex="-1"></a>df.loc[df.offer_id <span class="op">==</span> <span class="st">"3f207df678b143eea3cee63160fa8bed"</span>, <span class="st">"offer_id"</span>] <span class="op">=</span> <span class="st">"info_1"</span></span>
<span id="cb115-7"><a href="#cb115-7" aria-hidden="true" tabindex="-1"></a>df.loc[df.offer_id <span class="op">==</span> <span class="st">"0b1e1539f2cc45b7b9fa7c272da2e1d7"</span>, <span class="st">"offer_id"</span>] <span class="op">=</span> <span class="st">"discount_1"</span></span>
<span id="cb115-8"><a href="#cb115-8" aria-hidden="true" tabindex="-1"></a>df.loc[df.offer_id <span class="op">==</span> <span class="st">"4d5c57ea9a6940dd891ad53e9dbe8da0"</span>, <span class="st">"offer_id"</span>] <span class="op">=</span> <span class="st">"bogo_4"</span></span>
<span id="cb115-9"><a href="#cb115-9" aria-hidden="true" tabindex="-1"></a>df.loc[df.offer_id <span class="op">==</span> <span class="st">"5a8bc65990b245e5a138643cd4eb9837"</span>, <span class="st">"offer_id"</span>] <span class="op">=</span> <span class="st">"info_2"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Save the merged and cleaned dataframe</p>
<div class="cell" data-execution_count="94">
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a>cleaned_df<span class="op">=</span>df.copy() <span class="co">#remember to change the name of the other merged df from df to not confuse things</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="get-customer-offer-receivedviewed-and-completed-info-per-customer-by-offer-type" class="level4">
<h4 class="anchored" data-anchor-id="get-customer-offer-receivedviewed-and-completed-info-per-customer-by-offer-type">Get Customer offer (received,viewed and completed) info per customer by offer type</h4>
<p>This function takes in the merged data and collects the offer data of whether an offer was received, viewed and completed, annd does this for each offer type that was sent to the customer</p>
<div class="cell" data-execution_count="95">
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> cust_offer_type(cleaned_df, offer_type<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">''' Get offer data (received, viewed and completed) per customer by offer type</span></span>
<span id="cb117-3"><a href="#cb117-3" aria-hidden="true" tabindex="-1"></a><span class="co">    INPUT:</span></span>
<span id="cb117-4"><a href="#cb117-4" aria-hidden="true" tabindex="-1"></a><span class="co">    cleaned_df - merged transactions, portfolio, and profile datasets</span></span>
<span id="cb117-5"><a href="#cb117-5" aria-hidden="true" tabindex="-1"></a><span class="co">    offer_type - bogo, discount, informational</span></span>
<span id="cb117-6"><a href="#cb117-6" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb117-7"><a href="#cb117-7" aria-hidden="true" tabindex="-1"></a><span class="co">    RETURNS:</span></span>
<span id="cb117-8"><a href="#cb117-8" aria-hidden="true" tabindex="-1"></a><span class="co">    offer_type_cust - offer type data (received, viewed and completed) per customer</span></span>
<span id="cb117-9"><a href="#cb117-9" aria-hidden="true" tabindex="-1"></a><span class="co">    '''</span></span>
<span id="cb117-10"><a href="#cb117-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define dict</span></span>
<span id="cb117-11"><a href="#cb117-11" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> <span class="bu">dict</span>()</span>
<span id="cb117-12"><a href="#cb117-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> e <span class="kw">in</span> [<span class="st">'received'</span>, <span class="st">'viewed'</span>, <span class="st">'completed'</span>]:  </span>
<span id="cb117-13"><a href="#cb117-13" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get 'completed' data for informational offers </span></span>
<span id="cb117-14"><a href="#cb117-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> offer_type <span class="op">==</span> <span class="st">'informational'</span> <span class="kw">and</span> e <span class="op">==</span> <span class="st">'completed'</span>:</span>
<span id="cb117-15"><a href="#cb117-15" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb117-16"><a href="#cb117-16" aria-hidden="true" tabindex="-1"></a>        flag <span class="op">=</span> (cleaned_df[<span class="st">'offer_</span><span class="sc">{}</span><span class="st">'</span>.<span class="bu">format</span>(e)] <span class="op">==</span> <span class="dv">1</span>)</span>
<span id="cb117-17"><a href="#cb117-17" aria-hidden="true" tabindex="-1"></a>        key <span class="op">=</span> e</span>
<span id="cb117-18"><a href="#cb117-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> offer_type:</span>
<span id="cb117-19"><a href="#cb117-19" aria-hidden="true" tabindex="-1"></a>            flag <span class="op">=</span> flag <span class="op">&amp;</span> (cleaned_df.offer_type <span class="op">==</span> offer_type)</span>
<span id="cb117-20"><a href="#cb117-20" aria-hidden="true" tabindex="-1"></a>            key <span class="op">=</span> <span class="st">'</span><span class="sc">{}</span><span class="st">_'</span>.<span class="bu">format</span>(offer_type) <span class="op">+</span> key</span>
<span id="cb117-21"><a href="#cb117-21" aria-hidden="true" tabindex="-1"></a>        data[key] <span class="op">=</span> cleaned_df[flag].groupby(<span class="st">'customer_id'</span>).offer_id.count()</span>
<span id="cb117-22"><a href="#cb117-22" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get 'reward' data for informational offers </span></span>
<span id="cb117-23"><a href="#cb117-23" aria-hidden="true" tabindex="-1"></a>        flag <span class="op">=</span> (cleaned_df.offer_completed <span class="op">==</span> <span class="dv">1</span>)</span>
<span id="cb117-24"><a href="#cb117-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> offer_type <span class="op">!=</span> <span class="st">'informational'</span>:</span>
<span id="cb117-25"><a href="#cb117-25" aria-hidden="true" tabindex="-1"></a>            key <span class="op">=</span> <span class="st">'money_gained'</span></span>
<span id="cb117-26"><a href="#cb117-26" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> offer_type:</span>
<span id="cb117-27"><a href="#cb117-27" aria-hidden="true" tabindex="-1"></a>                flag <span class="op">=</span> flag <span class="op">&amp;</span> (cleaned_df.offer_type <span class="op">==</span> offer_type)</span>
<span id="cb117-28"><a href="#cb117-28" aria-hidden="true" tabindex="-1"></a>                key <span class="op">=</span> <span class="st">'</span><span class="sc">{}</span><span class="st">_'</span>.<span class="bu">format</span>(offer_type) <span class="op">+</span> key</span>
<span id="cb117-29"><a href="#cb117-29" aria-hidden="true" tabindex="-1"></a>            data[key] <span class="op">=</span> cleaned_df[flag].groupby(<span class="st">'customer_id'</span>).money_gained.<span class="bu">sum</span>()</span>
<span id="cb117-30"><a href="#cb117-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-31"><a href="#cb117-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="get-offer-data-per-customer-by-offer-id" class="level4">
<h4 class="anchored" data-anchor-id="get-offer-data-per-customer-by-offer-id">Get offer data per customer by offer id</h4>
<p>Remember that there are 10 different offer ids which a customer could potentially receive. We create a function that collects the offer data for each customer for each offer id and returns offer id sent to each customer</p>
<div class="cell" data-execution_count="96">
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> cust_offer_id(cleaned_df, offer_id):</span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">''' Get offer data (received, viewed and completed) per customer by offer id</span></span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a><span class="co">    INPUT:</span></span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a><span class="co">    cleaned_df - merged transactions, portfolio, and profile datasets</span></span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a><span class="co">    offer_id - 'bogo_1','bogo_2','bogo_3','bogo_4','discount_1','discount_2','discount_3','discount_4','info_1','info_2'</span></span>
<span id="cb118-6"><a href="#cb118-6" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb118-7"><a href="#cb118-7" aria-hidden="true" tabindex="-1"></a><span class="co">    RETURNS:</span></span>
<span id="cb118-8"><a href="#cb118-8" aria-hidden="true" tabindex="-1"></a><span class="co">    cust_offer_id - offer id data per customer</span></span>
<span id="cb118-9"><a href="#cb118-9" aria-hidden="true" tabindex="-1"></a><span class="co">    '''</span></span>
<span id="cb118-10"><a href="#cb118-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb118-11"><a href="#cb118-11" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> <span class="bu">dict</span>()</span>
<span id="cb118-12"><a href="#cb118-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-13"><a href="#cb118-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> e <span class="kw">in</span> [<span class="st">'received'</span>, <span class="st">'viewed'</span>, <span class="st">'completed'</span>]:</span>
<span id="cb118-14"><a href="#cb118-14" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get 'completed' data for informational offers</span></span>
<span id="cb118-15"><a href="#cb118-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> offer_id <span class="kw">in</span> [<span class="st">'info_1'</span>, <span class="st">'info_2'</span>] <span class="kw">and</span> e <span class="op">==</span> <span class="st">'completed'</span>:</span>
<span id="cb118-16"><a href="#cb118-16" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb118-17"><a href="#cb118-17" aria-hidden="true" tabindex="-1"></a>        event <span class="op">=</span> <span class="st">'offer_</span><span class="sc">{}</span><span class="st">'</span>.<span class="bu">format</span>(e)</span>
<span id="cb118-18"><a href="#cb118-18" aria-hidden="true" tabindex="-1"></a>        flag <span class="op">=</span> (cleaned_df[event] <span class="op">==</span> <span class="dv">1</span>) <span class="op">&amp;</span> (cleaned_df.offer_id <span class="op">==</span> offer_id)</span>
<span id="cb118-19"><a href="#cb118-19" aria-hidden="true" tabindex="-1"></a>        key <span class="op">=</span> <span class="st">'</span><span class="sc">{}</span><span class="st">_</span><span class="sc">{}</span><span class="st">'</span>.<span class="bu">format</span>(offer_id, e)</span>
<span id="cb118-20"><a href="#cb118-20" aria-hidden="true" tabindex="-1"></a>        data[key] <span class="op">=</span> cleaned_df[flag].groupby(<span class="st">'customer_id'</span>).offer_id.count()</span>
<span id="cb118-21"><a href="#cb118-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-22"><a href="#cb118-22" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get 'reward' data for informational offers</span></span>
<span id="cb118-23"><a href="#cb118-23" aria-hidden="true" tabindex="-1"></a>        flag <span class="op">=</span> (cleaned_df.offer_completed <span class="op">==</span> <span class="dv">1</span>) <span class="op">&amp;</span> (cleaned_df.offer_id <span class="op">==</span> offer_id)</span>
<span id="cb118-24"><a href="#cb118-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> offer_id <span class="kw">not</span> <span class="kw">in</span> [<span class="st">'info_1'</span>, <span class="st">'info_2'</span>]:</span>
<span id="cb118-25"><a href="#cb118-25" aria-hidden="true" tabindex="-1"></a>            key <span class="op">=</span> <span class="st">'</span><span class="sc">{}</span><span class="st">_money_gained'</span>.<span class="bu">format</span>(offer_id)</span>
<span id="cb118-26"><a href="#cb118-26" aria-hidden="true" tabindex="-1"></a>            data[key] <span class="op">=</span> cleaned_df[flag].groupby(<span class="st">'customer_id'</span>).money_gained.<span class="bu">sum</span>()</span>
<span id="cb118-27"><a href="#cb118-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-28"><a href="#cb118-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="create-merged-customer-dataframe-with-aggregated-transaction-offer-data-and-demographics" class="level4">
<h4 class="anchored" data-anchor-id="create-merged-customer-dataframe-with-aggregated-transaction-offer-data-and-demographics">Create merged customer dataframe with aggregated transaction, offer data and demographics</h4>
<p>Having collected the offer data per customer for each offer type and offer id, we now merge the datasets and add this data</p>
<div class="cell" data-execution_count="97">
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> merged_cust(cleaned_df, profile_fr_df2):</span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">''' Build a dataframe with aggregated purchase and offer data and demographics</span></span>
<span id="cb119-3"><a href="#cb119-3" aria-hidden="true" tabindex="-1"></a><span class="co">    INPUT:</span></span>
<span id="cb119-4"><a href="#cb119-4" aria-hidden="true" tabindex="-1"></a><span class="co">    cleaned_df - merged transactions, portfolio, and profile datasets</span></span>
<span id="cb119-5"><a href="#cb119-5" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb119-6"><a href="#cb119-6" aria-hidden="true" tabindex="-1"></a><span class="co">    RETURNS:</span></span>
<span id="cb119-7"><a href="#cb119-7" aria-hidden="true" tabindex="-1"></a><span class="co">    merged_cust - df with aggregated customer data</span></span>
<span id="cb119-8"><a href="#cb119-8" aria-hidden="true" tabindex="-1"></a><span class="co">    '''</span></span>
<span id="cb119-9"><a href="#cb119-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb119-10"><a href="#cb119-10" aria-hidden="true" tabindex="-1"></a>    cust_dict <span class="op">=</span> <span class="bu">dict</span>()</span>
<span id="cb119-11"><a href="#cb119-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb119-12"><a href="#cb119-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get total transaction data</span></span>
<span id="cb119-13"><a href="#cb119-13" aria-hidden="true" tabindex="-1"></a>    transactions <span class="op">=</span> cleaned_df[cleaned_df.transaction <span class="op">==</span> <span class="dv">1</span>].groupby(<span class="st">'customer_id'</span>)</span>
<span id="cb119-14"><a href="#cb119-14" aria-hidden="true" tabindex="-1"></a>    cust_dict[<span class="st">'total_expense'</span>] <span class="op">=</span> transactions.money_spent.<span class="bu">sum</span>()</span>
<span id="cb119-15"><a href="#cb119-15" aria-hidden="true" tabindex="-1"></a>    cust_dict[<span class="st">'total_transactions'</span>] <span class="op">=</span> transactions.money_spent.count()</span>
<span id="cb119-16"><a href="#cb119-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb119-17"><a href="#cb119-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get aggregate offer data</span></span>
<span id="cb119-18"><a href="#cb119-18" aria-hidden="true" tabindex="-1"></a>    cust_dict.update(cust_offer_type(cleaned_df))</span>
<span id="cb119-19"><a href="#cb119-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb119-20"><a href="#cb119-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get offer type data</span></span>
<span id="cb119-21"><a href="#cb119-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> ot <span class="kw">in</span> [<span class="st">'bogo'</span>, <span class="st">'discount'</span>, <span class="st">'informational'</span>]:</span>
<span id="cb119-22"><a href="#cb119-22" aria-hidden="true" tabindex="-1"></a>        cust_dict.update(cust_offer_type(cleaned_df, ot))</span>
<span id="cb119-23"><a href="#cb119-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb119-24"><a href="#cb119-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get offer id data</span></span>
<span id="cb119-25"><a href="#cb119-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> oi <span class="kw">in</span> [<span class="st">'bogo_1'</span>,<span class="st">'bogo_2'</span>,<span class="st">'bogo_3'</span>,<span class="st">'bogo_4'</span>,</span>
<span id="cb119-26"><a href="#cb119-26" aria-hidden="true" tabindex="-1"></a>               <span class="st">'discount_1'</span>,<span class="st">'discount_2'</span>,<span class="st">'discount_3'</span>,<span class="st">'discount_4'</span>,</span>
<span id="cb119-27"><a href="#cb119-27" aria-hidden="true" tabindex="-1"></a>               <span class="st">'info_1'</span>,<span class="st">'info_2'</span>]:</span>
<span id="cb119-28"><a href="#cb119-28" aria-hidden="true" tabindex="-1"></a>        cust_dict.update(cust_offer_id(cleaned_df, oi))</span>
<span id="cb119-29"><a href="#cb119-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-30"><a href="#cb119-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Build df, aggregate dict values and demographic data</span></span>
<span id="cb119-31"><a href="#cb119-31" aria-hidden="true" tabindex="-1"></a>    merged_cust <span class="op">=</span> pd.concat(cust_dict.values(), axis<span class="op">=</span><span class="dv">1</span>, sort<span class="op">=</span><span class="va">False</span>)<span class="op">;</span></span>
<span id="cb119-32"><a href="#cb119-32" aria-hidden="true" tabindex="-1"></a>    merged_cust.columns <span class="op">=</span> cust_dict.keys()</span>
<span id="cb119-33"><a href="#cb119-33" aria-hidden="true" tabindex="-1"></a>    merged_cust.fillna(<span class="dv">0</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb119-34"><a href="#cb119-34" aria-hidden="true" tabindex="-1"></a>    merged_cust <span class="op">=</span> pd.merge(merged_cust, profile_fr_df2.set_index(<span class="st">'customer_id'</span>),</span>
<span id="cb119-35"><a href="#cb119-35" aria-hidden="true" tabindex="-1"></a>                         left_index<span class="op">=</span><span class="va">True</span>, right_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb119-36"><a href="#cb119-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb119-37"><a href="#cb119-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add columns for net expense</span></span>
<span id="cb119-38"><a href="#cb119-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb119-39"><a href="#cb119-39" aria-hidden="true" tabindex="-1"></a>    merged_cust[<span class="st">'net_expense'</span>] <span class="op">=</span> merged_cust[<span class="st">'total_expense'</span>] <span class="op">-</span> merged_cust[<span class="st">'money_gained'</span>]</span>
<span id="cb119-40"><a href="#cb119-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-41"><a href="#cb119-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> merged_cust</span>
<span id="cb119-42"><a href="#cb119-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-43"><a href="#cb119-43" aria-hidden="true" tabindex="-1"></a><span class="co"># Show merged df</span></span>
<span id="cb119-44"><a href="#cb119-44" aria-hidden="true" tabindex="-1"></a>merged_cust <span class="op">=</span> merged_cust(cleaned_df, profile_fr_df2)</span>
<span id="cb119-45"><a href="#cb119-45" aria-hidden="true" tabindex="-1"></a>merged_cust.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="97">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>total_expense</th>
      <th>total_transactions</th>
      <th>received</th>
      <th>money_gained</th>
      <th>viewed</th>
      <th>completed</th>
      <th>bogo_received</th>
      <th>bogo_money_gained</th>
      <th>bogo_viewed</th>
      <th>bogo_completed</th>
      <th>...</th>
      <th>info_1_viewed</th>
      <th>info_2_received</th>
      <th>info_2_viewed</th>
      <th>gender</th>
      <th>year</th>
      <th>quarter</th>
      <th>age_group</th>
      <th>income_range</th>
      <th>member_type</th>
      <th>net_expense</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0009655768c64bdeb2e877511632db8f</th>
      <td>127.60</td>
      <td>8.0</td>
      <td>5.0</td>
      <td>9.0</td>
      <td>4.0</td>
      <td>3.0</td>
      <td>1.0</td>
      <td>5.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>...</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>M</td>
      <td>2017</td>
      <td>2</td>
      <td>2</td>
      <td>4</td>
      <td>1.0</td>
      <td>118.60</td>
    </tr>
    <tr>
      <th>0011e0d4e6b944f998e987f904e8c1e5</th>
      <td>79.46</td>
      <td>5.0</td>
      <td>5.0</td>
      <td>13.0</td>
      <td>5.0</td>
      <td>3.0</td>
      <td>1.0</td>
      <td>5.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>...</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>O</td>
      <td>2018</td>
      <td>1</td>
      <td>3</td>
      <td>3</td>
      <td>1.0</td>
      <td>66.46</td>
    </tr>
    <tr>
      <th>0020c2b971eb4e9188eac86d93036a77</th>
      <td>196.86</td>
      <td>8.0</td>
      <td>5.0</td>
      <td>14.0</td>
      <td>3.0</td>
      <td>3.0</td>
      <td>2.0</td>
      <td>10.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>F</td>
      <td>2016</td>
      <td>1</td>
      <td>3</td>
      <td>4</td>
      <td>2.0</td>
      <td>182.86</td>
    </tr>
    <tr>
      <th>0020ccbbb6d84e358d3414a3ff76cffd</th>
      <td>154.05</td>
      <td>12.0</td>
      <td>4.0</td>
      <td>13.0</td>
      <td>4.0</td>
      <td>3.0</td>
      <td>2.0</td>
      <td>10.0</td>
      <td>2.0</td>
      <td>2.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>F</td>
      <td>2016</td>
      <td>4</td>
      <td>2</td>
      <td>3</td>
      <td>2.0</td>
      <td>141.05</td>
    </tr>
    <tr>
      <th>003d66b6608740288d6cc97a6903f4f0</th>
      <td>48.34</td>
      <td>18.0</td>
      <td>5.0</td>
      <td>9.0</td>
      <td>4.0</td>
      <td>3.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>F</td>
      <td>2017</td>
      <td>2</td>
      <td>2</td>
      <td>4</td>
      <td>1.0</td>
      <td>39.34</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 59 columns</p>
</div>
</div>
</div>
<p>The result is a merged customer dataset that shows the total expenses,net expense, total offers viewed, received,completed by each customer and which offer types and offer ids</p>
</section>
<section id="get-any-customer-offer-information-grouped-by-any-column-of-your-choosing" class="level4">
<h4 class="anchored" data-anchor-id="get-any-customer-offer-information-grouped-by-any-column-of-your-choosing">Get any customer offer information grouped by any column of your choosing</h4>
<p>This function will take any column in the merged customer dataframe and return the offer status aggregates grouped by a column of your choosing</p>
<div class="cell" data-execution_count="98">
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> offer_status(merged_cust, stat, offer, by_col, aggr<span class="op">=</span><span class="st">'sum'</span>): </span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">''' Get any column for customers that received but not viewed an offer, viewed but not completed the offer,</span></span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a><span class="co">    and those that viewed and completed the offer, grouped by a column </span></span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a><span class="co">    INPUT:</span></span>
<span id="cb120-5"><a href="#cb120-5" aria-hidden="true" tabindex="-1"></a><span class="co">    merged_cust - aggregated offer and demographic df</span></span>
<span id="cb120-6"><a href="#cb120-6" aria-hidden="true" tabindex="-1"></a><span class="co">    stat - column of interest</span></span>
<span id="cb120-7"><a href="#cb120-7" aria-hidden="true" tabindex="-1"></a><span class="co">    offer - offer of interest</span></span>
<span id="cb120-8"><a href="#cb120-8" aria-hidden="true" tabindex="-1"></a><span class="co">    by_col - column used to group the data</span></span>
<span id="cb120-9"><a href="#cb120-9" aria-hidden="true" tabindex="-1"></a><span class="co">    aggr - aggregation method sum or mean</span></span>
<span id="cb120-10"><a href="#cb120-10" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb120-11"><a href="#cb120-11" aria-hidden="true" tabindex="-1"></a><span class="co">    RETURNS:</span></span>
<span id="cb120-12"><a href="#cb120-12" aria-hidden="true" tabindex="-1"></a><span class="co">    (received_agg, viewed_agg, completed) - tuple with sum aggregation</span></span>
<span id="cb120-13"><a href="#cb120-13" aria-hidden="true" tabindex="-1"></a><span class="co">    '''</span></span>
<span id="cb120-14"><a href="#cb120-14" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb120-15"><a href="#cb120-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define dict</span></span>
<span id="cb120-16"><a href="#cb120-16" aria-hidden="true" tabindex="-1"></a>    received_col <span class="op">=</span> <span class="st">'</span><span class="sc">{}</span><span class="st">_received'</span>.<span class="bu">format</span>(offer)</span>
<span id="cb120-17"><a href="#cb120-17" aria-hidden="true" tabindex="-1"></a>    viewed_col <span class="op">=</span> <span class="st">'</span><span class="sc">{}</span><span class="st">_viewed'</span>.<span class="bu">format</span>(offer)</span>
<span id="cb120-18"><a href="#cb120-18" aria-hidden="true" tabindex="-1"></a>    received <span class="op">=</span> (merged_cust[received_col] <span class="op">&gt;</span> <span class="dv">0</span>) <span class="op">&amp;</span> (merged_cust[viewed_col] <span class="op">==</span> <span class="dv">0</span>)</span>
<span id="cb120-19"><a href="#cb120-19" aria-hidden="true" tabindex="-1"></a>    completed <span class="op">=</span> <span class="va">None</span></span>
<span id="cb120-20"><a href="#cb120-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Aggregate customer behavior data for schema</span></span>
<span id="cb120-21"><a href="#cb120-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> offer <span class="kw">not</span> <span class="kw">in</span> [<span class="st">'informational'</span>, <span class="st">'info_1'</span>, <span class="st">'info_2'</span>]:</span>
<span id="cb120-22"><a href="#cb120-22" aria-hidden="true" tabindex="-1"></a>        completed_col <span class="op">=</span> <span class="st">'</span><span class="sc">{}</span><span class="st">_completed'</span>.<span class="bu">format</span>(offer)</span>
<span id="cb120-23"><a href="#cb120-23" aria-hidden="true" tabindex="-1"></a>        viewed <span class="op">=</span> (merged_cust[viewed_col] <span class="op">&gt;</span> <span class="dv">0</span>) <span class="op">&amp;</span> (merged_cust[completed_col] <span class="op">==</span> <span class="dv">0</span>)</span>
<span id="cb120-24"><a href="#cb120-24" aria-hidden="true" tabindex="-1"></a>        completed_off <span class="op">=</span> (merged_cust[completed_col] <span class="op">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb120-25"><a href="#cb120-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> aggr <span class="op">==</span> <span class="st">'sum'</span>:</span>
<span id="cb120-26"><a href="#cb120-26" aria-hidden="true" tabindex="-1"></a>            completed <span class="op">=</span> merged_cust[completed_off].groupby(by_col)[stat].<span class="bu">sum</span>()</span>
<span id="cb120-27"><a href="#cb120-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> aggr <span class="op">==</span> <span class="st">'mean'</span>:</span>
<span id="cb120-28"><a href="#cb120-28" aria-hidden="true" tabindex="-1"></a>            completed <span class="op">=</span> merged_cust[completed_off].groupby(by_col)[stat].mean()</span>
<span id="cb120-29"><a href="#cb120-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb120-30"><a href="#cb120-30" aria-hidden="true" tabindex="-1"></a>        viewed <span class="op">=</span> (merged_cust[viewed_col] <span class="op">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb120-31"><a href="#cb120-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> aggr <span class="op">==</span> <span class="st">'sum'</span>:</span>
<span id="cb120-32"><a href="#cb120-32" aria-hidden="true" tabindex="-1"></a>        received_agg <span class="op">=</span> merged_cust[received].groupby(by_col)[stat].<span class="bu">sum</span>()</span>
<span id="cb120-33"><a href="#cb120-33" aria-hidden="true" tabindex="-1"></a>        viewed_agg <span class="op">=</span> merged_cust[viewed].groupby(by_col)[stat].<span class="bu">sum</span>()</span>
<span id="cb120-34"><a href="#cb120-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> aggr <span class="op">==</span> <span class="st">'mean'</span>:</span>
<span id="cb120-35"><a href="#cb120-35" aria-hidden="true" tabindex="-1"></a>        received_agg <span class="op">=</span> merged_cust[received].groupby(by_col)[stat].mean()</span>
<span id="cb120-36"><a href="#cb120-36" aria-hidden="true" tabindex="-1"></a>        viewed_agg <span class="op">=</span> merged_cust[viewed].groupby(by_col)[stat].mean()</span>
<span id="cb120-37"><a href="#cb120-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> received_agg, viewed_agg, completed</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="calculate-the-average-expense-for-customers-according-to-offer-data" class="level4">
<h4 class="anchored" data-anchor-id="calculate-the-average-expense-for-customers-according-to-offer-data">Calculate the average expense for customers according to offer data</h4>
<p>Calculate the average expense for all customers to compare the average expense for those that, received, viewed, completed the offer and the permututations therewith</p>
<div class="cell" data-execution_count="99">
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> avg_expense(merged_cust, offer, by_col): </span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">''' Get the average expense for customers that received but not viewed an offer, viewed but not completed the offer, and those that viewed and completed the offer, group by a column </span></span>
<span id="cb121-3"><a href="#cb121-3" aria-hidden="true" tabindex="-1"></a><span class="co">    INPUT:</span></span>
<span id="cb121-4"><a href="#cb121-4" aria-hidden="true" tabindex="-1"></a><span class="co">    merged_cust - aggregated offer and demographic df</span></span>
<span id="cb121-5"><a href="#cb121-5" aria-hidden="true" tabindex="-1"></a><span class="co">    offer - offer of interest</span></span>
<span id="cb121-6"><a href="#cb121-6" aria-hidden="true" tabindex="-1"></a><span class="co">    by_col - column used to group the data</span></span>
<span id="cb121-7"><a href="#cb121-7" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb121-8"><a href="#cb121-8" aria-hidden="true" tabindex="-1"></a><span class="co">    RETURNS:</span></span>
<span id="cb121-9"><a href="#cb121-9" aria-hidden="true" tabindex="-1"></a><span class="co">    (received, viewed, completed) - tuple with the average expense</span></span>
<span id="cb121-10"><a href="#cb121-10" aria-hidden="true" tabindex="-1"></a><span class="co">    '''</span></span>
<span id="cb121-11"><a href="#cb121-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get totals</span></span>
<span id="cb121-12"><a href="#cb121-12" aria-hidden="true" tabindex="-1"></a>    received_total, viewed_total, completed_total <span class="op">=</span> offer_status(merged_cust,</span>
<span id="cb121-13"><a href="#cb121-13" aria-hidden="true" tabindex="-1"></a>                                                        <span class="st">'total_expense'</span>,</span>
<span id="cb121-14"><a href="#cb121-14" aria-hidden="true" tabindex="-1"></a>                                                        offer, by_col)</span>
<span id="cb121-15"><a href="#cb121-15" aria-hidden="true" tabindex="-1"></a>    received_trans, viewed_trans, completed_trans <span class="op">=</span> offer_status(merged_cust,</span>
<span id="cb121-16"><a href="#cb121-16" aria-hidden="true" tabindex="-1"></a>                                                        <span class="st">'total_transactions'</span>,</span>
<span id="cb121-17"><a href="#cb121-17" aria-hidden="true" tabindex="-1"></a>                                                        offer, by_col)</span>
<span id="cb121-18"><a href="#cb121-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate averages for received and viewed offers</span></span>
<span id="cb121-19"><a href="#cb121-19" aria-hidden="true" tabindex="-1"></a>    received_avg <span class="op">=</span> received_total <span class="op">/</span> received_trans</span>
<span id="cb121-20"><a href="#cb121-20" aria-hidden="true" tabindex="-1"></a>    received_avg.fillna(<span class="dv">0</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb121-21"><a href="#cb121-21" aria-hidden="true" tabindex="-1"></a>    viewed_avg <span class="op">=</span> viewed_total <span class="op">/</span> viewed_trans</span>
<span id="cb121-22"><a href="#cb121-22" aria-hidden="true" tabindex="-1"></a>    viewed_avg.fillna(<span class="dv">0</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb121-23"><a href="#cb121-23" aria-hidden="true" tabindex="-1"></a>    completed_avg <span class="op">=</span> <span class="va">None</span></span>
<span id="cb121-24"><a href="#cb121-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> offer <span class="kw">not</span> <span class="kw">in</span> [<span class="st">'informational'</span>, <span class="st">'info_1'</span>, <span class="st">'info_2'</span>]:</span>
<span id="cb121-25"><a href="#cb121-25" aria-hidden="true" tabindex="-1"></a>        completed_avg <span class="op">=</span> completed_total <span class="op">/</span> completed_trans</span>
<span id="cb121-26"><a href="#cb121-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-27"><a href="#cb121-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> received_avg, viewed_avg, completed_avg</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="plot-the-average-expense-per-transaction-for-each-customer-per-offer-type" class="level4">
<h4 class="anchored" data-anchor-id="plot-the-average-expense-per-transaction-for-each-customer-per-offer-type">Plot the average expense per transaction for each customer per offer type</h4>
<p>Plot according to whether they received, viewed and or completed an offer. The plot shows the offer type and the average expense</p>
<div class="cell" data-execution_count="100">
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> offer_earnings_plot(merged_cust, offer):</span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">''' Plot the average expense per transaction for customersthat have received, viewed and completed an offer.</span></span>
<span id="cb122-3"><a href="#cb122-3" aria-hidden="true" tabindex="-1"></a><span class="co">    INPUT:</span></span>
<span id="cb122-4"><a href="#cb122-4" aria-hidden="true" tabindex="-1"></a><span class="co">    merged_cust - customer df</span></span>
<span id="cb122-5"><a href="#cb122-5" aria-hidden="true" tabindex="-1"></a><span class="co">    offer - offer type</span></span>
<span id="cb122-6"><a href="#cb122-6" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb122-7"><a href="#cb122-7" aria-hidden="true" tabindex="-1"></a><span class="co">    RETURNS:</span></span>
<span id="cb122-8"><a href="#cb122-8" aria-hidden="true" tabindex="-1"></a><span class="co">    (age, incomme, and gender) - plots</span></span>
<span id="cb122-9"><a href="#cb122-9" aria-hidden="true" tabindex="-1"></a><span class="co">    '''</span>  </span>
<span id="cb122-10"><a href="#cb122-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set palette</span></span>
<span id="cb122-11"><a href="#cb122-11" aria-hidden="true" tabindex="-1"></a>    plt.rcParams[<span class="st">"image.cmap"</span>] <span class="op">=</span> <span class="st">"Set1"</span></span>
<span id="cb122-12"><a href="#cb122-12" aria-hidden="true" tabindex="-1"></a>    plt.rcParams[<span class="st">'axes.prop_cycle'</span>] <span class="op">=</span> plt.cycler(color<span class="op">=</span>plt.cm.Set1.colors)</span>
<span id="cb122-13"><a href="#cb122-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb122-14"><a href="#cb122-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define variables</span></span>
<span id="cb122-15"><a href="#cb122-15" aria-hidden="true" tabindex="-1"></a>    received_by <span class="op">=</span> <span class="bu">dict</span>()</span>
<span id="cb122-16"><a href="#cb122-16" aria-hidden="true" tabindex="-1"></a>    viewed_by <span class="op">=</span> <span class="bu">dict</span>()</span>
<span id="cb122-17"><a href="#cb122-17" aria-hidden="true" tabindex="-1"></a>    completed_by <span class="op">=</span> <span class="bu">dict</span>()</span>
<span id="cb122-18"><a href="#cb122-18" aria-hidden="true" tabindex="-1"></a>    received_avg_by <span class="op">=</span> <span class="bu">dict</span>()</span>
<span id="cb122-19"><a href="#cb122-19" aria-hidden="true" tabindex="-1"></a>    viewed_avg_by <span class="op">=</span> <span class="bu">dict</span>()</span>
<span id="cb122-20"><a href="#cb122-20" aria-hidden="true" tabindex="-1"></a>    completed_avg_by <span class="op">=</span> <span class="bu">dict</span>()</span>
<span id="cb122-21"><a href="#cb122-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-22"><a href="#cb122-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Aggregate data by age, income, and gender</span></span>
<span id="cb122-23"><a href="#cb122-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> key <span class="kw">in</span> [<span class="st">'age_group'</span>, <span class="st">'income_range'</span>, <span class="st">'gender'</span>]:</span>
<span id="cb122-24"><a href="#cb122-24" aria-hidden="true" tabindex="-1"></a>        received_by[key], viewed_by[key], completed_by[key] <span class="op">=</span> offer_status(merged_cust,</span>
<span id="cb122-25"><a href="#cb122-25" aria-hidden="true" tabindex="-1"></a>                                                                  <span class="st">'net_expense'</span>,</span>
<span id="cb122-26"><a href="#cb122-26" aria-hidden="true" tabindex="-1"></a>                                                                  offer, key,</span>
<span id="cb122-27"><a href="#cb122-27" aria-hidden="true" tabindex="-1"></a>                                                                  aggr<span class="op">=</span><span class="st">'mean'</span>)</span>
<span id="cb122-28"><a href="#cb122-28" aria-hidden="true" tabindex="-1"></a>        by <span class="op">=</span> avg_expense(merged_cust, offer, key)</span>
<span id="cb122-29"><a href="#cb122-29" aria-hidden="true" tabindex="-1"></a>        received_avg_by[key], viewed_avg_by[key], completed_avg_by[key] <span class="op">=</span> by</span>
<span id="cb122-30"><a href="#cb122-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb122-31"><a href="#cb122-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot layout</span></span>
<span id="cb122-32"><a href="#cb122-32" aria-hidden="true" tabindex="-1"></a>    plt.figure(figsize<span class="op">=</span>(<span class="dv">16</span>, <span class="dv">10</span>))</span>
<span id="cb122-33"><a href="#cb122-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-34"><a href="#cb122-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot offer expense by 'bogo'</span></span>
<span id="cb122-35"><a href="#cb122-35" aria-hidden="true" tabindex="-1"></a>    plt.subplot(<span class="dv">231</span>)</span>
<span id="cb122-36"><a href="#cb122-36" aria-hidden="true" tabindex="-1"></a>    plt.plot(received_avg_by[<span class="st">'age_group'</span>], label<span class="op">=</span><span class="st">'</span><span class="sc">{}</span><span class="st">-received'</span>.<span class="bu">format</span>(offer))</span>
<span id="cb122-37"><a href="#cb122-37" aria-hidden="true" tabindex="-1"></a>    plt.plot(viewed_avg_by[<span class="st">'age_group'</span>], label<span class="op">=</span><span class="st">'</span><span class="sc">{}</span><span class="st">-viewed'</span>.<span class="bu">format</span>(offer))</span>
<span id="cb122-38"><a href="#cb122-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> offer <span class="kw">not</span> <span class="kw">in</span> [<span class="st">'informational'</span>, <span class="st">'info_1'</span>, <span class="st">'info_2'</span>]:</span>
<span id="cb122-39"><a href="#cb122-39" aria-hidden="true" tabindex="-1"></a>        plt.plot(completed_avg_by[<span class="st">'age_group'</span>], label<span class="op">=</span><span class="st">'</span><span class="sc">{}</span><span class="st">-completed'</span>.<span class="bu">format</span>(offer))</span>
<span id="cb122-40"><a href="#cb122-40" aria-hidden="true" tabindex="-1"></a>    plt.legend(loc<span class="op">=</span><span class="st">'upper left'</span>)</span>
<span id="cb122-41"><a href="#cb122-41" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="st">'Average Transaction Value by Age'</span>)</span>
<span id="cb122-42"><a href="#cb122-42" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(<span class="st">'Age'</span>)</span>
<span id="cb122-43"><a href="#cb122-43" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(<span class="st">'USD'</span>)<span class="op">;</span></span>
<span id="cb122-44"><a href="#cb122-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-45"><a href="#cb122-45" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot offer expense by 'discount'</span></span>
<span id="cb122-46"><a href="#cb122-46" aria-hidden="true" tabindex="-1"></a>    plt.subplot(<span class="dv">232</span>)</span>
<span id="cb122-47"><a href="#cb122-47" aria-hidden="true" tabindex="-1"></a>    plt.plot(received_avg_by[<span class="st">'income_range'</span>], label<span class="op">=</span><span class="st">'</span><span class="sc">{}</span><span class="st">-received'</span>.<span class="bu">format</span>(offer))</span>
<span id="cb122-48"><a href="#cb122-48" aria-hidden="true" tabindex="-1"></a>    plt.plot(viewed_avg_by[<span class="st">'income_range'</span>], label<span class="op">=</span><span class="st">'</span><span class="sc">{}</span><span class="st">-viewed'</span>.<span class="bu">format</span>(offer))</span>
<span id="cb122-49"><a href="#cb122-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> offer <span class="kw">not</span> <span class="kw">in</span> [<span class="st">'informational'</span>, <span class="st">'info_1'</span>, <span class="st">'info_2'</span>]:</span>
<span id="cb122-50"><a href="#cb122-50" aria-hidden="true" tabindex="-1"></a>        plt.plot(completed_avg_by[<span class="st">'income_range'</span>], label<span class="op">=</span><span class="st">'</span><span class="sc">{}</span><span class="st">-completed'</span>.<span class="bu">format</span>(offer))</span>
<span id="cb122-51"><a href="#cb122-51" aria-hidden="true" tabindex="-1"></a>    plt.legend(loc<span class="op">=</span><span class="st">'upper left'</span>)</span>
<span id="cb122-52"><a href="#cb122-52" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="st">'Average Transaction Value by Income'</span>)</span>
<span id="cb122-53"><a href="#cb122-53" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(<span class="st">'Income'</span>)</span>
<span id="cb122-54"><a href="#cb122-54" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(<span class="st">'USD'</span>)<span class="op">;</span></span>
<span id="cb122-55"><a href="#cb122-55" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb122-56"><a href="#cb122-56" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot offer expense by 'informational'</span></span>
<span id="cb122-57"><a href="#cb122-57" aria-hidden="true" tabindex="-1"></a>    plt.subplot(<span class="dv">233</span>)</span>
<span id="cb122-58"><a href="#cb122-58" aria-hidden="true" tabindex="-1"></a>    index <span class="op">=</span> np.array([<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>])</span>
<span id="cb122-59"><a href="#cb122-59" aria-hidden="true" tabindex="-1"></a>    bar_width <span class="op">=</span> <span class="fl">0.3</span></span>
<span id="cb122-60"><a href="#cb122-60" aria-hidden="true" tabindex="-1"></a>    plt.bar(index, received_avg_by[<span class="st">'gender'</span>].reindex([<span class="st">'M'</span>, <span class="st">'F'</span>, <span class="st">'O'</span>]), bar_width,</span>
<span id="cb122-61"><a href="#cb122-61" aria-hidden="true" tabindex="-1"></a>            label<span class="op">=</span><span class="st">'</span><span class="sc">{}</span><span class="st">-received'</span>.<span class="bu">format</span>(offer))</span>
<span id="cb122-62"><a href="#cb122-62" aria-hidden="true" tabindex="-1"></a>    plt.bar(index <span class="op">+</span> bar_width, viewed_avg_by[<span class="st">'gender'</span>].reindex([<span class="st">'M'</span>, <span class="st">'F'</span>, <span class="st">'O'</span>]),</span>
<span id="cb122-63"><a href="#cb122-63" aria-hidden="true" tabindex="-1"></a>            bar_width, label<span class="op">=</span><span class="st">'</span><span class="sc">{}</span><span class="st">-viewed'</span>.<span class="bu">format</span>(offer))</span>
<span id="cb122-64"><a href="#cb122-64" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> offer <span class="kw">not</span> <span class="kw">in</span> [<span class="st">'informational'</span>, <span class="st">'info_1'</span>, <span class="st">'info_2'</span>]:</span>
<span id="cb122-65"><a href="#cb122-65" aria-hidden="true" tabindex="-1"></a>        plt.bar(index<span class="op">+</span><span class="dv">2</span><span class="op">*</span>bar_width, completed_avg_by[<span class="st">'gender'</span>].reindex([<span class="st">'M'</span>, <span class="st">'F'</span>, <span class="st">'O'</span>]),</span>
<span id="cb122-66"><a href="#cb122-66" aria-hidden="true" tabindex="-1"></a>                bar_width, label<span class="op">=</span><span class="st">'</span><span class="sc">{}</span><span class="st">-completed'</span>.<span class="bu">format</span>(offer))</span>
<span id="cb122-67"><a href="#cb122-67" aria-hidden="true" tabindex="-1"></a>    plt.legend(loc<span class="op">=</span><span class="st">'upper left'</span>)</span>
<span id="cb122-68"><a href="#cb122-68" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="st">'Average Transaction Value by Gender'</span>)</span>
<span id="cb122-69"><a href="#cb122-69" aria-hidden="true" tabindex="-1"></a>    plt.xticks(index <span class="op">+</span> bar_width, (<span class="st">'Male'</span>, <span class="st">'Female'</span>, <span class="st">'Other'</span>))</span>
<span id="cb122-70"><a href="#cb122-70" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(<span class="st">'Gender'</span>)</span>
<span id="cb122-71"><a href="#cb122-71" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(<span class="st">'USD'</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Map the values back to their categorical variables for analysis</p>
<div class="cell" data-execution_count="101">
<div class="sourceCode cell-code" id="cb123"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a>merged_cust[<span class="st">'income_range'</span>] <span class="op">=</span> merged_cust[<span class="st">'income_range'</span>].<span class="bu">map</span>({<span class="dv">1</span>: <span class="st">'low'</span>, <span class="dv">2</span>: <span class="st">'low_to_mid'</span>, <span class="dv">3</span>:<span class="st">'mid'</span>,<span class="dv">4</span>:<span class="st">'mid_to_high'</span>,<span class="dv">5</span>:<span class="st">'high'</span>})</span>
<span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a>merged_cust[<span class="st">'age_group'</span>] <span class="op">=</span> merged_cust[<span class="st">'age_group'</span>].<span class="bu">map</span>({<span class="dv">1</span>: <span class="st">'teenager'</span>, <span class="dv">2</span>: <span class="st">'young-adult'</span>, <span class="dv">3</span>:<span class="st">'adult'</span>, <span class="dv">4</span>:<span class="st">'elderly'</span>})</span>
<span id="cb123-3"><a href="#cb123-3" aria-hidden="true" tabindex="-1"></a>merged_cust[<span class="st">'member_type'</span>] <span class="op">=</span> merged_cust[<span class="st">'member_type'</span>].<span class="bu">map</span>({<span class="dv">1</span>: <span class="st">'new'</span>, <span class="dv">2</span>: <span class="st">'regular'</span>, <span class="dv">3</span>:<span class="st">'loyal'</span>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Plot bogo offer earnings</strong></p>
<div class="cell" data-execution_count="102">
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a>offer_earnings_plot(merged_cust, <span class="st">'bogo'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2021-07-14-Starbucks-Optimising-Customer-Segmentation-with-Random-Forest-and-Gradient-Boosting_files/figure-html/cell-103-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>The pattern in terms of offers, received, viewed and completed is the same accross age, income and gender demographics.</p>
<ul>
<li><p>The elderly have the highest average transaction for BOGO offers. In general, as age increases, customers spend more on BOGO.</p></li>
<li><p>High income earners spend the highest on BOGO followed by mid-to-high earners. In general we observe an increase in spending with an increase in income.</p></li>
<li><p>Females spend the most on BOGO but in terms of view rate, those that did not specfy gender spent more on BOGO if we compare how many received vs how many completed BOGO.</p></li>
</ul>
<p><strong>Plot discount offer earnings</strong></p>
<div class="cell" data-execution_count="103">
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a>offer_earnings_plot(merged_cust, <span class="st">'discount'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2021-07-14-Starbucks-Optimising-Customer-Segmentation-with-Random-Forest-and-Gradient-Boosting_files/figure-html/cell-104-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>The same trends we observed for BOGO seem to apply here as well.</p>
<p>Transactions increase with an increase in age with those above 60 spending the most on discounts.</p>
<p>High income earners will spend an average of 30USD on discount offers. Mid to high earners will also spent a lot on discount</p>
<p>Females are also the highest spenders on discount earners and again we see those with unspecified gender have a higher conversion rate of all demographics</p>
<p><strong>Plot informational offer earnings</strong></p>
<div class="cell" data-execution_count="104">
<div class="sourceCode cell-code" id="cb126"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a>offer_earnings_plot(merged_cust, <span class="st">'informational'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2021-07-14-Starbucks-Optimising-Customer-Segmentation-with-Random-Forest-and-Gradient-Boosting_files/figure-html/cell-105-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Informational offers follow the same pattern seen on all offers.</p>
</section>
<section id="get-the-money-gained-by-customers-for-completed-offers" class="level4">
<h4 class="anchored" data-anchor-id="get-the-money-gained-by-customers-for-completed-offers">Get the money gained by customers for completed offers</h4>
<div class="cell" data-execution_count="105">
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> net_earnings(merged_cust, offer, q<span class="op">=</span><span class="fl">0.5</span>):  </span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">'''Get the net_earnings for customers that viewed and completed offers </span></span>
<span id="cb127-3"><a href="#cb127-3" aria-hidden="true" tabindex="-1"></a><span class="co">    INPUT:</span></span>
<span id="cb127-4"><a href="#cb127-4" aria-hidden="true" tabindex="-1"></a><span class="co">    offer - offer of interest</span></span>
<span id="cb127-5"><a href="#cb127-5" aria-hidden="true" tabindex="-1"></a><span class="co">    q - quantile to be used</span></span>
<span id="cb127-6"><a href="#cb127-6" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb127-7"><a href="#cb127-7" aria-hidden="true" tabindex="-1"></a><span class="co">    RETURNS:</span></span>
<span id="cb127-8"><a href="#cb127-8" aria-hidden="true" tabindex="-1"></a><span class="co">    net_earnings - median of total transaction value</span></span>
<span id="cb127-9"><a href="#cb127-9" aria-hidden="true" tabindex="-1"></a><span class="co">    '''</span></span>
<span id="cb127-10"><a href="#cb127-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Flag customers that viewed offers</span></span>
<span id="cb127-11"><a href="#cb127-11" aria-hidden="true" tabindex="-1"></a>    flag <span class="op">=</span> (merged_cust[<span class="st">'</span><span class="sc">{}</span><span class="st">_viewed'</span>.<span class="bu">format</span>(offer)] <span class="op">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb127-12"><a href="#cb127-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sort through positive net earnings</span></span>
<span id="cb127-13"><a href="#cb127-13" aria-hidden="true" tabindex="-1"></a>    flag <span class="op">=</span> flag <span class="op">&amp;</span> (merged_cust.net_expense <span class="op">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb127-14"><a href="#cb127-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Aggregate those with at least 5 transactions</span></span>
<span id="cb127-15"><a href="#cb127-15" aria-hidden="true" tabindex="-1"></a>    flag <span class="op">=</span> flag <span class="op">&amp;</span> (merged_cust.total_transactions <span class="op">&gt;=</span> <span class="dv">5</span>)</span>
<span id="cb127-16"><a href="#cb127-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Aggregate viewed and completed offers</span></span>
<span id="cb127-17"><a href="#cb127-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> offer <span class="kw">not</span> <span class="kw">in</span> [<span class="st">'info_1'</span>, <span class="st">'info_2'</span>]:</span>
<span id="cb127-18"><a href="#cb127-18" aria-hidden="true" tabindex="-1"></a>        flag <span class="op">=</span> flag <span class="op">&amp;</span> (merged_cust[<span class="st">'</span><span class="sc">{}</span><span class="st">_completed'</span>.<span class="bu">format</span>(offer)] <span class="op">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb127-19"><a href="#cb127-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> merged_cust[flag].net_expense.quantile(q)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="106">
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a>net_earnings(merged_cust,<span class="st">'bogo'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="106">
<pre><code>129.85999999999999</code></pre>
</div>
</div>
<div class="cell" data-execution_count="107">
<div class="sourceCode cell-code" id="cb130"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define loop that sorts by highest earnings</span></span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> greatest_earnings(merged_cust, n_top<span class="op">=</span><span class="dv">2</span>, q<span class="op">=</span><span class="fl">0.5</span>, offers<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb130-3"><a href="#cb130-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">'''Sort offers based on the ones that result in the highest net_expense</span></span>
<span id="cb130-4"><a href="#cb130-4" aria-hidden="true" tabindex="-1"></a><span class="co">    INPUT:</span></span>
<span id="cb130-5"><a href="#cb130-5" aria-hidden="true" tabindex="-1"></a><span class="co">    customers - dataframe with aggregated data of the offers</span></span>
<span id="cb130-6"><a href="#cb130-6" aria-hidden="true" tabindex="-1"></a><span class="co">    n_top - number of offers to be returned (default: 2)</span></span>
<span id="cb130-7"><a href="#cb130-7" aria-hidden="true" tabindex="-1"></a><span class="co">    q - quantile used for sorting</span></span>
<span id="cb130-8"><a href="#cb130-8" aria-hidden="true" tabindex="-1"></a><span class="co">    offers - list of offers to be sorted</span></span>
<span id="cb130-9"><a href="#cb130-9" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb130-10"><a href="#cb130-10" aria-hidden="true" tabindex="-1"></a><span class="co">    RETURNS:</span></span>
<span id="cb130-11"><a href="#cb130-11" aria-hidden="true" tabindex="-1"></a><span class="co">    sorted list of offers, in descending order according to the median net_expense</span></span>
<span id="cb130-12"><a href="#cb130-12" aria-hidden="true" tabindex="-1"></a><span class="co">    '''</span></span>
<span id="cb130-13"><a href="#cb130-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sort for offers earnings in second quantile</span></span>
<span id="cb130-14"><a href="#cb130-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> offers:</span>
<span id="cb130-15"><a href="#cb130-15" aria-hidden="true" tabindex="-1"></a>        offers <span class="op">=</span> [<span class="st">'bogo_1'</span>,<span class="st">'bogo_2'</span>,<span class="st">'bogo_3'</span>,<span class="st">'bogo_4'</span>,</span>
<span id="cb130-16"><a href="#cb130-16" aria-hidden="true" tabindex="-1"></a>               <span class="st">'discount_1'</span>,<span class="st">'discount_2'</span>,<span class="st">'discount_3'</span>,<span class="st">'discount_4'</span>,</span>
<span id="cb130-17"><a href="#cb130-17" aria-hidden="true" tabindex="-1"></a>               <span class="st">'info_1'</span>,<span class="st">'info_2'</span>]</span>
<span id="cb130-18"><a href="#cb130-18" aria-hidden="true" tabindex="-1"></a>    offers.sort(key<span class="op">=</span><span class="kw">lambda</span> x: net_earnings(merged_cust, x, q), reverse<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb130-19"><a href="#cb130-19" aria-hidden="true" tabindex="-1"></a>    offers_dict <span class="op">=</span> {o: net_earnings(merged_cust, o, q) <span class="cf">for</span> o <span class="kw">in</span> offers}</span>
<span id="cb130-20"><a href="#cb130-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> offers[:n_top], offers_dict</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="108">
<div class="sourceCode cell-code" id="cb131"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Print 5 offers by most to least popular, highest to least highest earnings</span></span>
<span id="cb131-2"><a href="#cb131-2" aria-hidden="true" tabindex="-1"></a>offers <span class="op">=</span> greatest_earnings(merged_cust, n_top<span class="op">=</span><span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="109">
<div class="sourceCode cell-code" id="cb132"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a>offers</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="109">
<pre><code>(['discount_1', 'bogo_1', 'bogo_4', 'bogo_3', 'bogo_2'],
 {'discount_1': 145.425,
  'bogo_1': 145.325,
  'bogo_4': 145.23000000000002,
  'bogo_3': 131.14,
  'bogo_2': 131.03,
  'discount_2': 124.99000000000001,
  'discount_3': nan,
  'discount_4': 138.07999999999998,
  'info_1': 124.17000000000002,
  'info_2': 102.96000000000001})</code></pre>
</div>
</div>
</section>
</section>
<section id="create-another-merge-for-more-analysis" class="level3">
<h3 class="anchored" data-anchor-id="create-another-merge-for-more-analysis">Create another merge for more analysis</h3>
<p>Create a new dataframe that will combine transaction data with offer type such that the data about offers received, viewed and completed for each offer type are in one row.</p>
<div class="cell" data-execution_count="110">
<div class="sourceCode cell-code" id="cb134"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a>updated_cleaned_transcript<span class="op">=</span>pd.read_csv(<span class="st">'./updated_clean_transcript.csv'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="111">
<div class="sourceCode cell-code" id="cb135"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a>portfolio_clean</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="111">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>possible_reward</th>
      <th>spent_required</th>
      <th>offer_duration_days</th>
      <th>offer_type</th>
      <th>offer_id</th>
      <th>channel_email</th>
      <th>channel_mobile</th>
      <th>channel_social</th>
      <th>channel_web</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>10</td>
      <td>10</td>
      <td>7</td>
      <td>1</td>
      <td>ae264e3637204a6fb9bb56bc8210ddfd</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>10</td>
      <td>10</td>
      <td>5</td>
      <td>1</td>
      <td>4d5c57ea9a6940dd891ad53e9dbe8da0</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0</td>
      <td>0</td>
      <td>4</td>
      <td>3</td>
      <td>3f207df678b143eea3cee63160fa8bed</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>3</th>
      <td>5</td>
      <td>5</td>
      <td>7</td>
      <td>1</td>
      <td>9b98b8c7a33c4b65b9aebfe6a799e6d9</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>20</td>
      <td>10</td>
      <td>2</td>
      <td>0b1e1539f2cc45b7b9fa7c272da2e1d7</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>5</th>
      <td>3</td>
      <td>7</td>
      <td>7</td>
      <td>2</td>
      <td>2298d6c36e964ae4a3e7e9706d1fb8c2</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <th>6</th>
      <td>2</td>
      <td>10</td>
      <td>10</td>
      <td>2</td>
      <td>fafdcd668e3743c1bb461111dcafc2a4</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <th>7</th>
      <td>0</td>
      <td>0</td>
      <td>3</td>
      <td>3</td>
      <td>5a8bc65990b245e5a138643cd4eb9837</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>8</th>
      <td>5</td>
      <td>5</td>
      <td>5</td>
      <td>1</td>
      <td>f19421c1d4aa40978ebb69ca19b0e20d</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <th>9</th>
      <td>2</td>
      <td>10</td>
      <td>7</td>
      <td>2</td>
      <td>2906b810c7d4411798c6938adc9daaa5</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="cell" data-execution_count="112">
<div class="sourceCode cell-code" id="cb136"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a>profile[:<span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="112">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>gender</th>
      <th>customer_id</th>
      <th>year</th>
      <th>quarter</th>
      <th>age_group</th>
      <th>income_range</th>
      <th>member_type</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>F</td>
      <td>0610b486422d4921ae7d2bf64640c50b</td>
      <td>2017</td>
      <td>3</td>
      <td>3</td>
      <td>5</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>F</td>
      <td>78afa995795e4d85b5d9ceeca43f5fef</td>
      <td>2017</td>
      <td>2</td>
      <td>4</td>
      <td>5</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>5</th>
      <td>M</td>
      <td>e2127556f4f64592b11af22de27a7932</td>
      <td>2018</td>
      <td>2</td>
      <td>4</td>
      <td>3</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>8</th>
      <td>M</td>
      <td>389bc3fa690240e798340f5a15918d5c</td>
      <td>2018</td>
      <td>1</td>
      <td>4</td>
      <td>3</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>12</th>
      <td>M</td>
      <td>2eeac8d8feae4a8cad5a6af0499a211d</td>
      <td>2017</td>
      <td>4</td>
      <td>3</td>
      <td>3</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="cell" data-execution_count="113">
<div class="sourceCode cell-code" id="cb137"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a>profile_transcript_df<span class="op">=</span>profile.merge(updated_cleaned_transcript, on<span class="op">=</span><span class="st">'customer_id'</span>, how<span class="op">=</span><span class="st">'right'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="114">
<div class="sourceCode cell-code" id="cb138"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(profile_transcript_df) <span class="op">==</span> <span class="bu">len</span>(updated_cleaned_transcript)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="114">
<pre><code>True</code></pre>
</div>
</div>
<div class="cell" data-execution_count="115">
<div class="sourceCode cell-code" id="cb140"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a>complete_df <span class="op">=</span> portfolio_clean.merge(profile_transcript_df, on<span class="op">=</span><span class="st">'offer_id'</span>, how<span class="op">=</span><span class="st">'right'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Create a copy of the merged dataframe for EDA</p>
<div class="cell" data-execution_count="116">
<div class="sourceCode cell-code" id="cb141"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a>master_df<span class="op">=</span>complete_df.copy()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Create another copy that we will use for customer segmentation</p>
<div class="cell" data-execution_count="117">
<div class="sourceCode cell-code" id="cb142"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a>clustering_df<span class="op">=</span>master_df.copy()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="118">
<div class="sourceCode cell-code" id="cb143"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a><span class="co"># reconverting the values of the following features from numerical values to its original categorical values.</span></span>
<span id="cb143-2"><a href="#cb143-2" aria-hidden="true" tabindex="-1"></a>master_df[<span class="st">'offer_type'</span>] <span class="op">=</span> master_df[<span class="st">'offer_type'</span>].<span class="bu">map</span>({<span class="dv">1</span>: <span class="st">'BOGO'</span>, <span class="dv">2</span>: <span class="st">'Discount'</span>, <span class="dv">3</span>: <span class="st">'Informational'</span>})</span>
<span id="cb143-3"><a href="#cb143-3" aria-hidden="true" tabindex="-1"></a>master_df[<span class="st">'income_range'</span>] <span class="op">=</span> master_df[<span class="st">'income_range'</span>].<span class="bu">map</span>({<span class="dv">1</span>: <span class="st">'low'</span>, <span class="dv">2</span>: <span class="st">'low_to_mid'</span>, <span class="dv">3</span>:<span class="st">'mid'</span>,<span class="dv">4</span>:<span class="st">'mid_to_high'</span>,<span class="dv">5</span>:<span class="st">'high'</span>})</span>
<span id="cb143-4"><a href="#cb143-4" aria-hidden="true" tabindex="-1"></a>master_df[<span class="st">'age_group'</span>] <span class="op">=</span> master_df[<span class="st">'age_group'</span>].<span class="bu">map</span>({<span class="dv">1</span>: <span class="st">'teenager'</span>, <span class="dv">2</span>: <span class="st">'young-adult'</span>, <span class="dv">3</span>:<span class="st">'adult'</span>, <span class="dv">4</span>:<span class="st">'elderly'</span>})</span>
<span id="cb143-5"><a href="#cb143-5" aria-hidden="true" tabindex="-1"></a>master_df[<span class="st">'member_type'</span>] <span class="op">=</span> master_df[<span class="st">'member_type'</span>].<span class="bu">map</span>({<span class="dv">1</span>: <span class="st">'new'</span>, <span class="dv">2</span>: <span class="st">'regular'</span>, <span class="dv">3</span>:<span class="st">'loyal'</span>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="119">
<div class="sourceCode cell-code" id="cb144"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a>master_df[<span class="st">'offer_type'</span>].value_counts()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="119">
<pre><code>BOGO             50077
Discount         47491
Informational    22660
Name: offer_type, dtype: int64</code></pre>
</div>
</div>
<section id="connect-transaction-with-informational-offer" class="level4">
<h4 class="anchored" data-anchor-id="connect-transaction-with-informational-offer">Connect “transaction” with “informational” offer</h4>
<p>We want to connect informational offer with transaction done. Such that all the offer completed rows can show the offer type that was completed. Then all the remaining transactions will be for uncompleted offers. To find such transactions, we need to make sure that:</p>
<ol type="1">
<li>Offer type is “informational”</li>
<li>Customer saw the offer - “offer_viewed” is true</li>
<li>The same customer made a purchase within <strong>offer validity period</strong></li>
</ol>
<div class="cell" data-execution_count="120">
<div class="sourceCode cell-code" id="cb146"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>time</span>
<span id="cb146-2"><a href="#cb146-2" aria-hidden="true" tabindex="-1"></a><span class="co">##added offer received to see what it does</span></span>
<span id="cb146-3"><a href="#cb146-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Total rows: </span><span class="sc">{}</span><span class="st">"</span>.<span class="bu">format</span>(<span class="bu">len</span>(master_df)))</span>
<span id="cb146-4"><a href="#cb146-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Total "transaction" rows: </span><span class="sc">{}</span><span class="st">'</span>.<span class="bu">format</span>(<span class="bu">len</span>(master_df[master_df.event <span class="op">==</span> <span class="st">"transaction"</span>])))</span>
<span id="cb146-5"><a href="#cb146-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-6"><a href="#cb146-6" aria-hidden="true" tabindex="-1"></a>rows_to_drop <span class="op">=</span> [] </span>
<span id="cb146-7"><a href="#cb146-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-8"><a href="#cb146-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Check all informational offers that were viewed:</span></span>
<span id="cb146-9"><a href="#cb146-9" aria-hidden="true" tabindex="-1"></a>informational_df <span class="op">=</span> master_df.loc[(master_df.offer_type <span class="op">==</span> <span class="st">"Informational"</span>)  <span class="op">&amp;</span> (master_df.event <span class="op">==</span> <span class="st">"offer viewed"</span>)]</span>
<span id="cb146-10"><a href="#cb146-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> index, row <span class="kw">in</span> informational_df.iterrows():</span>
<span id="cb146-11"><a href="#cb146-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb146-12"><a href="#cb146-12" aria-hidden="true" tabindex="-1"></a>    customer <span class="op">=</span> master_df.at[index, <span class="st">'customer_id'</span>] <span class="co"># get customer id</span></span>
<span id="cb146-13"><a href="#cb146-13" aria-hidden="true" tabindex="-1"></a>    duration_hrs <span class="op">=</span> master_df.at[index, <span class="st">'offer_duration_days'</span>] <span class="co"># get offer duration</span></span>
<span id="cb146-14"><a href="#cb146-14" aria-hidden="true" tabindex="-1"></a>    viewed_time <span class="op">=</span> master_df.at[index, <span class="st">'time'</span>] <span class="co"># get the time when offer was viewed</span></span>
<span id="cb146-15"><a href="#cb146-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb146-16"><a href="#cb146-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check all transactions of this particular customer:</span></span>
<span id="cb146-17"><a href="#cb146-17" aria-hidden="true" tabindex="-1"></a>    transaction_df <span class="op">=</span> master_df.loc[(master_df.event <span class="op">==</span> <span class="st">"transaction"</span>) <span class="op">&amp;</span> (master_df.customer_id <span class="op">==</span> customer)]</span>
<span id="cb146-18"><a href="#cb146-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> transaction_index, transaction_row <span class="kw">in</span> transaction_df.iterrows():</span>
<span id="cb146-19"><a href="#cb146-19" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb146-20"><a href="#cb146-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> master_df.at[transaction_index, <span class="st">'time'</span>] <span class="op">&gt;=</span> viewed_time: <span class="co"># transaction was AFTER offer was viewed</span></span>
<span id="cb146-21"><a href="#cb146-21" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (master_df.at[transaction_index, <span class="st">'time'</span>] <span class="op">-</span> viewed_time) <span class="op">&gt;=</span> duration_hrs: <span class="co"># offer was still VALID</span></span>
<span id="cb146-22"><a href="#cb146-22" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb146-23"><a href="#cb146-23" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="st">"Updating row nr. "</span> <span class="op">+</span> <span class="bu">str</span>(index)</span>
<span id="cb146-24"><a href="#cb146-24" aria-hidden="true" tabindex="-1"></a>                      <span class="op">+</span> <span class="st">" "</span><span class="op">*</span><span class="dv">100</span>, end<span class="op">=</span><span class="st">"</span><span class="ch">\r</span><span class="st">"</span>) <span class="co"># erase output and print on the same line</span></span>
<span id="cb146-25"><a href="#cb146-25" aria-hidden="true" tabindex="-1"></a>               </span>
<span id="cb146-26"><a href="#cb146-26" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Update the event (offer viewed) row:</span></span>
<span id="cb146-27"><a href="#cb146-27" aria-hidden="true" tabindex="-1"></a>                master_df.at[index, <span class="st">'money_spent'</span>] <span class="op">=</span> master_df.at[transaction_index, <span class="st">'money_spent'</span>]</span>
<span id="cb146-28"><a href="#cb146-28" aria-hidden="true" tabindex="-1"></a>                master_df.at[index, <span class="st">'event'</span>] <span class="op">=</span> <span class="st">"offer completed"</span></span>
<span id="cb146-29"><a href="#cb146-29" aria-hidden="true" tabindex="-1"></a>                master_df.at[index, <span class="st">'offer_completed'</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb146-30"><a href="#cb146-30" aria-hidden="true" tabindex="-1"></a>                master_df.at[index, <span class="st">'transaction'</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb146-31"><a href="#cb146-31" aria-hidden="true" tabindex="-1"></a>                master_df.at[index, <span class="st">'time'</span>] <span class="op">=</span> master_df.at[transaction_index, <span class="st">'time'</span>]</span>
<span id="cb146-32"><a href="#cb146-32" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb146-33"><a href="#cb146-33" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Drop the transaction row later:</span></span>
<span id="cb146-34"><a href="#cb146-34" aria-hidden="true" tabindex="-1"></a>                rows_to_drop.append(transaction_index)  </span>
<span id="cb146-35"><a href="#cb146-35" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb146-36"><a href="#cb146-36" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span> <span class="co"># to skip any later transactions and just use the first one that matches our search</span></span>
<span id="cb146-37"><a href="#cb146-37" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb146-38"><a href="#cb146-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-39"><a href="#cb146-39" aria-hidden="true" tabindex="-1"></a>master_df <span class="op">=</span> master_df[<span class="op">~</span>master_df.index.isin(rows_to_drop)] <span class="co"># faster alternative to dropping rows one by one</span></span>
<span id="cb146-40"><a href="#cb146-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-41"><a href="#cb146-41" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Rows after job is finished: </span><span class="sc">{}</span><span class="st">"</span>.<span class="bu">format</span>(<span class="bu">len</span>(master_df)))</span>
<span id="cb146-42"><a href="#cb146-42" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Transaction rows after job is finished: </span><span class="sc">{}</span><span class="st">"</span>.<span class="bu">format</span>(<span class="bu">len</span>(master_df[master_df.event <span class="op">==</span> <span class="st">"transaction"</span>])))</span>
<span id="cb146-43"><a href="#cb146-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-44"><a href="#cb146-44" aria-hidden="true" tabindex="-1"></a>master_df[(master_df.offer_type <span class="op">==</span> <span class="st">"Informational"</span>) <span class="op">&amp;</span> (master_df.event <span class="op">==</span> <span class="st">"offer completed"</span>)].head(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 6 µs, sys: 0 ns, total: 6 µs
Wall time: 11.7 µs
Total rows: 214604
Total "transaction" rows: 94376
Rows after job is finished: 208256                                                                                         
Transaction rows after job is finished: 88028</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="120">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>possible_reward</th>
      <th>spent_required</th>
      <th>offer_duration_days</th>
      <th>offer_type</th>
      <th>offer_id</th>
      <th>channel_email</th>
      <th>channel_mobile</th>
      <th>channel_social</th>
      <th>channel_web</th>
      <th>gender</th>
      <th>...</th>
      <th>Unnamed: 0</th>
      <th>event</th>
      <th>time</th>
      <th>money_spent</th>
      <th>money_gained</th>
      <th>offer_completed</th>
      <th>offer_received</th>
      <th>offer_viewed</th>
      <th>transaction</th>
      <th>auto_completed</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>105909</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>3.0</td>
      <td>Informational</td>
      <td>5a8bc65990b245e5a138643cd4eb9837</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>F</td>
      <td>...</td>
      <td>85291</td>
      <td>offer completed</td>
      <td>15.75</td>
      <td>23.93</td>
      <td>0.0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>105911</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>3.0</td>
      <td>Informational</td>
      <td>5a8bc65990b245e5a138643cd4eb9837</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>F</td>
      <td>...</td>
      <td>123541</td>
      <td>offer completed</td>
      <td>19.00</td>
      <td>23.30</td>
      <td>0.0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>105913</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>3.0</td>
      <td>Informational</td>
      <td>5a8bc65990b245e5a138643cd4eb9837</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>F</td>
      <td>...</td>
      <td>77214</td>
      <td>offer completed</td>
      <td>15.00</td>
      <td>22.99</td>
      <td>0.0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
<p>3 rows × 26 columns</p>
</div>
</div>
</div>
<div class="cell" data-execution_count="121">
<div class="sourceCode cell-code" id="cb148"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Number of informational offers that were viewed but not completed:"</span>)</span>
<span id="cb148-2"><a href="#cb148-2" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(master_df[(master_df.offer_type <span class="op">==</span> <span class="st">"Informational"</span>) <span class="op">&amp;</span> (master_df.event <span class="op">==</span> <span class="st">"offer viewed"</span>)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Number of informational offers that were viewed but not completed:</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="121">
<pre><code>2778</code></pre>
</div>
</div>
</section>
<section id="connect-transaction-with-bogo-offer" class="level4">
<h4 class="anchored" data-anchor-id="connect-transaction-with-bogo-offer">Connect “transaction” with “bogo” offer</h4>
<p>We want to connect bogo offer with transaction done. Such that all the offer completed rows can show the offer type that was completed. Then all the remaining transactions will be for uncompleted offers. To find such transactions, we need to make sure that:</p>
<ol type="1">
<li>Offer type is “informational”</li>
<li>Customer received saw the offer - “offer_viewed” is true</li>
<li>The same customer made a purchase within <strong>offer validity period</strong></li>
</ol>
<div class="cell" data-execution_count="122">
<div class="sourceCode cell-code" id="cb151"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb151-1"><a href="#cb151-1" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>time</span>
<span id="cb151-2"><a href="#cb151-2" aria-hidden="true" tabindex="-1"></a><span class="co">##added offer received to see what it does</span></span>
<span id="cb151-3"><a href="#cb151-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Total rows: </span><span class="sc">{}</span><span class="st">"</span>.<span class="bu">format</span>(<span class="bu">len</span>(master_df)))</span>
<span id="cb151-4"><a href="#cb151-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Total "transaction" rows: </span><span class="sc">{}</span><span class="st">'</span>.<span class="bu">format</span>(<span class="bu">len</span>(master_df[master_df.event <span class="op">==</span> <span class="st">"transaction"</span>])))</span>
<span id="cb151-5"><a href="#cb151-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb151-6"><a href="#cb151-6" aria-hidden="true" tabindex="-1"></a>rows_to_drop <span class="op">=</span> [] </span>
<span id="cb151-7"><a href="#cb151-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb151-8"><a href="#cb151-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Check all informational offers that were viewed:</span></span>
<span id="cb151-9"><a href="#cb151-9" aria-hidden="true" tabindex="-1"></a>informational_df <span class="op">=</span> master_df.loc[(master_df.offer_type <span class="op">==</span> <span class="st">"BOGO"</span>)  <span class="op">&amp;</span> (master_df.event <span class="op">==</span> <span class="st">"offer viewed"</span>)]</span>
<span id="cb151-10"><a href="#cb151-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> index, row <span class="kw">in</span> informational_df.iterrows():</span>
<span id="cb151-11"><a href="#cb151-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb151-12"><a href="#cb151-12" aria-hidden="true" tabindex="-1"></a>    customer <span class="op">=</span> master_df.at[index, <span class="st">'customer_id'</span>] <span class="co"># get customer id</span></span>
<span id="cb151-13"><a href="#cb151-13" aria-hidden="true" tabindex="-1"></a>    duration_hrs <span class="op">=</span> master_df.at[index, <span class="st">'offer_duration_days'</span>] <span class="co"># get offer duration</span></span>
<span id="cb151-14"><a href="#cb151-14" aria-hidden="true" tabindex="-1"></a>    viewed_time <span class="op">=</span> master_df.at[index, <span class="st">'time'</span>] <span class="co"># get the time when offer was viewed</span></span>
<span id="cb151-15"><a href="#cb151-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb151-16"><a href="#cb151-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check all transactions of this particular customer:</span></span>
<span id="cb151-17"><a href="#cb151-17" aria-hidden="true" tabindex="-1"></a>    transaction_df <span class="op">=</span> master_df.loc[(master_df.event <span class="op">==</span> <span class="st">"transaction"</span>) <span class="op">&amp;</span> (master_df.customer_id <span class="op">==</span> customer)]</span>
<span id="cb151-18"><a href="#cb151-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> transaction_index, transaction_row <span class="kw">in</span> transaction_df.iterrows():</span>
<span id="cb151-19"><a href="#cb151-19" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb151-20"><a href="#cb151-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> master_df.at[transaction_index, <span class="st">'time'</span>] <span class="op">&gt;=</span> viewed_time: <span class="co"># transaction was AFTER offer was viewed</span></span>
<span id="cb151-21"><a href="#cb151-21" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (master_df.at[transaction_index, <span class="st">'time'</span>] <span class="op">-</span> viewed_time) <span class="op">&gt;=</span> duration_hrs: <span class="co"># offer was still VALID</span></span>
<span id="cb151-22"><a href="#cb151-22" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb151-23"><a href="#cb151-23" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="st">"Updating row nr. "</span> <span class="op">+</span> <span class="bu">str</span>(index)</span>
<span id="cb151-24"><a href="#cb151-24" aria-hidden="true" tabindex="-1"></a>                      <span class="op">+</span> <span class="st">" "</span><span class="op">*</span><span class="dv">100</span>, end<span class="op">=</span><span class="st">"</span><span class="ch">\r</span><span class="st">"</span>) <span class="co"># erase output and print on the same line</span></span>
<span id="cb151-25"><a href="#cb151-25" aria-hidden="true" tabindex="-1"></a>               </span>
<span id="cb151-26"><a href="#cb151-26" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Update the event (offer viewed) row:</span></span>
<span id="cb151-27"><a href="#cb151-27" aria-hidden="true" tabindex="-1"></a>                master_df.at[index, <span class="st">'money_spent'</span>] <span class="op">=</span> master_df.at[transaction_index, <span class="st">'money_spent'</span>]</span>
<span id="cb151-28"><a href="#cb151-28" aria-hidden="true" tabindex="-1"></a>                master_df.at[index, <span class="st">'event'</span>] <span class="op">=</span> <span class="st">"offer completed"</span></span>
<span id="cb151-29"><a href="#cb151-29" aria-hidden="true" tabindex="-1"></a>                master_df.at[index, <span class="st">'offer_completed'</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb151-30"><a href="#cb151-30" aria-hidden="true" tabindex="-1"></a>                master_df.at[index, <span class="st">'transaction'</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb151-31"><a href="#cb151-31" aria-hidden="true" tabindex="-1"></a>                master_df.at[index, <span class="st">'time'</span>] <span class="op">=</span> master_df.at[transaction_index, <span class="st">'time'</span>]</span>
<span id="cb151-32"><a href="#cb151-32" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb151-33"><a href="#cb151-33" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Drop the transaction row later:</span></span>
<span id="cb151-34"><a href="#cb151-34" aria-hidden="true" tabindex="-1"></a>                rows_to_drop.append(transaction_index)  </span>
<span id="cb151-35"><a href="#cb151-35" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb151-36"><a href="#cb151-36" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span> <span class="co"># to skip any later transactions and just use the first one that matches our search</span></span>
<span id="cb151-37"><a href="#cb151-37" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb151-38"><a href="#cb151-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb151-39"><a href="#cb151-39" aria-hidden="true" tabindex="-1"></a>master_df <span class="op">=</span> master_df[<span class="op">~</span>master_df.index.isin(rows_to_drop)] <span class="co"># faster alternative to dropping rows one by one</span></span>
<span id="cb151-40"><a href="#cb151-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb151-41"><a href="#cb151-41" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Rows after job is finished: </span><span class="sc">{}</span><span class="st">"</span>.<span class="bu">format</span>(<span class="bu">len</span>(master_df)))</span>
<span id="cb151-42"><a href="#cb151-42" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Transaction rows after job is finished: </span><span class="sc">{}</span><span class="st">"</span>.<span class="bu">format</span>(<span class="bu">len</span>(master_df[master_df.event <span class="op">==</span> <span class="st">"transaction"</span>])))</span>
<span id="cb151-43"><a href="#cb151-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb151-44"><a href="#cb151-44" aria-hidden="true" tabindex="-1"></a>master_df[(master_df.offer_type <span class="op">==</span> <span class="st">"BOGO"</span>) <span class="op">&amp;</span> (master_df.event <span class="op">==</span> <span class="st">"offer completed"</span>)].head(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 7 µs, sys: 0 ns, total: 7 µs
Wall time: 11.7 µs
Total rows: 208256
Total "transaction" rows: 88028
Rows after job is finished: 203163                                                                                         
Transaction rows after job is finished: 82935</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="122">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>possible_reward</th>
      <th>spent_required</th>
      <th>offer_duration_days</th>
      <th>offer_type</th>
      <th>offer_id</th>
      <th>channel_email</th>
      <th>channel_mobile</th>
      <th>channel_social</th>
      <th>channel_web</th>
      <th>gender</th>
      <th>...</th>
      <th>Unnamed: 0</th>
      <th>event</th>
      <th>time</th>
      <th>money_spent</th>
      <th>money_gained</th>
      <th>offer_completed</th>
      <th>offer_received</th>
      <th>offer_viewed</th>
      <th>transaction</th>
      <th>auto_completed</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>5.0</td>
      <td>5.0</td>
      <td>7.0</td>
      <td>BOGO</td>
      <td>9b98b8c7a33c4b65b9aebfe6a799e6d9</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>F</td>
      <td>...</td>
      <td>47583</td>
      <td>offer completed</td>
      <td>5.50</td>
      <td>19.89</td>
      <td>5.0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>6</th>
      <td>5.0</td>
      <td>5.0</td>
      <td>7.0</td>
      <td>BOGO</td>
      <td>9b98b8c7a33c4b65b9aebfe6a799e6d9</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>M</td>
      <td>...</td>
      <td>200086</td>
      <td>offer completed</td>
      <td>20.75</td>
      <td>15.63</td>
      <td>5.0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>18</th>
      <td>5.0</td>
      <td>5.0</td>
      <td>7.0</td>
      <td>BOGO</td>
      <td>9b98b8c7a33c4b65b9aebfe6a799e6d9</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>M</td>
      <td>...</td>
      <td>29498</td>
      <td>offer completed</td>
      <td>16.25</td>
      <td>1.54</td>
      <td>0.0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
<p>3 rows × 26 columns</p>
</div>
</div>
</div>
<div class="cell" data-execution_count="123">
<div class="sourceCode cell-code" id="cb153"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb153-1"><a href="#cb153-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Number of BOGO offers that were viewed but not completed:"</span>)</span>
<span id="cb153-2"><a href="#cb153-2" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(master_df[(master_df.offer_type <span class="op">==</span> <span class="st">"BOGO"</span>) <span class="op">&amp;</span> (master_df.event <span class="op">==</span> <span class="st">"offer viewed"</span>)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Number of BOGO offers that were viewed but not completed:</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="123">
<pre><code>3958</code></pre>
</div>
</div>
</section>
<section id="connect-transaction-with-discount-offer" class="level4">
<h4 class="anchored" data-anchor-id="connect-transaction-with-discount-offer">Connect “transaction” with “discount” offer</h4>
<p>We want to connect bogo offer with transaction done. Such that all the offer completed rows can show the offer type that was completed. Then all the remaining transactions will be for uncompleted offers. To find such transactions, we need to make sure that:</p>
<ol type="1">
<li>Offer type is “discount”</li>
<li>Customer received and saw the offer - “offer_viewed” is true</li>
<li>The same customer made a purchase within <strong>offer validity period</strong></li>
</ol>
<div class="cell" data-execution_count="124">
<div class="sourceCode cell-code" id="cb156"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb156-1"><a href="#cb156-1" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>time</span>
<span id="cb156-2"><a href="#cb156-2" aria-hidden="true" tabindex="-1"></a><span class="co">##added offer received to see what it does</span></span>
<span id="cb156-3"><a href="#cb156-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Total rows: </span><span class="sc">{}</span><span class="st">"</span>.<span class="bu">format</span>(<span class="bu">len</span>(master_df)))</span>
<span id="cb156-4"><a href="#cb156-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Total "transaction" rows: </span><span class="sc">{}</span><span class="st">'</span>.<span class="bu">format</span>(<span class="bu">len</span>(master_df[master_df.event <span class="op">==</span> <span class="st">"transaction"</span>])))</span>
<span id="cb156-5"><a href="#cb156-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-6"><a href="#cb156-6" aria-hidden="true" tabindex="-1"></a>rows_to_drop <span class="op">=</span> [] </span>
<span id="cb156-7"><a href="#cb156-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-8"><a href="#cb156-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Check all informational offers that were viewed:</span></span>
<span id="cb156-9"><a href="#cb156-9" aria-hidden="true" tabindex="-1"></a>informational_df <span class="op">=</span> master_df.loc[(master_df.offer_type <span class="op">==</span> <span class="st">"Discount"</span>) <span class="op">&amp;</span> (master_df.event <span class="op">==</span> <span class="st">"offer received"</span>)</span>
<span id="cb156-10"><a href="#cb156-10" aria-hidden="true" tabindex="-1"></a>                                 <span class="op">&amp;</span> (master_df.event <span class="op">==</span> <span class="st">"offer viewed"</span>)]</span>
<span id="cb156-11"><a href="#cb156-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> index, row <span class="kw">in</span> informational_df.iterrows():</span>
<span id="cb156-12"><a href="#cb156-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb156-13"><a href="#cb156-13" aria-hidden="true" tabindex="-1"></a>    customer <span class="op">=</span> master_df.at[index, <span class="st">'customer_id'</span>] <span class="co"># get customer id</span></span>
<span id="cb156-14"><a href="#cb156-14" aria-hidden="true" tabindex="-1"></a>    duration_hrs <span class="op">=</span> master_df.at[index, <span class="st">'offer_duration_days'</span>] <span class="co"># get offer duration</span></span>
<span id="cb156-15"><a href="#cb156-15" aria-hidden="true" tabindex="-1"></a>    viewed_time <span class="op">=</span> master_df.at[index, <span class="st">'time'</span>] <span class="co"># get the time when offer was viewed</span></span>
<span id="cb156-16"><a href="#cb156-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb156-17"><a href="#cb156-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check all transactions of this particular customer:</span></span>
<span id="cb156-18"><a href="#cb156-18" aria-hidden="true" tabindex="-1"></a>    transaction_df <span class="op">=</span> master_df.loc[(master_df.event <span class="op">==</span> <span class="st">"transaction"</span>) <span class="op">&amp;</span> (master_df.customer_id <span class="op">==</span> customer)]</span>
<span id="cb156-19"><a href="#cb156-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> transaction_index, transaction_row <span class="kw">in</span> transaction_df.iterrows():</span>
<span id="cb156-20"><a href="#cb156-20" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb156-21"><a href="#cb156-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> master_df.at[transaction_index, <span class="st">'time'</span>] <span class="op">&gt;=</span> viewed_time: <span class="co"># transaction was AFTER offer was viewed</span></span>
<span id="cb156-22"><a href="#cb156-22" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (master_df.at[transaction_index, <span class="st">'time'</span>] <span class="op">-</span> viewed_time) <span class="op">&gt;=</span> duration_hrs: <span class="co"># offer was still VALID</span></span>
<span id="cb156-23"><a href="#cb156-23" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb156-24"><a href="#cb156-24" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="st">"Updating row nr. "</span> <span class="op">+</span> <span class="bu">str</span>(index)</span>
<span id="cb156-25"><a href="#cb156-25" aria-hidden="true" tabindex="-1"></a>                      <span class="op">+</span> <span class="st">" "</span><span class="op">*</span><span class="dv">100</span>, end<span class="op">=</span><span class="st">"</span><span class="ch">\r</span><span class="st">"</span>) <span class="co"># erase output and print on the same line</span></span>
<span id="cb156-26"><a href="#cb156-26" aria-hidden="true" tabindex="-1"></a>               </span>
<span id="cb156-27"><a href="#cb156-27" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Update the event (offer viewed) row:</span></span>
<span id="cb156-28"><a href="#cb156-28" aria-hidden="true" tabindex="-1"></a>                master_df.at[index, <span class="st">'money_spent'</span>] <span class="op">=</span> master_df.at[transaction_index, <span class="st">'money_spent'</span>]</span>
<span id="cb156-29"><a href="#cb156-29" aria-hidden="true" tabindex="-1"></a>                master_df.at[index, <span class="st">'event'</span>] <span class="op">=</span> <span class="st">"offer completed"</span></span>
<span id="cb156-30"><a href="#cb156-30" aria-hidden="true" tabindex="-1"></a>                master_df.at[index, <span class="st">'offer_completed'</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb156-31"><a href="#cb156-31" aria-hidden="true" tabindex="-1"></a>                master_df.at[index, <span class="st">'transaction'</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb156-32"><a href="#cb156-32" aria-hidden="true" tabindex="-1"></a>                master_df.at[index, <span class="st">'time'</span>] <span class="op">=</span> master_df.at[transaction_index, <span class="st">'time'</span>]</span>
<span id="cb156-33"><a href="#cb156-33" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb156-34"><a href="#cb156-34" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Drop the transaction row later:</span></span>
<span id="cb156-35"><a href="#cb156-35" aria-hidden="true" tabindex="-1"></a>                rows_to_drop.append(transaction_index)  </span>
<span id="cb156-36"><a href="#cb156-36" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb156-37"><a href="#cb156-37" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span> <span class="co"># to skip any later transactions and just use the first one that matches our search</span></span>
<span id="cb156-38"><a href="#cb156-38" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb156-39"><a href="#cb156-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-40"><a href="#cb156-40" aria-hidden="true" tabindex="-1"></a>master_df <span class="op">=</span> master_df[<span class="op">~</span>master_df.index.isin(rows_to_drop)] <span class="co"># faster alternative to dropping rows one by one</span></span>
<span id="cb156-41"><a href="#cb156-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-42"><a href="#cb156-42" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Rows after job is finished: </span><span class="sc">{}</span><span class="st">"</span>.<span class="bu">format</span>(<span class="bu">len</span>(master_df)))</span>
<span id="cb156-43"><a href="#cb156-43" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Transaction rows after job is finished: </span><span class="sc">{}</span><span class="st">"</span>.<span class="bu">format</span>(<span class="bu">len</span>(master_df[master_df.event <span class="op">==</span> <span class="st">"transaction"</span>])))</span>
<span id="cb156-44"><a href="#cb156-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-45"><a href="#cb156-45" aria-hidden="true" tabindex="-1"></a>master_df[(master_df.offer_type <span class="op">==</span> <span class="st">"Discount"</span>) <span class="op">&amp;</span> (master_df.event <span class="op">==</span> <span class="st">"offer completed"</span>)].head(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 3 µs, sys: 0 ns, total: 3 µs
Wall time: 6.68 µs
Total rows: 203163
Total "transaction" rows: 82935
Rows after job is finished: 203163
Transaction rows after job is finished: 82935</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="124">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>possible_reward</th>
      <th>spent_required</th>
      <th>offer_duration_days</th>
      <th>offer_type</th>
      <th>offer_id</th>
      <th>channel_email</th>
      <th>channel_mobile</th>
      <th>channel_social</th>
      <th>channel_web</th>
      <th>gender</th>
      <th>...</th>
      <th>Unnamed: 0</th>
      <th>event</th>
      <th>time</th>
      <th>money_spent</th>
      <th>money_gained</th>
      <th>offer_completed</th>
      <th>offer_received</th>
      <th>offer_viewed</th>
      <th>transaction</th>
      <th>auto_completed</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>144112</th>
      <td>2.0</td>
      <td>10.0</td>
      <td>7.0</td>
      <td>Discount</td>
      <td>2906b810c7d4411798c6938adc9daaa5</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>F</td>
      <td>...</td>
      <td>77217</td>
      <td>offer completed</td>
      <td>8.0</td>
      <td>27.23</td>
      <td>2.0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>144114</th>
      <td>2.0</td>
      <td>10.0</td>
      <td>7.0</td>
      <td>Discount</td>
      <td>2906b810c7d4411798c6938adc9daaa5</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>M</td>
      <td>...</td>
      <td>177270</td>
      <td>offer completed</td>
      <td>18.0</td>
      <td>11.50</td>
      <td>2.0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>144118</th>
      <td>2.0</td>
      <td>10.0</td>
      <td>7.0</td>
      <td>Discount</td>
      <td>2906b810c7d4411798c6938adc9daaa5</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>M</td>
      <td>...</td>
      <td>106954</td>
      <td>offer completed</td>
      <td>13.0</td>
      <td>115.00</td>
      <td>2.0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
<p>3 rows × 26 columns</p>
</div>
</div>
</div>
<div class="cell" data-execution_count="125">
<div class="sourceCode cell-code" id="cb158"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb158-1"><a href="#cb158-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Number of Discount offers that were viewed but not completed:"</span>)</span>
<span id="cb158-2"><a href="#cb158-2" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(master_df[(master_df.offer_type <span class="op">==</span> <span class="st">"Discount"</span>) <span class="op">&amp;</span> (master_df.event <span class="op">==</span> <span class="st">"offer viewed"</span>)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Number of Discount offers that were viewed but not completed:</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="125">
<pre><code>5460</code></pre>
</div>
</div>
</section>
</section>
<section id="distribution-of-age-groups-among-customers" class="level3">
<h3 class="anchored" data-anchor-id="distribution-of-age-groups-among-customers">Distribution of Age Groups among customers</h3>
<div class="cell" data-execution_count="126">
<div class="sourceCode cell-code" id="cb161"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb161-1"><a href="#cb161-1" aria-hidden="true" tabindex="-1"></a>sns.countplot(master_df[<span class="st">'age_group'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="126">
<pre><code>&lt;AxesSubplot:xlabel='age_group', ylabel='count'&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="2021-07-14-Starbucks-Optimising-Customer-Segmentation-with-Random-Forest-and-Gradient-Boosting_files/figure-html/cell-127-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="127">
<div class="sourceCode cell-code" id="cb163"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb163-1"><a href="#cb163-1" aria-hidden="true" tabindex="-1"></a>master_df[<span class="st">'age_group'</span>].value_counts()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="127">
<pre><code>adult          93596
elderly        72478
young-adult    27734
teenager        9355
Name: age_group, dtype: int64</code></pre>
</div>
</div>
<p>The distribution of ages among starbucks customers is skewed towards the older group. The elderly are the largest population followed by the adults. Teenagers are the smallest group</p>
</section>
<section id="distribution-of-gender-among-customers" class="level3">
<h3 class="anchored" data-anchor-id="distribution-of-gender-among-customers">Distribution of Gender among customers</h3>
<div class="cell" data-execution_count="128">
<div class="sourceCode cell-code" id="cb165"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb165-1"><a href="#cb165-1" aria-hidden="true" tabindex="-1"></a>sns.countplot(master_df[<span class="st">'gender'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="128">
<pre><code>&lt;AxesSubplot:xlabel='gender', ylabel='count'&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="2021-07-14-Starbucks-Optimising-Customer-Segmentation-with-Random-Forest-and-Gradient-Boosting_files/figure-html/cell-129-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="129">
<div class="sourceCode cell-code" id="cb167"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb167-1"><a href="#cb167-1" aria-hidden="true" tabindex="-1"></a>master_df[<span class="st">'gender'</span>].value_counts()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="129">
<pre><code>M    118718
F     81552
O      2893
Name: gender, dtype: int64</code></pre>
</div>
</div>
<p>58.6 % of customers are male, 39.8% are female and 1.4% prefer not to specify gender</p>
</section>
<section id="distribution-of-income-among-customers" class="level3">
<h3 class="anchored" data-anchor-id="distribution-of-income-among-customers">Distribution of income among customers</h3>
<div class="cell" data-execution_count="130">
<div class="sourceCode cell-code" id="cb169"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb169-1"><a href="#cb169-1" aria-hidden="true" tabindex="-1"></a>sns.countplot(master_df[<span class="st">'income_range'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="130">
<pre><code>&lt;AxesSubplot:xlabel='income_range', ylabel='count'&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="2021-07-14-Starbucks-Optimising-Customer-Segmentation-with-Random-Forest-and-Gradient-Boosting_files/figure-html/cell-131-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>Middle income and low_to_mid income earners are occupy a huge proportion of the population, with mid income earners being the dorminant. Low earners are fewer, they are the least</p>
<section id="distribution-of-income-by-gender-among-customers" class="level4">
<h4 class="anchored" data-anchor-id="distribution-of-income-by-gender-among-customers">Distribution of income by gender among customers</h4>
<div class="cell" data-execution_count="131">
<div class="sourceCode cell-code" id="cb171"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb171-1"><a href="#cb171-1" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">6</span>))</span>
<span id="cb171-2"><a href="#cb171-2" aria-hidden="true" tabindex="-1"></a>g <span class="op">=</span> sns.countplot(x<span class="op">=</span><span class="st">"income_range"</span>, hue<span class="op">=</span><span class="st">"gender"</span>, data<span class="op">=</span>master_df)</span>
<span id="cb171-3"><a href="#cb171-3" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Distribution of income per gender'</span>)</span>
<span id="cb171-4"><a href="#cb171-4" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Total'</span>)</span>
<span id="cb171-5"><a href="#cb171-5" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Type of Member'</span>)</span>
<span id="cb171-6"><a href="#cb171-6" aria-hidden="true" tabindex="-1"></a>xlabels <span class="op">=</span> [<span class="st">'low'</span>,<span class="st">'low_to_mid'</span>,<span class="st">'mid'</span>,<span class="st">'mid_to_high'</span>,<span class="st">'high'</span>]</span>
<span id="cb171-7"><a href="#cb171-7" aria-hidden="true" tabindex="-1"></a>g.set_xticklabels(xlabels)</span>
<span id="cb171-8"><a href="#cb171-8" aria-hidden="true" tabindex="-1"></a>plt.xticks(rotation <span class="op">=</span> <span class="dv">0</span>)</span>
<span id="cb171-9"><a href="#cb171-9" aria-hidden="true" tabindex="-1"></a>plt.legend(title<span class="op">=</span><span class="st">'Gender'</span>)</span>
<span id="cb171-10"><a href="#cb171-10" aria-hidden="true" tabindex="-1"></a>plt.show()<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2021-07-14-Starbucks-Optimising-Customer-Segmentation-with-Random-Forest-and-Gradient-Boosting_files/figure-html/cell-132-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="132">
<div class="sourceCode cell-code" id="cb172"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb172-1"><a href="#cb172-1" aria-hidden="true" tabindex="-1"></a>master_df.groupby([<span class="st">'income_range'</span>,<span class="st">'gender'</span>]).customer_id.count()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="132">
<pre><code>income_range  gender
high          F         14980
              M          9945
              O           230
low           F           327
              M           953
              O            62
low_to_mid    F         17953
              M         41775
              O           726
mid           F         26124
              M         44576
              O          1170
mid_to_high   F         22168
              M         21469
              O           705
Name: customer_id, dtype: int64</code></pre>
</div>
</div>
<p>Females are the highest earners. Most men are low to mid and mid earners. There’s an almost equal distribution of male and females among the mid to high bracket</p>
</section>
</section>
<section id="distribution-of-offer-type-and-offer-id-during-experiment" class="level3">
<h3 class="anchored" data-anchor-id="distribution-of-offer-type-and-offer-id-during-experiment">Distribution of Offer Type and Offer ID during experiment</h3>
<div class="cell" data-execution_count="133">
<div class="sourceCode cell-code" id="cb174"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb174-1"><a href="#cb174-1" aria-hidden="true" tabindex="-1"></a>sns.countplot(master_df[<span class="st">'offer_type'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="133">
<pre><code>&lt;AxesSubplot:xlabel='offer_type', ylabel='count'&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="2021-07-14-Starbucks-Optimising-Customer-Segmentation-with-Random-Forest-and-Gradient-Boosting_files/figure-html/cell-134-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="134">
<div class="sourceCode cell-code" id="cb176"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb176-1"><a href="#cb176-1" aria-hidden="true" tabindex="-1"></a>master_df[<span class="st">'offer_type'</span>].value_counts()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="134">
<pre><code>BOGO             50077
Discount         47491
Informational    22660
Name: offer_type, dtype: int64</code></pre>
</div>
</div>
<p>There are 3 types of offers presented to customers, BOGO, discount and informational. BOGO and discount were sent out more.BOGO was the most distributed offer, 25% of distributed offers were BOGO, 23% were Discount and 11.2% were Informational offers. There were 10 different offers from the 3 different offer types, there were 4 types of BOGO offers, 4 types of discount offers and 2 types of informational offers.</p>
</section>
<section id="distribution-of-offer-received-viewed-and-completed" class="level3">
<h3 class="anchored" data-anchor-id="distribution-of-offer-received-viewed-and-completed">Distribution of offer received viewed and completed</h3>
<div class="cell" data-execution_count="135">
<div class="sourceCode cell-code" id="cb178"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb178-1"><a href="#cb178-1" aria-hidden="true" tabindex="-1"></a>f, axes <span class="op">=</span> plt.subplots(ncols<span class="op">=</span><span class="dv">4</span>, figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">6</span>))</span>
<span id="cb178-2"><a href="#cb178-2" aria-hidden="true" tabindex="-1"></a>sns.distplot(master_df.offer_completed, kde<span class="op">=</span><span class="va">True</span>, color<span class="op">=</span><span class="st">"g"</span>, ax<span class="op">=</span>axes[<span class="dv">0</span>]).set_title(<span class="st">'Offer completed Distribution'</span>)</span>
<span id="cb178-3"><a href="#cb178-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb178-4"><a href="#cb178-4" aria-hidden="true" tabindex="-1"></a>sns.distplot(master_df.offer_received, kde<span class="op">=</span><span class="va">True</span>, color<span class="op">=</span><span class="st">"r"</span>, ax<span class="op">=</span>axes[<span class="dv">1</span>]).set_title(<span class="st">'Offer received Distribution'</span>)</span>
<span id="cb178-5"><a href="#cb178-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb178-6"><a href="#cb178-6" aria-hidden="true" tabindex="-1"></a>sns.distplot(master_df.offer_viewed, kde<span class="op">=</span><span class="va">True</span>, color<span class="op">=</span><span class="st">"r"</span>, ax<span class="op">=</span>axes[<span class="dv">2</span>]).set_title(<span class="st">'Offer viewed Distribution'</span>)</span>
<span id="cb178-7"><a href="#cb178-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb178-8"><a href="#cb178-8" aria-hidden="true" tabindex="-1"></a>sns.distplot(master_df.auto_completed, kde<span class="op">=</span><span class="va">True</span>, color<span class="op">=</span><span class="st">"b"</span>, ax<span class="op">=</span>axes[<span class="dv">3</span>]).set_title(<span class="st">'Offer viewed Distribution'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="135">
<pre><code>Text(0.5, 1.0, 'Offer viewed Distribution')</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="2021-07-14-Starbucks-Optimising-Customer-Segmentation-with-Random-Forest-and-Gradient-Boosting_files/figure-html/cell-136-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>The distribution of offer data follows the same pattern. There were a lot of offers not completed vs those that were completed. The same with offers received, viewed and auto completed</p>
</section>
<section id="distribution-of-transactions-for-the-offers" class="level3">
<h3 class="anchored" data-anchor-id="distribution-of-transactions-for-the-offers">Distribution of Transactions for the offers</h3>
<div class="cell" data-execution_count="136">
<div class="sourceCode cell-code" id="cb180"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb180-1"><a href="#cb180-1" aria-hidden="true" tabindex="-1"></a><span class="co">#KDEPlot: Kernel Density Estimate Plot</span></span>
<span id="cb180-2"><a href="#cb180-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-3"><a href="#cb180-3" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>(<span class="dv">15</span>,<span class="dv">4</span>))</span>
<span id="cb180-4"><a href="#cb180-4" aria-hidden="true" tabindex="-1"></a>ax<span class="op">=</span>sns.kdeplot(master_df.loc[(master_df[<span class="st">'offer_type'</span>] <span class="op">==</span> <span class="st">'BOGO'</span>),<span class="st">'transaction'</span>] , color<span class="op">=</span><span class="st">'b'</span>,shade<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb180-5"><a href="#cb180-5" aria-hidden="true" tabindex="-1"></a>ax<span class="op">=</span>sns.kdeplot(master_df.loc[(master_df[<span class="st">'offer_type'</span>] <span class="op">==</span> <span class="st">'Informational'</span>),<span class="st">'transaction'</span>] , color<span class="op">=</span><span class="st">'r'</span>,shade<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb180-6"><a href="#cb180-6" aria-hidden="true" tabindex="-1"></a>ax<span class="op">=</span>sns.kdeplot(master_df.loc[(master_df[<span class="st">'offer_type'</span>] <span class="op">==</span> <span class="st">'Discount'</span>),<span class="st">'transaction'</span>] , color<span class="op">=</span><span class="st">'c'</span>,shade<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb180-7"><a href="#cb180-7" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Offer type distribution - Transaction V.S. No Transaction'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="136">
<pre><code>Text(0.5, 1.0, 'Offer type distribution - Transaction V.S. No Transaction')</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="2021-07-14-Starbucks-Optimising-Customer-Segmentation-with-Random-Forest-and-Gradient-Boosting_files/figure-html/cell-137-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>The distribution of transactions done vs transactions not done for BOGO,Discount and Informational offers follows the same pattern. There was more transactions not done as compared to transactions completed</p>
</section>
<section id="transactions-done-to-complete-offers" class="level3">
<h3 class="anchored" data-anchor-id="transactions-done-to-complete-offers">Transactions done to complete offers</h3>
<div class="cell" data-execution_count="137">
<div class="sourceCode cell-code" id="cb182"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb182-1"><a href="#cb182-1" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> sns.barplot(x<span class="op">=</span><span class="st">"transaction"</span>, y<span class="op">=</span><span class="st">"transaction"</span>, hue<span class="op">=</span><span class="st">"offer_completed"</span>, data<span class="op">=</span>master_df, estimator<span class="op">=</span><span class="kw">lambda</span> x: <span class="bu">len</span>(x) <span class="op">/</span> <span class="bu">len</span>(master_df) <span class="op">*</span> <span class="dv">100</span>)</span>
<span id="cb182-2"><a href="#cb182-2" aria-hidden="true" tabindex="-1"></a>ax.<span class="bu">set</span>(ylabel<span class="op">=</span><span class="st">"Percent"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="137">
<pre><code>[Text(0, 0.5, 'Percent')]</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="2021-07-14-Starbucks-Optimising-Customer-Segmentation-with-Random-Forest-and-Gradient-Boosting_files/figure-html/cell-138-output-2.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="auto-completed-transactions" class="level3">
<h3 class="anchored" data-anchor-id="auto-completed-transactions">Auto completed transactions</h3>
<div class="cell" data-execution_count="138">
<div class="sourceCode cell-code" id="cb184"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb184-1"><a href="#cb184-1" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> sns.barplot(x<span class="op">=</span><span class="st">"transaction"</span>, y<span class="op">=</span><span class="st">"transaction"</span>, hue<span class="op">=</span><span class="st">"auto_completed"</span>, data<span class="op">=</span>master_df, estimator<span class="op">=</span><span class="kw">lambda</span> x: <span class="bu">len</span>(x) <span class="op">/</span> <span class="bu">len</span>(master_df) <span class="op">*</span> <span class="dv">100</span>)</span>
<span id="cb184-2"><a href="#cb184-2" aria-hidden="true" tabindex="-1"></a>ax.<span class="bu">set</span>(ylabel<span class="op">=</span><span class="st">"Percent"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="138">
<pre><code>[Text(0, 0.5, 'Percent')]</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="2021-07-14-Starbucks-Optimising-Customer-Segmentation-with-Random-Forest-and-Gradient-Boosting_files/figure-html/cell-139-output-2.png" class="img-fluid"></p>
</div>
</div>
<section id="create-a-column-for-daily-avg-spending" class="level4">
<h4 class="anchored" data-anchor-id="create-a-column-for-daily-avg-spending">Create a column for daily avg spending</h4>
<p>Calculate how much a user spends or has spent on average since they became a member. Use the days of membership and became member on that we dropped before. We do this by creating a new df called data that groups how much money was spent by a customer by customer_id, gender, age group, income range and days of membership</p>
<p>First add that became member on column to the master_df</p>
<div class="cell" data-execution_count="341">
<div class="sourceCode cell-code" id="cb186"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb186-1"><a href="#cb186-1" aria-hidden="true" tabindex="-1"></a><span class="co">#create a dataframe just fr the became member on which we want to use for only a certain analysis on EDA</span></span>
<span id="cb186-2"><a href="#cb186-2" aria-hidden="true" tabindex="-1"></a>df1<span class="op">=</span>pd.read_json(<span class="st">'./profile.json'</span>, orient<span class="op">=</span><span class="st">'records'</span>, lines<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="342">
<div class="sourceCode cell-code" id="cb187"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb187-1"><a href="#cb187-1" aria-hidden="true" tabindex="-1"></a>df1.drop(columns<span class="op">=</span>[<span class="st">'gender'</span>,<span class="st">'age'</span>,<span class="st">'income'</span>], inplace<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="343">
<div class="sourceCode cell-code" id="cb188"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb188-1"><a href="#cb188-1" aria-hidden="true" tabindex="-1"></a>df1.rename(columns<span class="op">=</span>{<span class="st">'id'</span>: <span class="st">'customer_id'</span>}, inplace<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="344">
<div class="sourceCode cell-code" id="cb189"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb189-1"><a href="#cb189-1" aria-hidden="true" tabindex="-1"></a><span class="co">#change the became_member_on from int to datetime</span></span>
<span id="cb189-2"><a href="#cb189-2" aria-hidden="true" tabindex="-1"></a>df1[<span class="st">'became_member_on'</span>] <span class="op">=</span> pd.to_datetime(df1[<span class="st">'became_member_on'</span>], <span class="bu">format</span><span class="op">=</span><span class="st">'%Y%m</span><span class="sc">%d</span><span class="st">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="345">
<div class="sourceCode cell-code" id="cb190"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb190-1"><a href="#cb190-1" aria-hidden="true" tabindex="-1"></a>new_df<span class="op">=</span>df1.merge(master_df, on<span class="op">=</span><span class="st">'customer_id'</span>, how<span class="op">=</span><span class="st">'right'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="346">
<div class="sourceCode cell-code" id="cb191"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb191-1"><a href="#cb191-1" aria-hidden="true" tabindex="-1"></a>master_df<span class="op">=</span>new_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="347">
<div class="sourceCode cell-code" id="cb192"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb192-1"><a href="#cb192-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> datetime</span>
<span id="cb192-2"><a href="#cb192-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb192-3"><a href="#cb192-3" aria-hidden="true" tabindex="-1"></a>data_collection_date <span class="op">=</span> <span class="st">"2018-10-18"</span></span>
<span id="cb192-4"><a href="#cb192-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb192-5"><a href="#cb192-5" aria-hidden="true" tabindex="-1"></a>master_df[<span class="st">'days_of_membership'</span>] <span class="op">=</span> datetime.datetime.strptime(data_collection_date, <span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st">'</span>) <span class="op">-</span> master_df[<span class="st">'became_member_on'</span>]</span>
<span id="cb192-6"><a href="#cb192-6" aria-hidden="true" tabindex="-1"></a>master_df[<span class="st">'days_of_membership'</span>] <span class="op">=</span> master_df[<span class="st">'days_of_membership'</span>].dt.days.astype(<span class="st">'int16'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="348">
<div class="sourceCode cell-code" id="cb193"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb193-1"><a href="#cb193-1" aria-hidden="true" tabindex="-1"></a><span class="co"># group data by person, calculate summary spend:</span></span>
<span id="cb193-2"><a href="#cb193-2" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> master_df.groupby([<span class="st">'customer_id'</span>, <span class="st">'gender'</span>, <span class="st">'age_group'</span>, <span class="st">'income_range'</span>, <span class="st">'days_of_membership'</span>,<span class="st">'member_type'</span>], as_index<span class="op">=</span><span class="va">False</span>)[<span class="st">'money_spent'</span>].<span class="bu">sum</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="349">
<div class="sourceCode cell-code" id="cb194"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb194-1"><a href="#cb194-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create new column "daily_spend_avg"</span></span>
<span id="cb194-2"><a href="#cb194-2" aria-hidden="true" tabindex="-1"></a>data[<span class="st">'daily_spend_avg'</span>] <span class="op">=</span> data.money_spent <span class="op">/</span> data.days_of_membership</span>
<span id="cb194-3"><a href="#cb194-3" aria-hidden="true" tabindex="-1"></a>data.sample(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="349">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>customer_id</th>
      <th>gender</th>
      <th>age_group</th>
      <th>income_range</th>
      <th>days_of_membership</th>
      <th>member_type</th>
      <th>money_spent</th>
      <th>daily_spend_avg</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>11965</th>
      <td>ce9ff37fcd4a4f6180ee3df63d6ce6c0</td>
      <td>1</td>
      <td>4</td>
      <td>3</td>
      <td>763</td>
      <td>regular</td>
      <td>106.77</td>
      <td>0.139934</td>
    </tr>
    <tr>
      <th>12349</th>
      <td>d53ea893dd774977ad75280d4be4c621</td>
      <td>1</td>
      <td>3</td>
      <td>2</td>
      <td>445</td>
      <td>new</td>
      <td>10.04</td>
      <td>0.022562</td>
    </tr>
    <tr>
      <th>223</th>
      <td>0409df7f3af74e8c813d975fbd4ceb02</td>
      <td>1</td>
      <td>4</td>
      <td>4</td>
      <td>1108</td>
      <td>regular</td>
      <td>64.20</td>
      <td>0.057942</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
</section>
</section>
<section id="daily-average-spend-of-customers-by-gender" class="level3">
<h3 class="anchored" data-anchor-id="daily-average-spend-of-customers-by-gender">Daily Average spend of customers by Gender</h3>
<div class="cell" data-execution_count="350">
<div class="sourceCode cell-code" id="cb195"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb195-1"><a href="#cb195-1" aria-hidden="true" tabindex="-1"></a> <span class="co">#Custom colors that we will use in graphs:</span></span>
<span id="cb195-2"><a href="#cb195-2" aria-hidden="true" tabindex="-1"></a>custom_colors <span class="op">=</span> [<span class="st">'#006241'</span>, <span class="st">'#84233C'</span>, <span class="st">'#1E3932'</span>, <span class="st">'#9D5116'</span>, <span class="st">'#E44C2C'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="351">
<div class="sourceCode cell-code" id="cb196"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb196-1"><a href="#cb196-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create plot:</span></span>
<span id="cb196-2"><a href="#cb196-2" aria-hidden="true" tabindex="-1"></a>sns.boxplot(x<span class="op">=</span><span class="st">"gender"</span>, y<span class="op">=</span><span class="st">"daily_spend_avg"</span>, data<span class="op">=</span>data, showmeans<span class="op">=</span><span class="va">True</span>, palette<span class="op">=</span>custom_colors)</span>
<span id="cb196-3"><a href="#cb196-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb196-4"><a href="#cb196-4" aria-hidden="true" tabindex="-1"></a>plt.tight_layout(pad<span class="op">=</span><span class="fl">1.4</span>)</span>
<span id="cb196-5"><a href="#cb196-5" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'average daily spend (USD)'</span>)</span>
<span id="cb196-6"><a href="#cb196-6" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'gender'</span>)</span>
<span id="cb196-7"><a href="#cb196-7" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Money spent by gender (daily average based on 95</span><span class="sc">% o</span><span class="st">f data)'</span>, fontsize<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb196-8"><a href="#cb196-8" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb196-9"><a href="#cb196-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb196-10"><a href="#cb196-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Mean values:"</span>)</span>
<span id="cb196-11"><a href="#cb196-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(data.groupby([<span class="st">'gender'</span>], as_index<span class="op">=</span><span class="va">False</span>)[<span class="st">'daily_spend_avg'</span>].mean())</span>
<span id="cb196-12"><a href="#cb196-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb196-13"><a href="#cb196-13" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2021-07-14-Starbucks-Optimising-Customer-Segmentation-with-Random-Forest-and-Gradient-Boosting_files/figure-html/cell-150-output-1.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Mean values:
   gender  daily_spend_avg
0       1         0.218562
1       2         0.305103
2       3         0.276180</code></pre>
</div>
</div>
<p>By the shape of our plot there seem to be some outliers, customers who spend quite a substantial amount per day on average. Lets see these outliers and remove them</p>
<div class="cell" data-execution_count="352">
<div class="sourceCode cell-code" id="cb198"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb198-1"><a href="#cb198-1" aria-hidden="true" tabindex="-1"></a>data.daily_spend_avg.describe()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="352">
<pre><code>count    14804.000000
mean         0.255175
std          0.377713
min          0.000000
25%          0.067523
50%          0.163119
75%          0.309466
max         11.286446
Name: daily_spend_avg, dtype: float64</code></pre>
</div>
</div>
<p>As expected, the average daily spend for most customers is 0.25 US, but there are customers who max an average of 11.2US a day. We also see that the lower 75% percentile are 0.30US. We will remove anyone above this</p>
<div class="cell" data-execution_count="353">
<div class="sourceCode cell-code" id="cb200"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb200-1"><a href="#cb200-1" aria-hidden="true" tabindex="-1"></a>data.daily_spend_avg.quantile(<span class="fl">0.95</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="353">
<pre><code>0.7612370712384876</code></pre>
</div>
</div>
<p>After a few iterations, we see that over 90% of customers spend 0.40US or less, only the 5% spend 0.70US and upwards, so we remove the 5%</p>
<div class="cell" data-execution_count="354">
<div class="sourceCode cell-code" id="cb202"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb202-1"><a href="#cb202-1" aria-hidden="true" tabindex="-1"></a><span class="co"># remove upper 5% outliers:</span></span>
<span id="cb202-2"><a href="#cb202-2" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> data[data.daily_spend_avg <span class="op">&lt;</span> data.daily_spend_avg.quantile(<span class="fl">0.95</span>)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>With the outliers removed, we check again the average money spent by gender</p>
<div class="cell" data-execution_count="355">
<div class="sourceCode cell-code" id="cb203"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb203-1"><a href="#cb203-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create plot:</span></span>
<span id="cb203-2"><a href="#cb203-2" aria-hidden="true" tabindex="-1"></a>sns.boxplot(x<span class="op">=</span><span class="st">"gender"</span>, y<span class="op">=</span><span class="st">"daily_spend_avg"</span>, data<span class="op">=</span>data, showmeans<span class="op">=</span><span class="va">True</span>, palette<span class="op">=</span>custom_colors)</span>
<span id="cb203-3"><a href="#cb203-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb203-4"><a href="#cb203-4" aria-hidden="true" tabindex="-1"></a>plt.tight_layout(pad<span class="op">=</span><span class="fl">1.4</span>)</span>
<span id="cb203-5"><a href="#cb203-5" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'average daily spend (USD)'</span>)</span>
<span id="cb203-6"><a href="#cb203-6" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'gender'</span>)</span>
<span id="cb203-7"><a href="#cb203-7" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Money spent by gender (daily average based on 95</span><span class="sc">% o</span><span class="st">f data)'</span>, fontsize<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb203-8"><a href="#cb203-8" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb203-9"><a href="#cb203-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb203-10"><a href="#cb203-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Mean values:"</span>)</span>
<span id="cb203-11"><a href="#cb203-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(data.groupby([<span class="st">'gender'</span>], as_index<span class="op">=</span><span class="va">False</span>)[<span class="st">'daily_spend_avg'</span>].mean())</span>
<span id="cb203-12"><a href="#cb203-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb203-13"><a href="#cb203-13" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2021-07-14-Starbucks-Optimising-Customer-Segmentation-with-Random-Forest-and-Gradient-Boosting_files/figure-html/cell-154-output-1.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Mean values:
   gender  daily_spend_avg
0       1         0.167434
1       2         0.235465
2       3         0.219009</code></pre>
</div>
</div>
<p>Females are the highest spenders, they spend on average 0.23USD per day followed by gender O who spend 0.21USD per day and least spenders are males who spent on average 0.16USD.</p>
</section>
<section id="daily-average-spend-of-customers-by-age-group" class="level3">
<h3 class="anchored" data-anchor-id="daily-average-spend-of-customers-by-age-group">Daily average spend of customers by Age Group</h3>
<div class="cell" data-execution_count="356">
<div class="sourceCode cell-code" id="cb205"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb205-1"><a href="#cb205-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create plot:</span></span>
<span id="cb205-2"><a href="#cb205-2" aria-hidden="true" tabindex="-1"></a>sns.boxplot(x<span class="op">=</span><span class="st">"age_group"</span>, y<span class="op">=</span><span class="st">"daily_spend_avg"</span>, data<span class="op">=</span>data, showmeans<span class="op">=</span><span class="va">True</span>, palette<span class="op">=</span>custom_colors)</span>
<span id="cb205-3"><a href="#cb205-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb205-4"><a href="#cb205-4" aria-hidden="true" tabindex="-1"></a>plt.tight_layout(pad<span class="op">=</span><span class="fl">1.4</span>)</span>
<span id="cb205-5"><a href="#cb205-5" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'average daily spend (USD)'</span>)</span>
<span id="cb205-6"><a href="#cb205-6" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'age group'</span>)</span>
<span id="cb205-7"><a href="#cb205-7" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Money spent by age group (daily average based on 95</span><span class="sc">% o</span><span class="st">f data)'</span>, fontsize<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb205-8"><a href="#cb205-8" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb205-9"><a href="#cb205-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb205-10"><a href="#cb205-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Mean values:"</span>)</span>
<span id="cb205-11"><a href="#cb205-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(data.groupby([<span class="st">'age_group'</span>], as_index<span class="op">=</span><span class="va">False</span>)[<span class="st">'daily_spend_avg'</span>].mean())</span>
<span id="cb205-12"><a href="#cb205-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb205-13"><a href="#cb205-13" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2021-07-14-Starbucks-Optimising-Customer-Segmentation-with-Random-Forest-and-Gradient-Boosting_files/figure-html/cell-155-output-1.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Mean values:
   age_group  daily_spend_avg
0          1         0.141821
1          2         0.153142
2          3         0.199117
3          4         0.211793</code></pre>
</div>
</div>
<p>The elderly, that is those above 60 are the highest age group spending an average of 0.21US per day. Adults, those aged 35-60 are the second highest spenders on average, spending 0.19US per day. Ages 17-34 are the least spenders, spending roughly 0.14US per day</p>
</section>
<section id="daily-average-spend-of-customers-by-income-range" class="level3">
<h3 class="anchored" data-anchor-id="daily-average-spend-of-customers-by-income-range">Daily average spend of customers by income range</h3>
<div class="cell" data-execution_count="357">
<div class="sourceCode cell-code" id="cb207"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb207-1"><a href="#cb207-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create plot:</span></span>
<span id="cb207-2"><a href="#cb207-2" aria-hidden="true" tabindex="-1"></a>sns.boxplot(x<span class="op">=</span><span class="st">"income_range"</span>, y<span class="op">=</span><span class="st">"daily_spend_avg"</span>, data<span class="op">=</span>data, showmeans<span class="op">=</span><span class="va">True</span>, palette<span class="op">=</span>custom_colors)</span>
<span id="cb207-3"><a href="#cb207-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb207-4"><a href="#cb207-4" aria-hidden="true" tabindex="-1"></a>plt.tight_layout(pad<span class="op">=</span><span class="fl">1.4</span>)</span>
<span id="cb207-5"><a href="#cb207-5" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'average daily spend (USD)'</span>)</span>
<span id="cb207-6"><a href="#cb207-6" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'income range'</span>)</span>
<span id="cb207-7"><a href="#cb207-7" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Money spent by age group (daily average based on 95</span><span class="sc">% o</span><span class="st">f data)'</span>, fontsize<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb207-8"><a href="#cb207-8" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb207-9"><a href="#cb207-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb207-10"><a href="#cb207-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Mean values:"</span>)</span>
<span id="cb207-11"><a href="#cb207-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(data.groupby([<span class="st">'income_range'</span>], as_index<span class="op">=</span><span class="va">False</span>)[<span class="st">'daily_spend_avg'</span>].mean())</span>
<span id="cb207-12"><a href="#cb207-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb207-13"><a href="#cb207-13" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2021-07-14-Starbucks-Optimising-Customer-Segmentation-with-Random-Forest-and-Gradient-Boosting_files/figure-html/cell-156-output-1.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Mean values:
   income_range  daily_spend_avg
0             1         0.108308
1             2         0.133231
2             3         0.179468
3             4         0.240649
4             5         0.283618</code></pre>
</div>
</div>
<p>As expected, high income earners have the highest average spend. Spending on average, 0.28US per day, mid to high earners also spend highly with 0.23US per day. Low and low to mid income earners spend right around the same amount. They spend about 0.11US per day</p>
</section>
<section id="daily-average-spend-by-member-type" class="level3">
<h3 class="anchored" data-anchor-id="daily-average-spend-by-member-type">Daily Average spend by member type</h3>
<div class="cell" data-execution_count="358">
<div class="sourceCode cell-code" id="cb209"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb209-1"><a href="#cb209-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create plot:</span></span>
<span id="cb209-2"><a href="#cb209-2" aria-hidden="true" tabindex="-1"></a>sns.boxplot(x<span class="op">=</span><span class="st">"member_type"</span>, y<span class="op">=</span><span class="st">"daily_spend_avg"</span>, data<span class="op">=</span>data, showmeans<span class="op">=</span><span class="va">True</span>, palette<span class="op">=</span>custom_colors)</span>
<span id="cb209-3"><a href="#cb209-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb209-4"><a href="#cb209-4" aria-hidden="true" tabindex="-1"></a>plt.tight_layout(pad<span class="op">=</span><span class="fl">1.4</span>)</span>
<span id="cb209-5"><a href="#cb209-5" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'average daily spend (USD)'</span>)</span>
<span id="cb209-6"><a href="#cb209-6" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'member type'</span>)</span>
<span id="cb209-7"><a href="#cb209-7" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Money spent by type of member (daily average based on 95</span><span class="sc">% o</span><span class="st">f data)'</span>, fontsize<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb209-8"><a href="#cb209-8" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb209-9"><a href="#cb209-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb209-10"><a href="#cb209-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Mean values:"</span>)</span>
<span id="cb209-11"><a href="#cb209-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(data.groupby([<span class="st">'member_type'</span>], as_index<span class="op">=</span><span class="va">False</span>)[<span class="st">'daily_spend_avg'</span>].mean())</span>
<span id="cb209-12"><a href="#cb209-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb209-13"><a href="#cb209-13" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2021-07-14-Starbucks-Optimising-Customer-Segmentation-with-Random-Forest-and-Gradient-Boosting_files/figure-html/cell-157-output-1.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Mean values:
  member_type  daily_spend_avg
0       loyal         0.055500
1         new         0.225833
2     regular         0.178587</code></pre>
</div>
</div>
<p>New members have the highest average dailly spend followed by regular members. Loyal members, those who have been members for over 3 years are no longer daily spenders</p>
<section id="money-spent-for-duration-of-offer" class="level4">
<h4 class="anchored" data-anchor-id="money-spent-for-duration-of-offer">Money spent for duration of offer</h4>
<div class="cell" data-execution_count="369">
<div class="sourceCode cell-code" id="cb211"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb211-1"><a href="#cb211-1" aria-hidden="true" tabindex="-1"></a>new_data <span class="op">=</span> master_df[master_df.money_spent <span class="op">&lt;</span> master_df.money_spent.quantile(<span class="fl">0.95</span>)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="371">
<div class="sourceCode cell-code" id="cb212"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb212-1"><a href="#cb212-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create plot:</span></span>
<span id="cb212-2"><a href="#cb212-2" aria-hidden="true" tabindex="-1"></a>sns.boxplot(x<span class="op">=</span><span class="st">"offer_duration_days"</span>, y<span class="op">=</span><span class="st">"money_spent"</span>, data<span class="op">=</span>new_data, showmeans<span class="op">=</span><span class="va">True</span>, palette<span class="op">=</span>custom_colors)</span>
<span id="cb212-3"><a href="#cb212-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb212-4"><a href="#cb212-4" aria-hidden="true" tabindex="-1"></a>plt.tight_layout(pad<span class="op">=</span><span class="fl">1.4</span>)</span>
<span id="cb212-5"><a href="#cb212-5" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'average spend (USD)'</span>)</span>
<span id="cb212-6"><a href="#cb212-6" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'offer duration in days'</span>)</span>
<span id="cb212-7"><a href="#cb212-7" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Money spent for each offer duration (daily average based on 95</span><span class="sc">% o</span><span class="st">f data)'</span>, fontsize<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb212-8"><a href="#cb212-8" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb212-9"><a href="#cb212-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb212-10"><a href="#cb212-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Mean values:"</span>)</span>
<span id="cb212-11"><a href="#cb212-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(master_df.groupby([<span class="st">'offer_duration_days'</span>], as_index<span class="op">=</span><span class="va">False</span>)[<span class="st">'money_spent'</span>].mean())</span>
<span id="cb212-12"><a href="#cb212-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb212-13"><a href="#cb212-13" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2021-07-14-Starbucks-Optimising-Customer-Segmentation-with-Random-Forest-and-Gradient-Boosting_files/figure-html/cell-159-output-1.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Mean values:
   offer_duration_days  money_spent
0                  3.0     4.402707
1                  4.0     4.005438
2                  5.0     6.907186
3                  7.0     6.593053
4                 10.0     6.539640</code></pre>
</div>
</div>
<p>More money was spent for offers that lasted longer, on average 2USD more was spent on offers that lasted more than 5 days and more</p>
<p>Summary of average daily spending has revealed that: * High earning elderly females who are new members have the highest daily average spend i.e Female members who are over 60 years earning over 90K and have been members for at least 1200 days</p>
<div class="cell" data-execution_count="372">
<div class="sourceCode cell-code" id="cb214"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb214-1"><a href="#cb214-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create plot:</span></span>
<span id="cb214-2"><a href="#cb214-2" aria-hidden="true" tabindex="-1"></a>sns.boxplot(x<span class="op">=</span><span class="st">"spent_required"</span>, y<span class="op">=</span><span class="st">"money_spent"</span>, data<span class="op">=</span>new_data, showmeans<span class="op">=</span><span class="va">True</span>, palette<span class="op">=</span>custom_colors)</span>
<span id="cb214-3"><a href="#cb214-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb214-4"><a href="#cb214-4" aria-hidden="true" tabindex="-1"></a>plt.tight_layout(pad<span class="op">=</span><span class="fl">1.4</span>)</span>
<span id="cb214-5"><a href="#cb214-5" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'average daily spend (USD)'</span>)</span>
<span id="cb214-6"><a href="#cb214-6" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'spent requred'</span>)</span>
<span id="cb214-7"><a href="#cb214-7" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Money spent for the required spend (daily average based on 95</span><span class="sc">% o</span><span class="st">f data)'</span>, fontsize<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb214-8"><a href="#cb214-8" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb214-9"><a href="#cb214-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb214-10"><a href="#cb214-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Mean values:"</span>)</span>
<span id="cb214-11"><a href="#cb214-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(master_df.groupby([<span class="st">'spent_required'</span>], as_index<span class="op">=</span><span class="va">False</span>)[<span class="st">'money_spent'</span>].mean())</span>
<span id="cb214-12"><a href="#cb214-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb214-13"><a href="#cb214-13" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2021-07-14-Starbucks-Optimising-Customer-Segmentation-with-Random-Forest-and-Gradient-Boosting_files/figure-html/cell-160-output-1.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Mean values:
   spent_required  money_spent
0             0.0     4.224865
1             5.0     6.736110
2             7.0     6.279434
3            10.0     6.762536
4            20.0     6.492396</code></pre>
</div>
</div>
<p>The more spent required the more money was spent but it capped at 6.76USD</p>
<div class="cell" data-execution_count="376">
<div class="sourceCode cell-code" id="cb216"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb216-1"><a href="#cb216-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create plot:</span></span>
<span id="cb216-2"><a href="#cb216-2" aria-hidden="true" tabindex="-1"></a>sns.boxplot(x<span class="op">=</span><span class="st">"channel_mobile"</span>, y<span class="op">=</span><span class="st">"offer_completed"</span>, data<span class="op">=</span>new_data, showmeans<span class="op">=</span><span class="va">True</span>, palette<span class="op">=</span>custom_colors)</span>
<span id="cb216-3"><a href="#cb216-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb216-4"><a href="#cb216-4" aria-hidden="true" tabindex="-1"></a>plt.tight_layout(pad<span class="op">=</span><span class="fl">1.4</span>)</span>
<span id="cb216-5"><a href="#cb216-5" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Offer completed'</span>)</span>
<span id="cb216-6"><a href="#cb216-6" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'channel used: mobile'</span>)</span>
<span id="cb216-7"><a href="#cb216-7" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Offers completed from receiving offer via mobile (daily average based on 95</span><span class="sc">% o</span><span class="st">f data)'</span>, fontsize<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb216-8"><a href="#cb216-8" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb216-9"><a href="#cb216-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb216-10"><a href="#cb216-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Sum of values:"</span>)</span>
<span id="cb216-11"><a href="#cb216-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(master_df.groupby([<span class="st">'channel_mobile'</span>], as_index<span class="op">=</span><span class="va">False</span>)[<span class="st">'offer_completed'</span>].<span class="bu">sum</span>())</span>
<span id="cb216-12"><a href="#cb216-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb216-13"><a href="#cb216-13" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2021-07-14-Starbucks-Optimising-Customer-Segmentation-with-Random-Forest-and-Gradient-Boosting_files/figure-html/cell-161-output-1.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Sum of values:
   channel_mobile  offer_completed
0             0.0             1367
1             1.0            35532</code></pre>
</div>
</div>
<p>Most people who received offer via mobile completed it. It seems that mobile is the most important channel</p>
<div class="cell" data-execution_count="377">
<div class="sourceCode cell-code" id="cb218"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb218-1"><a href="#cb218-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create plot:</span></span>
<span id="cb218-2"><a href="#cb218-2" aria-hidden="true" tabindex="-1"></a>sns.boxplot(x<span class="op">=</span><span class="st">"offer_type"</span>, y<span class="op">=</span><span class="st">"money_spent"</span>, data<span class="op">=</span>new_data, showmeans<span class="op">=</span><span class="va">True</span>, palette<span class="op">=</span>custom_colors)</span>
<span id="cb218-3"><a href="#cb218-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb218-4"><a href="#cb218-4" aria-hidden="true" tabindex="-1"></a>plt.tight_layout(pad<span class="op">=</span><span class="fl">1.4</span>)</span>
<span id="cb218-5"><a href="#cb218-5" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'money spent per offer type'</span>)</span>
<span id="cb218-6"><a href="#cb218-6" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'offer type'</span>)</span>
<span id="cb218-7"><a href="#cb218-7" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Offers completed from receiving offer via mobile (daily average based on 95</span><span class="sc">% o</span><span class="st">f data)'</span>, fontsize<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb218-8"><a href="#cb218-8" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb218-9"><a href="#cb218-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb218-10"><a href="#cb218-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Sum of values:"</span>)</span>
<span id="cb218-11"><a href="#cb218-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(master_df.groupby([<span class="st">'offer_type'</span>], as_index<span class="op">=</span><span class="va">False</span>)[<span class="st">'money_spent'</span>].mean())</span>
<span id="cb218-12"><a href="#cb218-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb218-13"><a href="#cb218-13" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2021-07-14-Starbucks-Optimising-Customer-Segmentation-with-Random-Forest-and-Gradient-Boosting_files/figure-html/cell-162-output-1.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Sum of values:
      offer_type  money_spent
0           BOGO     6.851173
1       Discount     6.464640
2  Informational     4.224865</code></pre>
</div>
</div>
</section>
</section>
<section id="distribution-of-offers-among-age-groups" class="level3">
<h3 class="anchored" data-anchor-id="distribution-of-offers-among-age-groups">Distribution of offers among age groups</h3>
<div class="cell" data-execution_count="157">
<div class="sourceCode cell-code" id="cb220"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb220-1"><a href="#cb220-1" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">6</span>))</span>
<span id="cb220-2"><a href="#cb220-2" aria-hidden="true" tabindex="-1"></a>g <span class="op">=</span> sns.countplot(x<span class="op">=</span><span class="st">"age_group"</span>, hue<span class="op">=</span><span class="st">"offer_type"</span>, data<span class="op">=</span>master_df)</span>
<span id="cb220-3"><a href="#cb220-3" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Most Popular Offers to Each Age Group'</span>)</span>
<span id="cb220-4"><a href="#cb220-4" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Total'</span>)</span>
<span id="cb220-5"><a href="#cb220-5" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Age Group'</span>)</span>
<span id="cb220-6"><a href="#cb220-6" aria-hidden="true" tabindex="-1"></a>xlabels <span class="op">=</span> [<span class="st">'teenager'</span>,<span class="st">'young-adult'</span>,<span class="st">'adult'</span>,<span class="st">'elderly'</span>]</span>
<span id="cb220-7"><a href="#cb220-7" aria-hidden="true" tabindex="-1"></a>g.set_xticklabels(xlabels)</span>
<span id="cb220-8"><a href="#cb220-8" aria-hidden="true" tabindex="-1"></a>plt.xticks(rotation <span class="op">=</span> <span class="dv">0</span>)</span>
<span id="cb220-9"><a href="#cb220-9" aria-hidden="true" tabindex="-1"></a>plt.legend(title<span class="op">=</span><span class="st">'Offer Type'</span>)</span>
<span id="cb220-10"><a href="#cb220-10" aria-hidden="true" tabindex="-1"></a>plt.show()<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2021-07-14-Starbucks-Optimising-Customer-Segmentation-with-Random-Forest-and-Gradient-Boosting_files/figure-html/cell-163-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="158">
<div class="sourceCode cell-code" id="cb221"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb221-1"><a href="#cb221-1" aria-hidden="true" tabindex="-1"></a>master_df.groupby([<span class="st">'age_group'</span>,<span class="st">'offer_type'</span>]).offer_id.count()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="158">
<pre><code>age_group    offer_type   
adult        BOGO             23393
             Discount         22207
             Informational    10774
elderly      BOGO             18690
             Discount         17956
             Informational     8426
teenager     BOGO              2023
             Discount          1800
             Informational      924
young-adult  BOGO              5971
             Discount          5528
             Informational     2536
Name: offer_id, dtype: int64</code></pre>
</div>
</div>
<p>Overall across all age groups, BOGO is the most occuring type of offer. The distribution of offers follows the same pattern accross all age groups. BOGO being most popular closely followed by discount with the informational offers being the least by a margin.</p>
</section>
<section id="distribution-of-offers-by-income-group" class="level3">
<h3 class="anchored" data-anchor-id="distribution-of-offers-by-income-group">Distribution of offers by Income Group</h3>
<div class="cell" data-execution_count="159">
<div class="sourceCode cell-code" id="cb223"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb223-1"><a href="#cb223-1" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">6</span>))</span>
<span id="cb223-2"><a href="#cb223-2" aria-hidden="true" tabindex="-1"></a>g <span class="op">=</span> sns.countplot(x<span class="op">=</span><span class="st">"income_range"</span>, hue<span class="op">=</span><span class="st">"offer_type"</span>, data<span class="op">=</span>master_df)</span>
<span id="cb223-3"><a href="#cb223-3" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Most Popular Offers to Each Income Group'</span>)</span>
<span id="cb223-4"><a href="#cb223-4" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Total'</span>)</span>
<span id="cb223-5"><a href="#cb223-5" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Income Group'</span>)</span>
<span id="cb223-6"><a href="#cb223-6" aria-hidden="true" tabindex="-1"></a>xlabels <span class="op">=</span> [<span class="st">'low'</span>,<span class="st">'low_to_mid'</span>, <span class="st">'mid'</span>,<span class="st">'mid_to_high'</span>,<span class="st">'high'</span>]</span>
<span id="cb223-7"><a href="#cb223-7" aria-hidden="true" tabindex="-1"></a>g.set_xticklabels(xlabels)</span>
<span id="cb223-8"><a href="#cb223-8" aria-hidden="true" tabindex="-1"></a>plt.xticks(rotation <span class="op">=</span> <span class="dv">0</span>)</span>
<span id="cb223-9"><a href="#cb223-9" aria-hidden="true" tabindex="-1"></a>plt.legend(title<span class="op">=</span><span class="st">'Offer Type'</span>)</span>
<span id="cb223-10"><a href="#cb223-10" aria-hidden="true" tabindex="-1"></a>plt.show()<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2021-07-14-Starbucks-Optimising-Customer-Segmentation-with-Random-Forest-and-Gradient-Boosting_files/figure-html/cell-165-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="160">
<div class="sourceCode cell-code" id="cb224"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb224-1"><a href="#cb224-1" aria-hidden="true" tabindex="-1"></a>master_df.groupby([<span class="st">'income_range'</span>,<span class="st">'offer_type'</span>]).customer_id.count()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="160">
<pre><code>income_range  offer_type   
high          BOGO              7528
              Discount          7187
              Informational     3301
low           BOGO               302
              Discount           240
              Informational      128
low_to_mid    BOGO             13151
              Discount         11909
              Informational     5762
mid           BOGO             16877
              Discount         16173
              Informational     8027
mid_to_high   BOGO             12219
              Discount         11982
              Informational     5442
Name: customer_id, dtype: int64</code></pre>
</div>
</div>
<p>Most offers are concentrated around low to mid income earners. The second highest number of offers were sent to mid and mid to high income earners. High earners received the least offers. In terms of pattern, the offers follow the same pattern accross all income groups</p>
</section>
<section id="distribution-of-offers-by-member-type" class="level3">
<h3 class="anchored" data-anchor-id="distribution-of-offers-by-member-type">Distribution of offers by Member Type</h3>
<div class="cell" data-execution_count="161">
<div class="sourceCode cell-code" id="cb226"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb226-1"><a href="#cb226-1" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">6</span>))</span>
<span id="cb226-2"><a href="#cb226-2" aria-hidden="true" tabindex="-1"></a>g <span class="op">=</span> sns.countplot(x<span class="op">=</span><span class="st">"member_type"</span>, hue<span class="op">=</span><span class="st">"offer_type"</span>, data<span class="op">=</span>master_df)</span>
<span id="cb226-3"><a href="#cb226-3" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Most Popular Offers to Each Type of Member'</span>)</span>
<span id="cb226-4"><a href="#cb226-4" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Total'</span>)</span>
<span id="cb226-5"><a href="#cb226-5" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Type of Member'</span>)</span>
<span id="cb226-6"><a href="#cb226-6" aria-hidden="true" tabindex="-1"></a>xlabels <span class="op">=</span> [<span class="st">'new'</span>,<span class="st">'regular'</span>,<span class="st">'loyal'</span>]</span>
<span id="cb226-7"><a href="#cb226-7" aria-hidden="true" tabindex="-1"></a>g.set_xticklabels(xlabels)</span>
<span id="cb226-8"><a href="#cb226-8" aria-hidden="true" tabindex="-1"></a>plt.xticks(rotation <span class="op">=</span> <span class="dv">0</span>)</span>
<span id="cb226-9"><a href="#cb226-9" aria-hidden="true" tabindex="-1"></a>plt.legend(title<span class="op">=</span><span class="st">'Offer Type'</span>)</span>
<span id="cb226-10"><a href="#cb226-10" aria-hidden="true" tabindex="-1"></a>plt.show()<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2021-07-14-Starbucks-Optimising-Customer-Segmentation-with-Random-Forest-and-Gradient-Boosting_files/figure-html/cell-167-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="162">
<div class="sourceCode cell-code" id="cb227"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb227-1"><a href="#cb227-1" aria-hidden="true" tabindex="-1"></a>master_df.groupby([<span class="st">'member_type'</span>,<span class="st">'offer_type'</span>]).customer_id.count()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="162">
<pre><code>member_type  offer_type   
loyal        BOGO              4355
             Discount          4021
             Informational     1995
new          BOGO             30940
             Discount         29113
             Informational    14059
regular      BOGO             14697
             Discount         14302
             Informational     6571
Name: customer_id, dtype: int64</code></pre>
</div>
</div>
<p>The highest number of offers were sent to new members followed by loyal members with regular members receiving the least amount of offers. In terms of popularity of offers, the same pattern consistently emerges of BOGO being highest with discount close by and low informational offers</p>
</section>
<section id="distribution-of-events-per-type-of-member" class="level3">
<h3 class="anchored" data-anchor-id="distribution-of-events-per-type-of-member">Distribution of Events per Type of Member</h3>
<div class="cell" data-execution_count="163">
<div class="sourceCode cell-code" id="cb229"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb229-1"><a href="#cb229-1" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">6</span>))</span>
<span id="cb229-2"><a href="#cb229-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb229-3"><a href="#cb229-3" aria-hidden="true" tabindex="-1"></a>g <span class="op">=</span> sns.countplot(x<span class="op">=</span><span class="st">"member_type"</span>, hue<span class="op">=</span><span class="st">"event"</span>, data<span class="op">=</span>master_df)</span>
<span id="cb229-4"><a href="#cb229-4" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Count of Event Type per Type of Member'</span>)</span>
<span id="cb229-5"><a href="#cb229-5" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Total'</span>)</span>
<span id="cb229-6"><a href="#cb229-6" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Type of Member'</span>)</span>
<span id="cb229-7"><a href="#cb229-7" aria-hidden="true" tabindex="-1"></a>xlabels <span class="op">=</span> [<span class="st">'new'</span>,<span class="st">'regular'</span>,<span class="st">'loyal'</span>]</span>
<span id="cb229-8"><a href="#cb229-8" aria-hidden="true" tabindex="-1"></a>g.set_xticklabels(xlabels)</span>
<span id="cb229-9"><a href="#cb229-9" aria-hidden="true" tabindex="-1"></a>plt.xticks(rotation <span class="op">=</span> <span class="dv">0</span>)</span>
<span id="cb229-10"><a href="#cb229-10" aria-hidden="true" tabindex="-1"></a>plt.legend(title<span class="op">=</span><span class="st">'Event'</span>)</span>
<span id="cb229-11"><a href="#cb229-11" aria-hidden="true" tabindex="-1"></a>plt.show()<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2021-07-14-Starbucks-Optimising-Customer-Segmentation-with-Random-Forest-and-Gradient-Boosting_files/figure-html/cell-169-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="164">
<div class="sourceCode cell-code" id="cb230"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb230-1"><a href="#cb230-1" aria-hidden="true" tabindex="-1"></a>master_df.groupby([<span class="st">'event'</span>,<span class="st">'member_type'</span>]).customer_id.count()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="164">
<pre><code>event            member_type
auto completed   loyal            303
                 new             2497
                 regular         1829
offer completed  loyal           3485
                 new            20537
                 regular        12842
offer received   loyal           5785
                 new            41395
                 regular        19223
offer viewed     loyal            798
                 new             9683
                 regular         1676
transaction      loyal          12299
                 new            40539
                 regular        30036
Name: customer_id, dtype: int64</code></pre>
</div>
</div>
<p>41 395 new customers received offers. Of those that received offers, only 41.5% viewed the offer and 37.5% completed the offer.</p>
<p>40 539 new customers made transactions on the app, new members made the highest number of transactions of all the members. Regular members also made a sizeable amount of transactions on the app, they made 30 036 transactions. Loyal members had the least number of transactions, making 12 299 transactions</p>
<p>Regular members were the second highest to receive offers, receiving 19 223 offers but only 24% viewing the offers and 60% completing the offers. Most regular members completed the offers without viewing them.</p>
<p>5785 loyal customers received offers, of this number, 38.2% viewed the offers and 41% completed the offers.</p>
<div class="cell" data-execution_count="165">
<div class="sourceCode cell-code" id="cb232"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb232-1"><a href="#cb232-1" aria-hidden="true" tabindex="-1"></a>master_df.groupby([<span class="st">'event'</span>,<span class="st">'member_type'</span>,<span class="st">'offer_type'</span>]).offer_id.count()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="165">
<pre><code>event            member_type  offer_type   
auto completed   loyal        BOGO               127
                              Discount           176
                 new          BOGO              1099
                              Discount          1398
                 regular      BOGO               751
                              Discount          1078
offer completed  loyal        BOGO              1593
                              Discount          1251
                              Informational      641
                 new          BOGO             10156
                              Discount          6549
                              Informational     3832
                 regular      BOGO              5835
                              Discount          4904
                              Informational     2103
offer received   loyal        BOGO              2334
                              Discount          2291
                              Informational     1160
                 new          BOGO             16512
                              Discount         16593
                              Informational     8290
                 regular      BOGO              7646
                              Discount          7749
                              Informational     3828
offer viewed     loyal        BOGO               301
                              Discount           303
                              Informational      194
                 new          BOGO              3173
                              Discount          4573
                              Informational     1937
                 regular      BOGO               465
                              Discount           571
                              Informational      640
Name: offer_id, dtype: int64</code></pre>
</div>
</div>
<p>An indepth analysis of the types of offers given to customers shows interesting observations.</p>
<p><strong>On new customers:</strong></p>
<p>39.88% of new customers received BOGO offer, 41.4% of those that received the BOGO viewed it, which constituted 39.8% of all offer views by new customers. 45% of those new customers that received the BOGO completed it, accounting for 48.8% of all new customers that completed offers.</p>
<p>40% of new customers received the discount offer, 27.5% of those that received this offer viewed the offer, accounting for 26.6% of all offer views by new customers. 47.8% of new customers who received the discount offer completed it, which accounts for 51.1% of all offers completed by new customers.</p>
<p>20% of new customers received informational offers, 69.5% of them viewed it, which accounts for 33.5% of views by new customers.</p>
<p>None of the new customers completed informational offers.</p>
<p><strong>On regular customers:</strong></p>
<p>39.77% of regular customers received the BOGO offer, of these only 18% viewed it. This means that 29.4% of all views of BOGO offer were done by regular customers. 74% of regular customers who received the BOGO offer completed it. This accounts for 48.6% of all offers completed by regular customers</p>
<p>40.3% of regular customers received the discount offer, of these only 7% of them viewed it. This means that 12.1% of offer views by regular customers were viewing discount offer. 77.1% of regular customers who received discount offer completed it. This means 51.4% of all offers completed by regular customers was on discount offers.</p>
<p>19.91% of regular customers received the informational offer, of these 71.6% of them viewed it. 23.5% of all views made by regular customers were on informational offers.</p>
<p>None of the informational offers were completed.</p>
<p><strong>On loyal customers:</strong></p>
<p>40.3% of loyal customers received the BOGO offer, of these 46% of them viewed it. This means that, 48.85% of all loyal customer views were on BOGO. 40.5% of loyal customers who received BOGO completed it. This accounts for 39.86% of all offers completed by loyal customers.</p>
<p>39.6% of loyal customers received discount offer, 13.2% viewed it. This means that 13.7% of all views by loyal customers was on discount offer.62.28% of loyal customers who received the discount offer completed it. This accounts for 60% of all offers completed by loyal customers.</p>
<div class="cell" data-execution_count="166">
<div class="sourceCode cell-code" id="cb234"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb234-1"><a href="#cb234-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calculate_percentage_success():</span>
<span id="cb234-2"><a href="#cb234-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">'''Calculate percent success by offer</span></span>
<span id="cb234-3"><a href="#cb234-3" aria-hidden="true" tabindex="-1"></a><span class="co">    INPUT:</span></span>
<span id="cb234-4"><a href="#cb234-4" aria-hidden="true" tabindex="-1"></a><span class="co">    cleaned_df - dataframe with merged transaction, offer, and demographic data</span></span>
<span id="cb234-5"><a href="#cb234-5" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb234-6"><a href="#cb234-6" aria-hidden="true" tabindex="-1"></a><span class="co">    RETURNS:</span></span>
<span id="cb234-7"><a href="#cb234-7" aria-hidden="true" tabindex="-1"></a><span class="co">    percent success by offer</span></span>
<span id="cb234-8"><a href="#cb234-8" aria-hidden="true" tabindex="-1"></a><span class="co">    '''</span></span>
<span id="cb234-9"><a href="#cb234-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define variables, calculate percent success</span></span>
<span id="cb234-10"><a href="#cb234-10" aria-hidden="true" tabindex="-1"></a>    successful_count <span class="op">=</span> cleaned_df[[<span class="st">'offer_id'</span>, <span class="st">'offer_completed'</span>]].groupby(</span>
<span id="cb234-11"><a href="#cb234-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">'offer_id'</span>).<span class="bu">sum</span>().reset_index()</span>
<span id="cb234-12"><a href="#cb234-12" aria-hidden="true" tabindex="-1"></a>    offer_count <span class="op">=</span> cleaned_df[<span class="st">'offer_id'</span>].value_counts()</span>
<span id="cb234-13"><a href="#cb234-13" aria-hidden="true" tabindex="-1"></a>    offer_count <span class="op">=</span> pd.DataFrame(<span class="bu">list</span>(<span class="bu">zip</span>(offer_count.index.values,</span>
<span id="cb234-14"><a href="#cb234-14" aria-hidden="true" tabindex="-1"></a>                                        offer_count.values)),</span>
<span id="cb234-15"><a href="#cb234-15" aria-hidden="true" tabindex="-1"></a>                               columns<span class="op">=</span>[<span class="st">'offer_id'</span>, <span class="st">'count'</span>])</span>
<span id="cb234-16"><a href="#cb234-16" aria-hidden="true" tabindex="-1"></a>    successful_count <span class="op">=</span> successful_count.sort_values(<span class="st">'offer_id'</span>)</span>
<span id="cb234-17"><a href="#cb234-17" aria-hidden="true" tabindex="-1"></a>    offer_count <span class="op">=</span> offer_count.sort_values(<span class="st">'offer_id'</span>)</span>
<span id="cb234-18"><a href="#cb234-18" aria-hidden="true" tabindex="-1"></a>    percent_success <span class="op">=</span> pd.merge(offer_count, successful_count, on<span class="op">=</span><span class="st">"offer_id"</span>)</span>
<span id="cb234-19"><a href="#cb234-19" aria-hidden="true" tabindex="-1"></a>    percent_success[<span class="st">'percent_success'</span>] <span class="op">=</span> (<span class="dv">100</span> <span class="op">*</span> percent_success[<span class="st">'offer_completed'</span>] <span class="op">/</span> percent_success[<span class="st">'count'</span>])</span>
<span id="cb234-20"><a href="#cb234-20" aria-hidden="true" tabindex="-1"></a>    percent_success <span class="op">=</span> percent_success.drop(columns<span class="op">=</span>[<span class="st">'offer_completed'</span>])</span>
<span id="cb234-21"><a href="#cb234-21" aria-hidden="true" tabindex="-1"></a>    percent_success <span class="op">=</span> percent_success.sort_values(<span class="st">'percent_success'</span>, ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb234-22"><a href="#cb234-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb234-23"><a href="#cb234-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> percent_success.reset_index(drop<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="167">
<div class="sourceCode cell-code" id="cb235"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb235-1"><a href="#cb235-1" aria-hidden="true" tabindex="-1"></a>percent_success <span class="op">=</span> calculate_percentage_success()</span>
<span id="cb235-2"><a href="#cb235-2" aria-hidden="true" tabindex="-1"></a>percent_success</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="167">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>offer_id</th>
      <th>count</th>
      <th>percent_success</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>bogo_3</td>
      <td>14372</td>
      <td>29.139994</td>
    </tr>
    <tr>
      <th>1</th>
      <td>discount_4</td>
      <td>14002</td>
      <td>27.931724</td>
    </tr>
    <tr>
      <th>2</th>
      <td>fafdcd668e3743c1bb461111dcafc2a4</td>
      <td>18062</td>
      <td>27.699037</td>
    </tr>
    <tr>
      <th>3</th>
      <td>discount_1</td>
      <td>12327</td>
      <td>27.468159</td>
    </tr>
    <tr>
      <th>4</th>
      <td>discount_2</td>
      <td>17920</td>
      <td>27.265625</td>
    </tr>
    <tr>
      <th>5</th>
      <td>bogo_2</td>
      <td>16989</td>
      <td>24.150921</td>
    </tr>
    <tr>
      <th>6</th>
      <td>bogo_1</td>
      <td>16241</td>
      <td>22.517086</td>
    </tr>
    <tr>
      <th>7</th>
      <td>bogo_4</td>
      <td>16232</td>
      <td>20.391819</td>
    </tr>
    <tr>
      <th>8</th>
      <td>info_1</td>
      <td>10144</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>9</th>
      <td>info_2</td>
      <td>12516</td>
      <td>0.000000</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="cell" data-execution_count="168">
<div class="sourceCode cell-code" id="cb236"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb236-1"><a href="#cb236-1" aria-hidden="true" tabindex="-1"></a>percent_success <span class="op">=</span> percent_success.drop(percent_success.index[[<span class="dv">8</span>,<span class="dv">9</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="171">
<div class="sourceCode cell-code" id="cb237"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb237-1"><a href="#cb237-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot percent success by offer type</span></span>
<span id="cb237-2"><a href="#cb237-2" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">28</span>, <span class="dv">8</span>), nrows<span class="op">=</span><span class="dv">1</span>, ncols<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb237-3"><a href="#cb237-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb237-4"><a href="#cb237-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot offer type by count</span></span>
<span id="cb237-5"><a href="#cb237-5" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].bar(percent_success.index <span class="op">+</span> <span class="dv">1</span>, percent_success[<span class="st">'count'</span>], color<span class="op">=</span><span class="st">'teal'</span>)</span>
<span id="cb237-6"><a href="#cb237-6" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].set_xticks(np.arange(<span class="dv">0</span>,<span class="dv">8</span>) <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb237-7"><a href="#cb237-7" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].set_xlabel(<span class="st">'Offer Type'</span>,size <span class="op">=</span> <span class="dv">15</span>)</span>
<span id="cb237-8"><a href="#cb237-8" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].set_ylabel(<span class="st">'Count'</span>,size <span class="op">=</span> <span class="dv">15</span>)</span>
<span id="cb237-9"><a href="#cb237-9" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].set_title(<span class="st">'Offer Type by Count'</span>, size <span class="op">=</span> <span class="dv">20</span>)</span>
<span id="cb237-10"><a href="#cb237-10" aria-hidden="true" tabindex="-1"></a>group_labels <span class="op">=</span> [<span class="st">'bogo_3'</span>, <span class="st">'discount_4'</span>, <span class="st">'discount_3'</span>, </span>
<span id="cb237-11"><a href="#cb237-11" aria-hidden="true" tabindex="-1"></a>                <span class="st">'discount_2'</span>, <span class="st">'discount_1'</span>, <span class="st">'bogo_4'</span>, </span>
<span id="cb237-12"><a href="#cb237-12" aria-hidden="true" tabindex="-1"></a>                <span class="st">'bogo_1'</span>, <span class="st">'bogo_2'</span>]</span>
<span id="cb237-13"><a href="#cb237-13" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].set_xticklabels(group_labels, rotation<span class="op">=-</span><span class="dv">45</span>)</span>
<span id="cb237-14"><a href="#cb237-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb237-15"><a href="#cb237-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb237-16"><a href="#cb237-16" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].plot(percent_success.index <span class="op">+</span> <span class="dv">1</span>, percent_success[<span class="st">'percent_success'</span>], linewidth<span class="op">=</span><span class="fl">4.0</span>, color<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb237-17"><a href="#cb237-17" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].set_xticks(np.arange(<span class="dv">0</span>,<span class="dv">8</span>) <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb237-18"><a href="#cb237-18" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].set_xlabel(<span class="st">'Offer Type'</span>,size <span class="op">=</span> <span class="dv">15</span>)</span>
<span id="cb237-19"><a href="#cb237-19" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].set_ylabel(<span class="st">'Percent Success'</span>,size <span class="op">=</span> <span class="dv">15</span>)</span>
<span id="cb237-20"><a href="#cb237-20" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].set_title(<span class="st">'Percent Success by Offer Type'</span>, size <span class="op">=</span> <span class="dv">20</span>)</span>
<span id="cb237-21"><a href="#cb237-21" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].set_xticklabels(group_labels, rotation<span class="op">=-</span><span class="dv">45</span>)</span>
<span id="cb237-22"><a href="#cb237-22" aria-hidden="true" tabindex="-1"></a>group_labels <span class="op">=</span> [<span class="st">'bogo_3'</span>, <span class="st">'discount_4'</span>, <span class="st">'discount_3'</span>, </span>
<span id="cb237-23"><a href="#cb237-23" aria-hidden="true" tabindex="-1"></a>                <span class="st">'discount_2'</span>, <span class="st">'discount_1'</span>, <span class="st">'bogo_4'</span>, </span>
<span id="cb237-24"><a href="#cb237-24" aria-hidden="true" tabindex="-1"></a>                <span class="st">'bogo_1'</span>, <span class="st">'bogo_2'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2021-07-14-Starbucks-Optimising-Customer-Segmentation-with-Random-Forest-and-Gradient-Boosting_files/figure-html/cell-175-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>The bogo_3 is the most succesful offer with 29% success. The discount offers perfomed pretty well averaging 27%.</p>
</section>
<section id="distribution-of-events-per-gender" class="level3">
<h3 class="anchored" data-anchor-id="distribution-of-events-per-gender">Distribution of Events per Gender</h3>
<div class="cell" data-execution_count="172">
<div class="sourceCode cell-code" id="cb238"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb238-1"><a href="#cb238-1" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">6</span>))</span>
<span id="cb238-2"><a href="#cb238-2" aria-hidden="true" tabindex="-1"></a>g <span class="op">=</span> sns.countplot(x<span class="op">=</span><span class="st">"gender"</span>, hue<span class="op">=</span><span class="st">"event"</span>, data<span class="op">=</span>master_df)</span>
<span id="cb238-3"><a href="#cb238-3" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Count of Event Type per Gender'</span>)</span>
<span id="cb238-4"><a href="#cb238-4" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Total'</span>)</span>
<span id="cb238-5"><a href="#cb238-5" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Gender'</span>)</span>
<span id="cb238-6"><a href="#cb238-6" aria-hidden="true" tabindex="-1"></a>plt.xticks(rotation <span class="op">=</span> <span class="dv">0</span>)</span>
<span id="cb238-7"><a href="#cb238-7" aria-hidden="true" tabindex="-1"></a>plt.legend(title<span class="op">=</span><span class="st">'Event'</span>)</span>
<span id="cb238-8"><a href="#cb238-8" aria-hidden="true" tabindex="-1"></a>plt.show()<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2021-07-14-Starbucks-Optimising-Customer-Segmentation-with-Random-Forest-and-Gradient-Boosting_files/figure-html/cell-176-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="173">
<div class="sourceCode cell-code" id="cb239"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb239-1"><a href="#cb239-1" aria-hidden="true" tabindex="-1"></a>master_df.groupby([<span class="st">'event'</span>,<span class="st">'gender'</span>,<span class="st">'offer_type'</span>]).customer_id.count()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="173">
<pre><code>event            gender  offer_type   
auto completed   F       BOGO               995
                         Discount          1360
                 M       BOGO               963
                         Discount          1271
                 O       BOGO                20
                         Discount            23
offer completed  F       BOGO              7566
                         Discount          5742
                         Informational     2668
                 M       BOGO              9785
                         Discount          6762
                         Informational     3809
                 O       BOGO               253
                         Discount           209
                         Informational      105
offer received   F       BOGO             10975
                         Discount         10943
                         Informational     5538
                 M       BOGO             15208
                         Discount         15354
                         Informational     7567
                 O       BOGO               354
                         Discount           367
                         Informational      195
offer viewed     F       BOGO              1368
                         Discount          1894
                         Informational     1242
                 M       BOGO              2534
                         Discount          3488
                         Informational     1480
                 O       BOGO                56
                         Discount            78
                         Informational       56
Name: customer_id, dtype: int64</code></pre>
</div>
</div>
<div class="cell" data-execution_count="174">
<div class="sourceCode cell-code" id="cb241"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb241-1"><a href="#cb241-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Number of BOGO offers that were received by females but not completed:"</span>)</span>
<span id="cb241-2"><a href="#cb241-2" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(master_df[(master_df.offer_type <span class="op">==</span> <span class="st">"BOGO"</span>) <span class="op">&amp;</span> (master_df.gender <span class="op">==</span> <span class="st">"F"</span>) <span class="op">&amp;</span> (master_df.event <span class="op">==</span> <span class="st">"offer received"</span>)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Number of BOGO offers that were received by females but not completed:</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="174">
<pre><code>10975</code></pre>
</div>
</div>
<blockquote class="blockquote">
<p><strong>Female BOGO offer</strong>: * 10 975 females received the BOGO offers, 1368 viewed it but did not complete it. 7566 received and completed it. Only 995 of them auto completed it. <strong>Female Discount offer</strong>: * 10 943 females received the Discount offers, 1267 viewed but did not complete. 6369 received and completed it.1360 of them auto completed it. <strong>Female Informational offer</strong>: * 5538 females received the informational offer, 1242 viewed but did not complete the offer. 2668 received and completed the offer.</p>
</blockquote>
<blockquote class="blockquote">
<p><strong>Male BOGO offer</strong>: * 15 208 males received the BOGO offer. Of these 2534 viewed the offer but did not complete it. 9785 received and completed the offer. 963 completed the offer automatically. <strong>Male Discount offer</strong>: * 15 354 males received the discount offer. Of these 2201 males only viewed the offer. 8049 received and completed the offer. 1271 auto completed the offer <strong>Male Informational offer</strong>: * 7567 males received the informational offer. 1480 males viewed the offer without completing it. 3809 received and completed it</p>
</blockquote>
<blockquote class="blockquote">
<p><strong>Gender unspecified BOGO offer</strong>: * 354 of these customers received the offer. 56 only viewed the offer. 253 received and completed the offer while 20 auto completed it.</p>
</blockquote>
</section>
<section id="distribution-of-events-per-income-range" class="level3">
<h3 class="anchored" data-anchor-id="distribution-of-events-per-income-range">Distribution of Events per Income range</h3>
<div class="cell" data-execution_count="175">
<div class="sourceCode cell-code" id="cb244"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb244-1"><a href="#cb244-1" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">6</span>))</span>
<span id="cb244-2"><a href="#cb244-2" aria-hidden="true" tabindex="-1"></a>g <span class="op">=</span> sns.countplot(x<span class="op">=</span><span class="st">"income_range"</span>, hue<span class="op">=</span><span class="st">"event"</span>, data<span class="op">=</span>master_df)</span>
<span id="cb244-3"><a href="#cb244-3" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Count of Event Type per Income Range'</span>)</span>
<span id="cb244-4"><a href="#cb244-4" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Total'</span>)</span>
<span id="cb244-5"><a href="#cb244-5" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Type of Member'</span>)</span>
<span id="cb244-6"><a href="#cb244-6" aria-hidden="true" tabindex="-1"></a>xlabels <span class="op">=</span> [<span class="st">'low'</span>,<span class="st">'low_to_mid'</span>,<span class="st">'mid'</span>,<span class="st">'mid_to_high'</span>,<span class="st">'high'</span>]</span>
<span id="cb244-7"><a href="#cb244-7" aria-hidden="true" tabindex="-1"></a>g.set_xticklabels(xlabels)</span>
<span id="cb244-8"><a href="#cb244-8" aria-hidden="true" tabindex="-1"></a>plt.xticks(rotation <span class="op">=</span> <span class="dv">0</span>)</span>
<span id="cb244-9"><a href="#cb244-9" aria-hidden="true" tabindex="-1"></a>plt.legend(title<span class="op">=</span><span class="st">'Event'</span>)</span>
<span id="cb244-10"><a href="#cb244-10" aria-hidden="true" tabindex="-1"></a>plt.show()<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2021-07-14-Starbucks-Optimising-Customer-Segmentation-with-Random-Forest-and-Gradient-Boosting_files/figure-html/cell-179-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="176">
<div class="sourceCode cell-code" id="cb245"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb245-1"><a href="#cb245-1" aria-hidden="true" tabindex="-1"></a>master_df.groupby([<span class="st">'event'</span>,<span class="st">'income_range'</span>]).customer_id.count()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="176">
<pre><code>event            income_range
auto completed   high             1052
                 low                18
                 low_to_mid       1088
                 mid              1205
                 mid_to_high      1269
offer completed  high             5466
                 low               187
                 low_to_mid       8869
                 mid             13039
                 mid_to_high      9338
offer received   high             9814
                 low               396
                 low_to_mid      17715
                 mid             22495
                 mid_to_high     16081
offer viewed     high             1684
                 low                69
                 low_to_mid       3150
                 mid              4338
                 mid_to_high      2955
transaction      high             7139
                 low               672
                 low_to_mid      29632
                 mid             30793
                 mid_to_high     14699
Name: customer_id, dtype: int64</code></pre>
</div>
</div>
<p>Mid income earners received and completed the most offers and made the most transactions.</p>
<p>Low to mid income earners were the second highest in terms of offers received and completed.</p>
<div class="cell" data-execution_count="177">
<div class="sourceCode cell-code" id="cb247"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb247-1"><a href="#cb247-1" aria-hidden="true" tabindex="-1"></a>master_df.groupby([<span class="st">'event'</span>,<span class="st">'offer_type'</span>,<span class="st">'income_range'</span>]).customer_id.count()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="177">
<pre><code>event            offer_type     income_range
auto completed   BOGO           high             434
                                low                9
                                low_to_mid       473
                                mid              504
                                mid_to_high      558
                 Discount       high             618
                                low                9
                                low_to_mid       615
                                mid              701
                                mid_to_high      711
offer completed  BOGO           high            2621
                                low              100
                                low_to_mid      4420
                                mid             6095
                                mid_to_high     4368
                 Discount       high            2038
                                low               50
                                low_to_mid      2679
                                mid             4398
                                mid_to_high     3548
                 Informational  high             807
                                low               37
                                low_to_mid      1770
                                mid             2546
                                mid_to_high     1422
offer received   BOGO           high            3967
                                low              167
                                low_to_mid      7087
                                mid             8904
                                mid_to_high     6412
                 Discount       high            3865
                                low              148
                                low_to_mid      7120
                                mid             9019
                                mid_to_high     6512
                 Informational  high            1982
                                low               81
                                low_to_mid      3508
                                mid             4572
                                mid_to_high     3157
offer viewed     BOGO           high             506
                                low               26
                                low_to_mid      1171
                                mid             1374
                                mid_to_high      881
                 Discount       high             666
                                low               33
                                low_to_mid      1495
                                mid             2055
                                mid_to_high     1211
                 Informational  high             512
                                low               10
                                low_to_mid       484
                                mid              909
                                mid_to_high      863
Name: customer_id, dtype: int64</code></pre>
</div>
</div>
</section>
<section id="distribution-of-events-by-age-group" class="level3">
<h3 class="anchored" data-anchor-id="distribution-of-events-by-age-group">Distribution of events by age group</h3>
<div class="cell" data-execution_count="178">
<div class="sourceCode cell-code" id="cb249"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb249-1"><a href="#cb249-1" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">6</span>))</span>
<span id="cb249-2"><a href="#cb249-2" aria-hidden="true" tabindex="-1"></a>g <span class="op">=</span> sns.countplot(x<span class="op">=</span><span class="st">"age_group"</span>, hue<span class="op">=</span><span class="st">"event"</span>, data<span class="op">=</span>master_df)</span>
<span id="cb249-3"><a href="#cb249-3" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Count of Event Type per Age Group'</span>)</span>
<span id="cb249-4"><a href="#cb249-4" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Total'</span>)</span>
<span id="cb249-5"><a href="#cb249-5" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Type of Member'</span>)</span>
<span id="cb249-6"><a href="#cb249-6" aria-hidden="true" tabindex="-1"></a>xlabels <span class="op">=</span> [<span class="st">'teenager'</span>,<span class="st">'young-adult'</span>,<span class="st">'adult'</span>,<span class="st">'elderly'</span>]</span>
<span id="cb249-7"><a href="#cb249-7" aria-hidden="true" tabindex="-1"></a>g.set_xticklabels(xlabels)</span>
<span id="cb249-8"><a href="#cb249-8" aria-hidden="true" tabindex="-1"></a>plt.xticks(rotation <span class="op">=</span> <span class="dv">0</span>)</span>
<span id="cb249-9"><a href="#cb249-9" aria-hidden="true" tabindex="-1"></a>plt.legend(title<span class="op">=</span><span class="st">'Event'</span>)</span>
<span id="cb249-10"><a href="#cb249-10" aria-hidden="true" tabindex="-1"></a>plt.show()<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2021-07-14-Starbucks-Optimising-Customer-Segmentation-with-Random-Forest-and-Gradient-Boosting_files/figure-html/cell-182-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="179">
<div class="sourceCode cell-code" id="cb250"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb250-1"><a href="#cb250-1" aria-hidden="true" tabindex="-1"></a>master_df.groupby([<span class="st">'event'</span>,<span class="st">'age_group'</span>]).customer_id.count()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="179">
<pre><code>event            age_group  
auto completed   adult           2054
                 elderly         1859
                 teenager         166
                 young-adult      553
offer completed  adult          17478
                 elderly        13889
                 teenager        1380
                 young-adult     4152
offer received   adult          30957
                 elderly        24808
                 teenager        2714
                 young-adult     8022
offer viewed     adult           5885
                 elderly         4516
                 teenager         487
                 young-adult     1308
transaction      adult          37222
                 elderly        27406
                 teenager        4608
                 young-adult    13699
Name: customer_id, dtype: int64</code></pre>
</div>
</div>
<section id="analysis-of-those-who-completed-the-offer-by-age-group" class="level4">
<h4 class="anchored" data-anchor-id="analysis-of-those-who-completed-the-offer-by-age-group">Analysis of those who completed the offer by age group</h4>
<div class="cell" data-execution_count="180">
<div class="sourceCode cell-code" id="cb252"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb252-1"><a href="#cb252-1" aria-hidden="true" tabindex="-1"></a>completed <span class="op">=</span> master_df[master_df[<span class="st">'offer_completed'</span>]<span class="op">==</span><span class="dv">1</span>]</span>
<span id="cb252-2"><a href="#cb252-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb252-3"><a href="#cb252-3" aria-hidden="true" tabindex="-1"></a>completed <span class="op">=</span> pd.DataFrame(completed.age_group.value_counts()).reset_index()</span>
<span id="cb252-4"><a href="#cb252-4" aria-hidden="true" tabindex="-1"></a>not_completed <span class="op">=</span> pd.DataFrame(master_df.age_group.value_counts()).reset_index()</span>
<span id="cb252-5"><a href="#cb252-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb252-6"><a href="#cb252-6" aria-hidden="true" tabindex="-1"></a>merge <span class="op">=</span> pd.merge(completed, not_completed, how<span class="op">=</span><span class="st">'inner'</span>, on<span class="op">=</span><span class="st">'index'</span>)</span>
<span id="cb252-7"><a href="#cb252-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb252-8"><a href="#cb252-8" aria-hidden="true" tabindex="-1"></a>merge <span class="op">=</span> merge.rename(columns<span class="op">=</span>{<span class="st">"age_group_x"</span>:<span class="st">'completed'</span>, <span class="st">"age_group_y"</span>:<span class="st">'not_completed'</span>, <span class="st">"index"</span>:<span class="st">'age_group'</span> })</span>
<span id="cb252-9"><a href="#cb252-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb252-10"><a href="#cb252-10" aria-hidden="true" tabindex="-1"></a>merge</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="180">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>age_group</th>
      <th>completed</th>
      <th>not_completed</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>adult</td>
      <td>17478</td>
      <td>93596</td>
    </tr>
    <tr>
      <th>1</th>
      <td>elderly</td>
      <td>13889</td>
      <td>72478</td>
    </tr>
    <tr>
      <th>2</th>
      <td>young-adult</td>
      <td>4152</td>
      <td>27734</td>
    </tr>
    <tr>
      <th>3</th>
      <td>teenager</td>
      <td>1380</td>
      <td>9355</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="cell" data-execution_count="181">
<div class="sourceCode cell-code" id="cb253"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb253-1"><a href="#cb253-1" aria-hidden="true" tabindex="-1"></a>sns.<span class="bu">set</span>(style<span class="op">=</span><span class="st">"whitegrid"</span>)</span>
<span id="cb253-2"><a href="#cb253-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb253-3"><a href="#cb253-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize the matplotlib figure</span></span>
<span id="cb253-4"><a href="#cb253-4" aria-hidden="true" tabindex="-1"></a>f, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">13</span>, <span class="dv">7</span>))</span>
<span id="cb253-5"><a href="#cb253-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb253-6"><a href="#cb253-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the total schools per city</span></span>
<span id="cb253-7"><a href="#cb253-7" aria-hidden="true" tabindex="-1"></a>sns.set_color_codes(<span class="st">"pastel"</span>)</span>
<span id="cb253-8"><a href="#cb253-8" aria-hidden="true" tabindex="-1"></a>sns.barplot(x<span class="op">=</span><span class="st">"not_completed"</span>, y<span class="op">=</span><span class="st">'age_group'</span>, data<span class="op">=</span>merge,</span>
<span id="cb253-9"><a href="#cb253-9" aria-hidden="true" tabindex="-1"></a>            label<span class="op">=</span><span class="st">"Total"</span>, color<span class="op">=</span><span class="st">"b"</span>)</span>
<span id="cb253-10"><a href="#cb253-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb253-11"><a href="#cb253-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the total community schools per city</span></span>
<span id="cb253-12"><a href="#cb253-12" aria-hidden="true" tabindex="-1"></a>sns.set_color_codes(<span class="st">"muted"</span>)</span>
<span id="cb253-13"><a href="#cb253-13" aria-hidden="true" tabindex="-1"></a>sns.barplot(x<span class="op">=</span><span class="st">"completed"</span>, y<span class="op">=</span><span class="st">"age_group"</span>, data<span class="op">=</span>merge,</span>
<span id="cb253-14"><a href="#cb253-14" aria-hidden="true" tabindex="-1"></a>            label<span class="op">=</span><span class="st">"completed"</span>, color<span class="op">=</span><span class="st">"r"</span>)</span>
<span id="cb253-15"><a href="#cb253-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb253-16"><a href="#cb253-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Add a legend and informative axis label</span></span>
<span id="cb253-17"><a href="#cb253-17" aria-hidden="true" tabindex="-1"></a>ax.legend(ncol<span class="op">=</span><span class="dv">2</span>, loc<span class="op">=</span><span class="st">"lower right"</span>, frameon<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb253-18"><a href="#cb253-18" aria-hidden="true" tabindex="-1"></a>ax.<span class="bu">set</span>( ylabel<span class="op">=</span><span class="st">"Age Group"</span>, title<span class="op">=</span><span class="st">'Number of people Per Age Group'</span>,</span>
<span id="cb253-19"><a href="#cb253-19" aria-hidden="true" tabindex="-1"></a>       xlabel<span class="op">=</span><span class="st">"# of people"</span>)</span>
<span id="cb253-20"><a href="#cb253-20" aria-hidden="true" tabindex="-1"></a>sns.despine(left<span class="op">=</span><span class="va">True</span>, bottom<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2021-07-14-Starbucks-Optimising-Customer-Segmentation-with-Random-Forest-and-Gradient-Boosting_files/figure-html/cell-185-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="182">
<div class="sourceCode cell-code" id="cb254"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb254-1"><a href="#cb254-1" aria-hidden="true" tabindex="-1"></a>master_df.groupby([<span class="st">'event'</span>,<span class="st">'age_group'</span>]).customer_id.count()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="182">
<pre><code>event            age_group  
auto completed   adult           2054
                 elderly         1859
                 teenager         166
                 young-adult      553
offer completed  adult          17478
                 elderly        13889
                 teenager        1380
                 young-adult     4152
offer received   adult          30957
                 elderly        24808
                 teenager        2714
                 young-adult     8022
offer viewed     adult           5885
                 elderly         4516
                 teenager         487
                 young-adult     1308
transaction      adult          37222
                 elderly        27406
                 teenager        4608
                 young-adult    13699
Name: customer_id, dtype: int64</code></pre>
</div>
</div>
</section>
<section id="clusters-of-those-who-completed-the-offer" class="level4">
<h4 class="anchored" data-anchor-id="clusters-of-those-who-completed-the-offer">Clusters of those who completed the offer</h4>
<div class="cell" data-execution_count="183">
<div class="sourceCode cell-code" id="cb256"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb256-1"><a href="#cb256-1" aria-hidden="true" tabindex="-1"></a><span class="co">## For the KDEs and Clustering, we need the cat variables numeric</span></span>
<span id="cb256-2"><a href="#cb256-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb256-3"><a href="#cb256-3" aria-hidden="true" tabindex="-1"></a>master_df[<span class="st">'income_range'</span>] <span class="op">=</span> master_df[<span class="st">'income_range'</span>].<span class="bu">map</span>({<span class="st">'low'</span>: <span class="dv">1</span>, <span class="st">'low_to_mid'</span>: <span class="dv">2</span>, <span class="st">'mid'</span>:<span class="dv">3</span>, <span class="st">'mid_to_high'</span>:<span class="dv">4</span>, <span class="st">'high'</span>:<span class="dv">5</span>})</span>
<span id="cb256-4"><a href="#cb256-4" aria-hidden="true" tabindex="-1"></a>master_df[<span class="st">'age_group'</span>] <span class="op">=</span> master_df[<span class="st">'age_group'</span>].<span class="bu">map</span>({<span class="st">'teenager'</span>:<span class="dv">1</span> , <span class="st">'young-adult'</span>: <span class="dv">2</span>, <span class="st">'adult'</span>:<span class="dv">3</span>, <span class="st">'elderly'</span>:<span class="dv">4</span>})</span>
<span id="cb256-5"><a href="#cb256-5" aria-hidden="true" tabindex="-1"></a>master_df[<span class="st">'gender'</span>] <span class="op">=</span> master_df[<span class="st">'gender'</span>].<span class="bu">map</span>({<span class="st">'M'</span>:<span class="dv">1</span> , <span class="st">'F'</span>: <span class="dv">2</span>, <span class="st">'O'</span>:<span class="dv">3</span>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="184">
<div class="sourceCode cell-code" id="cb257"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb257-1"><a href="#cb257-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Import KMeans Model</span></span>
<span id="cb257-2"><a href="#cb257-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.cluster <span class="im">import</span> KMeans</span>
<span id="cb257-3"><a href="#cb257-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb257-4"><a href="#cb257-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Graph and create 3 clusters of offer completed</span></span>
<span id="cb257-5"><a href="#cb257-5" aria-hidden="true" tabindex="-1"></a>kmeans <span class="op">=</span> KMeans(n_clusters<span class="op">=</span><span class="dv">3</span>,random_state<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb257-6"><a href="#cb257-6" aria-hidden="true" tabindex="-1"></a>kmeans.fit(new_df[new_df.offer_completed<span class="op">==</span><span class="dv">1</span>][[<span class="st">"age_group"</span>,<span class="st">"income_range"</span>]])</span>
<span id="cb257-7"><a href="#cb257-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb257-8"><a href="#cb257-8" aria-hidden="true" tabindex="-1"></a>kmeans_colors <span class="op">=</span> [<span class="st">'green'</span> <span class="cf">if</span> c <span class="op">==</span> <span class="dv">0</span> <span class="cf">else</span> <span class="st">'blue'</span> <span class="cf">if</span> c <span class="op">==</span> <span class="dv">2</span> <span class="cf">else</span> <span class="st">'red'</span> <span class="cf">for</span> c <span class="kw">in</span> kmeans.labels_]</span>
<span id="cb257-9"><a href="#cb257-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb257-10"><a href="#cb257-10" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb257-11"><a href="#cb257-11" aria-hidden="true" tabindex="-1"></a>plt.scatter(x<span class="op">=</span><span class="st">"age_group"</span>,y<span class="op">=</span><span class="st">"income_range"</span>, data<span class="op">=</span>new_df[new_df.offer_completed<span class="op">==</span><span class="dv">1</span>],</span>
<span id="cb257-12"><a href="#cb257-12" aria-hidden="true" tabindex="-1"></a>            alpha<span class="op">=</span><span class="fl">0.25</span>,color <span class="op">=</span> kmeans_colors)</span>
<span id="cb257-13"><a href="#cb257-13" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Age Group"</span>)</span>
<span id="cb257-14"><a href="#cb257-14" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Income Range"</span>)</span>
<span id="cb257-15"><a href="#cb257-15" aria-hidden="true" tabindex="-1"></a>plt.scatter(x<span class="op">=</span>kmeans.cluster_centers_[:,<span class="dv">0</span>],y<span class="op">=</span>kmeans.cluster_centers_[:,<span class="dv">1</span>],color<span class="op">=</span><span class="st">"black"</span>,marker<span class="op">=</span><span class="st">"X"</span>,s<span class="op">=</span><span class="dv">100</span>)</span>
<span id="cb257-16"><a href="#cb257-16" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Clusters of Offer completed"</span>)</span>
<span id="cb257-17"><a href="#cb257-17" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2021-07-14-Starbucks-Optimising-Customer-Segmentation-with-Random-Forest-and-Gradient-Boosting_files/figure-html/cell-188-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>There are 3 clusters of those that completed the offer those that were older and had high income. Those that were older and had mid income and those that were middle aged and middle income earners. We will do an advanced customer segmentation</p>
</section>
<section id="age-distribution-of-those-who-completed-the-offer" class="level4">
<h4 class="anchored" data-anchor-id="age-distribution-of-those-who-completed-the-offer">Age distribution of those who completed the offer</h4>
<div class="cell" data-execution_count="185">
<div class="sourceCode cell-code" id="cb258"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb258-1"><a href="#cb258-1" aria-hidden="true" tabindex="-1"></a><span class="co">#KDEPlot: Kernel Density Estimate Plot</span></span>
<span id="cb258-2"><a href="#cb258-2" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>(<span class="dv">15</span>,<span class="dv">4</span>))</span>
<span id="cb258-3"><a href="#cb258-3" aria-hidden="true" tabindex="-1"></a>ax<span class="op">=</span>sns.kdeplot(master_df.loc[(master_df[<span class="st">'offer_completed'</span>] <span class="op">==</span> <span class="dv">0</span>),<span class="st">'age_group'</span>] ,label<span class="op">=</span><span class="st">'offer not completed'</span>, color<span class="op">=</span><span class="st">'b'</span>,shade<span class="op">=</span><span class="va">True</span> )</span>
<span id="cb258-4"><a href="#cb258-4" aria-hidden="true" tabindex="-1"></a>ax<span class="op">=</span>sns.kdeplot(master_df.loc[(master_df[<span class="st">'offer_completed'</span>] <span class="op">==</span> <span class="dv">1</span>),<span class="st">'age_group'</span>] , color<span class="op">=</span><span class="st">'r'</span>,shade<span class="op">=</span><span class="va">True</span>, label<span class="op">=</span><span class="st">'turnover'</span>)</span>
<span id="cb258-5"><a href="#cb258-5" aria-hidden="true" tabindex="-1"></a>ax.<span class="bu">set</span>(xlabel<span class="op">=</span><span class="st">'Age distribution of those who completed the offer'</span>, ylabel<span class="op">=</span><span class="st">'Frequency'</span>)</span>
<span id="cb258-6"><a href="#cb258-6" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Age Distribution - Offer completed V.S. Offer not completed'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="185">
<pre><code>Text(0.5, 1.0, 'Age Distribution - Offer completed V.S. Offer not completed')</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="2021-07-14-Starbucks-Optimising-Customer-Segmentation-with-Random-Forest-and-Gradient-Boosting_files/figure-html/cell-189-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>Most of the customers that completed offers were adults and the elderly. The least to complete offers were the teens and young adults</p>
</section>
<section id="income-distribution-of-those-who-completed-the-offer" class="level4">
<h4 class="anchored" data-anchor-id="income-distribution-of-those-who-completed-the-offer">Income distribution of those who completed the offer</h4>
<div class="cell" data-execution_count="186">
<div class="sourceCode cell-code" id="cb260"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb260-1"><a href="#cb260-1" aria-hidden="true" tabindex="-1"></a><span class="co">#KDEPlot: Kernel Density Estimate Plot</span></span>
<span id="cb260-2"><a href="#cb260-2" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>(<span class="dv">15</span>,<span class="dv">4</span>))</span>
<span id="cb260-3"><a href="#cb260-3" aria-hidden="true" tabindex="-1"></a>ax<span class="op">=</span>sns.kdeplot(master_df.loc[(master_df[<span class="st">'offer_completed'</span>] <span class="op">==</span> <span class="dv">0</span>),<span class="st">'income_range'</span>] ,label<span class="op">=</span><span class="st">'offer not completed'</span>, color<span class="op">=</span><span class="st">'b'</span>,shade<span class="op">=</span><span class="va">True</span> )</span>
<span id="cb260-4"><a href="#cb260-4" aria-hidden="true" tabindex="-1"></a>ax<span class="op">=</span>sns.kdeplot(master_df.loc[(master_df[<span class="st">'offer_completed'</span>] <span class="op">==</span> <span class="dv">1</span>),<span class="st">'income_range'</span>] , color<span class="op">=</span><span class="st">'r'</span>,shade<span class="op">=</span><span class="va">True</span>, label<span class="op">=</span><span class="st">'turnover'</span>)</span>
<span id="cb260-5"><a href="#cb260-5" aria-hidden="true" tabindex="-1"></a>ax.<span class="bu">set</span>(xlabel<span class="op">=</span><span class="st">'Income distribution of those who completed the offer'</span>, ylabel<span class="op">=</span><span class="st">'Frequency'</span>)</span>
<span id="cb260-6"><a href="#cb260-6" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Income Distribution - Offer completed V.S. Offer not completed'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="186">
<pre><code>Text(0.5, 1.0, 'Income Distribution - Offer completed V.S. Offer not completed')</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="2021-07-14-Starbucks-Optimising-Customer-Segmentation-with-Random-Forest-and-Gradient-Boosting_files/figure-html/cell-190-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>The bulk of those that completed offers were low to mid and mid income earners</p>
<p><a id="segmentation"></a><a> ## Creating customer clusters using KNN</a></p><a>
</a><div class="cell" data-execution_count="187"><a>
</a><div class="sourceCode cell-code" id="cb262"><a></a><pre class="sourceCode python code-with-copy"><a><code class="sourceCode python"><span id="cb262-1"></span></code></a><code class="sourceCode python"><a href="#cb262-1" aria-hidden="true" tabindex="-1"></a>clustering_df</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="187">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>possible_reward</th>
      <th>spent_required</th>
      <th>offer_duration_days</th>
      <th>offer_type</th>
      <th>offer_id</th>
      <th>channel_email</th>
      <th>channel_mobile</th>
      <th>channel_social</th>
      <th>channel_web</th>
      <th>gender</th>
      <th>...</th>
      <th>Unnamed: 0</th>
      <th>event</th>
      <th>time</th>
      <th>money_spent</th>
      <th>money_gained</th>
      <th>offer_completed</th>
      <th>offer_received</th>
      <th>offer_viewed</th>
      <th>transaction</th>
      <th>auto_completed</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>5.0</td>
      <td>5.0</td>
      <td>7.0</td>
      <td>1</td>
      <td>9b98b8c7a33c4b65b9aebfe6a799e6d9</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>F</td>
      <td>...</td>
      <td>0</td>
      <td>offer received</td>
      <td>0.0</td>
      <td>0.00</td>
      <td>0.0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>5.0</td>
      <td>5.0</td>
      <td>7.0</td>
      <td>1</td>
      <td>9b98b8c7a33c4b65b9aebfe6a799e6d9</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>F</td>
      <td>...</td>
      <td>47583</td>
      <td>offer completed</td>
      <td>5.5</td>
      <td>19.89</td>
      <td>5.0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>5.0</td>
      <td>5.0</td>
      <td>7.0</td>
      <td>1</td>
      <td>9b98b8c7a33c4b65b9aebfe6a799e6d9</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>M</td>
      <td>...</td>
      <td>150600</td>
      <td>offer received</td>
      <td>17.0</td>
      <td>0.00</td>
      <td>0.0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>5.0</td>
      <td>5.0</td>
      <td>7.0</td>
      <td>1</td>
      <td>9b98b8c7a33c4b65b9aebfe6a799e6d9</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>M</td>
      <td>...</td>
      <td>171209</td>
      <td>offer viewed</td>
      <td>17.5</td>
      <td>0.00</td>
      <td>0.0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5.0</td>
      <td>5.0</td>
      <td>7.0</td>
      <td>1</td>
      <td>9b98b8c7a33c4b65b9aebfe6a799e6d9</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>M</td>
      <td>...</td>
      <td>53179</td>
      <td>offer received</td>
      <td>7.0</td>
      <td>0.00</td>
      <td>0.0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>214599</th>
      <td>10.0</td>
      <td>10.0</td>
      <td>5.0</td>
      <td>1</td>
      <td>4d5c57ea9a6940dd891ad53e9dbe8da0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>M</td>
      <td>...</td>
      <td>217850</td>
      <td>offer viewed</td>
      <td>21.0</td>
      <td>0.00</td>
      <td>0.0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>214600</th>
      <td>10.0</td>
      <td>10.0</td>
      <td>5.0</td>
      <td>1</td>
      <td>4d5c57ea9a6940dd891ad53e9dbe8da0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>M</td>
      <td>...</td>
      <td>257182</td>
      <td>offer received</td>
      <td>24.0</td>
      <td>0.00</td>
      <td>0.0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>214601</th>
      <td>10.0</td>
      <td>10.0</td>
      <td>5.0</td>
      <td>1</td>
      <td>4d5c57ea9a6940dd891ad53e9dbe8da0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>M</td>
      <td>...</td>
      <td>261927</td>
      <td>offer viewed</td>
      <td>24.0</td>
      <td>0.00</td>
      <td>0.0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>214602</th>
      <td>10.0</td>
      <td>10.0</td>
      <td>5.0</td>
      <td>1</td>
      <td>4d5c57ea9a6940dd891ad53e9dbe8da0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>F</td>
      <td>...</td>
      <td>253904</td>
      <td>offer received</td>
      <td>24.0</td>
      <td>0.00</td>
      <td>0.0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>214603</th>
      <td>10.0</td>
      <td>10.0</td>
      <td>5.0</td>
      <td>1</td>
      <td>4d5c57ea9a6940dd891ad53e9dbe8da0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>F</td>
      <td>...</td>
      <td>260855</td>
      <td>offer viewed</td>
      <td>24.0</td>
      <td>0.00</td>
      <td>0.0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
<p>214604 rows × 26 columns</p>
</div>
</div>
</div>
<div class="cell" data-execution_count="188">
<div class="sourceCode cell-code" id="cb263"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb263-1"><a href="#cb263-1" aria-hidden="true" tabindex="-1"></a>cust_df<span class="op">=</span>clustering_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="189">
<div class="sourceCode cell-code" id="cb264"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb264-1"><a href="#cb264-1" aria-hidden="true" tabindex="-1"></a>cust_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="189">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>possible_reward</th>
      <th>spent_required</th>
      <th>offer_duration_days</th>
      <th>offer_type</th>
      <th>offer_id</th>
      <th>channel_email</th>
      <th>channel_mobile</th>
      <th>channel_social</th>
      <th>channel_web</th>
      <th>gender</th>
      <th>...</th>
      <th>Unnamed: 0</th>
      <th>event</th>
      <th>time</th>
      <th>money_spent</th>
      <th>money_gained</th>
      <th>offer_completed</th>
      <th>offer_received</th>
      <th>offer_viewed</th>
      <th>transaction</th>
      <th>auto_completed</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>5.0</td>
      <td>5.0</td>
      <td>7.0</td>
      <td>1</td>
      <td>9b98b8c7a33c4b65b9aebfe6a799e6d9</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>F</td>
      <td>...</td>
      <td>0</td>
      <td>offer received</td>
      <td>0.0</td>
      <td>0.00</td>
      <td>0.0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>5.0</td>
      <td>5.0</td>
      <td>7.0</td>
      <td>1</td>
      <td>9b98b8c7a33c4b65b9aebfe6a799e6d9</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>F</td>
      <td>...</td>
      <td>47583</td>
      <td>offer completed</td>
      <td>5.5</td>
      <td>19.89</td>
      <td>5.0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>5.0</td>
      <td>5.0</td>
      <td>7.0</td>
      <td>1</td>
      <td>9b98b8c7a33c4b65b9aebfe6a799e6d9</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>M</td>
      <td>...</td>
      <td>150600</td>
      <td>offer received</td>
      <td>17.0</td>
      <td>0.00</td>
      <td>0.0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>5.0</td>
      <td>5.0</td>
      <td>7.0</td>
      <td>1</td>
      <td>9b98b8c7a33c4b65b9aebfe6a799e6d9</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>M</td>
      <td>...</td>
      <td>171209</td>
      <td>offer viewed</td>
      <td>17.5</td>
      <td>0.00</td>
      <td>0.0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5.0</td>
      <td>5.0</td>
      <td>7.0</td>
      <td>1</td>
      <td>9b98b8c7a33c4b65b9aebfe6a799e6d9</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>M</td>
      <td>...</td>
      <td>53179</td>
      <td>offer received</td>
      <td>7.0</td>
      <td>0.00</td>
      <td>0.0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>214599</th>
      <td>10.0</td>
      <td>10.0</td>
      <td>5.0</td>
      <td>1</td>
      <td>4d5c57ea9a6940dd891ad53e9dbe8da0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>M</td>
      <td>...</td>
      <td>217850</td>
      <td>offer viewed</td>
      <td>21.0</td>
      <td>0.00</td>
      <td>0.0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>214600</th>
      <td>10.0</td>
      <td>10.0</td>
      <td>5.0</td>
      <td>1</td>
      <td>4d5c57ea9a6940dd891ad53e9dbe8da0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>M</td>
      <td>...</td>
      <td>257182</td>
      <td>offer received</td>
      <td>24.0</td>
      <td>0.00</td>
      <td>0.0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>214601</th>
      <td>10.0</td>
      <td>10.0</td>
      <td>5.0</td>
      <td>1</td>
      <td>4d5c57ea9a6940dd891ad53e9dbe8da0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>M</td>
      <td>...</td>
      <td>261927</td>
      <td>offer viewed</td>
      <td>24.0</td>
      <td>0.00</td>
      <td>0.0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>214602</th>
      <td>10.0</td>
      <td>10.0</td>
      <td>5.0</td>
      <td>1</td>
      <td>4d5c57ea9a6940dd891ad53e9dbe8da0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>F</td>
      <td>...</td>
      <td>253904</td>
      <td>offer received</td>
      <td>24.0</td>
      <td>0.00</td>
      <td>0.0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>214603</th>
      <td>10.0</td>
      <td>10.0</td>
      <td>5.0</td>
      <td>1</td>
      <td>4d5c57ea9a6940dd891ad53e9dbe8da0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>F</td>
      <td>...</td>
      <td>260855</td>
      <td>offer viewed</td>
      <td>24.0</td>
      <td>0.00</td>
      <td>0.0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
<p>214604 rows × 26 columns</p>
</div>
</div>
</div>
<div class="cell" data-execution_count="190">
<div class="sourceCode cell-code" id="cb265"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb265-1"><a href="#cb265-1" aria-hidden="true" tabindex="-1"></a><span class="co">#map the values back to their categorical variables</span></span>
<span id="cb265-2"><a href="#cb265-2" aria-hidden="true" tabindex="-1"></a>cust_df[<span class="st">'income_range'</span>] <span class="op">=</span> cust_df[<span class="st">'income_range'</span>].<span class="bu">map</span>({<span class="dv">1</span>: <span class="st">'low'</span>, <span class="dv">2</span>: <span class="st">'low_to_mid'</span>, <span class="dv">3</span>:<span class="st">'mid'</span>,<span class="dv">4</span>:<span class="st">'mid_to_high'</span>,<span class="dv">5</span>:<span class="st">'high'</span>})</span>
<span id="cb265-3"><a href="#cb265-3" aria-hidden="true" tabindex="-1"></a>cust_df[<span class="st">'age_group'</span>] <span class="op">=</span> cust_df[<span class="st">'age_group'</span>].<span class="bu">map</span>({<span class="dv">1</span>: <span class="st">'teenager'</span>, <span class="dv">2</span>: <span class="st">'young-adult'</span>, <span class="dv">3</span>:<span class="st">'adult'</span>, <span class="dv">4</span>:<span class="st">'elderly'</span>})</span>
<span id="cb265-4"><a href="#cb265-4" aria-hidden="true" tabindex="-1"></a>cust_df[<span class="st">'member_type'</span>] <span class="op">=</span> cust_df[<span class="st">'member_type'</span>].<span class="bu">map</span>({<span class="dv">1</span>: <span class="st">'new'</span>, <span class="dv">2</span>: <span class="st">'regular'</span>, <span class="dv">3</span>:<span class="st">'loyal'</span>})</span>
<span id="cb265-5"><a href="#cb265-5" aria-hidden="true" tabindex="-1"></a>cust_df[<span class="st">'offer_type'</span>] <span class="op">=</span> cust_df[<span class="st">'offer_type'</span>].<span class="bu">map</span>({<span class="dv">1</span>: <span class="st">'BOGO'</span>, <span class="dv">2</span>: <span class="st">'Discount'</span>, <span class="dv">3</span>: <span class="st">'Informational'</span>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="191">
<div class="sourceCode cell-code" id="cb266"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb266-1"><a href="#cb266-1" aria-hidden="true" tabindex="-1"></a>columns_to_keep <span class="op">=</span> [<span class="st">'gender'</span>,</span>
<span id="cb266-2"><a href="#cb266-2" aria-hidden="true" tabindex="-1"></a> <span class="st">'age_group'</span>,</span>
<span id="cb266-3"><a href="#cb266-3" aria-hidden="true" tabindex="-1"></a> <span class="st">'customer_id'</span>,</span>
<span id="cb266-4"><a href="#cb266-4" aria-hidden="true" tabindex="-1"></a> <span class="st">'income_range'</span>,</span>
<span id="cb266-5"><a href="#cb266-5" aria-hidden="true" tabindex="-1"></a> <span class="st">'member_type'</span>,</span>
<span id="cb266-6"><a href="#cb266-6" aria-hidden="true" tabindex="-1"></a> <span class="st">'money_spent'</span>,</span>
<span id="cb266-7"><a href="#cb266-7" aria-hidden="true" tabindex="-1"></a> <span class="st">'money_gained'</span>,</span>
<span id="cb266-8"><a href="#cb266-8" aria-hidden="true" tabindex="-1"></a> <span class="st">'offer_type'</span>,                  </span>
<span id="cb266-9"><a href="#cb266-9" aria-hidden="true" tabindex="-1"></a> <span class="st">'offer_completed'</span>,</span>
<span id="cb266-10"><a href="#cb266-10" aria-hidden="true" tabindex="-1"></a> <span class="st">'offer_duration_days'</span>,</span>
<span id="cb266-11"><a href="#cb266-11" aria-hidden="true" tabindex="-1"></a> <span class="st">'time'</span>,</span>
<span id="cb266-12"><a href="#cb266-12" aria-hidden="true" tabindex="-1"></a> <span class="st">'offer_viewed'</span>,</span>
<span id="cb266-13"><a href="#cb266-13" aria-hidden="true" tabindex="-1"></a> <span class="st">'transaction'</span>,</span>
<span id="cb266-14"><a href="#cb266-14" aria-hidden="true" tabindex="-1"></a> <span class="st">'auto_completed'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="192">
<div class="sourceCode cell-code" id="cb267"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb267-1"><a href="#cb267-1" aria-hidden="true" tabindex="-1"></a>cust_df <span class="op">=</span> cust_df[columns_to_keep]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="193">
<div class="sourceCode cell-code" id="cb268"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb268-1"><a href="#cb268-1" aria-hidden="true" tabindex="-1"></a>cust_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="193">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>gender</th>
      <th>age_group</th>
      <th>customer_id</th>
      <th>income_range</th>
      <th>member_type</th>
      <th>money_spent</th>
      <th>money_gained</th>
      <th>offer_type</th>
      <th>offer_completed</th>
      <th>offer_duration_days</th>
      <th>time</th>
      <th>offer_viewed</th>
      <th>transaction</th>
      <th>auto_completed</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>F</td>
      <td>elderly</td>
      <td>78afa995795e4d85b5d9ceeca43f5fef</td>
      <td>high</td>
      <td>new</td>
      <td>0.00</td>
      <td>0.0</td>
      <td>BOGO</td>
      <td>0</td>
      <td>7.0</td>
      <td>0.0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>F</td>
      <td>elderly</td>
      <td>78afa995795e4d85b5d9ceeca43f5fef</td>
      <td>high</td>
      <td>new</td>
      <td>19.89</td>
      <td>5.0</td>
      <td>BOGO</td>
      <td>1</td>
      <td>7.0</td>
      <td>5.5</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>M</td>
      <td>elderly</td>
      <td>e2127556f4f64592b11af22de27a7932</td>
      <td>mid</td>
      <td>new</td>
      <td>0.00</td>
      <td>0.0</td>
      <td>BOGO</td>
      <td>0</td>
      <td>7.0</td>
      <td>17.0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>M</td>
      <td>elderly</td>
      <td>e2127556f4f64592b11af22de27a7932</td>
      <td>mid</td>
      <td>new</td>
      <td>0.00</td>
      <td>0.0</td>
      <td>BOGO</td>
      <td>0</td>
      <td>7.0</td>
      <td>17.5</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>M</td>
      <td>elderly</td>
      <td>389bc3fa690240e798340f5a15918d5c</td>
      <td>mid</td>
      <td>new</td>
      <td>0.00</td>
      <td>0.0</td>
      <td>BOGO</td>
      <td>0</td>
      <td>7.0</td>
      <td>7.0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>214599</th>
      <td>M</td>
      <td>adult</td>
      <td>8578196a074a4f328976e334fa9383a3</td>
      <td>mid</td>
      <td>new</td>
      <td>0.00</td>
      <td>0.0</td>
      <td>BOGO</td>
      <td>0</td>
      <td>5.0</td>
      <td>21.0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>214600</th>
      <td>M</td>
      <td>adult</td>
      <td>9fcbff4f8d7241faa4ab8a9d19c8a812</td>
      <td>high</td>
      <td>new</td>
      <td>0.00</td>
      <td>0.0</td>
      <td>BOGO</td>
      <td>0</td>
      <td>5.0</td>
      <td>24.0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>214601</th>
      <td>M</td>
      <td>adult</td>
      <td>9fcbff4f8d7241faa4ab8a9d19c8a812</td>
      <td>high</td>
      <td>new</td>
      <td>0.00</td>
      <td>0.0</td>
      <td>BOGO</td>
      <td>0</td>
      <td>5.0</td>
      <td>24.0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>214602</th>
      <td>F</td>
      <td>adult</td>
      <td>3045af4e98794a04a5542d3eac939b1f</td>
      <td>mid_to_high</td>
      <td>regular</td>
      <td>0.00</td>
      <td>0.0</td>
      <td>BOGO</td>
      <td>0</td>
      <td>5.0</td>
      <td>24.0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>214603</th>
      <td>F</td>
      <td>adult</td>
      <td>3045af4e98794a04a5542d3eac939b1f</td>
      <td>mid_to_high</td>
      <td>regular</td>
      <td>0.00</td>
      <td>0.0</td>
      <td>BOGO</td>
      <td>0</td>
      <td>5.0</td>
      <td>24.0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
<p>214604 rows × 14 columns</p>
</div>
</div>
</div>
<p>Encode the gender variables</p>
<div class="cell" data-execution_count="194">
<div class="sourceCode cell-code" id="cb269"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb269-1"><a href="#cb269-1" aria-hidden="true" tabindex="-1"></a>cust_df <span class="op">=</span> cust_df.join(pd.get_dummies(cust_df[<span class="st">'gender'</span>])).drop(<span class="st">'gender'</span>, axis<span class="op">=</span><span class="dv">1</span>) <span class="co"># drop the original column</span></span>
<span id="cb269-2"><a href="#cb269-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb269-3"><a href="#cb269-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> column <span class="kw">in</span> [<span class="st">'M'</span>, <span class="st">'F'</span>, <span class="st">'O'</span>]:</span>
<span id="cb269-4"><a href="#cb269-4" aria-hidden="true" tabindex="-1"></a>    cust_df <span class="op">=</span> cust_df.rename(columns<span class="op">=</span>{column: (<span class="st">"gender_"</span> <span class="op">+</span> column.replace(<span class="st">" "</span>, <span class="st">"_"</span>))})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="195">
<div class="sourceCode cell-code" id="cb270"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb270-1"><a href="#cb270-1" aria-hidden="true" tabindex="-1"></a>cust_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="195">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>age_group</th>
      <th>customer_id</th>
      <th>income_range</th>
      <th>member_type</th>
      <th>money_spent</th>
      <th>money_gained</th>
      <th>offer_type</th>
      <th>offer_completed</th>
      <th>offer_duration_days</th>
      <th>time</th>
      <th>offer_viewed</th>
      <th>transaction</th>
      <th>auto_completed</th>
      <th>gender_F</th>
      <th>gender_M</th>
      <th>gender_O</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>elderly</td>
      <td>78afa995795e4d85b5d9ceeca43f5fef</td>
      <td>high</td>
      <td>new</td>
      <td>0.00</td>
      <td>0.0</td>
      <td>BOGO</td>
      <td>0</td>
      <td>7.0</td>
      <td>0.0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>elderly</td>
      <td>78afa995795e4d85b5d9ceeca43f5fef</td>
      <td>high</td>
      <td>new</td>
      <td>19.89</td>
      <td>5.0</td>
      <td>BOGO</td>
      <td>1</td>
      <td>7.0</td>
      <td>5.5</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>elderly</td>
      <td>e2127556f4f64592b11af22de27a7932</td>
      <td>mid</td>
      <td>new</td>
      <td>0.00</td>
      <td>0.0</td>
      <td>BOGO</td>
      <td>0</td>
      <td>7.0</td>
      <td>17.0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>elderly</td>
      <td>e2127556f4f64592b11af22de27a7932</td>
      <td>mid</td>
      <td>new</td>
      <td>0.00</td>
      <td>0.0</td>
      <td>BOGO</td>
      <td>0</td>
      <td>7.0</td>
      <td>17.5</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>elderly</td>
      <td>389bc3fa690240e798340f5a15918d5c</td>
      <td>mid</td>
      <td>new</td>
      <td>0.00</td>
      <td>0.0</td>
      <td>BOGO</td>
      <td>0</td>
      <td>7.0</td>
      <td>7.0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>214599</th>
      <td>adult</td>
      <td>8578196a074a4f328976e334fa9383a3</td>
      <td>mid</td>
      <td>new</td>
      <td>0.00</td>
      <td>0.0</td>
      <td>BOGO</td>
      <td>0</td>
      <td>5.0</td>
      <td>21.0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>214600</th>
      <td>adult</td>
      <td>9fcbff4f8d7241faa4ab8a9d19c8a812</td>
      <td>high</td>
      <td>new</td>
      <td>0.00</td>
      <td>0.0</td>
      <td>BOGO</td>
      <td>0</td>
      <td>5.0</td>
      <td>24.0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>214601</th>
      <td>adult</td>
      <td>9fcbff4f8d7241faa4ab8a9d19c8a812</td>
      <td>high</td>
      <td>new</td>
      <td>0.00</td>
      <td>0.0</td>
      <td>BOGO</td>
      <td>0</td>
      <td>5.0</td>
      <td>24.0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>214602</th>
      <td>adult</td>
      <td>3045af4e98794a04a5542d3eac939b1f</td>
      <td>mid_to_high</td>
      <td>regular</td>
      <td>0.00</td>
      <td>0.0</td>
      <td>BOGO</td>
      <td>0</td>
      <td>5.0</td>
      <td>24.0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>214603</th>
      <td>adult</td>
      <td>3045af4e98794a04a5542d3eac939b1f</td>
      <td>mid_to_high</td>
      <td>regular</td>
      <td>0.00</td>
      <td>0.0</td>
      <td>BOGO</td>
      <td>0</td>
      <td>5.0</td>
      <td>24.0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
<p>214604 rows × 16 columns</p>
</div>
</div>
</div>
</section>
<section id="creating-dummy-variables-for-modelling" class="level4">
<h4 class="anchored" data-anchor-id="creating-dummy-variables-for-modelling">creating dummy variables for modelling</h4>
<div class="cell" data-execution_count="196">
<div class="sourceCode cell-code" id="cb271"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb271-1"><a href="#cb271-1" aria-hidden="true" tabindex="-1"></a>cust_df <span class="op">=</span> cust_df.join(pd.get_dummies(cust_df[<span class="st">'age_group'</span>])).drop(<span class="st">'age_group'</span>, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb271-2"><a href="#cb271-2" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="197">
<div class="sourceCode cell-code" id="cb272"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb272-1"><a href="#cb272-1" aria-hidden="true" tabindex="-1"></a>cust_df <span class="op">=</span> cust_df.join(pd.get_dummies(cust_df[<span class="st">'income_range'</span>])).drop(<span class="st">'income_range'</span>, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb272-2"><a href="#cb272-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb272-3"><a href="#cb272-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> column <span class="kw">in</span> [<span class="st">'low'</span>, <span class="st">'low_to_mid'</span>, <span class="st">'mid'</span>,<span class="st">'mid_to_high'</span>,<span class="st">'high'</span>]:</span>
<span id="cb272-4"><a href="#cb272-4" aria-hidden="true" tabindex="-1"></a>    cust_df <span class="op">=</span> cust_df.rename(columns<span class="op">=</span>{column: (<span class="st">"income_"</span> <span class="op">+</span> column.replace(<span class="st">" "</span>, <span class="st">"_"</span>))})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="198">
<div class="sourceCode cell-code" id="cb273"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb273-1"><a href="#cb273-1" aria-hidden="true" tabindex="-1"></a>cust_df <span class="op">=</span> cust_df.join(pd.get_dummies(cust_df[<span class="st">'offer_type'</span>])).drop(<span class="st">'offer_type'</span>, axis<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="199">
<div class="sourceCode cell-code" id="cb274"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb274-1"><a href="#cb274-1" aria-hidden="true" tabindex="-1"></a>cust_df <span class="op">=</span> cust_df.join(pd.get_dummies(cust_df[<span class="st">'member_type'</span>])).drop(<span class="st">'member_type'</span>, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb274-2"><a href="#cb274-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb274-3"><a href="#cb274-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> column <span class="kw">in</span> [<span class="st">'new'</span>, <span class="st">'regular'</span>, <span class="st">'loyal'</span>]:</span>
<span id="cb274-4"><a href="#cb274-4" aria-hidden="true" tabindex="-1"></a>    cust_df <span class="op">=</span> cust_df.rename(columns<span class="op">=</span>{column: (<span class="st">"member_"</span> <span class="op">+</span> column.replace(<span class="st">" "</span>, <span class="st">"_"</span>))})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="200">
<div class="sourceCode cell-code" id="cb275"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb275-1"><a href="#cb275-1" aria-hidden="true" tabindex="-1"></a>cust_df.columns</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="200">
<pre><code>Index(['customer_id', 'money_spent', 'money_gained', 'offer_completed',
       'offer_duration_days', 'time', 'offer_viewed', 'transaction',
       'auto_completed', 'gender_F', 'gender_M', 'gender_O', 'adult',
       'elderly', 'teenager', 'young-adult', 'income_high', 'income_low',
       'income_low_to_mid', 'income_mid', 'income_mid_to_high', 'BOGO',
       'Discount', 'Informational', 'member_loyal', 'member_new',
       'member_regular'],
      dtype='object')</code></pre>
</div>
</div>
</section>
<section id="aggregate-the-customers-by-the-other-columns" class="level4">
<h4 class="anchored" data-anchor-id="aggregate-the-customers-by-the-other-columns">Aggregate the customers by the other columns</h4>
<div class="cell" data-execution_count="201">
<div class="sourceCode cell-code" id="cb277"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb277-1"><a href="#cb277-1" aria-hidden="true" tabindex="-1"></a>customer_df <span class="op">=</span> cust_df.groupby([<span class="st">'customer_id'</span>]).agg({<span class="st">'income_high'</span>:<span class="st">'mean'</span>,</span>
<span id="cb277-2"><a href="#cb277-2" aria-hidden="true" tabindex="-1"></a>                                                <span class="st">'income_low'</span>:<span class="st">'mean'</span>,</span>
<span id="cb277-3"><a href="#cb277-3" aria-hidden="true" tabindex="-1"></a>                                                 <span class="st">'income_low_to_mid'</span>:<span class="st">'mean'</span>,</span>
<span id="cb277-4"><a href="#cb277-4" aria-hidden="true" tabindex="-1"></a>                                                <span class="st">'income_mid'</span>:<span class="st">'mean'</span>, </span>
<span id="cb277-5"><a href="#cb277-5" aria-hidden="true" tabindex="-1"></a>                                                <span class="st">'income_mid_to_high'</span>:<span class="st">'mean'</span>,</span>
<span id="cb277-6"><a href="#cb277-6" aria-hidden="true" tabindex="-1"></a>                                                 <span class="st">'member_loyal'</span>:<span class="st">'mean'</span>,</span>
<span id="cb277-7"><a href="#cb277-7" aria-hidden="true" tabindex="-1"></a>                                                <span class="st">'member_new'</span>:<span class="st">'mean'</span>,</span>
<span id="cb277-8"><a href="#cb277-8" aria-hidden="true" tabindex="-1"></a>                                                <span class="st">'member_regular'</span>:<span class="st">'mean'</span>,</span>
<span id="cb277-9"><a href="#cb277-9" aria-hidden="true" tabindex="-1"></a>                                                 <span class="st">'BOGO'</span>:<span class="st">'sum'</span>,</span>
<span id="cb277-10"><a href="#cb277-10" aria-hidden="true" tabindex="-1"></a>                                                <span class="st">'Discount'</span>:<span class="st">'sum'</span>,</span>
<span id="cb277-11"><a href="#cb277-11" aria-hidden="true" tabindex="-1"></a>                                                <span class="st">'Informational'</span>:<span class="st">'sum'</span>,</span>
<span id="cb277-12"><a href="#cb277-12" aria-hidden="true" tabindex="-1"></a>                                                 <span class="st">'adult'</span>:<span class="st">'mean'</span>,</span>
<span id="cb277-13"><a href="#cb277-13" aria-hidden="true" tabindex="-1"></a>                                                <span class="st">'elderly'</span>:<span class="st">'mean'</span>,</span>
<span id="cb277-14"><a href="#cb277-14" aria-hidden="true" tabindex="-1"></a>                                                <span class="st">'teenager'</span>:<span class="st">'mean'</span>,</span>
<span id="cb277-15"><a href="#cb277-15" aria-hidden="true" tabindex="-1"></a>                                                <span class="st">'young-adult'</span>:<span class="st">'mean'</span>, </span>
<span id="cb277-16"><a href="#cb277-16" aria-hidden="true" tabindex="-1"></a>                                                 <span class="st">'time'</span>:<span class="st">'mean'</span>,</span>
<span id="cb277-17"><a href="#cb277-17" aria-hidden="true" tabindex="-1"></a>                                                <span class="st">'offer_duration_days'</span>:<span class="st">'mean'</span>,</span>
<span id="cb277-18"><a href="#cb277-18" aria-hidden="true" tabindex="-1"></a>                                                <span class="st">'money_spent'</span>:<span class="st">'mean'</span>,</span>
<span id="cb277-19"><a href="#cb277-19" aria-hidden="true" tabindex="-1"></a>                                                <span class="st">'money_gained'</span>:<span class="st">'mean'</span>,</span>
<span id="cb277-20"><a href="#cb277-20" aria-hidden="true" tabindex="-1"></a>                                                <span class="st">'offer_completed'</span>:<span class="st">'sum'</span>,</span>
<span id="cb277-21"><a href="#cb277-21" aria-hidden="true" tabindex="-1"></a>                                                <span class="st">'offer_viewed'</span>:<span class="st">'sum'</span>,</span>
<span id="cb277-22"><a href="#cb277-22" aria-hidden="true" tabindex="-1"></a>                                                <span class="st">'transaction'</span>:<span class="st">'sum'</span>,</span>
<span id="cb277-23"><a href="#cb277-23" aria-hidden="true" tabindex="-1"></a>                                                <span class="st">'auto_completed'</span>:<span class="st">'sum'</span>,</span>
<span id="cb277-24"><a href="#cb277-24" aria-hidden="true" tabindex="-1"></a>                                                <span class="st">'gender_F'</span>:<span class="st">'mean'</span>,</span>
<span id="cb277-25"><a href="#cb277-25" aria-hidden="true" tabindex="-1"></a>                                                <span class="st">'gender_M'</span>:<span class="st">'mean'</span>,</span>
<span id="cb277-26"><a href="#cb277-26" aria-hidden="true" tabindex="-1"></a>                                                <span class="st">'gender_O'</span>:<span class="st">'mean'</span>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="202">
<div class="sourceCode cell-code" id="cb278"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb278-1"><a href="#cb278-1" aria-hidden="true" tabindex="-1"></a>customer_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="202">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>income_high</th>
      <th>income_low</th>
      <th>income_low_to_mid</th>
      <th>income_mid</th>
      <th>income_mid_to_high</th>
      <th>member_loyal</th>
      <th>member_new</th>
      <th>member_regular</th>
      <th>BOGO</th>
      <th>Discount</th>
      <th>...</th>
      <th>offer_duration_days</th>
      <th>money_spent</th>
      <th>money_gained</th>
      <th>offer_completed</th>
      <th>offer_viewed</th>
      <th>transaction</th>
      <th>auto_completed</th>
      <th>gender_F</th>
      <th>gender_M</th>
      <th>gender_O</th>
    </tr>
    <tr>
      <th>customer_id</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0009655768c64bdeb2e877511632db8f</th>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>2</td>
      <td>4</td>
      <td>...</td>
      <td>5.800000</td>
      <td>8.506667</td>
      <td>0.600000</td>
      <td>2</td>
      <td>4</td>
      <td>8</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>0011e0d4e6b944f998e987f904e8c1e5</th>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>2</td>
      <td>4</td>
      <td>...</td>
      <td>6.200000</td>
      <td>6.112308</td>
      <td>0.615385</td>
      <td>2</td>
      <td>5</td>
      <td>5</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>0020c2b971eb4e9188eac86d93036a77</th>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>3</td>
      <td>3</td>
      <td>...</td>
      <td>6.625000</td>
      <td>14.061429</td>
      <td>0.857143</td>
      <td>2</td>
      <td>3</td>
      <td>8</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>0020ccbbb6d84e358d3414a3ff76cffd</th>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>4</td>
      <td>2</td>
      <td>...</td>
      <td>5.500000</td>
      <td>9.061765</td>
      <td>0.764706</td>
      <td>3</td>
      <td>4</td>
      <td>12</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>003d66b6608740288d6cc97a6903f4f0</th>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>6</td>
      <td>...</td>
      <td>7.400000</td>
      <td>1.933600</td>
      <td>0.360000</td>
      <td>2</td>
      <td>4</td>
      <td>18</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>fff3ba4757bd42088c044ca26d73817a</th>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>3</td>
      <td>5</td>
      <td>...</td>
      <td>6.454545</td>
      <td>30.577895</td>
      <td>0.473684</td>
      <td>1</td>
      <td>3</td>
      <td>11</td>
      <td>2</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>fff7576017104bcc8677a8d63322b5e1</th>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>6</td>
      <td>4</td>
      <td>...</td>
      <td>7.800000</td>
      <td>2.138571</td>
      <td>0.500000</td>
      <td>1</td>
      <td>4</td>
      <td>6</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>fff8957ea8b240a6b5e634b6ee8eafcf</th>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>2</td>
      <td>2</td>
      <td>...</td>
      <td>6.800000</td>
      <td>1.215000</td>
      <td>0.000000</td>
      <td>0</td>
      <td>2</td>
      <td>5</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>fffad4f4828548d1b5583907f2e9906b</th>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>6</td>
      <td>0</td>
      <td>...</td>
      <td>5.000000</td>
      <td>5.225294</td>
      <td>0.882353</td>
      <td>3</td>
      <td>4</td>
      <td>12</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>ffff82501cea40309d5fdd7edcca4a07</th>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>2</td>
      <td>10</td>
      <td>...</td>
      <td>8.000000</td>
      <td>10.765238</td>
      <td>0.857143</td>
      <td>6</td>
      <td>6</td>
      <td>15</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
<p>14825 rows × 26 columns</p>
</div>
</div>
</div>
<div class="cell" data-execution_count="203">
<div class="sourceCode cell-code" id="cb279"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb279-1"><a href="#cb279-1" aria-hidden="true" tabindex="-1"></a>customer_df.isnull().<span class="bu">sum</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="203">
<pre><code>income_high            0
income_low             0
income_low_to_mid      0
income_mid             0
income_mid_to_high     0
member_loyal           0
member_new             0
member_regular         0
BOGO                   0
Discount               0
Informational          0
adult                  0
elderly                0
teenager               0
young-adult            0
time                   0
offer_duration_days    5
money_spent            0
money_gained           0
offer_completed        0
offer_viewed           0
transaction            0
auto_completed         0
gender_F               0
gender_M               0
gender_O               0
dtype: int64</code></pre>
</div>
</div>
<div class="cell" data-execution_count="204">
<div class="sourceCode cell-code" id="cb281"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb281-1"><a href="#cb281-1" aria-hidden="true" tabindex="-1"></a>customer_df<span class="op">=</span>customer_df.drop(customer_df[customer_df[<span class="st">'offer_duration_days'</span>].isnull()].index)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="205">
<div class="sourceCode cell-code" id="cb282"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb282-1"><a href="#cb282-1" aria-hidden="true" tabindex="-1"></a>customer_df[<span class="st">'money_spent'</span>].<span class="bu">max</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="205">
<pre><code>181.33</code></pre>
</div>
</div>
<div class="cell" data-execution_count="232">
<div class="sourceCode cell-code" id="cb284"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb284-1"><a href="#cb284-1" aria-hidden="true" tabindex="-1"></a><span class="co">#customer_df.to_csv('./data_for_clustering.csv')</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="233">
<div class="sourceCode cell-code" id="cb285"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb285-1"><a href="#cb285-1" aria-hidden="true" tabindex="-1"></a><span class="co">#customer_df=pd.read_csv('./data_for_clustering.csv')</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="234">
<div class="sourceCode cell-code" id="cb286"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb286-1"><a href="#cb286-1" aria-hidden="true" tabindex="-1"></a><span class="co">#customer_df.set_index('customer_id')</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="206">
<div class="sourceCode cell-code" id="cb287"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb287-1"><a href="#cb287-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> RobustScaler</span>
<span id="cb287-2"><a href="#cb287-2" aria-hidden="true" tabindex="-1"></a><span class="co">#from kneed import KneeLocator</span></span>
<span id="cb287-3"><a href="#cb287-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.datasets <span class="im">import</span> make_blobs</span>
<span id="cb287-4"><a href="#cb287-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.cluster <span class="im">import</span> KMeans</span>
<span id="cb287-5"><a href="#cb287-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> silhouette_score</span>
<span id="cb287-6"><a href="#cb287-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> StandardScaler</span>
<span id="cb287-7"><a href="#cb287-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.decomposition <span class="im">import</span> PCA</span>
<span id="cb287-8"><a href="#cb287-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> mpl_toolkits.mplot3d <span class="im">import</span> Axes3D</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="scale-the-data-for-clustering" class="level4">
<h4 class="anchored" data-anchor-id="scale-the-data-for-clustering">Scale the data for clustering</h4>
<div class="cell" data-execution_count="207">
<div class="sourceCode cell-code" id="cb288"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb288-1"><a href="#cb288-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb288-2"><a href="#cb288-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb288-3"><a href="#cb288-3" aria-hidden="true" tabindex="-1"></a><span class="co"># RobustScaler removes the median and scales the data according to the quantile range (defaults to IQR).</span></span>
<span id="cb288-4"><a href="#cb288-4" aria-hidden="true" tabindex="-1"></a><span class="co"># The IQR is the range between the 1st quartile (25th quantile) and the 3rd quartile (75th quantile).</span></span>
<span id="cb288-5"><a href="#cb288-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb288-6"><a href="#cb288-6" aria-hidden="true" tabindex="-1"></a>scaler <span class="op">=</span> RobustScaler()</span>
<span id="cb288-7"><a href="#cb288-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb288-8"><a href="#cb288-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit to data (compute the median and quantiles to be used for scaling), then transform it:</span></span>
<span id="cb288-9"><a href="#cb288-9" aria-hidden="true" tabindex="-1"></a>customers_scaled <span class="op">=</span> pd.DataFrame(scaler.fit_transform(customer_df.astype(<span class="bu">float</span>)))</span>
<span id="cb288-10"><a href="#cb288-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb288-11"><a href="#cb288-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb288-12"><a href="#cb288-12" aria-hidden="true" tabindex="-1"></a>customers_scaled.columns<span class="op">=</span>customer_df.columns <span class="co"># keep column names</span></span>
<span id="cb288-13"><a href="#cb288-13" aria-hidden="true" tabindex="-1"></a>customers_scaled.index<span class="op">=</span>customer_df.index <span class="co"># keep indices</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 44.2 ms, sys: 0 ns, total: 44.2 ms
Wall time: 42.5 ms</code></pre>
</div>
</div>
<div class="cell" data-execution_count="208">
<div class="sourceCode cell-code" id="cb290"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb290-1"><a href="#cb290-1" aria-hidden="true" tabindex="-1"></a>customers_scaled.columns</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="208">
<pre><code>Index(['income_high', 'income_low', 'income_low_to_mid', 'income_mid',
       'income_mid_to_high', 'member_loyal', 'member_new', 'member_regular',
       'BOGO', 'Discount', 'Informational', 'adult', 'elderly', 'teenager',
       'young-adult', 'time', 'offer_duration_days', 'money_spent',
       'money_gained', 'offer_completed', 'offer_viewed', 'transaction',
       'auto_completed', 'gender_F', 'gender_M', 'gender_O'],
      dtype='object')</code></pre>
</div>
</div>
</section>
<section id="dimensionality-reduction" class="level4">
<h4 class="anchored" data-anchor-id="dimensionality-reduction">Dimensionality reduction</h4>
<div class="cell" data-execution_count="209">
<div class="sourceCode cell-code" id="cb292"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb292-1"><a href="#cb292-1" aria-hidden="true" tabindex="-1"></a>SSE <span class="op">=</span> []</span>
<span id="cb292-2"><a href="#cb292-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb292-3"><a href="#cb292-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> cluster <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>,<span class="dv">10</span>):</span>
<span id="cb292-4"><a href="#cb292-4" aria-hidden="true" tabindex="-1"></a>    kmeans <span class="op">=</span> KMeans(n_jobs <span class="op">=</span> <span class="op">-</span><span class="dv">1</span>, n_clusters <span class="op">=</span> cluster, init<span class="op">=</span><span class="st">'k-means++'</span>)</span>
<span id="cb292-5"><a href="#cb292-5" aria-hidden="true" tabindex="-1"></a>    kmeans.fit(customers_scaled)</span>
<span id="cb292-6"><a href="#cb292-6" aria-hidden="true" tabindex="-1"></a>    SSE.append(kmeans.inertia_)</span>
<span id="cb292-7"><a href="#cb292-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb292-8"><a href="#cb292-8" aria-hidden="true" tabindex="-1"></a><span class="co"># converting the results into a dataframe and plotting them</span></span>
<span id="cb292-9"><a href="#cb292-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb292-10"><a href="#cb292-10" aria-hidden="true" tabindex="-1"></a>frame <span class="op">=</span> pd.DataFrame({<span class="st">'Cluster'</span>:<span class="bu">range</span>(<span class="dv">1</span>,<span class="dv">10</span>), <span class="st">'SSE'</span>:SSE})</span>
<span id="cb292-11"><a href="#cb292-11" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">12</span>,<span class="dv">6</span>))</span>
<span id="cb292-12"><a href="#cb292-12" aria-hidden="true" tabindex="-1"></a>plt.plot(frame[<span class="st">'Cluster'</span>], frame[<span class="st">'SSE'</span>], marker<span class="op">=</span><span class="st">'o'</span>)</span>
<span id="cb292-13"><a href="#cb292-13" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Number of clusters'</span>)</span>
<span id="cb292-14"><a href="#cb292-14" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Inertia'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="209">
<pre><code>Text(0, 0.5, 'Inertia')</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="2021-07-14-Starbucks-Optimising-Customer-Segmentation-with-Random-Forest-and-Gradient-Boosting_files/figure-html/cell-216-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>After 5 clusters the the models begins to deteriorate, so we will pick 5 as optimal</p>
</section>
<section id="explained-variance-of-the-pca" class="level4">
<h4 class="anchored" data-anchor-id="explained-variance-of-the-pca">Explained variance of the PCA</h4>
<div class="cell" data-execution_count="210">
<div class="sourceCode cell-code" id="cb294"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb294-1"><a href="#cb294-1" aria-hidden="true" tabindex="-1"></a>pca <span class="op">=</span> PCA(n_components<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb294-2"><a href="#cb294-2" aria-hidden="true" tabindex="-1"></a>principalComponents <span class="op">=</span> pca.fit_transform(customers_scaled)</span>
<span id="cb294-3"><a href="#cb294-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb294-4"><a href="#cb294-4" aria-hidden="true" tabindex="-1"></a>features <span class="op">=</span> <span class="bu">range</span>(pca.n_components_)</span>
<span id="cb294-5"><a href="#cb294-5" aria-hidden="true" tabindex="-1"></a>plt.bar(features, pca.explained_variance_ratio_, color<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb294-6"><a href="#cb294-6" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'PCA features'</span>)</span>
<span id="cb294-7"><a href="#cb294-7" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'variance %'</span>)</span>
<span id="cb294-8"><a href="#cb294-8" aria-hidden="true" tabindex="-1"></a>plt.xticks(features)</span>
<span id="cb294-9"><a href="#cb294-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb294-10"><a href="#cb294-10" aria-hidden="true" tabindex="-1"></a>PCA_components <span class="op">=</span> pd.DataFrame(principalComponents)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2021-07-14-Starbucks-Optimising-Customer-Segmentation-with-Random-Forest-and-Gradient-Boosting_files/figure-html/cell-217-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>The first 5 components explain 80% of the variance</p>
<div class="cell" data-execution_count="211">
<div class="sourceCode cell-code" id="cb295"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb295-1"><a href="#cb295-1" aria-hidden="true" tabindex="-1"></a>ks <span class="op">=</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">10</span>)</span>
<span id="cb295-2"><a href="#cb295-2" aria-hidden="true" tabindex="-1"></a>inertias <span class="op">=</span> []</span>
<span id="cb295-3"><a href="#cb295-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb295-4"><a href="#cb295-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> k <span class="kw">in</span> ks:</span>
<span id="cb295-5"><a href="#cb295-5" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> KMeans(n_clusters<span class="op">=</span>k)</span>
<span id="cb295-6"><a href="#cb295-6" aria-hidden="true" tabindex="-1"></a>    model.fit(PCA_components.iloc[:,:<span class="dv">2</span>])</span>
<span id="cb295-7"><a href="#cb295-7" aria-hidden="true" tabindex="-1"></a>    inertias.append(model.inertia_)</span>
<span id="cb295-8"><a href="#cb295-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb295-9"><a href="#cb295-9" aria-hidden="true" tabindex="-1"></a>plt.plot(ks, inertias, <span class="st">'-o'</span>, color<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb295-10"><a href="#cb295-10" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'number of clusters, k'</span>)</span>
<span id="cb295-11"><a href="#cb295-11" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'inertia'</span>)</span>
<span id="cb295-12"><a href="#cb295-12" aria-hidden="true" tabindex="-1"></a>plt.xticks(ks)</span>
<span id="cb295-13"><a href="#cb295-13" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2021-07-14-Starbucks-Optimising-Customer-Segmentation-with-Random-Forest-and-Gradient-Boosting_files/figure-html/cell-218-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="212">
<div class="sourceCode cell-code" id="cb296"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb296-1"><a href="#cb296-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> KMeans(n_clusters<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb296-2"><a href="#cb296-2" aria-hidden="true" tabindex="-1"></a>model.fit(PCA_components.iloc[:,:<span class="dv">2</span>])</span>
<span id="cb296-3"><a href="#cb296-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb296-4"><a href="#cb296-4" aria-hidden="true" tabindex="-1"></a><span class="co"># silhouette score</span></span>
<span id="cb296-5"><a href="#cb296-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(silhouette_score(PCA_components.iloc[:,:<span class="dv">2</span>], model.labels_, metric<span class="op">=</span><span class="st">'euclidean'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.3285211122724981</code></pre>
</div>
</div>
<p>Silhouette score is good enough</p>
<div class="cell" data-execution_count="213">
<div class="sourceCode cell-code" id="cb298"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb298-1"><a href="#cb298-1" aria-hidden="true" tabindex="-1"></a>f<span class="op">=</span>pd.read_csv(<span class="st">'./data_for_clustering.csv'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="214">
<div class="sourceCode cell-code" id="cb299"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb299-1"><a href="#cb299-1" aria-hidden="true" tabindex="-1"></a>f<span class="op">=</span>f.drop([<span class="st">'customer_id'</span>],axis<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="map-back-clusters-to-dataframe" class="level4">
<h4 class="anchored" data-anchor-id="map-back-clusters-to-dataframe">Map back clusters to dataframe</h4>
<div class="cell" data-execution_count="215">
<div class="sourceCode cell-code" id="cb300"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb300-1"><a href="#cb300-1" aria-hidden="true" tabindex="-1"></a>pred <span class="op">=</span> model.predict(PCA_components.iloc[:,:<span class="dv">2</span>])</span>
<span id="cb300-2"><a href="#cb300-2" aria-hidden="true" tabindex="-1"></a>frame <span class="op">=</span> pd.DataFrame(f)</span>
<span id="cb300-3"><a href="#cb300-3" aria-hidden="true" tabindex="-1"></a>frame[<span class="st">'cluster'</span>] <span class="op">=</span> pred</span>
<span id="cb300-4"><a href="#cb300-4" aria-hidden="true" tabindex="-1"></a>frame.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="215">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>Unnamed: 0</th>
      <th>income_high</th>
      <th>income_low</th>
      <th>income_low_to_mid</th>
      <th>income_mid</th>
      <th>income_mid_to_high</th>
      <th>member_loyal</th>
      <th>member_new</th>
      <th>member_regular</th>
      <th>BOGO</th>
      <th>...</th>
      <th>money_spent</th>
      <th>money_gained</th>
      <th>offer_completed</th>
      <th>offer_viewed</th>
      <th>transaction</th>
      <th>auto_completed</th>
      <th>gender_F</th>
      <th>gender_M</th>
      <th>gender_O</th>
      <th>cluster</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>2</td>
      <td>...</td>
      <td>8.506667</td>
      <td>0.600000</td>
      <td>2</td>
      <td>4</td>
      <td>8</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>2</td>
      <td>...</td>
      <td>6.112308</td>
      <td>0.615385</td>
      <td>2</td>
      <td>5</td>
      <td>5</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>3</td>
      <td>...</td>
      <td>14.061429</td>
      <td>0.857143</td>
      <td>2</td>
      <td>3</td>
      <td>8</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>3</td>
    </tr>
    <tr>
      <th>3</th>
      <td>3</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>4</td>
      <td>...</td>
      <td>9.061765</td>
      <td>0.764706</td>
      <td>3</td>
      <td>4</td>
      <td>12</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>3</td>
    </tr>
    <tr>
      <th>4</th>
      <td>4</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>1.933600</td>
      <td>0.360000</td>
      <td>2</td>
      <td>4</td>
      <td>18</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 28 columns</p>
</div>
</div>
</div>
<div class="cell" data-execution_count="216">
<div class="sourceCode cell-code" id="cb301"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb301-1"><a href="#cb301-1" aria-hidden="true" tabindex="-1"></a>avg_df <span class="op">=</span> f.groupby([<span class="st">'cluster'</span>], as_index<span class="op">=</span><span class="va">False</span>).mean()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="217">
<div class="sourceCode cell-code" id="cb302"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb302-1"><a href="#cb302-1" aria-hidden="true" tabindex="-1"></a>customer_df<span class="op">=</span>f.copy()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Rename the columns back to meaningful names</p>
<div class="cell" data-execution_count="218">
<div class="sourceCode cell-code" id="cb303"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb303-1"><a href="#cb303-1" aria-hidden="true" tabindex="-1"></a>customer_df <span class="op">=</span> customer_df.rename(columns<span class="op">=</span>{<span class="st">"gender_F"</span>: <span class="st">"Female"</span>,</span>
<span id="cb303-2"><a href="#cb303-2" aria-hidden="true" tabindex="-1"></a>                                          <span class="st">"gender_M"</span>: <span class="st">"Male"</span>,</span>
<span id="cb303-3"><a href="#cb303-3" aria-hidden="true" tabindex="-1"></a>                                          <span class="st">"gender_O"</span>: <span class="st">"Other"</span>})</span>
<span id="cb303-4"><a href="#cb303-4" aria-hidden="true" tabindex="-1"></a>gender <span class="op">=</span> customer_df[[<span class="st">'Female'</span>,<span class="st">'Male'</span>,<span class="st">'Other'</span>]]</span>
<span id="cb303-5"><a href="#cb303-5" aria-hidden="true" tabindex="-1"></a>gender <span class="op">=</span> pd.DataFrame(gender.idxmax(<span class="dv">1</span>))</span>
<span id="cb303-6"><a href="#cb303-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb303-7"><a href="#cb303-7" aria-hidden="true" tabindex="-1"></a>customer_df <span class="op">=</span> customer_df.rename(columns<span class="op">=</span>{<span class="st">"offer_completed"</span>: <span class="st">"offer completed"</span>,</span>
<span id="cb303-8"><a href="#cb303-8" aria-hidden="true" tabindex="-1"></a>                                          <span class="st">"offer_viewed"</span>: <span class="st">"offer ignored"</span>,</span>
<span id="cb303-9"><a href="#cb303-9" aria-hidden="true" tabindex="-1"></a>                                          <span class="st">"transaction"</span>: <span class="st">"casual purchase"</span>,</span>
<span id="cb303-10"><a href="#cb303-10" aria-hidden="true" tabindex="-1"></a>                                          <span class="st">"auto_completed"</span>: <span class="st">"offer auto completed"</span>})</span>
<span id="cb303-11"><a href="#cb303-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb303-12"><a href="#cb303-12" aria-hidden="true" tabindex="-1"></a>customer_df <span class="op">=</span> customer_df.rename(columns<span class="op">=</span>{<span class="st">"income_high"</span>: <span class="st">"high"</span>,</span>
<span id="cb303-13"><a href="#cb303-13" aria-hidden="true" tabindex="-1"></a>                                          <span class="st">"income_low"</span>: <span class="st">"low"</span>,</span>
<span id="cb303-14"><a href="#cb303-14" aria-hidden="true" tabindex="-1"></a>                                          <span class="st">"income_low_to_mid"</span>: <span class="st">"low_to_mid"</span>,</span>
<span id="cb303-15"><a href="#cb303-15" aria-hidden="true" tabindex="-1"></a>                                          <span class="st">"income_mid"</span>: <span class="st">"mid"</span>,</span>
<span id="cb303-16"><a href="#cb303-16" aria-hidden="true" tabindex="-1"></a>                                         <span class="st">"income_mid_to_high"</span>: <span class="st">"mid_to_high"</span>        })</span>
<span id="cb303-17"><a href="#cb303-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb303-18"><a href="#cb303-18" aria-hidden="true" tabindex="-1"></a>customer_df <span class="op">=</span> customer_df.rename(columns<span class="op">=</span>{<span class="st">"member_new"</span>: <span class="st">"new"</span>,                                                                       </span>
<span id="cb303-19"><a href="#cb303-19" aria-hidden="true" tabindex="-1"></a>                                          <span class="st">"member_regular"</span>: <span class="st">"regular"</span>,</span>
<span id="cb303-20"><a href="#cb303-20" aria-hidden="true" tabindex="-1"></a>                                          <span class="st">"member_loyal"</span>: <span class="st">"loyal"</span>,</span>
<span id="cb303-21"><a href="#cb303-21" aria-hidden="true" tabindex="-1"></a>                                                })</span>
<span id="cb303-22"><a href="#cb303-22" aria-hidden="true" tabindex="-1"></a>member_type<span class="op">=</span>customer_df[[<span class="st">'new'</span>,<span class="st">'regular'</span>,<span class="st">'loyal'</span>]]</span>
<span id="cb303-23"><a href="#cb303-23" aria-hidden="true" tabindex="-1"></a>member_type<span class="op">=</span>pd.DataFrame(member_type.idxmax(<span class="dv">1</span>))</span>
<span id="cb303-24"><a href="#cb303-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb303-25"><a href="#cb303-25" aria-hidden="true" tabindex="-1"></a>event <span class="op">=</span> customer_df[[<span class="st">'offer completed'</span>,<span class="st">'offer ignored'</span>,<span class="st">'casual purchase'</span>,<span class="st">'offer auto completed'</span>]]</span>
<span id="cb303-26"><a href="#cb303-26" aria-hidden="true" tabindex="-1"></a>event <span class="op">=</span> pd.DataFrame(event.idxmax(<span class="dv">1</span>))</span>
<span id="cb303-27"><a href="#cb303-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb303-28"><a href="#cb303-28" aria-hidden="true" tabindex="-1"></a>income<span class="op">=</span>customer_df[[<span class="st">'high'</span>,<span class="st">'low'</span>,<span class="st">'low_to_mid'</span>,<span class="st">'mid'</span>,<span class="st">'mid_to_high'</span>]]</span>
<span id="cb303-29"><a href="#cb303-29" aria-hidden="true" tabindex="-1"></a>income<span class="op">=</span>pd.DataFrame(income.idxmax(<span class="dv">1</span>))</span>
<span id="cb303-30"><a href="#cb303-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb303-31"><a href="#cb303-31" aria-hidden="true" tabindex="-1"></a>age_group<span class="op">=</span>customer_df[[<span class="st">'adult'</span>,<span class="st">'elderly'</span>,<span class="st">'teenager'</span>,<span class="st">'young-adult'</span>]]</span>
<span id="cb303-32"><a href="#cb303-32" aria-hidden="true" tabindex="-1"></a>age_group<span class="op">=</span>pd.DataFrame(age_group.idxmax(<span class="dv">1</span>))</span>
<span id="cb303-33"><a href="#cb303-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb303-34"><a href="#cb303-34" aria-hidden="true" tabindex="-1"></a>offer<span class="op">=</span>customer_df[[<span class="st">'BOGO'</span>,<span class="st">'Discount'</span>,<span class="st">'Informational'</span>]]</span>
<span id="cb303-35"><a href="#cb303-35" aria-hidden="true" tabindex="-1"></a>offer<span class="op">=</span>pd.DataFrame(offer.idxmax(<span class="dv">1</span>))</span>
<span id="cb303-36"><a href="#cb303-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb303-37"><a href="#cb303-37" aria-hidden="true" tabindex="-1"></a>customer_df[<span class="st">'gender'</span>] <span class="op">=</span> gender[<span class="dv">0</span>]</span>
<span id="cb303-38"><a href="#cb303-38" aria-hidden="true" tabindex="-1"></a>customer_df[<span class="st">'event'</span>] <span class="op">=</span> event[<span class="dv">0</span>]</span>
<span id="cb303-39"><a href="#cb303-39" aria-hidden="true" tabindex="-1"></a>customer_df[<span class="st">'income'</span>]<span class="op">=</span>income[<span class="dv">0</span>]</span>
<span id="cb303-40"><a href="#cb303-40" aria-hidden="true" tabindex="-1"></a>customer_df[<span class="st">'member_type'</span>]<span class="op">=</span>member_type[<span class="dv">0</span>]</span>
<span id="cb303-41"><a href="#cb303-41" aria-hidden="true" tabindex="-1"></a>customer_df[<span class="st">'age_group'</span>]<span class="op">=</span>age_group[<span class="dv">0</span>]</span>
<span id="cb303-42"><a href="#cb303-42" aria-hidden="true" tabindex="-1"></a>customer_df[<span class="st">'offer'</span>]<span class="op">=</span>offer[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Drop the columns that we have mapped back to the dataframe</p>
<div class="cell" data-execution_count="219">
<div class="sourceCode cell-code" id="cb304"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb304-1"><a href="#cb304-1" aria-hidden="true" tabindex="-1"></a>customer_df.drop(columns<span class="op">=</span>[<span class="st">'high'</span>,<span class="st">'low'</span>,<span class="st">'low_to_mid'</span>,<span class="st">'mid'</span>,<span class="st">'mid_to_high'</span>,<span class="st">'Female'</span>,<span class="st">'Male'</span>,<span class="st">'Other'</span>,<span class="st">'new'</span>,<span class="st">'regular'</span>,<span class="st">'loyal'</span>,<span class="st">'adult'</span>,<span class="st">'elderly'</span>,<span class="st">'teenager'</span>,<span class="st">'young-adult'</span>],axis<span class="op">=</span><span class="dv">1</span>,inplace<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="220">
<div class="sourceCode cell-code" id="cb305"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb305-1"><a href="#cb305-1" aria-hidden="true" tabindex="-1"></a>customer_df.sample(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="220">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>Unnamed: 0</th>
      <th>BOGO</th>
      <th>Discount</th>
      <th>Informational</th>
      <th>time</th>
      <th>offer_duration_days</th>
      <th>money_spent</th>
      <th>money_gained</th>
      <th>offer completed</th>
      <th>offer ignored</th>
      <th>casual purchase</th>
      <th>offer auto completed</th>
      <th>cluster</th>
      <th>gender</th>
      <th>event</th>
      <th>income</th>
      <th>member_type</th>
      <th>age_group</th>
      <th>offer</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>3421</th>
      <td>3421</td>
      <td>4</td>
      <td>4</td>
      <td>4</td>
      <td>15.107143</td>
      <td>6.000</td>
      <td>3.321429</td>
      <td>0.238095</td>
      <td>2</td>
      <td>6</td>
      <td>11</td>
      <td>0</td>
      <td>0</td>
      <td>Female</td>
      <td>casual purchase</td>
      <td>low_to_mid</td>
      <td>new</td>
      <td>adult</td>
      <td>BOGO</td>
    </tr>
    <tr>
      <th>11645</th>
      <td>11645</td>
      <td>2</td>
      <td>8</td>
      <td>2</td>
      <td>14.777778</td>
      <td>6.500</td>
      <td>25.943333</td>
      <td>0.777778</td>
      <td>5</td>
      <td>6</td>
      <td>20</td>
      <td>0</td>
      <td>2</td>
      <td>Male</td>
      <td>casual purchase</td>
      <td>mid</td>
      <td>regular</td>
      <td>young-adult</td>
      <td>Discount</td>
    </tr>
    <tr>
      <th>7701</th>
      <td>7701</td>
      <td>3</td>
      <td>4</td>
      <td>1</td>
      <td>12.516667</td>
      <td>8.125</td>
      <td>2.910000</td>
      <td>0.333333</td>
      <td>1</td>
      <td>2</td>
      <td>8</td>
      <td>0</td>
      <td>1</td>
      <td>Male</td>
      <td>casual purchase</td>
      <td>mid</td>
      <td>loyal</td>
      <td>elderly</td>
      <td>Discount</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
</section>
<section id="customer-distribution-per-predicted-cluster" class="level4">
<h4 class="anchored" data-anchor-id="customer-distribution-per-predicted-cluster">Customer distribution per predicted cluster</h4>
<div class="cell" data-execution_count="221">
<div class="sourceCode cell-code" id="cb306"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb306-1"><a href="#cb306-1" aria-hidden="true" tabindex="-1"></a>sns.countplot(x<span class="op">=</span><span class="st">"cluster"</span>, data<span class="op">=</span>customer_df, palette<span class="op">=</span>custom_colors)</span>
<span id="cb306-2"><a href="#cb306-2" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Customer count by predicted cluster"</span>, fontsize<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb306-3"><a href="#cb306-3" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2021-07-14-Starbucks-Optimising-Customer-Segmentation-with-Random-Forest-and-Gradient-Boosting_files/figure-html/cell-228-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>There’s almost an even distribution of customers among the four predicted clusters</p>
</section>
<section id="income-distribution-among-the-predicted-clusters" class="level4">
<h4 class="anchored" data-anchor-id="income-distribution-among-the-predicted-clusters">Income Distribution among the predicted clusters</h4>
<div class="cell" data-execution_count="222">
<div class="sourceCode cell-code" id="cb307"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb307-1"><a href="#cb307-1" aria-hidden="true" tabindex="-1"></a>g <span class="op">=</span> sns.FacetGrid(customer_df, col<span class="op">=</span><span class="st">'cluster'</span>, col_wrap<span class="op">=</span><span class="dv">2</span>, height <span class="op">=</span> <span class="dv">4</span>, hue<span class="op">=</span><span class="st">'cluster'</span>, palette<span class="op">=</span>custom_colors)</span>
<span id="cb307-2"><a href="#cb307-2" aria-hidden="true" tabindex="-1"></a>g.<span class="bu">map</span>(plt.hist, <span class="st">"income"</span>)</span>
<span id="cb307-3"><a href="#cb307-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb307-4"><a href="#cb307-4" aria-hidden="true" tabindex="-1"></a>plt.subplots_adjust(top<span class="op">=</span><span class="fl">0.9</span>) <span class="co"># fix title position</span></span>
<span id="cb307-5"><a href="#cb307-5" aria-hidden="true" tabindex="-1"></a>g.fig.suptitle(<span class="st">"Income distribution by predicted cluster"</span>, fontsize<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb307-6"><a href="#cb307-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb307-7"><a href="#cb307-7" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2021-07-14-Starbucks-Optimising-Customer-Segmentation-with-Random-Forest-and-Gradient-Boosting_files/figure-html/cell-229-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Clusters 0 has mostly mid to high and high earners, cluster 1 has mid and high income earners.</p>
<p>Cluster 2 has a normal distribution from between low to mid to high income earners with mid and high income earners being the most.</p>
<p>Cluster 3 is mostly skewed towards high income earners</p>
</section>
<section id="age-distribution-per-predicted-cluster" class="level4">
<h4 class="anchored" data-anchor-id="age-distribution-per-predicted-cluster">Age distribution per predicted cluster</h4>
<div class="cell" data-execution_count="223">
<div class="sourceCode cell-code" id="cb308"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb308-1"><a href="#cb308-1" aria-hidden="true" tabindex="-1"></a>g <span class="op">=</span> sns.FacetGrid(customer_df, col<span class="op">=</span><span class="st">'cluster'</span>, col_wrap<span class="op">=</span><span class="dv">2</span>, height <span class="op">=</span> <span class="dv">4</span>, hue<span class="op">=</span><span class="st">'cluster'</span>, palette<span class="op">=</span>custom_colors)</span>
<span id="cb308-2"><a href="#cb308-2" aria-hidden="true" tabindex="-1"></a>g.<span class="bu">map</span>(plt.hist, <span class="st">"age_group"</span>)</span>
<span id="cb308-3"><a href="#cb308-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb308-4"><a href="#cb308-4" aria-hidden="true" tabindex="-1"></a>plt.subplots_adjust(top<span class="op">=</span><span class="fl">0.9</span>) <span class="co"># fix title position</span></span>
<span id="cb308-5"><a href="#cb308-5" aria-hidden="true" tabindex="-1"></a>g.fig.suptitle(<span class="st">"Age distribution by predicted cluster"</span>, fontsize<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb308-6"><a href="#cb308-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb308-7"><a href="#cb308-7" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2021-07-14-Starbucks-Optimising-Customer-Segmentation-with-Random-Forest-and-Gradient-Boosting_files/figure-html/cell-230-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Cluster 0 has a lot of elderly and young adults mostly. Cluster 2 has adults and teenagers. Cluster 3 has adults and the elderly</p>
</section>
<section id="member-distribution-per-predicted-cluster" class="level4">
<h4 class="anchored" data-anchor-id="member-distribution-per-predicted-cluster">Member distribution per predicted cluster</h4>
<div class="cell" data-execution_count="224">
<div class="sourceCode cell-code" id="cb309"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb309-1"><a href="#cb309-1" aria-hidden="true" tabindex="-1"></a>g <span class="op">=</span> sns.FacetGrid(customer_df, col<span class="op">=</span><span class="st">'cluster'</span>, col_wrap<span class="op">=</span><span class="dv">2</span>, height <span class="op">=</span> <span class="dv">4</span>, hue<span class="op">=</span><span class="st">'cluster'</span>, palette<span class="op">=</span>custom_colors)</span>
<span id="cb309-2"><a href="#cb309-2" aria-hidden="true" tabindex="-1"></a>g.<span class="bu">map</span>(plt.hist, <span class="st">"member_type"</span>)</span>
<span id="cb309-3"><a href="#cb309-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb309-4"><a href="#cb309-4" aria-hidden="true" tabindex="-1"></a>plt.subplots_adjust(top<span class="op">=</span><span class="fl">0.9</span>) <span class="co"># fix title position</span></span>
<span id="cb309-5"><a href="#cb309-5" aria-hidden="true" tabindex="-1"></a>g.fig.suptitle(<span class="st">"Member distribution by predicted cluster"</span>, fontsize<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb309-6"><a href="#cb309-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb309-7"><a href="#cb309-7" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2021-07-14-Starbucks-Optimising-Customer-Segmentation-with-Random-Forest-and-Gradient-Boosting_files/figure-html/cell-231-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Cluster 0 and 1 have mostly regular members. Cluster 2 and 3 have an almost equal distribution of regular and new members</p>
</section>
<section id="gender-distribution-per-predicted-cluster" class="level4">
<h4 class="anchored" data-anchor-id="gender-distribution-per-predicted-cluster">Gender distribution per predicted cluster</h4>
<div class="cell" data-execution_count="225">
<div class="sourceCode cell-code" id="cb310"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb310-1"><a href="#cb310-1" aria-hidden="true" tabindex="-1"></a>g <span class="op">=</span> sns.FacetGrid(customer_df, col<span class="op">=</span><span class="st">'cluster'</span>, col_wrap<span class="op">=</span><span class="dv">2</span>, height <span class="op">=</span> <span class="dv">4</span>, hue<span class="op">=</span><span class="st">'cluster'</span>, palette<span class="op">=</span>custom_colors)</span>
<span id="cb310-2"><a href="#cb310-2" aria-hidden="true" tabindex="-1"></a>g.<span class="bu">map</span>(plt.hist, <span class="st">"gender"</span>)</span>
<span id="cb310-3"><a href="#cb310-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb310-4"><a href="#cb310-4" aria-hidden="true" tabindex="-1"></a>plt.subplots_adjust(top<span class="op">=</span><span class="fl">0.9</span>) <span class="co"># fix title position</span></span>
<span id="cb310-5"><a href="#cb310-5" aria-hidden="true" tabindex="-1"></a>g.fig.suptitle(<span class="st">"Gender distribution by predicted cluster"</span>, fontsize<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb310-6"><a href="#cb310-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb310-7"><a href="#cb310-7" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2021-07-14-Starbucks-Optimising-Customer-Segmentation-with-Random-Forest-and-Gradient-Boosting_files/figure-html/cell-232-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="offer-distribution-per-predicted-cluster" class="level4">
<h4 class="anchored" data-anchor-id="offer-distribution-per-predicted-cluster">Offer distribution per predicted cluster</h4>
<div class="cell" data-execution_count="226">
<div class="sourceCode cell-code" id="cb311"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb311-1"><a href="#cb311-1" aria-hidden="true" tabindex="-1"></a>g <span class="op">=</span> sns.FacetGrid(customer_df, col<span class="op">=</span><span class="st">'cluster'</span>, col_wrap<span class="op">=</span><span class="dv">2</span>, height <span class="op">=</span> <span class="dv">4</span>, hue<span class="op">=</span><span class="st">'cluster'</span>, palette<span class="op">=</span>custom_colors)</span>
<span id="cb311-2"><a href="#cb311-2" aria-hidden="true" tabindex="-1"></a>g.<span class="bu">map</span>(plt.hist, <span class="st">"offer"</span>)</span>
<span id="cb311-3"><a href="#cb311-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb311-4"><a href="#cb311-4" aria-hidden="true" tabindex="-1"></a>plt.subplots_adjust(top<span class="op">=</span><span class="fl">0.9</span>) <span class="co"># fix title position</span></span>
<span id="cb311-5"><a href="#cb311-5" aria-hidden="true" tabindex="-1"></a>g.fig.suptitle(<span class="st">"Offer distribution by predicted cluster"</span>, fontsize<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb311-6"><a href="#cb311-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb311-7"><a href="#cb311-7" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2021-07-14-Starbucks-Optimising-Customer-Segmentation-with-Random-Forest-and-Gradient-Boosting_files/figure-html/cell-233-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="money-spent-by-each-predicted-cluster" class="level4">
<h4 class="anchored" data-anchor-id="money-spent-by-each-predicted-cluster">Money spent by each predicted cluster</h4>
<div class="cell" data-execution_count="227">
<div class="sourceCode cell-code" id="cb312"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb312-1"><a href="#cb312-1" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> customer_df[customer_df.money_spent <span class="op">&lt;</span> customer_df.money_spent.quantile(<span class="fl">0.95</span>)]</span>
<span id="cb312-2"><a href="#cb312-2" aria-hidden="true" tabindex="-1"></a>sns.boxplot(x<span class="op">=</span><span class="st">"cluster"</span>, y<span class="op">=</span><span class="st">"money_spent"</span>, hue<span class="op">=</span><span class="st">"event"</span>, data<span class="op">=</span>data, showmeans<span class="op">=</span><span class="va">True</span>, palette<span class="op">=</span><span class="st">"cubehelix"</span>)</span>
<span id="cb312-3"><a href="#cb312-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb312-4"><a href="#cb312-4" aria-hidden="true" tabindex="-1"></a>plt.legend(loc<span class="op">=</span>(<span class="fl">1.05</span>,<span class="fl">0.85</span>))</span>
<span id="cb312-5"><a href="#cb312-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb312-6"><a href="#cb312-6" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Predicted cluster vs. money spent per event type (95</span><span class="sc">% o</span><span class="st">f data)"</span>, fontsize<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb312-7"><a href="#cb312-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb312-8"><a href="#cb312-8" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2021-07-14-Starbucks-Optimising-Customer-Segmentation-with-Random-Forest-and-Gradient-Boosting_files/figure-html/cell-234-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Cluster 2 and 3 made the most transactions. Cluster 3 has the highest average money spent for both transactions and completed offers. Followed closely by cluster 2. Cluster 0 had a few outliers but most customers in that cluster did not complete offers, a large number of them made casual purchases and or ignored the offers.</p>
<p>Clusters 2 and 3 are the groups to target with offers.</p>
<ul>
<li><p>Cluster 2 has a lot of customers in the mid and high earning bracket, has mostly adults and teenagers who are new and regular members and evenly distributed among males and females</p></li>
<li><p>Cluster 3, the highest spenders, has a customers normally distributed between low to mid and high earning bracket, with mid and mid to high earners being the highest spenders in the group. In terms of member type it is evenly distributed between new and regular members with very few loyal members, same even distribution among males and females and very very few other genders. This cluster is filled with adults and the elderly which is consistent with what we have been finding</p></li>
</ul>
<div class="cell" data-execution_count="228">
<div class="sourceCode cell-code" id="cb313"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb313-1"><a href="#cb313-1" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> customer_df[customer_df.money_spent <span class="op">&lt;</span> customer_df.money_spent.quantile(<span class="fl">0.95</span>)]</span>
<span id="cb313-2"><a href="#cb313-2" aria-hidden="true" tabindex="-1"></a>sns.boxplot(x<span class="op">=</span><span class="st">"cluster"</span>, y<span class="op">=</span><span class="st">"money_spent"</span>, hue<span class="op">=</span><span class="st">"offer"</span>, data<span class="op">=</span>data, showmeans<span class="op">=</span><span class="va">True</span>, palette<span class="op">=</span><span class="st">"cubehelix"</span>)</span>
<span id="cb313-3"><a href="#cb313-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb313-4"><a href="#cb313-4" aria-hidden="true" tabindex="-1"></a>plt.legend(loc<span class="op">=</span>(<span class="fl">1.05</span>,<span class="fl">0.85</span>))</span>
<span id="cb313-5"><a href="#cb313-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb313-6"><a href="#cb313-6" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Predicted cluster vs. money spent per offer type (95</span><span class="sc">% o</span><span class="st">f data)"</span>, fontsize<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb313-7"><a href="#cb313-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb313-8"><a href="#cb313-8" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2021-07-14-Starbucks-Optimising-Customer-Segmentation-with-Random-Forest-and-Gradient-Boosting_files/figure-html/cell-235-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Cluster 3 customers spent a lot on Informational offers, more than 50% of them spend above average (10USD) on it. They also spend the highest on average on Discount offers, most of them spending between 7.5 to 12.5USD. They also spent a lot on BOGO offers though not the most popular offer among this cluster. They spent a minimum of 5USD which is higher than the minimum spend for all other clusters. Most of them spent an average of 9USD on BOGO offers.</p>
<p>Informational offers were not popular among cluster 2 who did not spent on it. Only a few outliers completed this offer. They spent quite a lot on discount and BOGO offers spending an average of 10USD on both which was the second highest spend on offers among the clusters.</p>
<p>Cluster 1 liked and spent the most on informational offers spending between 2.5 and 10USD on them. They spent about the same on BOGO and Discount spending on average between 1 to 7.5USD.</p>
<p>Cluster O also like all 3 offers with Informational being the most popular,followed by discount and last BOGO offers. Cluster O and 1 spent the least on all offers</p>
<p><a id="preprocessing"></a><a></a></p><a>
</a></section><a>
</a></section><a>
</a><section id="data-preprocessing" class="level2"><a>
<h2 class="anchored" data-anchor-id="data-preprocessing">Data Preprocessing</h2>
</a><div class="cell" data-execution_count="229"><a>
</a><div class="sourceCode cell-code" id="cb314"><a></a><pre class="sourceCode python code-with-copy"><a><code class="sourceCode python"><span id="cb314-1"></span></code></a><code class="sourceCode python"><a href="#cb314-1" aria-hidden="true" tabindex="-1"></a>transcript_for_modelling<span class="op">=</span>updated_cleaned_transcript.copy()</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="230">
<div class="sourceCode cell-code" id="cb315"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb315-1"><a href="#cb315-1" aria-hidden="true" tabindex="-1"></a>portfolio_for_modelling[:<span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="230">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>possible_reward</th>
      <th>spent_required</th>
      <th>offer_duration_days</th>
      <th>offer_type</th>
      <th>offer_id</th>
      <th>channel_email</th>
      <th>channel_mobile</th>
      <th>channel_social</th>
      <th>channel_web</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>10</td>
      <td>10</td>
      <td>7</td>
      <td>bogo</td>
      <td>ae264e3637204a6fb9bb56bc8210ddfd</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>10</td>
      <td>10</td>
      <td>5</td>
      <td>bogo</td>
      <td>4d5c57ea9a6940dd891ad53e9dbe8da0</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0</td>
      <td>0</td>
      <td>4</td>
      <td>informational</td>
      <td>3f207df678b143eea3cee63160fa8bed</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>3</th>
      <td>5</td>
      <td>5</td>
      <td>7</td>
      <td>bogo</td>
      <td>9b98b8c7a33c4b65b9aebfe6a799e6d9</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>20</td>
      <td>10</td>
      <td>discount</td>
      <td>0b1e1539f2cc45b7b9fa7c272da2e1d7</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="cell" data-execution_count="231">
<div class="sourceCode cell-code" id="cb316"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb316-1"><a href="#cb316-1" aria-hidden="true" tabindex="-1"></a>profile_for_modelling</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="231">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>gender</th>
      <th>age</th>
      <th>customer_id</th>
      <th>became_member_on</th>
      <th>income</th>
      <th>year</th>
      <th>quarter</th>
      <th>days_of_membership</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>F</td>
      <td>55</td>
      <td>0610b486422d4921ae7d2bf64640c50b</td>
      <td>2017-07-15</td>
      <td>112000.0</td>
      <td>2017</td>
      <td>3</td>
      <td>460</td>
    </tr>
    <tr>
      <th>3</th>
      <td>F</td>
      <td>75</td>
      <td>78afa995795e4d85b5d9ceeca43f5fef</td>
      <td>2017-05-09</td>
      <td>100000.0</td>
      <td>2017</td>
      <td>2</td>
      <td>527</td>
    </tr>
    <tr>
      <th>5</th>
      <td>M</td>
      <td>68</td>
      <td>e2127556f4f64592b11af22de27a7932</td>
      <td>2018-04-26</td>
      <td>70000.0</td>
      <td>2018</td>
      <td>2</td>
      <td>175</td>
    </tr>
    <tr>
      <th>8</th>
      <td>M</td>
      <td>65</td>
      <td>389bc3fa690240e798340f5a15918d5c</td>
      <td>2018-02-09</td>
      <td>53000.0</td>
      <td>2018</td>
      <td>1</td>
      <td>251</td>
    </tr>
    <tr>
      <th>12</th>
      <td>M</td>
      <td>58</td>
      <td>2eeac8d8feae4a8cad5a6af0499a211d</td>
      <td>2017-11-11</td>
      <td>51000.0</td>
      <td>2017</td>
      <td>4</td>
      <td>341</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>16995</th>
      <td>F</td>
      <td>45</td>
      <td>6d5f3a774f3d4714ab0c092238f3a1d7</td>
      <td>2018-06-04</td>
      <td>54000.0</td>
      <td>2018</td>
      <td>2</td>
      <td>136</td>
    </tr>
    <tr>
      <th>16996</th>
      <td>M</td>
      <td>61</td>
      <td>2cb4f97358b841b9a9773a7aa05a9d77</td>
      <td>2018-07-13</td>
      <td>72000.0</td>
      <td>2018</td>
      <td>3</td>
      <td>97</td>
    </tr>
    <tr>
      <th>16997</th>
      <td>M</td>
      <td>49</td>
      <td>01d26f638c274aa0b965d24cefe3183f</td>
      <td>2017-01-26</td>
      <td>73000.0</td>
      <td>2017</td>
      <td>1</td>
      <td>630</td>
    </tr>
    <tr>
      <th>16998</th>
      <td>F</td>
      <td>83</td>
      <td>9dc1421481194dcd9400aec7c9ae6366</td>
      <td>2016-03-07</td>
      <td>50000.0</td>
      <td>2016</td>
      <td>1</td>
      <td>955</td>
    </tr>
    <tr>
      <th>16999</th>
      <td>F</td>
      <td>62</td>
      <td>e4052622e5ba45a8b96b59aba68cf068</td>
      <td>2017-07-22</td>
      <td>82000.0</td>
      <td>2017</td>
      <td>3</td>
      <td>453</td>
    </tr>
  </tbody>
</table>
<p>14825 rows × 8 columns</p>
</div>
</div>
</div>
<div class="cell" data-execution_count="232">
<div class="sourceCode cell-code" id="cb317"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb317-1"><a href="#cb317-1" aria-hidden="true" tabindex="-1"></a>profile_for_modelling.drop(columns<span class="op">=</span>[<span class="st">'became_member_on'</span>,<span class="st">'year'</span>,<span class="st">'quarter'</span>],axis<span class="op">=</span><span class="dv">1</span>,inplace<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="233">
<div class="sourceCode cell-code" id="cb318"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb318-1"><a href="#cb318-1" aria-hidden="true" tabindex="-1"></a>df7 <span class="op">=</span> pd.merge(transcript_for_modelling, profile_for_modelling, on<span class="op">=</span><span class="st">'customer_id'</span>, how<span class="op">=</span><span class="st">'left'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="234">
<div class="sourceCode cell-code" id="cb319"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb319-1"><a href="#cb319-1" aria-hidden="true" tabindex="-1"></a>combined_df<span class="op">=</span>pd.merge(df7, portfolio_for_modelling, on<span class="op">=</span><span class="st">'offer_id'</span>, how<span class="op">=</span><span class="st">'left'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="235">
<div class="sourceCode cell-code" id="cb320"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb320-1"><a href="#cb320-1" aria-hidden="true" tabindex="-1"></a>combined_df[:<span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="235">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>Unnamed: 0</th>
      <th>customer_id</th>
      <th>event</th>
      <th>time</th>
      <th>money_spent</th>
      <th>offer_id</th>
      <th>money_gained</th>
      <th>offer_completed</th>
      <th>offer_received</th>
      <th>offer_viewed</th>
      <th>...</th>
      <th>income</th>
      <th>days_of_membership</th>
      <th>possible_reward</th>
      <th>spent_required</th>
      <th>offer_duration_days</th>
      <th>offer_type</th>
      <th>channel_email</th>
      <th>channel_mobile</th>
      <th>channel_social</th>
      <th>channel_web</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>78afa995795e4d85b5d9ceeca43f5fef</td>
      <td>offer received</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>9b98b8c7a33c4b65b9aebfe6a799e6d9</td>
      <td>0.0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>...</td>
      <td>100000.0</td>
      <td>527</td>
      <td>5.0</td>
      <td>5.0</td>
      <td>7.0</td>
      <td>bogo</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>e2127556f4f64592b11af22de27a7932</td>
      <td>offer received</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>2906b810c7d4411798c6938adc9daaa5</td>
      <td>0.0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>...</td>
      <td>70000.0</td>
      <td>175</td>
      <td>2.0</td>
      <td>10.0</td>
      <td>7.0</td>
      <td>discount</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>5</td>
      <td>389bc3fa690240e798340f5a15918d5c</td>
      <td>offer received</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>f19421c1d4aa40978ebb69ca19b0e20d</td>
      <td>0.0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>...</td>
      <td>53000.0</td>
      <td>251</td>
      <td>5.0</td>
      <td>5.0</td>
      <td>5.0</td>
      <td>bogo</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>7</td>
      <td>2eeac8d8feae4a8cad5a6af0499a211d</td>
      <td>offer received</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>3f207df678b143eea3cee63160fa8bed</td>
      <td>0.0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>...</td>
      <td>51000.0</td>
      <td>341</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>4.0</td>
      <td>informational</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>8</td>
      <td>aa4862eba776480b8bb9c68455b8c2e1</td>
      <td>offer received</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0b1e1539f2cc45b7b9fa7c272da2e1d7</td>
      <td>0.0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>...</td>
      <td>57000.0</td>
      <td>402</td>
      <td>5.0</td>
      <td>20.0</td>
      <td>10.0</td>
      <td>discount</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 24 columns</p>
</div>
</div>
</div>
<div class="cell" data-execution_count="236">
<div class="sourceCode cell-code" id="cb321"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb321-1"><a href="#cb321-1" aria-hidden="true" tabindex="-1"></a>columns_to_keep <span class="op">=</span> [<span class="st">'customer_id'</span>,<span class="st">'age'</span>,<span class="st">'gender'</span>,</span>
<span id="cb321-2"><a href="#cb321-2" aria-hidden="true" tabindex="-1"></a> <span class="st">'income'</span>,<span class="st">'channel_social'</span>,<span class="st">'channel_email'</span>,<span class="st">'channel_mobile'</span>,<span class="st">'channel_web'</span>,<span class="st">'offer_duration_days'</span>,</span>
<span id="cb321-3"><a href="#cb321-3" aria-hidden="true" tabindex="-1"></a><span class="st">'money_gained'</span>,<span class="st">'spent_required'</span>,<span class="st">'days_of_membership'</span>,</span>
<span id="cb321-4"><a href="#cb321-4" aria-hidden="true" tabindex="-1"></a> <span class="st">'offer_type'</span>,</span>
<span id="cb321-5"><a href="#cb321-5" aria-hidden="true" tabindex="-1"></a> <span class="st">'offer_received'</span>,</span>
<span id="cb321-6"><a href="#cb321-6" aria-hidden="true" tabindex="-1"></a> <span class="st">'offer_viewed'</span>,</span>
<span id="cb321-7"><a href="#cb321-7" aria-hidden="true" tabindex="-1"></a> <span class="st">'offer_completed'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="237">
<div class="sourceCode cell-code" id="cb322"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb322-1"><a href="#cb322-1" aria-hidden="true" tabindex="-1"></a>model_df<span class="op">=</span>combined_df[columns_to_keep]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="238">
<div class="sourceCode cell-code" id="cb323"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb323-1"><a href="#cb323-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb323-2"><a href="#cb323-2" aria-hidden="true" tabindex="-1"></a>improved_model_df<span class="op">=</span>model_df.groupby([<span class="st">'customer_id'</span>,<span class="st">'gender'</span>,<span class="st">'income'</span>,<span class="st">'offer_type'</span>,<span class="st">'spent_required'</span>,<span class="st">'money_gained'</span>], as_index<span class="op">=</span><span class="va">False</span>).<span class="bu">sum</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 296 ms, sys: 28 ms, total: 324 ms
Wall time: 326 ms</code></pre>
</div>
</div>
<div class="cell" data-execution_count="239">
<div class="sourceCode cell-code" id="cb325"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb325-1"><a href="#cb325-1" aria-hidden="true" tabindex="-1"></a>improved_model_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="239">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>customer_id</th>
      <th>gender</th>
      <th>income</th>
      <th>offer_type</th>
      <th>spent_required</th>
      <th>money_gained</th>
      <th>age</th>
      <th>channel_social</th>
      <th>channel_email</th>
      <th>channel_mobile</th>
      <th>channel_web</th>
      <th>offer_duration_days</th>
      <th>days_of_membership</th>
      <th>offer_received</th>
      <th>offer_viewed</th>
      <th>offer_completed</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0009655768c64bdeb2e877511632db8f</td>
      <td>M</td>
      <td>72000.0</td>
      <td>bogo</td>
      <td>5.0</td>
      <td>0.0</td>
      <td>33</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>5.0</td>
      <td>545</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0009655768c64bdeb2e877511632db8f</td>
      <td>M</td>
      <td>72000.0</td>
      <td>bogo</td>
      <td>5.0</td>
      <td>5.0</td>
      <td>33</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>5.0</td>
      <td>545</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0009655768c64bdeb2e877511632db8f</td>
      <td>M</td>
      <td>72000.0</td>
      <td>discount</td>
      <td>10.0</td>
      <td>0.0</td>
      <td>66</td>
      <td>1.0</td>
      <td>2.0</td>
      <td>2.0</td>
      <td>2.0</td>
      <td>17.0</td>
      <td>1090</td>
      <td>2</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0009655768c64bdeb2e877511632db8f</td>
      <td>M</td>
      <td>72000.0</td>
      <td>discount</td>
      <td>10.0</td>
      <td>2.0</td>
      <td>66</td>
      <td>1.0</td>
      <td>2.0</td>
      <td>2.0</td>
      <td>2.0</td>
      <td>17.0</td>
      <td>1090</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0009655768c64bdeb2e877511632db8f</td>
      <td>M</td>
      <td>72000.0</td>
      <td>informational</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>132</td>
      <td>2.0</td>
      <td>4.0</td>
      <td>4.0</td>
      <td>2.0</td>
      <td>14.0</td>
      <td>2180</td>
      <td>2</td>
      <td>2</td>
      <td>0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>71395</th>
      <td>ffff82501cea40309d5fdd7edcca4a07</td>
      <td>F</td>
      <td>62000.0</td>
      <td>bogo</td>
      <td>5.0</td>
      <td>5.0</td>
      <td>45</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>7.0</td>
      <td>692</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <th>71396</th>
      <td>ffff82501cea40309d5fdd7edcca4a07</td>
      <td>F</td>
      <td>62000.0</td>
      <td>discount</td>
      <td>10.0</td>
      <td>0.0</td>
      <td>180</td>
      <td>1.0</td>
      <td>4.0</td>
      <td>4.0</td>
      <td>4.0</td>
      <td>31.0</td>
      <td>2768</td>
      <td>4</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>71397</th>
      <td>ffff82501cea40309d5fdd7edcca4a07</td>
      <td>F</td>
      <td>62000.0</td>
      <td>discount</td>
      <td>10.0</td>
      <td>2.0</td>
      <td>180</td>
      <td>1.0</td>
      <td>4.0</td>
      <td>4.0</td>
      <td>4.0</td>
      <td>31.0</td>
      <td>2768</td>
      <td>0</td>
      <td>4</td>
      <td>4</td>
    </tr>
    <tr>
      <th>71398</th>
      <td>ffff82501cea40309d5fdd7edcca4a07</td>
      <td>F</td>
      <td>62000.0</td>
      <td>discount</td>
      <td>20.0</td>
      <td>0.0</td>
      <td>45</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>10.0</td>
      <td>692</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>71399</th>
      <td>ffff82501cea40309d5fdd7edcca4a07</td>
      <td>F</td>
      <td>62000.0</td>
      <td>discount</td>
      <td>20.0</td>
      <td>5.0</td>
      <td>45</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>10.0</td>
      <td>692</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
<p>71400 rows × 16 columns</p>
</div>
</div>
</div>
<div class="cell" data-execution_count="240">
<div class="sourceCode cell-code" id="cb326"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb326-1"><a href="#cb326-1" aria-hidden="true" tabindex="-1"></a><span class="co"># First, compare how many times the offer was viewed vs. received:</span></span>
<span id="cb326-2"><a href="#cb326-2" aria-hidden="true" tabindex="-1"></a>improved_model_df[<span class="st">'label'</span>] <span class="op">=</span> np.where((improved_model_df[<span class="st">'offer_viewed'</span>] <span class="op">&gt;=</span> improved_model_df[<span class="st">'offer_received'</span>]) <span class="op">&amp;</span></span>
<span id="cb326-3"><a href="#cb326-3" aria-hidden="true" tabindex="-1"></a>                       (improved_model_df[<span class="st">'offer_viewed'</span>] <span class="op">&gt;</span> <span class="dv">0</span>), <span class="st">"no order"</span>, <span class="st">"no view"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="241">
<div class="sourceCode cell-code" id="cb327"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb327-1"><a href="#cb327-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Next, compare how many times offer was completed vs. viewed</span></span>
<span id="cb327-2"><a href="#cb327-2" aria-hidden="true" tabindex="-1"></a><span class="co"># We use 0.5 threshold as in at least half of offers has to be completed:</span></span>
<span id="cb327-3"><a href="#cb327-3" aria-hidden="true" tabindex="-1"></a>improved_model_df[<span class="st">'label'</span>]  <span class="op">=</span> np.where(((improved_model_df[<span class="st">'offer_completed'</span>] <span class="op">/</span> improved_model_df[<span class="st">'offer_viewed'</span>]) <span class="op">&gt;=</span> <span class="fl">0.5</span>) <span class="op">&amp;</span></span>
<span id="cb327-4"><a href="#cb327-4" aria-hidden="true" tabindex="-1"></a>                       (improved_model_df[<span class="st">'offer_viewed'</span>] <span class="op">&gt;</span> <span class="dv">0</span>) <span class="op">&amp;</span> </span>
<span id="cb327-5"><a href="#cb327-5" aria-hidden="true" tabindex="-1"></a>                       (improved_model_df[<span class="st">'offer_completed'</span>] <span class="op">&gt;</span> <span class="dv">0</span>), <span class="st">"possible order"</span>, <span class="st">"no order"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="242">
<div class="sourceCode cell-code" id="cb328"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb328-1"><a href="#cb328-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Finally, if there is no order and no view:</span></span>
<span id="cb328-2"><a href="#cb328-2" aria-hidden="true" tabindex="-1"></a>improved_model_df[<span class="st">'label'</span>] <span class="op">=</span> np.where((improved_model_df[<span class="st">'offer_viewed'</span>] <span class="op">==</span> <span class="dv">0</span>) <span class="op">&amp;</span> </span>
<span id="cb328-3"><a href="#cb328-3" aria-hidden="true" tabindex="-1"></a>                       (improved_model_df[<span class="st">'offer_completed'</span>] <span class="op">==</span> <span class="dv">0</span>), <span class="st">"no view"</span>, improved_model_df[<span class="st">'label'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="243">
<div class="sourceCode cell-code" id="cb329"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb329-1"><a href="#cb329-1" aria-hidden="true" tabindex="-1"></a>improved_model_df[<span class="st">'label'</span>].value_counts()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="243">
<pre><code>no view           31804
possible order    20080
no order          19516
Name: label, dtype: int64</code></pre>
</div>
</div>
<div class="cell" data-execution_count="244">
<div class="sourceCode cell-code" id="cb331"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb331-1"><a href="#cb331-1" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(improved_model_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="244">
<pre><code>71400</code></pre>
</div>
</div>
<div class="cell" data-execution_count="245">
<div class="sourceCode cell-code" id="cb333"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb333-1"><a href="#cb333-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Drop the event columns, we don't need them anymore:</span></span>
<span id="cb333-2"><a href="#cb333-2" aria-hidden="true" tabindex="-1"></a>improved_model_df <span class="op">=</span> improved_model_df.drop([<span class="st">'offer_received'</span>, <span class="st">'offer_viewed'</span>, <span class="st">'offer_completed'</span>], axis<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="246">
<div class="sourceCode cell-code" id="cb334"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb334-1"><a href="#cb334-1" aria-hidden="true" tabindex="-1"></a>improved_model_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="246">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>customer_id</th>
      <th>gender</th>
      <th>income</th>
      <th>offer_type</th>
      <th>spent_required</th>
      <th>money_gained</th>
      <th>age</th>
      <th>channel_social</th>
      <th>channel_email</th>
      <th>channel_mobile</th>
      <th>channel_web</th>
      <th>offer_duration_days</th>
      <th>days_of_membership</th>
      <th>label</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0009655768c64bdeb2e877511632db8f</td>
      <td>M</td>
      <td>72000.0</td>
      <td>bogo</td>
      <td>5.0</td>
      <td>0.0</td>
      <td>33</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>5.0</td>
      <td>545</td>
      <td>no view</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0009655768c64bdeb2e877511632db8f</td>
      <td>M</td>
      <td>72000.0</td>
      <td>bogo</td>
      <td>5.0</td>
      <td>5.0</td>
      <td>33</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>5.0</td>
      <td>545</td>
      <td>possible order</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0009655768c64bdeb2e877511632db8f</td>
      <td>M</td>
      <td>72000.0</td>
      <td>discount</td>
      <td>10.0</td>
      <td>0.0</td>
      <td>66</td>
      <td>1.0</td>
      <td>2.0</td>
      <td>2.0</td>
      <td>2.0</td>
      <td>17.0</td>
      <td>1090</td>
      <td>no view</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0009655768c64bdeb2e877511632db8f</td>
      <td>M</td>
      <td>72000.0</td>
      <td>discount</td>
      <td>10.0</td>
      <td>2.0</td>
      <td>66</td>
      <td>1.0</td>
      <td>2.0</td>
      <td>2.0</td>
      <td>2.0</td>
      <td>17.0</td>
      <td>1090</td>
      <td>possible order</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0009655768c64bdeb2e877511632db8f</td>
      <td>M</td>
      <td>72000.0</td>
      <td>informational</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>132</td>
      <td>2.0</td>
      <td>4.0</td>
      <td>4.0</td>
      <td>2.0</td>
      <td>14.0</td>
      <td>2180</td>
      <td>no order</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>71395</th>
      <td>ffff82501cea40309d5fdd7edcca4a07</td>
      <td>F</td>
      <td>62000.0</td>
      <td>bogo</td>
      <td>5.0</td>
      <td>5.0</td>
      <td>45</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>7.0</td>
      <td>692</td>
      <td>possible order</td>
    </tr>
    <tr>
      <th>71396</th>
      <td>ffff82501cea40309d5fdd7edcca4a07</td>
      <td>F</td>
      <td>62000.0</td>
      <td>discount</td>
      <td>10.0</td>
      <td>0.0</td>
      <td>180</td>
      <td>1.0</td>
      <td>4.0</td>
      <td>4.0</td>
      <td>4.0</td>
      <td>31.0</td>
      <td>2768</td>
      <td>no view</td>
    </tr>
    <tr>
      <th>71397</th>
      <td>ffff82501cea40309d5fdd7edcca4a07</td>
      <td>F</td>
      <td>62000.0</td>
      <td>discount</td>
      <td>10.0</td>
      <td>2.0</td>
      <td>180</td>
      <td>1.0</td>
      <td>4.0</td>
      <td>4.0</td>
      <td>4.0</td>
      <td>31.0</td>
      <td>2768</td>
      <td>possible order</td>
    </tr>
    <tr>
      <th>71398</th>
      <td>ffff82501cea40309d5fdd7edcca4a07</td>
      <td>F</td>
      <td>62000.0</td>
      <td>discount</td>
      <td>20.0</td>
      <td>0.0</td>
      <td>45</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>10.0</td>
      <td>692</td>
      <td>no view</td>
    </tr>
    <tr>
      <th>71399</th>
      <td>ffff82501cea40309d5fdd7edcca4a07</td>
      <td>F</td>
      <td>62000.0</td>
      <td>discount</td>
      <td>20.0</td>
      <td>5.0</td>
      <td>45</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>10.0</td>
      <td>692</td>
      <td>possible order</td>
    </tr>
  </tbody>
</table>
<p>71400 rows × 14 columns</p>
</div>
</div>
</div>
<div class="cell" data-execution_count="247">
<div class="sourceCode cell-code" id="cb335"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb335-1"><a href="#cb335-1" aria-hidden="true" tabindex="-1"></a>improved_model_df[<span class="st">"output"</span>] <span class="op">=</span> np.where(improved_model_df[<span class="st">'label'</span>]<span class="op">==</span><span class="st">'no view'</span>, <span class="dv">0</span>, np.nan)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="248">
<div class="sourceCode cell-code" id="cb336"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb336-1"><a href="#cb336-1" aria-hidden="true" tabindex="-1"></a>improved_model_df[<span class="st">"output"</span>] <span class="op">=</span> np.where(improved_model_df[<span class="st">'label'</span>]<span class="op">==</span><span class="st">'no order'</span>, <span class="dv">1</span>, improved_model_df[<span class="st">"output"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="249">
<div class="sourceCode cell-code" id="cb337"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb337-1"><a href="#cb337-1" aria-hidden="true" tabindex="-1"></a>improved_model_df[<span class="st">"output"</span>] <span class="op">=</span> np.where(improved_model_df[<span class="st">'label'</span>]<span class="op">==</span><span class="st">'possible order'</span>, <span class="dv">2</span>, improved_model_df[<span class="st">"output"</span>])</span>
<span id="cb337-2"><a href="#cb337-2" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="250">
<div class="sourceCode cell-code" id="cb338"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb338-1"><a href="#cb338-1" aria-hidden="true" tabindex="-1"></a>improved_model_df.groupby([<span class="st">'label'</span>, <span class="st">'output'</span>]).mean().index</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="250">
<pre><code>MultiIndex([(      'no order', 1.0),
            (       'no view', 0.0),
            ('possible order', 2.0)],
           names=['label', 'output'])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="251">
<div class="sourceCode cell-code" id="cb340"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb340-1"><a href="#cb340-1" aria-hidden="true" tabindex="-1"></a>improved_model_df.isnull().<span class="bu">sum</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="251">
<pre><code>customer_id            0
gender                 0
income                 0
offer_type             0
spent_required         0
money_gained           0
age                    0
channel_social         0
channel_email          0
channel_mobile         0
channel_web            0
offer_duration_days    0
days_of_membership     0
label                  0
output                 0
dtype: int64</code></pre>
</div>
</div>
<div class="cell" data-execution_count="252">
<div class="sourceCode cell-code" id="cb342"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb342-1"><a href="#cb342-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb342-2"><a href="#cb342-2" aria-hidden="true" tabindex="-1"></a>improved_model_df <span class="op">=</span> improved_model_df.join(pd.get_dummies(improved_model_df[<span class="st">'gender'</span>])).drop(<span class="st">'gender'</span>, axis<span class="op">=</span><span class="dv">1</span>) <span class="co"># drop the original column</span></span>
<span id="cb342-3"><a href="#cb342-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb342-4"><a href="#cb342-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> column <span class="kw">in</span> [<span class="st">'M'</span>, <span class="st">'F'</span>, <span class="st">'O'</span>]:</span>
<span id="cb342-5"><a href="#cb342-5" aria-hidden="true" tabindex="-1"></a>    improved_model_df <span class="op">=</span> improved_model_df.rename(columns<span class="op">=</span>{column: (<span class="st">"gender_"</span> <span class="op">+</span> column.replace(<span class="st">" "</span>, <span class="st">"_"</span>))}) <span class="co"># rename new columns</span></span>
<span id="cb342-6"><a href="#cb342-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb342-7"><a href="#cb342-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb342-8"><a href="#cb342-8" aria-hidden="true" tabindex="-1"></a>improved_model_df <span class="op">=</span> improved_model_df.join(pd.get_dummies(improved_model_df[<span class="st">'offer_type'</span>])).drop(<span class="st">'offer_type'</span>, axis<span class="op">=</span><span class="dv">1</span>) <span class="co"># drop the original column</span></span>
<span id="cb342-9"><a href="#cb342-9" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="253">
<div class="sourceCode cell-code" id="cb343"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb343-1"><a href="#cb343-1" aria-hidden="true" tabindex="-1"></a>improved_model_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="253">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>customer_id</th>
      <th>income</th>
      <th>spent_required</th>
      <th>money_gained</th>
      <th>age</th>
      <th>channel_social</th>
      <th>channel_email</th>
      <th>channel_mobile</th>
      <th>channel_web</th>
      <th>offer_duration_days</th>
      <th>days_of_membership</th>
      <th>label</th>
      <th>output</th>
      <th>gender_F</th>
      <th>gender_M</th>
      <th>gender_O</th>
      <th>bogo</th>
      <th>discount</th>
      <th>informational</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0009655768c64bdeb2e877511632db8f</td>
      <td>72000.0</td>
      <td>5.0</td>
      <td>0.0</td>
      <td>33</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>5.0</td>
      <td>545</td>
      <td>no view</td>
      <td>0.0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0009655768c64bdeb2e877511632db8f</td>
      <td>72000.0</td>
      <td>5.0</td>
      <td>5.0</td>
      <td>33</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>5.0</td>
      <td>545</td>
      <td>possible order</td>
      <td>2.0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0009655768c64bdeb2e877511632db8f</td>
      <td>72000.0</td>
      <td>10.0</td>
      <td>0.0</td>
      <td>66</td>
      <td>1.0</td>
      <td>2.0</td>
      <td>2.0</td>
      <td>2.0</td>
      <td>17.0</td>
      <td>1090</td>
      <td>no view</td>
      <td>0.0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0009655768c64bdeb2e877511632db8f</td>
      <td>72000.0</td>
      <td>10.0</td>
      <td>2.0</td>
      <td>66</td>
      <td>1.0</td>
      <td>2.0</td>
      <td>2.0</td>
      <td>2.0</td>
      <td>17.0</td>
      <td>1090</td>
      <td>possible order</td>
      <td>2.0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0009655768c64bdeb2e877511632db8f</td>
      <td>72000.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>132</td>
      <td>2.0</td>
      <td>4.0</td>
      <td>4.0</td>
      <td>2.0</td>
      <td>14.0</td>
      <td>2180</td>
      <td>no order</td>
      <td>1.0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>71395</th>
      <td>ffff82501cea40309d5fdd7edcca4a07</td>
      <td>62000.0</td>
      <td>5.0</td>
      <td>5.0</td>
      <td>45</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>7.0</td>
      <td>692</td>
      <td>possible order</td>
      <td>2.0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>71396</th>
      <td>ffff82501cea40309d5fdd7edcca4a07</td>
      <td>62000.0</td>
      <td>10.0</td>
      <td>0.0</td>
      <td>180</td>
      <td>1.0</td>
      <td>4.0</td>
      <td>4.0</td>
      <td>4.0</td>
      <td>31.0</td>
      <td>2768</td>
      <td>no view</td>
      <td>0.0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>71397</th>
      <td>ffff82501cea40309d5fdd7edcca4a07</td>
      <td>62000.0</td>
      <td>10.0</td>
      <td>2.0</td>
      <td>180</td>
      <td>1.0</td>
      <td>4.0</td>
      <td>4.0</td>
      <td>4.0</td>
      <td>31.0</td>
      <td>2768</td>
      <td>possible order</td>
      <td>2.0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>71398</th>
      <td>ffff82501cea40309d5fdd7edcca4a07</td>
      <td>62000.0</td>
      <td>20.0</td>
      <td>0.0</td>
      <td>45</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>10.0</td>
      <td>692</td>
      <td>no view</td>
      <td>0.0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>71399</th>
      <td>ffff82501cea40309d5fdd7edcca4a07</td>
      <td>62000.0</td>
      <td>20.0</td>
      <td>5.0</td>
      <td>45</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>10.0</td>
      <td>692</td>
      <td>possible order</td>
      <td>2.0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
<p>71400 rows × 19 columns</p>
</div>
</div>
</div>
<div class="cell" data-execution_count="254">
<div class="sourceCode cell-code" id="cb344"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb344-1"><a href="#cb344-1" aria-hidden="true" tabindex="-1"></a>improved_model_df <span class="op">=</span> improved_model_df.drop([<span class="st">'customer_id'</span>, <span class="st">'label'</span>], axis<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="255">
<div class="sourceCode cell-code" id="cb345"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb345-1"><a href="#cb345-1" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> improved_model_df.drop([<span class="st">'output'</span>], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb345-2"><a href="#cb345-2" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> improved_model_df[<span class="st">'output'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="256">
<div class="sourceCode cell-code" id="cb346"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb346-1"><a href="#cb346-1" aria-hidden="true" tabindex="-1"></a>feature_names<span class="op">=</span>X.columns</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="257">
<div class="sourceCode cell-code" id="cb347"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb347-1"><a href="#cb347-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Split the dataset into 2/3 training and 1/3 testing sets:</span></span>
<span id="cb347-2"><a href="#cb347-2" aria-hidden="true" tabindex="-1"></a>X_train, X_test, y_train, y_test <span class="op">=</span> sklearn.model_selection.train_test_split(X, y, test_size<span class="op">=</span><span class="fl">0.33</span>)</span>
<span id="cb347-3"><a href="#cb347-3" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="cater-for-class-imbalance-by-normalizing-the-data" class="level4">
<h4 class="anchored" data-anchor-id="cater-for-class-imbalance-by-normalizing-the-data">Cater for class imbalance by normalizing the data</h4>
<div class="cell" data-execution_count="258">
<div class="sourceCode cell-code" id="cb348"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb348-1"><a href="#cb348-1" aria-hidden="true" tabindex="-1"></a>ss <span class="op">=</span> StandardScaler()</span>
<span id="cb348-2"><a href="#cb348-2" aria-hidden="true" tabindex="-1"></a>X_train_scaled <span class="op">=</span> ss.fit_transform(X_train)</span>
<span id="cb348-3"><a href="#cb348-3" aria-hidden="true" tabindex="-1"></a>X_test_scaled <span class="op">=</span> ss.transform(X_test)</span>
<span id="cb348-4"><a href="#cb348-4" aria-hidden="true" tabindex="-1"></a>y_train <span class="op">=</span> np.array(y_train)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="dimensionality-reduction-1" class="level4">
<h4 class="anchored" data-anchor-id="dimensionality-reduction-1">Dimensionality reduction</h4>
<div class="cell" data-execution_count="259">
<div class="sourceCode cell-code" id="cb349"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb349-1"><a href="#cb349-1" aria-hidden="true" tabindex="-1"></a>pca_test <span class="op">=</span> PCA(n_components<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb349-2"><a href="#cb349-2" aria-hidden="true" tabindex="-1"></a>pca_test.fit(X_train_scaled)</span>
<span id="cb349-3"><a href="#cb349-3" aria-hidden="true" tabindex="-1"></a>sns.<span class="bu">set</span>(style<span class="op">=</span><span class="st">'whitegrid'</span>)</span>
<span id="cb349-4"><a href="#cb349-4" aria-hidden="true" tabindex="-1"></a>plt.plot(np.cumsum(pca_test.explained_variance_ratio_))</span>
<span id="cb349-5"><a href="#cb349-5" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'number of components'</span>)</span>
<span id="cb349-6"><a href="#cb349-6" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'cumulative explained variance'</span>)</span>
<span id="cb349-7"><a href="#cb349-7" aria-hidden="true" tabindex="-1"></a>plt.axvline(linewidth<span class="op">=</span><span class="dv">4</span>, color<span class="op">=</span><span class="st">'r'</span>, linestyle <span class="op">=</span> <span class="st">'--'</span>, x<span class="op">=</span><span class="dv">10</span>, ymin<span class="op">=</span><span class="dv">0</span>, ymax<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb349-8"><a href="#cb349-8" aria-hidden="true" tabindex="-1"></a>display(plt.show())</span>
<span id="cb349-9"><a href="#cb349-9" aria-hidden="true" tabindex="-1"></a>evr <span class="op">=</span> pca_test.explained_variance_ratio_</span>
<span id="cb349-10"><a href="#cb349-10" aria-hidden="true" tabindex="-1"></a>cvr <span class="op">=</span> np.cumsum(pca_test.explained_variance_ratio_)</span>
<span id="cb349-11"><a href="#cb349-11" aria-hidden="true" tabindex="-1"></a>pca_df <span class="op">=</span> pd.DataFrame()</span>
<span id="cb349-12"><a href="#cb349-12" aria-hidden="true" tabindex="-1"></a>pca_df[<span class="st">'Cumulative Variance Ratio'</span>] <span class="op">=</span> cvr</span>
<span id="cb349-13"><a href="#cb349-13" aria-hidden="true" tabindex="-1"></a>pca_df[<span class="st">'Explained Variance Ratio'</span>] <span class="op">=</span> evr</span>
<span id="cb349-14"><a href="#cb349-14" aria-hidden="true" tabindex="-1"></a>display(pca_df.head(<span class="dv">10</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2021-07-14-Starbucks-Optimising-Customer-Segmentation-with-Random-Forest-and-Gradient-Boosting_files/figure-html/cell-266-output-1.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<pre><code>None</code></pre>
</div>
<div class="cell-output cell-output-display">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>Cumulative Variance Ratio</th>
      <th>Explained Variance Ratio</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.301023</td>
      <td>0.301023</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.452145</td>
      <td>0.151122</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.581108</td>
      <td>0.128963</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.687933</td>
      <td>0.106825</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.752388</td>
      <td>0.064455</td>
    </tr>
    <tr>
      <th>5</th>
      <td>0.811185</td>
      <td>0.058798</td>
    </tr>
    <tr>
      <th>6</th>
      <td>0.859530</td>
      <td>0.048345</td>
    </tr>
    <tr>
      <th>7</th>
      <td>0.903105</td>
      <td>0.043575</td>
    </tr>
    <tr>
      <th>8</th>
      <td>0.943013</td>
      <td>0.039908</td>
    </tr>
    <tr>
      <th>9</th>
      <td>0.970594</td>
      <td>0.027581</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<p>The first 10 components explain more than 80% of the variance. So we reduce the features from 16 to 10</p>
<div class="cell" data-execution_count="260">
<div class="sourceCode cell-code" id="cb351"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb351-1"><a href="#cb351-1" aria-hidden="true" tabindex="-1"></a>pca <span class="op">=</span> PCA(n_components<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb351-2"><a href="#cb351-2" aria-hidden="true" tabindex="-1"></a>pca.fit(X_train_scaled)</span>
<span id="cb351-3"><a href="#cb351-3" aria-hidden="true" tabindex="-1"></a>X_train_scaled_pca <span class="op">=</span> pca.transform(X_train_scaled)</span>
<span id="cb351-4"><a href="#cb351-4" aria-hidden="true" tabindex="-1"></a>X_test_scaled_pca <span class="op">=</span> pca.transform(X_test_scaled)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="261">
<div class="sourceCode cell-code" id="cb352"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb352-1"><a href="#cb352-1" aria-hidden="true" tabindex="-1"></a>feature_names</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="261">
<pre><code>Index(['income', 'spent_required', 'money_gained', 'age', 'channel_social',
       'channel_email', 'channel_mobile', 'channel_web', 'offer_duration_days',
       'days_of_membership', 'gender_F', 'gender_M', 'gender_O', 'bogo',
       'discount', 'informational'],
      dtype='object')</code></pre>
</div>
</div>
<p>Show the 10 PCA components that will be used</p>
<div class="cell" data-execution_count="262">
<div class="sourceCode cell-code" id="cb354"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb354-1"><a href="#cb354-1" aria-hidden="true" tabindex="-1"></a>pca_dims <span class="op">=</span> []</span>
<span id="cb354-2"><a href="#cb354-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> x <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, <span class="bu">len</span>(pca_df)):</span>
<span id="cb354-3"><a href="#cb354-3" aria-hidden="true" tabindex="-1"></a>    pca_dims.append(<span class="st">'PCA Component </span><span class="sc">{}</span><span class="st">'</span>.<span class="bu">format</span>(x))</span>
<span id="cb354-4"><a href="#cb354-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb354-5"><a href="#cb354-5" aria-hidden="true" tabindex="-1"></a>pca_test_df <span class="op">=</span> pd.DataFrame(pca_test.components_, columns<span class="op">=</span>feature_names, index<span class="op">=</span>pca_dims)</span>
<span id="cb354-6"><a href="#cb354-6" aria-hidden="true" tabindex="-1"></a>pca_test_df.head(<span class="dv">10</span>).T</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="262">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>PCA Component 0</th>
      <th>PCA Component 1</th>
      <th>PCA Component 2</th>
      <th>PCA Component 3</th>
      <th>PCA Component 4</th>
      <th>PCA Component 5</th>
      <th>PCA Component 6</th>
      <th>PCA Component 7</th>
      <th>PCA Component 8</th>
      <th>PCA Component 9</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>income</th>
      <td>-0.028562</td>
      <td>-0.036625</td>
      <td>0.275378</td>
      <td>0.006455</td>
      <td>-0.158450</td>
      <td>0.891863</td>
      <td>-0.226312</td>
      <td>0.089534</td>
      <td>0.115347</td>
      <td>-0.097069</td>
    </tr>
    <tr>
      <th>spent_required</th>
      <td>-0.169380</td>
      <td>0.446360</td>
      <td>0.073624</td>
      <td>0.296529</td>
      <td>-0.015432</td>
      <td>0.029398</td>
      <td>0.156203</td>
      <td>0.057561</td>
      <td>0.182167</td>
      <td>0.566722</td>
    </tr>
    <tr>
      <th>money_gained</th>
      <td>-0.128817</td>
      <td>-0.174937</td>
      <td>0.072448</td>
      <td>0.398101</td>
      <td>-0.013212</td>
      <td>0.193610</td>
      <td>0.608934</td>
      <td>-0.104287</td>
      <td>-0.602865</td>
      <td>-0.072534</td>
    </tr>
    <tr>
      <th>age</th>
      <td>0.392124</td>
      <td>0.040493</td>
      <td>0.097037</td>
      <td>-0.001928</td>
      <td>-0.018094</td>
      <td>0.157566</td>
      <td>-0.002695</td>
      <td>0.043434</td>
      <td>-0.110044</td>
      <td>0.380196</td>
    </tr>
    <tr>
      <th>channel_social</th>
      <td>0.329502</td>
      <td>-0.080087</td>
      <td>0.005546</td>
      <td>0.137463</td>
      <td>-0.003726</td>
      <td>-0.062453</td>
      <td>0.227764</td>
      <td>0.652029</td>
      <td>0.168288</td>
      <td>-0.262367</td>
    </tr>
    <tr>
      <th>channel_email</th>
      <td>0.441519</td>
      <td>0.052701</td>
      <td>0.026723</td>
      <td>0.010143</td>
      <td>0.005786</td>
      <td>-0.001670</td>
      <td>0.032748</td>
      <td>0.038297</td>
      <td>-0.083064</td>
      <td>0.182826</td>
    </tr>
    <tr>
      <th>channel_mobile</th>
      <td>0.432665</td>
      <td>-0.088407</td>
      <td>0.007308</td>
      <td>-0.003196</td>
      <td>0.009227</td>
      <td>-0.025921</td>
      <td>-0.010107</td>
      <td>0.114983</td>
      <td>-0.100969</td>
      <td>-0.203393</td>
    </tr>
    <tr>
      <th>channel_web</th>
      <td>0.286502</td>
      <td>0.273583</td>
      <td>0.052277</td>
      <td>0.102929</td>
      <td>0.021088</td>
      <td>-0.033636</td>
      <td>-0.367388</td>
      <td>-0.445522</td>
      <td>-0.353391</td>
      <td>-0.257306</td>
    </tr>
    <tr>
      <th>offer_duration_days</th>
      <td>0.331012</td>
      <td>0.354808</td>
      <td>0.065766</td>
      <td>0.176817</td>
      <td>0.006436</td>
      <td>-0.026223</td>
      <td>-0.019763</td>
      <td>0.034665</td>
      <td>-0.066331</td>
      <td>0.162309</td>
    </tr>
    <tr>
      <th>days_of_membership</th>
      <td>0.275249</td>
      <td>0.017564</td>
      <td>-0.000360</td>
      <td>0.001778</td>
      <td>-0.033827</td>
      <td>0.094164</td>
      <td>0.488847</td>
      <td>-0.549413</td>
      <td>0.578696</td>
      <td>-0.185649</td>
    </tr>
    <tr>
      <th>gender_F</th>
      <td>-0.034878</td>
      <td>-0.062536</td>
      <td>0.665758</td>
      <td>-0.090922</td>
      <td>-0.094660</td>
      <td>-0.220687</td>
      <td>0.028768</td>
      <td>-0.015380</td>
      <td>0.009565</td>
      <td>-0.006354</td>
    </tr>
    <tr>
      <th>gender_M</th>
      <td>0.035851</td>
      <td>0.062421</td>
      <td>-0.667367</td>
      <td>0.089813</td>
      <td>-0.137836</td>
      <td>0.181333</td>
      <td>-0.029240</td>
      <td>0.013446</td>
      <td>-0.018437</td>
      <td>0.007022</td>
    </tr>
    <tr>
      <th>gender_O</th>
      <td>-0.004605</td>
      <td>-0.000464</td>
      <td>0.016833</td>
      <td>0.003264</td>
      <td>0.971754</td>
      <td>0.161382</td>
      <td>0.002410</td>
      <td>0.007860</td>
      <td>0.037284</td>
      <td>-0.002891</td>
    </tr>
    <tr>
      <th>bogo</th>
      <td>0.034535</td>
      <td>-0.382530</td>
      <td>0.020408</td>
      <td>0.564491</td>
      <td>0.008544</td>
      <td>-0.096284</td>
      <td>-0.270397</td>
      <td>-0.087753</td>
      <td>0.181347</td>
      <td>0.082079</td>
    </tr>
    <tr>
      <th>discount</th>
      <td>-0.131470</td>
      <td>0.563949</td>
      <td>0.031534</td>
      <td>-0.172596</td>
      <td>-0.004933</td>
      <td>0.034859</td>
      <td>0.157231</td>
      <td>0.140846</td>
      <td>-0.063367</td>
      <td>-0.327625</td>
    </tr>
    <tr>
      <th>informational</th>
      <td>0.144968</td>
      <td>-0.277401</td>
      <td>-0.076936</td>
      <td>-0.572614</td>
      <td>-0.005212</td>
      <td>0.089601</td>
      <td>0.163296</td>
      <td>-0.080720</td>
      <td>-0.172167</td>
      <td>0.367116</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<p><a id="prediction"></a><a> ## Prediction modelling</a></p><a>
</a></section><a>
</a><section id="train-the-baseline-model-for-random-forest" class="level4"><a>
<h4 class="anchored" data-anchor-id="train-the-baseline-model-for-random-forest">Train the baseline model for Random Forest</h4>
</a><div class="cell" data-execution_count="263"><a>
</a><div class="sourceCode cell-code" id="cb355"><a></a><pre class="sourceCode python code-with-copy"><a><code class="sourceCode python"><span id="cb355-1"></span></code></a><code class="sourceCode python"><a href="#cb355-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time
<span id="cb355-2"><a href="#cb355-2" aria-hidden="true" tabindex="-1"></a>rfc <span class="op">=</span> RandomForestClassifier()</span>
<span id="cb355-3"><a href="#cb355-3" aria-hidden="true" tabindex="-1"></a>rfc.fit(X_train_scaled_pca, y_train)</span>
<span id="cb355-4"><a href="#cb355-4" aria-hidden="true" tabindex="-1"></a>display(rfc.score(X_train_scaled_pca, y_train))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>1.0</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 19 s, sys: 35 ms, total: 19 s
Wall time: 19.4 s</code></pre>
</div>
</div>
<p><a id="gb"></a><a> ## Gradient Boosting Algorithm</a></p><a>
</a><p><a></a><a id="tune"></a><a> ## Hyperparameter Tuning</a></p><a>
</a></section><a>
</a><section id="hyperparameter-tuning-round-1-randomsearchcv" class="level4"><a>
<h4 class="anchored" data-anchor-id="hyperparameter-tuning-round-1-randomsearchcv">Hyperparameter Tuning Round 1: RandomSearchCV</h4>
<p>We will be tuning these hyperparameters: * n_estimators: the number of “trees” in our Random Forest. * max_features: the number of features at each split. * max_depth: the max number of “splits”each tree can have. * min_samples_split: the minimum number of observations required before a node of a tree can split itself. * min_samples_leaf: the minimum number of observations required at each leaf at the ends of each tree. * bootstrap: whether to use bootstrapping or not to provide data to each tree in the Random Forest. (Bootstrapping is a random sampling from the dataset with replacement.)</p>
</a><div class="cell" data-execution_count="435"><a>
</a><div class="sourceCode cell-code" id="cb358"><a></a><pre class="sourceCode python code-with-copy"><a><code class="sourceCode python"><span id="cb358-1"></span></code></a><code class="sourceCode python"><a href="#cb358-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time
<span id="cb358-2"><a href="#cb358-2" aria-hidden="true" tabindex="-1"></a>n_estimators <span class="op">=</span> [<span class="bu">int</span>(x) <span class="cf">for</span> x <span class="kw">in</span> np.linspace(start <span class="op">=</span> <span class="dv">100</span>, stop <span class="op">=</span> <span class="dv">1000</span>, num <span class="op">=</span> <span class="dv">10</span>)]</span>
<span id="cb358-3"><a href="#cb358-3" aria-hidden="true" tabindex="-1"></a>max_features <span class="op">=</span> [<span class="st">'log2'</span>, <span class="st">'sqrt'</span>]</span>
<span id="cb358-4"><a href="#cb358-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb358-5"><a href="#cb358-5" aria-hidden="true" tabindex="-1"></a>max_depth <span class="op">=</span> [<span class="bu">int</span>(x) <span class="cf">for</span> x <span class="kw">in</span> np.linspace(start <span class="op">=</span> <span class="dv">1</span>, stop <span class="op">=</span> <span class="dv">15</span>, num <span class="op">=</span> <span class="dv">15</span>)]</span>
<span id="cb358-6"><a href="#cb358-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb358-7"><a href="#cb358-7" aria-hidden="true" tabindex="-1"></a>min_samples_split <span class="op">=</span> [<span class="bu">int</span>(x) <span class="cf">for</span> x <span class="kw">in</span> np.linspace(start <span class="op">=</span> <span class="dv">2</span>, stop <span class="op">=</span> <span class="dv">50</span>, num <span class="op">=</span> <span class="dv">10</span>)]</span>
<span id="cb358-8"><a href="#cb358-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb358-9"><a href="#cb358-9" aria-hidden="true" tabindex="-1"></a>min_samples_leaf <span class="op">=</span> [<span class="bu">int</span>(x) <span class="cf">for</span> x <span class="kw">in</span> np.linspace(start <span class="op">=</span> <span class="dv">2</span>, stop <span class="op">=</span> <span class="dv">50</span>, num <span class="op">=</span> <span class="dv">10</span>)]</span>
<span id="cb358-10"><a href="#cb358-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb358-11"><a href="#cb358-11" aria-hidden="true" tabindex="-1"></a>bootstrap <span class="op">=</span> [<span class="va">True</span>, <span class="va">False</span>]</span>
<span id="cb358-12"><a href="#cb358-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb358-13"><a href="#cb358-13" aria-hidden="true" tabindex="-1"></a>param_dist <span class="op">=</span> {<span class="st">'n_estimators'</span>: n_estimators,</span>
<span id="cb358-14"><a href="#cb358-14" aria-hidden="true" tabindex="-1"></a>               <span class="st">'max_features'</span>: max_features,</span>
<span id="cb358-15"><a href="#cb358-15" aria-hidden="true" tabindex="-1"></a>               <span class="st">'max_depth'</span>: max_depth,</span>
<span id="cb358-16"><a href="#cb358-16" aria-hidden="true" tabindex="-1"></a>               <span class="st">'min_samples_split'</span>: min_samples_split,</span>
<span id="cb358-17"><a href="#cb358-17" aria-hidden="true" tabindex="-1"></a>               <span class="st">'min_samples_leaf'</span>: min_samples_leaf,</span>
<span id="cb358-18"><a href="#cb358-18" aria-hidden="true" tabindex="-1"></a>               <span class="st">'bootstrap'</span>: bootstrap}</span>
<span id="cb358-19"><a href="#cb358-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb358-20"><a href="#cb358-20" aria-hidden="true" tabindex="-1"></a>rs <span class="op">=</span> RandomizedSearchCV(rfc, </span>
<span id="cb358-21"><a href="#cb358-21" aria-hidden="true" tabindex="-1"></a>                        param_dist, </span>
<span id="cb358-22"><a href="#cb358-22" aria-hidden="true" tabindex="-1"></a>                        n_iter <span class="op">=</span> <span class="dv">100</span>, </span>
<span id="cb358-23"><a href="#cb358-23" aria-hidden="true" tabindex="-1"></a>                        cv <span class="op">=</span> <span class="dv">3</span>, </span>
<span id="cb358-24"><a href="#cb358-24" aria-hidden="true" tabindex="-1"></a>                        verbose <span class="op">=</span> <span class="dv">1</span>, </span>
<span id="cb358-25"><a href="#cb358-25" aria-hidden="true" tabindex="-1"></a>                        n_jobs<span class="op">=</span><span class="dv">3</span>, </span>
<span id="cb358-26"><a href="#cb358-26" aria-hidden="true" tabindex="-1"></a>                        random_state<span class="op">=</span><span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 2.04 ms, sys: 0 ns, total: 2.04 ms
Wall time: 17 ms</code></pre>
</div>
</div>
<div class="cell" data-execution_count="437">
<div class="sourceCode cell-code" id="cb360"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb360-1"><a href="#cb360-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb360-2"><a href="#cb360-2" aria-hidden="true" tabindex="-1"></a>rs.fit(X_train_scaled_pca, y_train)</span>
<span id="cb360-3"><a href="#cb360-3" aria-hidden="true" tabindex="-1"></a>rs.best_params_</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Fitting 3 folds for each of 100 candidates, totalling 300 fits
CPU times: user 1min 53s, sys: 380 ms, total: 1min 53s
Wall time: 1h 53min 42s</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="437">
<pre><code>{'n_estimators': 500,
 'min_samples_split': 12,
 'min_samples_leaf': 18,
 'max_features': 'sqrt',
 'max_depth': 13,
 'bootstrap': False}</code></pre>
</div>
</div>
<p>With n_iter = 100 and cv = 3, we created 300 Random Forest models, randomly sampling combinations of the hyperparameters input above. We can call “best_params_” to get the best performing model’s parameters. However, “best_params_” at this stage may not give us the best insight to get a range of parameters to try for the next round of hyperparameter tuning. To get a good range of values to try next, we can easily get a dataframe of our RandomSearchCV results</p>
<div class="cell" data-execution_count="438">
<div class="sourceCode cell-code" id="cb363"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb363-1"><a href="#cb363-1" aria-hidden="true" tabindex="-1"></a>rs_df <span class="op">=</span> pd.DataFrame(rs.cv_results_).sort_values(<span class="st">'rank_test_score'</span>).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb363-2"><a href="#cb363-2" aria-hidden="true" tabindex="-1"></a>rs_df <span class="op">=</span> rs_df.drop([</span>
<span id="cb363-3"><a href="#cb363-3" aria-hidden="true" tabindex="-1"></a>            <span class="st">'mean_fit_time'</span>, </span>
<span id="cb363-4"><a href="#cb363-4" aria-hidden="true" tabindex="-1"></a>            <span class="st">'std_fit_time'</span>, </span>
<span id="cb363-5"><a href="#cb363-5" aria-hidden="true" tabindex="-1"></a>            <span class="st">'mean_score_time'</span>,</span>
<span id="cb363-6"><a href="#cb363-6" aria-hidden="true" tabindex="-1"></a>            <span class="st">'std_score_time'</span>, </span>
<span id="cb363-7"><a href="#cb363-7" aria-hidden="true" tabindex="-1"></a>            <span class="st">'params'</span>, </span>
<span id="cb363-8"><a href="#cb363-8" aria-hidden="true" tabindex="-1"></a>            <span class="st">'split0_test_score'</span>, </span>
<span id="cb363-9"><a href="#cb363-9" aria-hidden="true" tabindex="-1"></a>            <span class="st">'split1_test_score'</span>, </span>
<span id="cb363-10"><a href="#cb363-10" aria-hidden="true" tabindex="-1"></a>            <span class="st">'split2_test_score'</span>, </span>
<span id="cb363-11"><a href="#cb363-11" aria-hidden="true" tabindex="-1"></a>            <span class="st">'std_test_score'</span>],</span>
<span id="cb363-12"><a href="#cb363-12" aria-hidden="true" tabindex="-1"></a>            axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb363-13"><a href="#cb363-13" aria-hidden="true" tabindex="-1"></a>rs_df.head(<span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="438">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>param_n_estimators</th>
      <th>param_min_samples_split</th>
      <th>param_min_samples_leaf</th>
      <th>param_max_features</th>
      <th>param_max_depth</th>
      <th>param_bootstrap</th>
      <th>mean_test_score</th>
      <th>rank_test_score</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>500</td>
      <td>12</td>
      <td>18</td>
      <td>sqrt</td>
      <td>13</td>
      <td>False</td>
      <td>0.886116</td>
      <td>1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>700</td>
      <td>12</td>
      <td>2</td>
      <td>sqrt</td>
      <td>13</td>
      <td>False</td>
      <td>0.886053</td>
      <td>2</td>
    </tr>
    <tr>
      <th>2</th>
      <td>400</td>
      <td>23</td>
      <td>2</td>
      <td>sqrt</td>
      <td>14</td>
      <td>False</td>
      <td>0.885593</td>
      <td>3</td>
    </tr>
    <tr>
      <th>3</th>
      <td>300</td>
      <td>28</td>
      <td>7</td>
      <td>log2</td>
      <td>13</td>
      <td>True</td>
      <td>0.885551</td>
      <td>4</td>
    </tr>
    <tr>
      <th>4</th>
      <td>700</td>
      <td>2</td>
      <td>2</td>
      <td>log2</td>
      <td>11</td>
      <td>True</td>
      <td>0.885530</td>
      <td>5</td>
    </tr>
    <tr>
      <th>5</th>
      <td>600</td>
      <td>50</td>
      <td>23</td>
      <td>sqrt</td>
      <td>14</td>
      <td>False</td>
      <td>0.885321</td>
      <td>6</td>
    </tr>
    <tr>
      <th>6</th>
      <td>800</td>
      <td>28</td>
      <td>12</td>
      <td>sqrt</td>
      <td>14</td>
      <td>True</td>
      <td>0.885154</td>
      <td>7</td>
    </tr>
    <tr>
      <th>7</th>
      <td>600</td>
      <td>23</td>
      <td>2</td>
      <td>sqrt</td>
      <td>15</td>
      <td>False</td>
      <td>0.885091</td>
      <td>8</td>
    </tr>
    <tr>
      <th>8</th>
      <td>300</td>
      <td>2</td>
      <td>23</td>
      <td>log2</td>
      <td>14</td>
      <td>False</td>
      <td>0.885070</td>
      <td>9</td>
    </tr>
    <tr>
      <th>9</th>
      <td>300</td>
      <td>18</td>
      <td>18</td>
      <td>sqrt</td>
      <td>13</td>
      <td>True</td>
      <td>0.885050</td>
      <td>10</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="cell" data-execution_count="440">
<div class="sourceCode cell-code" id="cb364"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb364-1"><a href="#cb364-1" aria-hidden="true" tabindex="-1"></a>fig, axs <span class="op">=</span> plt.subplots(ncols<span class="op">=</span><span class="dv">3</span>, nrows<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb364-2"><a href="#cb364-2" aria-hidden="true" tabindex="-1"></a>sns.<span class="bu">set</span>(style<span class="op">=</span><span class="st">"whitegrid"</span>, color_codes<span class="op">=</span><span class="va">True</span>, font_scale <span class="op">=</span> <span class="dv">2</span>)</span>
<span id="cb364-3"><a href="#cb364-3" aria-hidden="true" tabindex="-1"></a>fig.set_size_inches(<span class="dv">30</span>,<span class="dv">25</span>)</span>
<span id="cb364-4"><a href="#cb364-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb364-5"><a href="#cb364-5" aria-hidden="true" tabindex="-1"></a>sns.barplot(x<span class="op">=</span><span class="st">'param_n_estimators'</span>, y<span class="op">=</span><span class="st">'mean_test_score'</span>, data<span class="op">=</span>rs_df, ax<span class="op">=</span>axs[<span class="dv">0</span>,<span class="dv">0</span>], color<span class="op">=</span><span class="st">'lightgrey'</span>)</span>
<span id="cb364-6"><a href="#cb364-6" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>,<span class="dv">0</span>].set_ylim([<span class="fl">.83</span>,<span class="fl">.93</span>])</span>
<span id="cb364-7"><a href="#cb364-7" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>,<span class="dv">0</span>].set_title(label <span class="op">=</span> <span class="st">'n_estimators'</span>, size<span class="op">=</span><span class="dv">30</span>, weight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb364-8"><a href="#cb364-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb364-9"><a href="#cb364-9" aria-hidden="true" tabindex="-1"></a>sns.barplot(x<span class="op">=</span><span class="st">'param_min_samples_split'</span>, y<span class="op">=</span><span class="st">'mean_test_score'</span>, data<span class="op">=</span>rs_df, ax<span class="op">=</span>axs[<span class="dv">0</span>,<span class="dv">1</span>], color<span class="op">=</span><span class="st">'coral'</span>)</span>
<span id="cb364-10"><a href="#cb364-10" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>,<span class="dv">1</span>].set_ylim([<span class="fl">.85</span>,<span class="fl">.93</span>])</span>
<span id="cb364-11"><a href="#cb364-11" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>,<span class="dv">1</span>].set_title(label <span class="op">=</span> <span class="st">'min_samples_split'</span>, size<span class="op">=</span><span class="dv">30</span>, weight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb364-12"><a href="#cb364-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb364-13"><a href="#cb364-13" aria-hidden="true" tabindex="-1"></a>sns.barplot(x<span class="op">=</span><span class="st">'param_min_samples_leaf'</span>, y<span class="op">=</span><span class="st">'mean_test_score'</span>, data<span class="op">=</span>rs_df, ax<span class="op">=</span>axs[<span class="dv">0</span>,<span class="dv">2</span>], color<span class="op">=</span><span class="st">'lightgreen'</span>)</span>
<span id="cb364-14"><a href="#cb364-14" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>,<span class="dv">2</span>].set_ylim([<span class="fl">.80</span>,<span class="fl">.93</span>])</span>
<span id="cb364-15"><a href="#cb364-15" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>,<span class="dv">2</span>].set_title(label <span class="op">=</span> <span class="st">'min_samples_leaf'</span>, size<span class="op">=</span><span class="dv">30</span>, weight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb364-16"><a href="#cb364-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb364-17"><a href="#cb364-17" aria-hidden="true" tabindex="-1"></a>sns.barplot(x<span class="op">=</span><span class="st">'param_max_features'</span>, y<span class="op">=</span><span class="st">'mean_test_score'</span>, data<span class="op">=</span>rs_df, ax<span class="op">=</span>axs[<span class="dv">1</span>,<span class="dv">0</span>], color<span class="op">=</span><span class="st">'wheat'</span>)</span>
<span id="cb364-18"><a href="#cb364-18" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>,<span class="dv">0</span>].set_ylim([<span class="fl">.88</span>,<span class="fl">.92</span>])</span>
<span id="cb364-19"><a href="#cb364-19" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>,<span class="dv">0</span>].set_title(label <span class="op">=</span> <span class="st">'max_features'</span>, size<span class="op">=</span><span class="dv">30</span>, weight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb364-20"><a href="#cb364-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb364-21"><a href="#cb364-21" aria-hidden="true" tabindex="-1"></a>sns.barplot(x<span class="op">=</span><span class="st">'param_max_depth'</span>, y<span class="op">=</span><span class="st">'mean_test_score'</span>, data<span class="op">=</span>rs_df, ax<span class="op">=</span>axs[<span class="dv">1</span>,<span class="dv">1</span>], color<span class="op">=</span><span class="st">'lightpink'</span>)</span>
<span id="cb364-22"><a href="#cb364-22" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>,<span class="dv">1</span>].set_ylim([<span class="fl">.80</span>,<span class="fl">.93</span>])</span>
<span id="cb364-23"><a href="#cb364-23" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>,<span class="dv">1</span>].set_title(label <span class="op">=</span> <span class="st">'max_depth'</span>, size<span class="op">=</span><span class="dv">30</span>, weight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb364-24"><a href="#cb364-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb364-25"><a href="#cb364-25" aria-hidden="true" tabindex="-1"></a>sns.barplot(x<span class="op">=</span><span class="st">'param_bootstrap'</span>,y<span class="op">=</span><span class="st">'mean_test_score'</span>, data<span class="op">=</span>rs_df, ax<span class="op">=</span>axs[<span class="dv">1</span>,<span class="dv">2</span>], color<span class="op">=</span><span class="st">'skyblue'</span>)</span>
<span id="cb364-26"><a href="#cb364-26" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>,<span class="dv">2</span>].set_ylim([<span class="fl">.88</span>,<span class="fl">.92</span>])</span>
<span id="cb364-27"><a href="#cb364-27" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>,<span class="dv">2</span>].set_title(label <span class="op">=</span> <span class="st">'bootstrap'</span>, size<span class="op">=</span><span class="dv">30</span>, weight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb364-28"><a href="#cb364-28" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2021-07-14-Starbucks-Optimising-Customer-Segmentation-with-Random-Forest-and-Gradient-Boosting_files/figure-html/cell-274-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Looking at the plots above, we can extract insights about how well each value for each hyperparameter performed on average.</p>
<p>n_estimators: 300, 500, 700, 900 seem to have the highest average scores.</p>
<p>min_samples_split: There are high scores at 23and 44</p>
<p>min_samples_leaf: We can try values between 2,7,18,34.</p>
<p>max_features: “sqrt” has the highest average score.</p>
<p>max_depth: values of 8-15 seem to do well.</p>
<p>bootstrap: “False” has the highest average score.</p>
<p>So now we can take these insights and move into the second round of hyperparameter tuning to further narrow our selections.</p>
</section>
<section id="hyperparameter-tuning-round-2-gridsearchcv" class="level4">
<h4 class="anchored" data-anchor-id="hyperparameter-tuning-round-2-gridsearchcv">Hyperparameter Tuning Round 2: GridSearchCV</h4>
<div class="cell" data-execution_count="441">
<div class="sourceCode cell-code" id="cb365"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb365-1"><a href="#cb365-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb365-2"><a href="#cb365-2" aria-hidden="true" tabindex="-1"></a><span class="co">## Tune this after the analysis from above</span></span>
<span id="cb365-3"><a href="#cb365-3" aria-hidden="true" tabindex="-1"></a>n_estimators <span class="op">=</span> [<span class="dv">500</span>,<span class="dv">700</span>,<span class="dv">900</span>]</span>
<span id="cb365-4"><a href="#cb365-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb365-5"><a href="#cb365-5" aria-hidden="true" tabindex="-1"></a>max_depth <span class="op">=</span> [<span class="dv">8</span>,<span class="dv">9</span>,<span class="dv">10</span>,<span class="dv">11</span>,<span class="dv">12</span>,<span class="dv">13</span>,<span class="dv">14</span>,<span class="dv">15</span>]</span>
<span id="cb365-6"><a href="#cb365-6" aria-hidden="true" tabindex="-1"></a>min_samples_split <span class="op">=</span> [<span class="dv">23</span>,<span class="dv">44</span>]</span>
<span id="cb365-7"><a href="#cb365-7" aria-hidden="true" tabindex="-1"></a>min_samples_leaf <span class="op">=</span> [<span class="dv">2</span>,<span class="dv">18</span>,<span class="dv">34</span>]</span>
<span id="cb365-8"><a href="#cb365-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb365-9"><a href="#cb365-9" aria-hidden="true" tabindex="-1"></a>param_grid <span class="op">=</span> {<span class="st">'n_estimators'</span>: n_estimators,</span>
<span id="cb365-10"><a href="#cb365-10" aria-hidden="true" tabindex="-1"></a>               </span>
<span id="cb365-11"><a href="#cb365-11" aria-hidden="true" tabindex="-1"></a>               <span class="st">'max_depth'</span>: max_depth,</span>
<span id="cb365-12"><a href="#cb365-12" aria-hidden="true" tabindex="-1"></a>               <span class="st">'min_samples_split'</span>: min_samples_split,</span>
<span id="cb365-13"><a href="#cb365-13" aria-hidden="true" tabindex="-1"></a>               <span class="st">'min_samples_leaf'</span>: min_samples_leaf,}</span>
<span id="cb365-14"><a href="#cb365-14" aria-hidden="true" tabindex="-1"></a>gs <span class="op">=</span> GridSearchCV(rfc, param_grid, cv <span class="op">=</span> <span class="dv">3</span>, verbose <span class="op">=</span> <span class="dv">1</span>, n_jobs<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb365-15"><a href="#cb365-15" aria-hidden="true" tabindex="-1"></a>gs.fit(X_train_scaled_pca, y_train)</span>
<span id="cb365-16"><a href="#cb365-16" aria-hidden="true" tabindex="-1"></a>rfc_3 <span class="op">=</span> gs.best_estimator_</span>
<span id="cb365-17"><a href="#cb365-17" aria-hidden="true" tabindex="-1"></a>gs.best_params_</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Fitting 3 folds for each of 144 candidates, totalling 432 fits
CPU times: user 2min 10s, sys: 587 ms, total: 2min 10s
Wall time: 3h 38min 32s</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="441">
<pre><code>{'max_depth': 13,
 'min_samples_leaf': 2,
 'min_samples_split': 23,
 'n_estimators': 900}</code></pre>
</div>
</div>
<div class="cell" data-execution_count="267">
<div class="sourceCode cell-code" id="cb368"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb368-1"><a href="#cb368-1" aria-hidden="true" tabindex="-1"></a>x_test_scaled_df<span class="op">=</span>pd.DataFrame(X_test_scaled,columns<span class="op">=</span>feature_names)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="268">
<div class="sourceCode cell-code" id="cb369"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb369-1"><a href="#cb369-1" aria-hidden="true" tabindex="-1"></a>x_test_scaled_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="268">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>income</th>
      <th>spent_required</th>
      <th>money_gained</th>
      <th>age</th>
      <th>channel_social</th>
      <th>channel_email</th>
      <th>channel_mobile</th>
      <th>channel_web</th>
      <th>offer_duration_days</th>
      <th>days_of_membership</th>
      <th>gender_F</th>
      <th>gender_M</th>
      <th>gender_O</th>
      <th>bogo</th>
      <th>discount</th>
      <th>informational</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.480289</td>
      <td>0.308519</td>
      <td>-0.570975</td>
      <td>0.836877</td>
      <td>0.872210</td>
      <td>0.326346</td>
      <td>0.421475</td>
      <td>-1.453699</td>
      <td>0.498934</td>
      <td>-0.250415</td>
      <td>1.150423</td>
      <td>-1.117482</td>
      <td>-0.120439</td>
      <td>1.197087</td>
      <td>-0.92360</td>
      <td>-0.384232</td>
    </tr>
    <tr>
      <th>1</th>
      <td>-0.303513</td>
      <td>-1.582487</td>
      <td>-0.570975</td>
      <td>-0.785519</td>
      <td>-1.026961</td>
      <td>-0.700134</td>
      <td>-0.493049</td>
      <td>-0.360391</td>
      <td>-1.112714</td>
      <td>-0.571356</td>
      <td>1.150423</td>
      <td>-1.117482</td>
      <td>-0.120439</td>
      <td>-0.835361</td>
      <td>-0.92360</td>
      <td>2.602591</td>
    </tr>
    <tr>
      <th>2</th>
      <td>-0.026877</td>
      <td>-0.258783</td>
      <td>-0.570975</td>
      <td>-0.576696</td>
      <td>0.872210</td>
      <td>0.326346</td>
      <td>0.421475</td>
      <td>0.732917</td>
      <td>0.498934</td>
      <td>1.569288</td>
      <td>1.150423</td>
      <td>-1.117482</td>
      <td>-0.120439</td>
      <td>-0.835361</td>
      <td>1.08272</td>
      <td>-0.384232</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.618607</td>
      <td>0.308519</td>
      <td>2.948957</td>
      <td>-0.062669</td>
      <td>-0.077375</td>
      <td>-0.700134</td>
      <td>-0.493049</td>
      <td>-1.453699</td>
      <td>-0.629219</td>
      <td>-0.218217</td>
      <td>1.150423</td>
      <td>-1.117482</td>
      <td>-0.120439</td>
      <td>1.197087</td>
      <td>-0.92360</td>
      <td>-0.384232</td>
    </tr>
    <tr>
      <th>4</th>
      <td>-0.441831</td>
      <td>2.199524</td>
      <td>1.188991</td>
      <td>-0.383936</td>
      <td>-1.026961</td>
      <td>-0.700134</td>
      <td>-1.407573</td>
      <td>-0.360391</td>
      <td>-0.145725</td>
      <td>-0.563047</td>
      <td>1.150423</td>
      <td>-1.117482</td>
      <td>-0.120439</td>
      <td>-0.835361</td>
      <td>1.08272</td>
      <td>-0.384232</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>23557</th>
      <td>0.295865</td>
      <td>0.308519</td>
      <td>0.133011</td>
      <td>-0.303619</td>
      <td>-0.077375</td>
      <td>-0.700134</td>
      <td>-0.493049</td>
      <td>-0.360391</td>
      <td>-0.145725</td>
      <td>-0.390632</td>
      <td>-0.869245</td>
      <td>0.894869</td>
      <td>-0.120439</td>
      <td>-0.835361</td>
      <td>1.08272</td>
      <td>-0.384232</td>
    </tr>
    <tr>
      <th>23558</th>
      <td>2.416740</td>
      <td>0.308519</td>
      <td>-0.570975</td>
      <td>0.997511</td>
      <td>0.872210</td>
      <td>0.326346</td>
      <td>0.421475</td>
      <td>0.732917</td>
      <td>-0.145725</td>
      <td>-0.451912</td>
      <td>1.150423</td>
      <td>-1.117482</td>
      <td>-0.120439</td>
      <td>1.197087</td>
      <td>-0.92360</td>
      <td>-0.384232</td>
    </tr>
    <tr>
      <th>23559</th>
      <td>-0.580149</td>
      <td>-0.258783</td>
      <td>0.485004</td>
      <td>-0.753392</td>
      <td>-0.077375</td>
      <td>-0.700134</td>
      <td>-0.493049</td>
      <td>-0.360391</td>
      <td>-0.629219</td>
      <td>0.571152</td>
      <td>-0.869245</td>
      <td>0.894869</td>
      <td>-0.120439</td>
      <td>-0.835361</td>
      <td>1.08272</td>
      <td>-0.384232</td>
    </tr>
    <tr>
      <th>23560</th>
      <td>0.203653</td>
      <td>0.308519</td>
      <td>0.133011</td>
      <td>0.451357</td>
      <td>0.872210</td>
      <td>1.352827</td>
      <td>1.335999</td>
      <td>1.826225</td>
      <td>2.594077</td>
      <td>2.261024</td>
      <td>1.150423</td>
      <td>-1.117482</td>
      <td>-0.120439</td>
      <td>-0.835361</td>
      <td>1.08272</td>
      <td>-0.384232</td>
    </tr>
    <tr>
      <th>23561</th>
      <td>-1.502269</td>
      <td>0.308519</td>
      <td>2.948957</td>
      <td>-0.239366</td>
      <td>-0.077375</td>
      <td>-0.700134</td>
      <td>-0.493049</td>
      <td>-0.360391</td>
      <td>-0.951549</td>
      <td>-0.633674</td>
      <td>1.150423</td>
      <td>-1.117482</td>
      <td>-0.120439</td>
      <td>1.197087</td>
      <td>-0.92360</td>
      <td>-0.384232</td>
    </tr>
  </tbody>
</table>
<p>23562 rows × 16 columns</p>
</div>
</div>
</div>
<div class="cell" data-execution_count="269">
<div class="sourceCode cell-code" id="cb370"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb370-1"><a href="#cb370-1" aria-hidden="true" tabindex="-1"></a>x_test_scaled_df.drop(columns<span class="op">=</span>[<span class="st">'bogo'</span>,<span class="st">'discount'</span>,<span class="st">'informational'</span>,<span class="st">'gender_M'</span>,<span class="st">'gender_F'</span>,<span class="st">'gender_O'</span>],axis<span class="op">=</span><span class="dv">1</span>,inplace<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="evaluate-performance-of-models-on-test-data" class="level2">
<h2 class="anchored" data-anchor-id="evaluate-performance-of-models-on-test-data">Evaluate Performance Of Models On Test Data</h2>
<p>Now, we can evaluate each of the models that we have made on our test data. Remember that we are testing 3 models:</p>
<pre><code>1. Baseline Random Forest
2. Baseline Random Forest With PCA Reduced Dimensionality
3. Baseline Random Forest With PCA Reduced Dimensionality &amp; Hyperparameter Tuning</code></pre>
<div class="cell" data-execution_count="469">
<div class="sourceCode cell-code" id="cb372"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb372-1"><a href="#cb372-1" aria-hidden="true" tabindex="-1"></a>y_pred <span class="op">=</span> rfc.predict(x_test_scaled_df)</span>
<span id="cb372-2"><a href="#cb372-2" aria-hidden="true" tabindex="-1"></a>y_pred_pca <span class="op">=</span> rfc.predict(X_test_scaled_pca)</span>
<span id="cb372-3"><a href="#cb372-3" aria-hidden="true" tabindex="-1"></a>y_pred_gs <span class="op">=</span> gs.best_estimator_.predict(X_test_scaled_pca)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="486">
<div class="sourceCode cell-code" id="cb373"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb373-1"><a href="#cb373-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> confusion_matrix</span>
<span id="cb373-2"><a href="#cb373-2" aria-hidden="true" tabindex="-1"></a>conf_matrix_baseline <span class="op">=</span> pd.DataFrame(confusion_matrix(y_test, y_pred), index <span class="op">=</span> [<span class="st">'actual 0'</span>, <span class="st">'actual 1'</span>,<span class="st">'actual 2'</span>], columns <span class="op">=</span> [<span class="st">'predicted 0'</span>, <span class="st">'predicted 1'</span>,<span class="st">'predicted 2'</span>])</span>
<span id="cb373-3"><a href="#cb373-3" aria-hidden="true" tabindex="-1"></a>conf_matrix_baseline_pca <span class="op">=</span> pd.DataFrame(confusion_matrix(y_test, y_pred_pca), index <span class="op">=</span> [<span class="st">'actual 0'</span>, <span class="st">'actual 1'</span>,<span class="st">'actual 2'</span>], columns <span class="op">=</span> [<span class="st">'predicted 0'</span>, <span class="st">'predicted 1'</span>,<span class="st">'predicted 2'</span>])</span>
<span id="cb373-4"><a href="#cb373-4" aria-hidden="true" tabindex="-1"></a>conf_matrix_tuned_pca <span class="op">=</span> pd.DataFrame(confusion_matrix(y_test, y_pred_gs), index <span class="op">=</span> [<span class="st">'actual 0'</span>, <span class="st">'actual 1'</span>,<span class="st">'actual 2'</span>], columns <span class="op">=</span> [<span class="st">'predicted 0'</span>, <span class="st">'predicted 1'</span>,<span class="st">'predicted 2'</span>])</span>
<span id="cb373-5"><a href="#cb373-5" aria-hidden="true" tabindex="-1"></a>display(conf_matrix_baseline)</span>
<span id="cb373-6"><a href="#cb373-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb373-7"><a href="#cb373-7" aria-hidden="true" tabindex="-1"></a>display(<span class="st">'Baseline Random Forest recall score'</span>, recall_score(y_test, y_pred, average<span class="op">=</span><span class="st">'weighted'</span>))</span>
<span id="cb373-8"><a href="#cb373-8" aria-hidden="true" tabindex="-1"></a>display(conf_matrix_baseline_pca)</span>
<span id="cb373-9"><a href="#cb373-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb373-10"><a href="#cb373-10" aria-hidden="true" tabindex="-1"></a>display(<span class="st">'Baseline Random Forest With PCA recall score'</span>, recall_score(y_test, y_pred_pca,average<span class="op">=</span><span class="st">'weighted'</span>))</span>
<span id="cb373-11"><a href="#cb373-11" aria-hidden="true" tabindex="-1"></a>display(conf_matrix_tuned_pca)</span>
<span id="cb373-12"><a href="#cb373-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb373-13"><a href="#cb373-13" aria-hidden="true" tabindex="-1"></a>display(<span class="st">'Hyperparameter Tuned Random Forest With PCA Reduced Dimensionality recall score'</span>, recall_score(y_test, y_pred_gs,average<span class="op">=</span><span class="st">'weighted'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>predicted 0</th>
      <th>predicted 1</th>
      <th>predicted 2</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>actual 0</th>
      <td>8226</td>
      <td>1303</td>
      <td>1007</td>
    </tr>
    <tr>
      <th>actual 1</th>
      <td>1966</td>
      <td>610</td>
      <td>3840</td>
    </tr>
    <tr>
      <th>actual 2</th>
      <td>5044</td>
      <td>855</td>
      <td>711</td>
    </tr>
  </tbody>
</table>
</div>
</div>
<div class="cell-output cell-output-display">
<pre><code>'Baseline Random Forest recall score'</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>0.4051863169510228</code></pre>
</div>
<div class="cell-output cell-output-display">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>predicted 0</th>
      <th>predicted 1</th>
      <th>predicted 2</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>actual 0</th>
      <td>8724</td>
      <td>1040</td>
      <td>772</td>
    </tr>
    <tr>
      <th>actual 1</th>
      <td>643</td>
      <td>5773</td>
      <td>0</td>
    </tr>
    <tr>
      <th>actual 2</th>
      <td>395</td>
      <td>12</td>
      <td>6203</td>
    </tr>
  </tbody>
</table>
</div>
</div>
<div class="cell-output cell-output-display">
<pre><code>'Baseline Random Forest With PCA recall score'</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>0.878533231474408</code></pre>
</div>
<div class="cell-output cell-output-display">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>predicted 0</th>
      <th>predicted 1</th>
      <th>predicted 2</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>actual 0</th>
      <td>8644</td>
      <td>1000</td>
      <td>892</td>
    </tr>
    <tr>
      <th>actual 1</th>
      <td>541</td>
      <td>5874</td>
      <td>1</td>
    </tr>
    <tr>
      <th>actual 2</th>
      <td>204</td>
      <td>29</td>
      <td>6377</td>
    </tr>
  </tbody>
</table>
</div>
</div>
<div class="cell-output cell-output-display">
<pre><code>'Hyperparameter Tuned Random Forest With PCA Reduced Dimensionality recall score'</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>0.8868092691622104</code></pre>
</div>
</div>
<p>From this our result, our best perfoming model is our hyper parameter tund Random Forest model</p>
<div class="cell" data-execution_count="487">
<div class="sourceCode cell-code" id="cb380"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb380-1"><a href="#cb380-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> evaluate_model_performance(clf, X_train, y_train):</span>
<span id="cb380-2"><a href="#cb380-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">'''Prints a model's accuracy and F1-score</span></span>
<span id="cb380-3"><a href="#cb380-3" aria-hidden="true" tabindex="-1"></a><span class="co">    INPUT:</span></span>
<span id="cb380-4"><a href="#cb380-4" aria-hidden="true" tabindex="-1"></a><span class="co">    clf - Model object</span></span>
<span id="cb380-5"><a href="#cb380-5" aria-hidden="true" tabindex="-1"></a><span class="co">    X_train - Training data matrix</span></span>
<span id="cb380-6"><a href="#cb380-6" aria-hidden="true" tabindex="-1"></a><span class="co">    y_train - Expected model output vector</span></span>
<span id="cb380-7"><a href="#cb380-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb380-8"><a href="#cb380-8" aria-hidden="true" tabindex="-1"></a><span class="co">    OUTPUT:</span></span>
<span id="cb380-9"><a href="#cb380-9" aria-hidden="true" tabindex="-1"></a><span class="co">    clf_accuracy: Model accuracy</span></span>
<span id="cb380-10"><a href="#cb380-10" aria-hidden="true" tabindex="-1"></a><span class="co">    clf_f1_score: Model F1-score</span></span>
<span id="cb380-11"><a href="#cb380-11" aria-hidden="true" tabindex="-1"></a><span class="co">    '''</span></span>
<span id="cb380-12"><a href="#cb380-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb380-13"><a href="#cb380-13" aria-hidden="true" tabindex="-1"></a>    class_name <span class="op">=</span> re.sub(<span class="st">"[&lt;&gt;']"</span>, <span class="st">''</span>, <span class="bu">str</span>(clf.__class__))</span>
<span id="cb380-14"><a href="#cb380-14" aria-hidden="true" tabindex="-1"></a>    class_name <span class="op">=</span> class_name.split(<span class="st">' '</span>)[<span class="dv">1</span>]</span>
<span id="cb380-15"><a href="#cb380-15" aria-hidden="true" tabindex="-1"></a>    class_name <span class="op">=</span> class_name.split(<span class="st">'.'</span>)[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb380-16"><a href="#cb380-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb380-17"><a href="#cb380-17" aria-hidden="true" tabindex="-1"></a>    y_pred_rf <span class="op">=</span> clf.predict(X_train)</span>
<span id="cb380-18"><a href="#cb380-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb380-19"><a href="#cb380-19" aria-hidden="true" tabindex="-1"></a>    clf_accuracy <span class="op">=</span> accuracy_score(y_train, y_pred_rf)</span>
<span id="cb380-20"><a href="#cb380-20" aria-hidden="true" tabindex="-1"></a>    clf_f1_score <span class="op">=</span> f1_score(y_train, y_pred_rf,average<span class="op">=</span><span class="st">'weighted'</span>)</span>
<span id="cb380-21"><a href="#cb380-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb380-22"><a href="#cb380-22" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="sc">%s</span><span class="st"> model accuracy: </span><span class="sc">%.3f</span><span class="st">"</span> <span class="op">%</span> (class_name, clf_accuracy))</span>
<span id="cb380-23"><a href="#cb380-23" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="sc">%s</span><span class="st"> model f1-score: </span><span class="sc">%.3f</span><span class="st">"</span> <span class="op">%</span> (class_name, clf_f1_score))</span>
<span id="cb380-24"><a href="#cb380-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb380-25"><a href="#cb380-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> clf_accuracy, clf_f1_score</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="490">
<div class="sourceCode cell-code" id="cb381"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb381-1"><a href="#cb381-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluate random forest classifier model's performance</span></span>
<span id="cb381-2"><a href="#cb381-2" aria-hidden="true" tabindex="-1"></a>evaluate_model_performance(gs.best_estimator_, X_train_scaled_pca, y_train)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>RandomForestClassifier model accuracy: 0.916
RandomForestClassifier model f1-score: 0.915</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="490">
<pre><code>(0.9159454826706802, 0.9153190471092886)</code></pre>
</div>
</div>
<section id="feature-importance" class="level3">
<h3 class="anchored" data-anchor-id="feature-importance">Feature importance</h3>
<div class="cell" data-execution_count="491">
<div class="sourceCode cell-code" id="cb384"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb384-1"><a href="#cb384-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define variables</span></span>
<span id="cb384-2"><a href="#cb384-2" aria-hidden="true" tabindex="-1"></a><span class="co"># https://machinelearningmastery.com/calculate-feature-importance-with-python/</span></span>
<span id="cb384-3"><a href="#cb384-3" aria-hidden="true" tabindex="-1"></a>relative_importance <span class="op">=</span> gs.best_estimator_.feature_importances_</span>
<span id="cb384-4"><a href="#cb384-4" aria-hidden="true" tabindex="-1"></a>relative_importance <span class="op">=</span> relative_importance <span class="op">/</span> np.<span class="bu">sum</span>(relative_importance)</span>
<span id="cb384-5"><a href="#cb384-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb384-6"><a href="#cb384-6" aria-hidden="true" tabindex="-1"></a>feature_importance <span class="op">=\</span></span>
<span id="cb384-7"><a href="#cb384-7" aria-hidden="true" tabindex="-1"></a>    pd.DataFrame(<span class="bu">list</span>(<span class="bu">zip</span>(feature_names,</span>
<span id="cb384-8"><a href="#cb384-8" aria-hidden="true" tabindex="-1"></a>                          relative_importance)),</span>
<span id="cb384-9"><a href="#cb384-9" aria-hidden="true" tabindex="-1"></a>                 columns<span class="op">=</span>[<span class="st">'feature'</span>, <span class="st">'relativeimportance'</span>])</span>
<span id="cb384-10"><a href="#cb384-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb384-11"><a href="#cb384-11" aria-hidden="true" tabindex="-1"></a>feature_importance <span class="op">=</span> feature_importance.sort_values(<span class="st">'relativeimportance'</span>,</span>
<span id="cb384-12"><a href="#cb384-12" aria-hidden="true" tabindex="-1"></a>                                                    ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb384-13"><a href="#cb384-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb384-14"><a href="#cb384-14" aria-hidden="true" tabindex="-1"></a>feature_importance <span class="op">=</span> feature_importance.reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb384-15"><a href="#cb384-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb384-16"><a href="#cb384-16" aria-hidden="true" tabindex="-1"></a>palette <span class="op">=</span> sns.color_palette(<span class="st">"Blues_r"</span>, feature_importance.shape[<span class="dv">0</span>])</span>
<span id="cb384-17"><a href="#cb384-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb384-18"><a href="#cb384-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot Estimated Feature Importance</span></span>
<span id="cb384-19"><a href="#cb384-19" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">8</span>))</span>
<span id="cb384-20"><a href="#cb384-20" aria-hidden="true" tabindex="-1"></a>sns.barplot(x<span class="op">=</span><span class="st">'relativeimportance'</span>,</span>
<span id="cb384-21"><a href="#cb384-21" aria-hidden="true" tabindex="-1"></a>            y<span class="op">=</span><span class="st">'feature'</span>,</span>
<span id="cb384-22"><a href="#cb384-22" aria-hidden="true" tabindex="-1"></a>            data<span class="op">=</span>feature_importance,</span>
<span id="cb384-23"><a href="#cb384-23" aria-hidden="true" tabindex="-1"></a>            palette<span class="op">=</span>palette)</span>
<span id="cb384-24"><a href="#cb384-24" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Relative Importance'</span>)</span>
<span id="cb384-25"><a href="#cb384-25" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Feature'</span>)</span>
<span id="cb384-26"><a href="#cb384-26" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Estimated Feature Importance Based on Random Forest'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="491">
<pre><code>Text(0.5, 1.0, 'Estimated Feature Importance Based on Random Forest')</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="2021-07-14-Starbucks-Optimising-Customer-Segmentation-with-Random-Forest-and-Gradient-Boosting_files/figure-html/cell-283-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="456">
<div class="sourceCode cell-code" id="cb386"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb386-1"><a href="#cb386-1" aria-hidden="true" tabindex="-1"></a>feature_importance.head(n<span class="op">=</span><span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="456">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>feature</th>
      <th>relativeimportance</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>income</td>
      <td>0.242512</td>
    </tr>
    <tr>
      <th>1</th>
      <td>age</td>
      <td>0.188434</td>
    </tr>
    <tr>
      <th>2</th>
      <td>offer_duration_days</td>
      <td>0.174120</td>
    </tr>
    <tr>
      <th>3</th>
      <td>channel_mobile</td>
      <td>0.143021</td>
    </tr>
    <tr>
      <th>4</th>
      <td>spent_required</td>
      <td>0.093982</td>
    </tr>
    <tr>
      <th>5</th>
      <td>channel_web</td>
      <td>0.062092</td>
    </tr>
    <tr>
      <th>6</th>
      <td>days_of_membership</td>
      <td>0.042789</td>
    </tr>
    <tr>
      <th>7</th>
      <td>money_gained</td>
      <td>0.020546</td>
    </tr>
    <tr>
      <th>8</th>
      <td>channel_email</td>
      <td>0.016501</td>
    </tr>
    <tr>
      <th>9</th>
      <td>channel_social</td>
      <td>0.016003</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<p>According to our model, the 10 most important features that determine whether a customer will ignore, make an order or not make an order are: * Income which contributes the most- 24% * Age which contributes-18% * Duration of offer-17% * Offer sent on mobile-14% * The spend required to complete the offer-9% * If offer was sent on web-6% * How long a customer has been a member-4% * The reward to be gained-2% * Offer sent via email-1.6% * Offer sent via social media-1.6%</p>
<blockquote class="blockquote">
<p>Which means demographics contribute 42% of the decision. The channel used to communicate the offer contributes 23.2%. The details of the offer contribute 11%. How long the customer has been a member contributes 4%.</p>
</blockquote>
<p>Print the best model’s hyperparameters</p>
<div class="cell" data-execution_count="492">
<div class="sourceCode cell-code" id="cb387"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb387-1"><a href="#cb387-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(gs.best_estimator_)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>RandomForestClassifier(max_depth=13, min_samples_leaf=2, min_samples_split=23,
                       n_estimators=900)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="493">
<div class="sourceCode cell-code" id="cb389"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb389-1"><a href="#cb389-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> classification_report</span>
<span id="cb389-2"><a href="#cb389-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb389-3"><a href="#cb389-3" aria-hidden="true" tabindex="-1"></a>labels <span class="op">=</span> [<span class="st">"no view"</span>, <span class="st">"no order"</span>, <span class="st">"possible order"</span>]</span>
<span id="cb389-4"><a href="#cb389-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(classification_report(y_test,y_pred, target_names<span class="op">=</span>labels))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                precision    recall  f1-score   support

       no view       0.54      0.78      0.64     10536
      no order       0.22      0.10      0.13      6416
possible order       0.13      0.11      0.12      6610

      accuracy                           0.41     23562
     macro avg       0.30      0.33      0.30     23562
  weighted avg       0.34      0.41      0.35     23562
</code></pre>
</div>
</div>
<div class="cell" data-execution_count="264">
<div class="sourceCode cell-code" id="cb391"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb391-1"><a href="#cb391-1" aria-hidden="true" tabindex="-1"></a>rf<span class="op">=</span>RandomForestClassifier(max_depth<span class="op">=</span><span class="dv">13</span>, min_samples_leaf<span class="op">=</span><span class="dv">2</span>, min_samples_split<span class="op">=</span><span class="dv">23</span>,</span>
<span id="cb391-2"><a href="#cb391-2" aria-hidden="true" tabindex="-1"></a>                       n_estimators<span class="op">=</span><span class="dv">900</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="265">
<div class="sourceCode cell-code" id="cb392"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb392-1"><a href="#cb392-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb392-2"><a href="#cb392-2" aria-hidden="true" tabindex="-1"></a>rf.fit(X_train_scaled_pca, y_train)</span>
<span id="cb392-3"><a href="#cb392-3" aria-hidden="true" tabindex="-1"></a>display(rf.score(X_train_scaled_pca, y_train))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>0.9167398302604624</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 2min 20s, sys: 69.6 ms, total: 2min 20s
Wall time: 2min 21s</code></pre>
</div>
</div>
<div class="cell" data-execution_count="270">
<div class="sourceCode cell-code" id="cb395"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb395-1"><a href="#cb395-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb395-2"><a href="#cb395-2" aria-hidden="true" tabindex="-1"></a>y_pred_test <span class="op">=</span> rf.predict(x_test_scaled_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 2.93 s, sys: 0 ns, total: 2.93 s
Wall time: 2.95 s</code></pre>
</div>
</div>
<p><a id="conclusion"></a><a> ## Conclusion</a></p><a>
</a></section><a>
</a><section id="test-on-new-data" class="level3"><a>
<h3 class="anchored" data-anchor-id="test-on-new-data">Test on new data</h3>
</a><div class="cell" data-execution_count="277"><a>
</a><div class="sourceCode cell-code" id="cb397"><a></a><pre class="sourceCode python code-with-copy"><a><code class="sourceCode python"><span id="cb397-1"></span></code></a><code class="sourceCode python"><a href="#cb397-1" aria-hidden="true" tabindex="-1"></a>prediction<span class="op">=</span>y_pred_test
<span id="cb397-2"><a href="#cb397-2" aria-hidden="true" tabindex="-1"></a>frames<span class="op">=</span>x_test_scaled_df</span>
<span id="cb397-3"><a href="#cb397-3" aria-hidden="true" tabindex="-1"></a>frames[<span class="st">'Prediction'</span>] <span class="op">=</span> prediction</span>
<span id="cb397-4"><a href="#cb397-4" aria-hidden="true" tabindex="-1"></a>frames.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="277">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>income</th>
      <th>spent_required</th>
      <th>money_gained</th>
      <th>age</th>
      <th>channel_social</th>
      <th>channel_email</th>
      <th>channel_mobile</th>
      <th>channel_web</th>
      <th>offer_duration_days</th>
      <th>days_of_membership</th>
      <th>Prediction</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.480289</td>
      <td>0.308519</td>
      <td>-0.570975</td>
      <td>0.836877</td>
      <td>0.872210</td>
      <td>0.326346</td>
      <td>0.421475</td>
      <td>-1.453699</td>
      <td>0.498934</td>
      <td>-0.250415</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>-0.303513</td>
      <td>-1.582487</td>
      <td>-0.570975</td>
      <td>-0.785519</td>
      <td>-1.026961</td>
      <td>-0.700134</td>
      <td>-0.493049</td>
      <td>-0.360391</td>
      <td>-1.112714</td>
      <td>-0.571356</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>-0.026877</td>
      <td>-0.258783</td>
      <td>-0.570975</td>
      <td>-0.576696</td>
      <td>0.872210</td>
      <td>0.326346</td>
      <td>0.421475</td>
      <td>0.732917</td>
      <td>0.498934</td>
      <td>1.569288</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.618607</td>
      <td>0.308519</td>
      <td>2.948957</td>
      <td>-0.062669</td>
      <td>-0.077375</td>
      <td>-0.700134</td>
      <td>-0.493049</td>
      <td>-1.453699</td>
      <td>-0.629219</td>
      <td>-0.218217</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>-0.441831</td>
      <td>2.199524</td>
      <td>1.188991</td>
      <td>-0.383936</td>
      <td>-1.026961</td>
      <td>-0.700134</td>
      <td>-1.407573</td>
      <td>-0.360391</td>
      <td>-0.145725</td>
      <td>-0.563047</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="cell" data-execution_count="297">
<div class="sourceCode cell-code" id="cb398"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb398-1"><a href="#cb398-1" aria-hidden="true" tabindex="-1"></a>frames[<span class="st">'Prediction'</span>] <span class="op">=</span> frames[<span class="st">'Prediction'</span>].<span class="bu">map</span>({<span class="dv">0</span>: <span class="st">'no view'</span>, <span class="dv">1</span>: <span class="st">'no order'</span>, <span class="dv">2</span>: <span class="st">'possible order'</span>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="308">
<div class="sourceCode cell-code" id="cb399"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb399-1"><a href="#cb399-1" aria-hidden="true" tabindex="-1"></a>frames.Prediction.value_counts()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="308">
<pre><code>no view           12565
possible order     6387
no order           4610
Name: Prediction, dtype: int64</code></pre>
</div>
</div>
<div class="cell" data-execution_count="324">
<div class="sourceCode cell-code" id="cb401"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb401-1"><a href="#cb401-1" aria-hidden="true" tabindex="-1"></a>frames.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="324">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>income</th>
      <th>spent_required</th>
      <th>money_gained</th>
      <th>age</th>
      <th>channel_social</th>
      <th>channel_email</th>
      <th>channel_mobile</th>
      <th>channel_web</th>
      <th>offer_duration_days</th>
      <th>days_of_membership</th>
      <th>Prediction</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.480289</td>
      <td>0.308519</td>
      <td>-0.570975</td>
      <td>0.836877</td>
      <td>0.872210</td>
      <td>0.326346</td>
      <td>0.421475</td>
      <td>-1.453699</td>
      <td>0.498934</td>
      <td>-0.250415</td>
      <td>no view</td>
    </tr>
    <tr>
      <th>1</th>
      <td>-0.303513</td>
      <td>-1.582487</td>
      <td>-0.570975</td>
      <td>-0.785519</td>
      <td>-1.026961</td>
      <td>-0.700134</td>
      <td>-0.493049</td>
      <td>-0.360391</td>
      <td>-1.112714</td>
      <td>-0.571356</td>
      <td>no view</td>
    </tr>
    <tr>
      <th>2</th>
      <td>-0.026877</td>
      <td>-0.258783</td>
      <td>-0.570975</td>
      <td>-0.576696</td>
      <td>0.872210</td>
      <td>0.326346</td>
      <td>0.421475</td>
      <td>0.732917</td>
      <td>0.498934</td>
      <td>1.569288</td>
      <td>no view</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.618607</td>
      <td>0.308519</td>
      <td>2.948957</td>
      <td>-0.062669</td>
      <td>-0.077375</td>
      <td>-0.700134</td>
      <td>-0.493049</td>
      <td>-1.453699</td>
      <td>-0.629219</td>
      <td>-0.218217</td>
      <td>no view</td>
    </tr>
    <tr>
      <th>4</th>
      <td>-0.441831</td>
      <td>2.199524</td>
      <td>1.188991</td>
      <td>-0.383936</td>
      <td>-1.026961</td>
      <td>-0.700134</td>
      <td>-1.407573</td>
      <td>-0.360391</td>
      <td>-0.145725</td>
      <td>-0.563047</td>
      <td>no view</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="cell" data-execution_count="325">
<div class="sourceCode cell-code" id="cb402"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb402-1"><a href="#cb402-1" aria-hidden="true" tabindex="-1"></a>sns.countplot(frames[<span class="st">'Prediction'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="325">
<pre><code>&lt;AxesSubplot:xlabel='Prediction', ylabel='count'&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="2021-07-14-Starbucks-Optimising-Customer-Segmentation-with-Random-Forest-and-Gradient-Boosting_files/figure-html/cell-294-output-2.png" class="img-fluid"></p>
</div>
</div>
<p><a id="results"></a><a> ## Summary of Key Findings</a></p><a>
<p><strong>Starbucks Customer Demographics</strong>:</p>
<p>58.6 % of customers are male, 39.8% are female and 1.4% prefer not to specify gender. While men are the largest population, females are the highest earners and spenders. Most men are in the low_to_mid and mid income bracket.</p>
<p>There’s an almost equal distribution of male and females among the mid to high income bracket. Middle income and low_to_mid income earners occupy a huge proportion of the population, with mid income earners being the dorminant. Low earners are fewer, they are the least.</p>
<p><strong>Starbucks Customer spending behavior</strong>:</p>
<p>Females are the highest spenders, they spend on average 0.23USD per day followed by gender O who spend 0.21USD per day and least spenders are males who spent on average 0.16USD.</p>
<p>The elderly, that is those above 60 are the highest age group spending an average of 0.21USD per day. Adults, those aged 35-60 are the second highest spenders on average, spending 0.19USD per day. Ages 17-34 are the least spenders, spending roughly 0.14USD per day</p>
<p>As expected, high income earners have the highest average spend. Spending on average, 0.28USD per day, mid to high earners also spend highly with 0.23USD per day. Low and low to mid income earners spend right around the same amount. They spend about 0.11US per day</p>
<p>New members have the highest average daily spend followed by regular members. Loyal members, those who have been members for over 3 years are no longer daily spenders</p>
<p>Summary of average daily spending has revealed that: * High earning elderly females who are new members have the highest daily average spend i.e Female members who are over 60 years earning over 90K and have been members for at least 1200 days</p>
<p><strong>Starbucks Offers</strong>: * 41 395 new customers received offers. Of those that received offers, only 41.5% viewed the offer and did not complete it and 37.5% completed the offer.</p>
<ul>
<li><p>40 539 new customers made transactions on the app, new members made the highest number of transactions of all the members. Regular members also made a sizeable amount of transactions on the app, they made 30 036 transactions. Loyal members had the least number of transactions, making 12 299 transactions</p></li>
<li><p>Regular members were the second highest to receive offers, receiving 19 223 offers but only 24% viewing the offers and 60% completing the offers. Most regular members completed the offers without viewing them.</p></li>
<li><p>5785 loyal customers received offers, of this number, 38.2% viewed the offers and 41% completed the offers.</p></li>
</ul>
<p><strong>Perfomance of Offers on different members</strong>: * On new customers:</p>
<pre><code>* 39.88% of new customers received BOGO offer, 41.4% of those that received the BOGO viewed it, which constituted 39.8% of all offer views by new customers. 45% of those new customers that received the BOGO completed it, accounting for 48.8% of all new customers that completed offers.

* 40% of new customers received the discount offer, 27.5% of those that received this offer viewed the offer, accounting for 26.6% of all offer views by new customers. 47.8% of new customers who received the discount offer completed it, which accounts for 51.1% of all offers completed by new customers.

 * 20% of new customers received informational offers, 69.5% of them viewed it, which accounts for 33.5% of views by new customers.</code></pre>
<ul>
<li><p>On regular customers:</p>
<ul>
<li><p>39.77% of regular customers received the BOGO offer, of these only 18% viewed it. This means that 29.4% of all views of BOGO offer were done by regular customers. 74% of regular customers who received the BOGO offer completed it. This accounts for 48.6% of all offers completed by regular customers</p></li>
<li><p>40.3% of regular customers received the discount offer, of these only 7% of them viewed it. This means that 12.1% of offer views by regular customers were viewing discount offer. 77.1% of regular customers who received discount offer completed it. This means 51.4% of all offers completed by regular customers was on discount offers.</p></li>
<li><p>19.91% of regular customers received the informational offer, of these 71.6% of them viewed it. 23.5% of all views made by regular customers were on informational offers.</p></li>
</ul></li>
<li><p>On loyal customers:</p>
<ul>
<li><p>40.3% of loyal customers received the BOGO offer, of these 46% of them viewed it. This means that, 48.85% of all loyal customer views were on BOGO. 40.5% of loyal customers who received BOGO completed it. This accounts for 39.86% of all offers completed by loyal customers.</p></li>
<li><p>39.6% of loyal customers received discount offer, 13.2% viewed it. This means that 13.7% of all views by loyal customers was on discount offer.62.28% of loyal customers who received the discount offer completed it. This accounts for 60% of all offers completed by loyal customers.</p></li>
<li><p>The bogo_3 is the most succesful offer with 29% success. The discount offers perfomed pretty well averaging 27%.</p></li>
</ul></li>
</ul>
<p><strong>Pefomance of Offers on different Genders</strong>: * Female BOGO offer:</p>
<pre><code>* 10 975 females received the BOGO offers, 1368 viewed it but did not complete it. 7566 received and completed it. Only 995 of them auto completed it.</code></pre>
<ul>
<li><p>Female Discount offer:</p>
<ul>
<li>10 943 females received the Discount offers, 1267 viewed but did not complete. 6369 received and completed it.1360 of them auto completed it.</li>
</ul></li>
<li><p>Female Informational offer:</p>
<ul>
<li>5538 females received the informational offer, 1242 viewed but did not complete the offer. 2668 received and completed the offer.</li>
</ul></li>
<li><p>Male BOGO offer:</p>
<ul>
<li>15 208 males received the BOGO offer. Of these 2534 viewed the offer but did not complete it. 9785 received and completed the offer. 963 completed the offer automatically.</li>
</ul></li>
<li><p>Male Discount offer:</p>
<ul>
<li>15 354 males received the discount offer. Of these 2201 males only viewed the offer. 8049 received and completed the offer. 1271 auto completed the offer</li>
</ul></li>
<li><p>Male Informational offer:</p>
<ul>
<li>7567 males received the informational offer. 1480 males viewed the offer without completing it. 3809 received and completed it</li>
</ul></li>
<li><p>Gender unspecified BOGO offer:</p>
<ul>
<li><p>354 of these customers received the offer. 56 only viewed the offer. 253 received and completed the offer while 20 auto completed it.</p></li>
<li><p>Mid income earners received and completed the most offers and made the most transactions.</p></li>
<li><p>Low to mid income earners were the second highest in terms of offers received and completed.</p></li>
</ul></li>
</ul>
<p><strong>Customer Clusters</strong> There are 4 types clusters/Segments of customers. * <strong>Cluster 0</strong>: * Clusters 0 has mostly mid to high and high earners and has mostly elderly and young adults. This cluster liked and responded to all three offers though they spent the least of all 4 clusters. Cluster 0 had a few outliers but most customers in that cluster did not complete offers, a large number of them made casual purchases and or ignored the offers. Cluster O also like all 3 offers with Informational being the most popular,followed by discount and last BOGO offers</p>
<ul>
<li><strong>Cluster 1</strong>:
<ul>
<li>This cluster has mostly mid to high income earners. Cluster 1 liked and spent the most on informational offers spending between 2.5 and 10 USD on them. They spent about the same on BOGO and Discount spending on average between 1 to 7.5 USD. In general, this cluster spent the least amount on all offers.</li>
</ul></li>
<li><strong>Cluster 2</strong>:
<ul>
<li>Cluster 2 made the highest transactions. Cluster 2 has a normal distribution from between low to mid to high income earners with most members in the higher income bracket. Cluster 2 has mostly new and regular members. The prevalent ages being adults and teenagers with an even distribution among males and females. Informational offers were not popular among cluster 2, they did not spent on it. Only a few outliers completed this offer. They spent quite a lot on discount and BOGO offers spending an average of 10USD on both which was the second highest spend on offers among the clusters.</li>
</ul></li>
<li><strong>Cluster 3</strong>:
<ul>
<li>Cluster 3 is mostly skewed towards high income earners. Cluster 3 has the highest average money spent for both transactions and completed offers. Followed closely by cluster 2. In terms of member type it is evenly distributed between new and regular members with very few loyal members, same even distribution among males and females and very very few other genders. This cluster is filled with adults and the elderly which is consistent with what we have been finding. Cluster 3 customers spent a lot on Informational offers, more than 50% of them spend above average (10USD) on it. They also spend the highest on average on Discount offers, most of them spending between 7.5 to 12.5USD. They also spent a lot on BOGO offers though not the most popular offer among this cluster. They spent a minimum of 5USD which is higher than the minimum spend for all other clusters. Most of them spent an average of 9USD on BOGO offers.</li>
</ul></li>
</ul>
</a></section><a>
</a><section id="findings-from-the-model" class="level3"><a>
<h3 class="anchored" data-anchor-id="findings-from-the-model">Findings from the model</h3>
<p>According to our model, the 10 most important features that determine whether a customer will ignore, make an order or not make an order are: * Income which contributes the most- 24% * Age which contributes-18% * Duration of offer-17% * Offer sent on mobile-14% * The spend required to complete the offer-9% * If offer was sent on web-6% * How long a customer has been a member-4% * The reward to be gained-2% * Offer sent via email-1.6% * Offer sent via social media-1.6%</p>
<blockquote class="blockquote">
<p>Which means demographics contribute 42% of the decision. The channel used to communicate the offer contributes 23.2%. The details of the offer contribute 11%. How long the customer has been a member contributes 4%.</p>
</blockquote>
</a><p><a></a><a id="recs"></a><a> ## Recommendations</a></p><a>
<p><strong>Offers</strong>: BOGO and Discount offers perfomed very well accross all demographics and had a lot of money spent on them. Starbucks should keep rolling these out. Informational offers did not perform very well and are also difficult to monitor.There is also no way to track whether informational offers are redeemed (can only see if user received or opened informational offer). We have to assume they were influenced by the informational offer if they viewed it. Offer duration is also very significant factor in whether customers respond to offers, it contributes 17% to the decision of completing and not completing an offer. More money was spent for offers that lasted longer, on average 2USD more was spent on offers that lasted more than 5 days and more. The spent required is also a good measure, generally customers will spend at most under 7 dollars for spent required above 7.</p>
<p><strong>Target Groups</strong>: Females on average spend the most on all offers. Adult and elderly women who are mid to high earners are the most profitable group. They respond to offers and spend a lot on them.</p>
<p>In general, the higher the income the more customers spend on offers.</p>
<p>Adults and the elderly on average spend more on offers than all other groups.</p>
<p>42% of the decision to complete an offer or not is influenced by demographics i.e age and income.</p>
<p>Clusters 2 and 3 should be targeted more because they are high spenders, they are newer members, adults and have good income.</p>
<p><strong>Channel of sending offers</strong>: Channels sent via mobile received the highest spend and were the most completed. Most people who received offer via mobile completed it. It seems that mobile is the most important channel. According to the model, receiving the offer via mobile contributes 14% to the response on the offer. Probably because the rewards app is a mobile app. Other media do contribute like the web (6%), other channels contribute 1.6% each.</p>
<p><strong>Model</strong>: Starbucks should use the random forest classifier model, it can handle large amount of training data and is good for the multiclassification problem. By tuning it using random search and grid search, its best parameters can be found.</p>


</a></section><a>
</a></section><a>
</a></section><a>

</a></main><a> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</a></div><a> <!-- /content -->



</a></body></html>